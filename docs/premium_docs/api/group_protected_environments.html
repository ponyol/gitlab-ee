<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Valid access levels</title>
    <link rel="stylesheet" href="/../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Verify
group: Runner Core
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Group-level protected environments API</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/215888">Introduced</a> in GitLab 14.0. <a href="../administration/feature_flags/_index.html">Deployed behind the <code>group_level_protected_environments</code> flag</a>, disabled by default.</li>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/331085">Feature flag <code>group_level_protected_environments</code></a> removed in GitLab 14.3.</li>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/331085">Generally available</a> in GitLab 14.3.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>Use this API to interact with <a href="../ci/environments/protected_environments.md#group-level-protected-environments">group-level protected environments</a>.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>For protected environments, see <a href="protected_environments.html">protected environments API</a></p>
<p>{{&lt; /alert &gt;}}</p>
<h2>Valid access levels</h2>
<p>The access levels are defined in the <code>ProtectedEnvironments::DeployAccessLevel::ALLOWED_ACCESS_LEVELS</code> method.
Currently, these levels are recognized:</p>
<pre><code class="language-plaintext">30 =&gt; Developer access
40 =&gt; Maintainer access
60 =&gt; Admin access
</code></pre>
<h2>List group-level protected environments</h2>
<p>Gets a list of protected environments from a group.</p>
<pre><code class="language-plaintext">GET /groups/:id/protected_environments
</code></pre>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>integer or string</td>
<td>yes</td>
<td>The ID or <a href="rest/_index.md#namespaced-paths">URL-encoded path</a> of the group maintained by the authenticated user.</td>
</tr>
</tbody>
</table>
<pre><code class="language-shell">curl --request GET \
  --header &quot;PRIVATE-TOKEN: &lt;your_access_token&gt;&quot; \
  --url &quot;https://gitlab.example.com/api/v4/groups/5/protected_environments/&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">[
   {
      &quot;name&quot;:&quot;production&quot;,
      &quot;deploy_access_levels&quot;:[
         {
            &quot;id&quot;: 12,
            &quot;access_level&quot;: 40,
            &quot;access_level_description&quot;: &quot;Maintainers&quot;,
            &quot;user_id&quot;: null,
            &quot;group_id&quot;: null
         }
      ],
      &quot;required_approval_count&quot;: 0
   }
]
</code></pre>
<h2>Get a single protected environment</h2>
<p>Gets a single protected environment.</p>
<pre><code class="language-plaintext">GET /groups/:id/protected_environments/:name
</code></pre>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>integer or string</td>
<td>yes</td>
<td>The ID or <a href="rest/_index.md#namespaced-paths">URL-encoded path</a> of the group maintained by the authenticated user.</td>
</tr>
<tr>
<td><code>name</code></td>
<td>string</td>
<td>yes</td>
<td>The <a href="../ci/environments/_index.md#deployment-tier-of-environments">deployment tier</a> of the protected environment. Possible values: <code>production</code>, <code>staging</code>, <code>testing</code>, <code>development</code>, or <code>other</code>.</td>
</tr>
</tbody>
</table>
<pre><code class="language-shell">curl --request GET \
  --header &quot;PRIVATE-TOKEN: &lt;your_access_token&gt;&quot; \
  --url &quot;https://gitlab.example.com/api/v4/groups/5/protected_environments/production&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
   &quot;name&quot;:&quot;production&quot;,
   &quot;deploy_access_levels&quot;:[
      {
         &quot;id&quot;: 12,
         &quot;access_level&quot;:40,
         &quot;access_level_description&quot;:&quot;Maintainers&quot;,
         &quot;user_id&quot;:null,
         &quot;group_id&quot;:null
      }
   ],
   &quot;required_approval_count&quot;: 0
}
</code></pre>
<h2>Protect a single environment</h2>
<p>Protects a single environment.</p>
<pre><code class="language-plaintext">POST /groups/:id/protected_environments
</code></pre>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>integer or string</td>
<td>yes</td>
<td>The ID or <a href="rest/_index.md#namespaced-paths">URL-encoded path</a> of the group maintained by the authenticated user.</td>
</tr>
<tr>
<td><code>name</code></td>
<td>string</td>
<td>yes</td>
<td>The <a href="../ci/environments/_index.md#deployment-tier-of-environments">deployment tier</a> of the protected environment. Possible values: <code>production</code>, <code>staging</code>, <code>testing</code>, <code>development</code>, or <code>other</code>.</td>
</tr>
<tr>
<td><code>deploy_access_levels</code></td>
<td>array</td>
<td>yes</td>
<td>Array of access levels allowed to deploy, with each described by a hash. Possible values: <code>user_id</code>, <code>group_id</code> or <code>access_level</code>. They take the form of <code>{user_id: integer}</code>, <code>{group_id: integer}</code> or <code>{access_level: integer}</code>.</td>
</tr>
<tr>
<td><code>approval_rules</code></td>
<td>array</td>
<td>no</td>
<td>Array of access levels allowed to approve, with each described by a hash. Possible values: <code>user_id</code>, <code>group_id</code> or <code>access_level</code>. They take the form of <code>{user_id: integer}</code>, <code>{group_id: integer}</code> or <code>{access_level: integer}</code>. You can also specify the number of required approvals from the specified entity with <code>required_approvals</code> field. See <a href="../ci/environments/deployment_approvals.md#add-multiple-approval-rules">Multiple approval rules</a> for more information.</td>
</tr>
</tbody>
</table>
<p>The assignable <code>user_id</code> are the users who belong to the given group with the Maintainer role (or above).
The assignable <code>group_id</code> are the subgroups under the given group.</p>
<pre><code class="language-shell">curl --request POST \
  --header &quot;PRIVATE-TOKEN: &lt;your_access_token&gt;&quot; \
  --header &quot;Content-Type: application/json&quot; \
  --url &quot;https://gitlab.example.com/api/v4/groups/22034114/protected_environments&quot; \
  --data '{&quot;name&quot;: &quot;production&quot;, &quot;deploy_access_levels&quot;: [{&quot;group_id&quot;: 9899826}]}'
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
   &quot;name&quot;:&quot;production&quot;,
   &quot;deploy_access_levels&quot;:[
      {
         &quot;id&quot;: 12,
         &quot;access_level&quot;: 40,
         &quot;access_level_description&quot;: &quot;protected-access-group&quot;,
         &quot;user_id&quot;: null,
         &quot;group_id&quot;: 9899826
      }
   ],
   &quot;required_approval_count&quot;: 0
}
</code></pre>
<p>An example with multiple approval rules:</p>
<pre><code class="language-shell">curl --request POST \
  --header &quot;PRIVATE-TOKEN: &lt;your_access_token&gt;&quot; \
  --header &quot;Content-Type: application/json&quot; \
  --url &quot;https://gitlab.example.com/api/v4/groups/128/protected_environments&quot; \
  --data '{
    &quot;name&quot;: &quot;production&quot;,
    &quot;deploy_access_levels&quot;: [{&quot;group_id&quot;: 138}],
    &quot;approval_rules&quot;: [
      {&quot;group_id&quot;: 134},
      {&quot;group_id&quot;: 135, &quot;required_approvals&quot;: 2}
    ]
  }'
</code></pre>
<p>In this configuration, the operator group <code>"group_id": 138</code> can execute the deployment job
to <code>production</code> only after the QA group <code>"group_id": 134</code> and security group
<code>"group_id": 135</code> have approved the deployment.</p>
<h2>Update a protected environment</h2>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/351854">Introduced</a> in GitLab 15.4.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>Updates a single environment.</p>
<pre><code class="language-plaintext">PUT /groups/:id/protected_environments/:name
</code></pre>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>integer or string</td>
<td>yes</td>
<td>The ID or <a href="rest/_index.md#namespaced-paths">URL-encoded path</a> of the group maintained by the authenticated user.</td>
</tr>
<tr>
<td><code>name</code></td>
<td>string</td>
<td>yes</td>
<td>The <a href="../ci/environments/_index.md#deployment-tier-of-environments">deployment tier</a> of the protected environment. Possible values: <code>production</code>, <code>staging</code>, <code>testing</code>, <code>development</code>, or <code>other</code>.</td>
</tr>
<tr>
<td><code>deploy_access_levels</code></td>
<td>array</td>
<td>no</td>
<td>Array of access levels allowed to deploy, with each described by a hash. Possible values: <code>user_id</code>, <code>group_id</code> or <code>access_level</code>. They take the form of <code>{user_id: integer}</code>, <code>{group_id: integer}</code> or <code>{access_level: integer}</code>.</td>
</tr>
<tr>
<td><code>required_approval_count</code></td>
<td>integer</td>
<td>no</td>
<td>The number of approvals required to deploy to this environment.</td>
</tr>
<tr>
<td><code>approval_rules</code></td>
<td>array</td>
<td>no</td>
<td>Array of access levels allowed to approve, with each described by a hash. Possible values: <code>user_id</code>, <code>group_id</code>, or <code>access_level</code>. They take the form of <code>{user_id: integer}</code>, <code>{group_id: integer}</code>, or <code>{access_level: integer}</code>. You can also specify the number of required approvals from the specified entity with <code>required_approvals</code> field. See <a href="../ci/environments/deployment_approvals.md#add-multiple-approval-rules">Multiple approval rules</a> for more information.</td>
</tr>
</tbody>
</table>
<p>To update:</p>
<ul>
<li><strong><code>user_id</code></strong>: Ensure the updated user belongs to the given group with the Maintainer role (or above). You must also pass the <code>id</code> of either a <code>deploy_access_level</code> or <code>approval_rule</code> in the respective hash.</li>
<li><strong><code>group_id</code></strong>: Ensure the updated group is a subgroup of the group this protected environment belongs to. You must also pass the <code>id</code> of either a <code>deploy_access_level</code> or <code>approval_rule</code> in the respective hash.</li>
</ul>
<p>To delete:</p>
<ul>
<li>You must pass <code>_destroy</code> set to <code>true</code>. See the following examples.</li>
</ul>
<h3>Example: Create a <code>deploy_access_level</code> record</h3>
<pre><code class="language-shell">curl --request PUT \
  --header &quot;PRIVATE-TOKEN: &lt;your_access_token&gt;&quot; \
  --header &quot;Content-Type: application/json&quot; \
  --url &quot;https://gitlab.example.com/api/v4/groups/22034114/protected_environments/production&quot; \
  --data '{&quot;deploy_access_levels&quot;: [{&quot;group_id&quot;: 9899829, &quot;access_level&quot;: 40}]}'
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
   &quot;name&quot;: &quot;production&quot;,
   &quot;deploy_access_levels&quot;: [
      {
         &quot;id&quot;: 12,
         &quot;access_level&quot;: 40,
         &quot;access_level_description&quot;: &quot;protected-access-group&quot;,
         &quot;user_id&quot;: null,
         &quot;group_id&quot;: 9899829,
         &quot;group_inheritance_type&quot;: 1
      }
   ],
   &quot;required_approval_count&quot;: 0
}
</code></pre>
<h3>Example: Update a <code>deploy_access_level</code> record</h3>
<pre><code class="language-shell">curl --request PUT \
  --header &quot;PRIVATE-TOKEN: &lt;your_access_token&gt;&quot; \
  --header &quot;Content-Type: application/json&quot; \
  --url &quot;https://gitlab.example.com/api/v4/groups/22034114/protected_environments/production&quot; \
  --data '{&quot;deploy_access_levels&quot;: [{&quot;id&quot;: 12, &quot;group_id&quot;: 22034120}]}'
</code></pre>
<pre><code class="language-json">{
   &quot;name&quot;: &quot;production&quot;,
   &quot;deploy_access_levels&quot;: [
      {
         &quot;id&quot;: 12,
         &quot;access_level&quot;: 40,
         &quot;access_level_description&quot;: &quot;protected-access-group&quot;,
         &quot;user_id&quot;: null,
         &quot;group_id&quot;: 22034120,
         &quot;group_inheritance_type&quot;: 0
      }
   ],
   &quot;required_approval_count&quot;: 2
}
</code></pre>
<h3>Example: Delete a <code>deploy_access_level</code> record</h3>
<pre><code class="language-shell">curl --request PUT \
  --header &quot;PRIVATE-TOKEN: &lt;your_access_token&gt;&quot; \
  --header &quot;Content-Type: application/json&quot; \
  --url &quot;https://gitlab.example.com/api/v4/groups/22034114/protected_environments/production&quot; \
  --data '{&quot;deploy_access_levels&quot;: [{&quot;id&quot;: 12, &quot;_destroy&quot;: true}]}'
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
   &quot;name&quot;: &quot;production&quot;,
   &quot;deploy_access_levels&quot;: [],
   &quot;required_approval_count&quot;: 0
}
</code></pre>
<h3>Example: Create an <code>approval_rule</code> record</h3>
<pre><code class="language-shell">curl --request PUT \
  --header &quot;PRIVATE-TOKEN: &lt;your_access_token&gt;&quot; \
  --header &quot;Content-Type: application/json&quot; \
  --url &quot;https://gitlab.example.com/api/v4/groups/22034114/protected_environments/production&quot; \
  --data '{&quot;approval_rules&quot;: [{&quot;group_id&quot;: 134, &quot;required_approvals&quot;: 1}]}'
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
   &quot;name&quot;: &quot;production&quot;,
   &quot;approval_rules&quot;: [
      {
         &quot;id&quot;: 38,
         &quot;user_id&quot;: null,
         &quot;group_id&quot;: 134,
         &quot;access_level&quot;: null,
         &quot;access_level_description&quot;: &quot;qa-group&quot;,
         &quot;required_approvals&quot;: 1,
         &quot;group_inheritance_type&quot;: 0
      }
   ]
}
</code></pre>
<h3>Example: Update an <code>approval_rule</code> record</h3>
<pre><code class="language-shell">curl --request PUT \
  --header &quot;PRIVATE-TOKEN: &lt;your_access_token&gt;&quot; \
  --header &quot;Content-Type: application/json&quot; \
  --url &quot;https://gitlab.example.com/api/v4/groups/22034114/protected_environments/production&quot; \
  --data '{&quot;approval_rules&quot;: [{&quot;id&quot;: 38, &quot;group_id&quot;: 135, &quot;required_approvals&quot;: 2}]}'
</code></pre>
<pre><code class="language-json">{
   &quot;name&quot;: &quot;production&quot;,
   &quot;approval_rules&quot;: [
      {
         &quot;id&quot;: 38,
         &quot;user_id&quot;: null,
         &quot;group_id&quot;: 135,
         &quot;access_level&quot;: null,
         &quot;access_level_description&quot;: &quot;security-group&quot;,
         &quot;required_approvals&quot;: 2,
         &quot;group_inheritance_type&quot;: 0
      }
   ]
}
</code></pre>
<h3>Example: Delete an <code>approval_rule</code> record</h3>
<pre><code class="language-shell">curl --request PUT \
  --header &quot;PRIVATE-TOKEN: &lt;your_access_token&gt;&quot; \
  --header &quot;Content-Type: application/json&quot; \
  --url &quot;https://gitlab.example.com/api/v4/groups/22034114/protected_environments/production&quot; \
  --data '{&quot;approval_rules&quot;: [{&quot;id&quot;: 38, &quot;_destroy&quot;: true}]}'
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
   &quot;name&quot;: &quot;production&quot;,
   &quot;approval_rules&quot;: []
}
</code></pre>
<h2>Unprotect a single environment</h2>
<p>Unprotects the given protected environment.</p>
<pre><code class="language-plaintext">DELETE /groups/:id/protected_environments/:name
</code></pre>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>integer or string</td>
<td>yes</td>
<td>The ID or <a href="rest/_index.md#namespaced-paths">URL-encoded path</a> of the group maintained by the authenticated user.</td>
</tr>
<tr>
<td><code>name</code></td>
<td>string</td>
<td>yes</td>
<td>The <a href="../ci/environments/_index.md#deployment-tier-of-environments">deployment tier</a> of the protected environment. Possible values: <code>production</code>, <code>staging</code>, <code>testing</code>, <code>development</code>, or <code>other</code>.</td>
</tr>
</tbody>
</table>
<pre><code class="language-shell">curl --request DELETE \
  --header &quot;PRIVATE-TOKEN: &lt;your_access_token&gt;&quot; \
  --url &quot;https://gitlab.example.com/api/v4/groups/5/protected_environments/staging&quot;
</code></pre>
<p>The response should return a 200 code.</p></code></pre>
</body>
</html>
