<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># SAML debugging tools</title>
    <link rel="stylesheet" href="/../../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Software Supply Chain Security
group: Authentication
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Troubleshooting SAML</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Free, Premium, Ultimate</li>
<li>Offering: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>This page contains possible solutions for problems you might encounter when using:</p>
<ul>
<li><a href="_index.html">SAML SSO for GitLab.com groups</a>.</li>
<li>The GitLab Self-Managed instance-level <a href="../../../integration/saml.html">SAML OmniAuth Provider</a>.</li>
<li><a href="../../../administration/dedicated/configure_instance/authentication/saml.md#add-a-saml-provider-with-switchboard">Switchboard</a> to configure SAML for GitLab Dedicated instances.</li>
</ul>
<h2>SAML debugging tools</h2>
<p>SAML responses are base64 encoded. To decode them on the fly you can use the <strong>SAML-tracer</strong> browser extension (<a href="https://addons.mozilla.org/en-US/firefox/addon/saml-tracer/">Firefox</a>, <a href="https://chromewebstore.google.com/detail/saml-tracer/mpdajninpobndbfcldcmbpnnbhibjmch?hl=en">Chrome</a>).</p>
<p>If you cannot install a browser plugin, you can <a href="#manually-generate-a-saml-response">manually generate and capture a SAML response</a> instead.</p>
<p>Pay specific attention to:</p>
<ul>
<li>The <code>NameID</code>, which identifies the user signing in. If the user has previously
  signed in, this must match the value that <a href="#verify-nameid">GitLab stored</a>.</li>
<li>The presence of a <code>X509Certificate</code>, which is required to verify the response signature.</li>
<li>The <code>SubjectConfirmation</code> and <code>Conditions</code>, which can cause errors if misconfigured.</li>
</ul>
<h3>Generate a SAML response</h3>
<p>Use SAML responses to preview the attribute names and values sent in the assertions list while attempting to sign in
using an identity provider.</p>
<p>To generate a SAML Response:</p>
<ol>
<li>Install one of the <a href="#saml-debugging-tools">browser debugging tools</a>.</li>
<li>Open a new browser tab.</li>
<li>Open the SAML tracer console:</li>
<li>Chrome: On a context menu on the page, select <strong>Inspect</strong>, then select the <strong>SAML</strong> tab in the developer console.</li>
<li>Firefox: Select the SAML-tracer icon located on the browser toolbar.</li>
<li>For GitLab.com Groups:</li>
<li>Go to the GitLab single sign-on URL for the group.</li>
<li>Select <strong>Authorize</strong> or attempt to sign</li>
<li>For GitLab Self-Managed instance:</li>
<li>Go to the instance home page</li>
<li>Select the <code>SAML Login</code> button to sign in</li>
<li>A SAML response is displayed in the tracer console that resembles this
   <a href="_index.md#example-saml-response">example SAML response</a>.</li>
<li>Within the SAML tracer, select the <strong>Export</strong> icon to save the response in JSON format.</li>
</ol>
<h4>Manually generate a SAML response</h4>
<p><i class="fa-youtube-play" aria-hidden="true"></i>
For an overview, see this <a href="https://youtu.be/umMPj6ohF_I">video on manually generating a SAML response without using a browser plugin (using Google Chrome)</a>, uploaded by GitLab Support.</p>
<!-- Video published on 2024-09-09 -->

<p>Regardless of what browser you use, the process is similar to the following:</p>
<ol>
<li>Right-click on a new browser and select <strong>Inspect</strong> to open the <strong>DevTools</strong> window.</li>
<li>Select the <strong>Network</strong> tab. Make sure that <strong>Preserve log</strong> is selected.</li>
<li>Switch to the browser page and sign in to GitLab using SAML SSO.</li>
<li>Switch back to the <strong>DevTools</strong> window and filter for the <code>callback</code> event.</li>
<li>Select the <strong>Payload</strong> tab for the callback event and right-click to copy the value.</li>
<li>Paste this value into the following command: <code>echo "&lt;value&gt;" | base64 --decode &gt; saml_response.xml</code>.</li>
<li>Open <code>saml_response.xml</code> in a code editor.</li>
</ol>
<p>If you have an XML "prettifier" installed in your code editor, you should be able to automatically
   format the response to be easier to read.</p>
<h2>Search Rails logs for a SAML sign-in</h2>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Free, Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>You can find detailed information about a SAML sign-in in the <a href="../../../administration/logs/_index.md#audit_jsonlog"><code>audit_json.log</code> file</a>.</p>
<p>For example, by searching for <code>system_access</code>, you can find entries that show when a user signed into GitLab using SAML:</p>
<pre><code class="language-json">{
  &quot;severity&quot;: &quot;INFO&quot;,
  &quot;time&quot;: &quot;2024-08-13T06:05:35.721Z&quot;,
  &quot;correlation_id&quot;: &quot;01J555EZK136DQ8S7P32G9GEND&quot;,
  &quot;meta.caller_id&quot;: &quot;OmniauthCallbacksController#saml&quot;,
  &quot;meta.remote_ip&quot;: &quot;45.87.213.198&quot;,
  &quot;meta.feature_category&quot;: &quot;system_access&quot;,
  &quot;meta.user&quot;: &quot;bbtest&quot;,
  &quot;meta.user_id&quot;: 16,
  &quot;meta.client_id&quot;: &quot;user/16&quot;,
  &quot;author_id&quot;: 16,
  &quot;author_name&quot;: &quot;bbtest@agounder.onmicrosoft.com&quot;,
  &quot;entity_id&quot;: 16,
  &quot;entity_type&quot;: &quot;User&quot;,
  &quot;created_at&quot;: &quot;2024-08-13T06:05:35.708+00:00&quot;,
  &quot;ip_address&quot;: &quot;45.87.213.198&quot;,
  &quot;with&quot;: &quot;saml&quot;,
  &quot;target_id&quot;: 16,
  &quot;target_type&quot;: &quot;User&quot;,
  &quot;target_details&quot;: &quot;bbtest@agounder.onmicrosoft.com&quot;,
  &quot;entity_path&quot;: &quot;bbtest&quot;
}
</code></pre>
<p>If you have configured SAML Group Links, the log also shows entries detailing membership being removed:</p>
<pre><code class="language-json">{
  &quot;severity&quot;: &quot;INFO&quot;,
  &quot;time&quot;: &quot;2024-08-13T05:24:07.769Z&quot;,
  &quot;correlation_id&quot;: &quot;01J55330SRTKTD5CHMS96DNZEN&quot;,
  &quot;meta.caller_id&quot;: &quot;Auth::SamlGroupSyncWorker&quot;,
  &quot;meta.remote_ip&quot;: &quot;45.87.213.206&quot;,
  &quot;meta.feature_category&quot;: &quot;system_access&quot;,
  &quot;meta.client_id&quot;: &quot;ip/45.87.213.206&quot;,
  &quot;meta.root_caller_id&quot;: &quot;OmniauthCallbacksController#saml&quot;,
  &quot;id&quot;: 179,
  &quot;author_id&quot;: 6,
  &quot;entity_id&quot;: 2,
  &quot;entity_type&quot;: &quot;Group&quot;,
  &quot;details&quot;: {
    &quot;remove&quot;: &quot;user_access&quot;,
    &quot;member_id&quot;: 7,
    &quot;author_name&quot;: &quot;BB Test&quot;,
    &quot;author_class&quot;: &quot;User&quot;,
    &quot;target_id&quot;: 6,
    &quot;target_type&quot;: &quot;User&quot;,
    &quot;target_details&quot;: &quot;BB Test&quot;,
    &quot;custom_message&quot;: &quot;Membership destroyed&quot;,
    &quot;ip_address&quot;: &quot;45.87.213.198&quot;,
    &quot;entity_path&quot;: &quot;group1&quot;
  }
}
</code></pre>
<p>You can also see details of the user that GitLab received from the SAML provider in <code>auth_json.log</code>, for example:</p>
<pre><code class="language-json">{
  &quot;severity&quot;: &quot;INFO&quot;,
  &quot;time&quot;: &quot;2024-08-20T07:01:20.979Z&quot;,
  &quot;correlation_id&quot;: &quot;01J5Q9E59X4P40ZT3MCE35C2A9&quot;,
  &quot;meta.caller_id&quot;: &quot;OmniauthCallbacksController#saml&quot;,
  &quot;meta.remote_ip&quot;: &quot;xxx.xxx.xxx.xxx&quot;,
  &quot;meta.feature_category&quot;: &quot;system_access&quot;,
  &quot;meta.client_id&quot;: &quot;ip/xxx.xxx.xxx.xxx&quot;,
  &quot;payload_type&quot;: &quot;saml_response&quot;,
  &quot;saml_response&quot;: {
    &quot;issuer&quot;: [
      &quot;https://sts.windows.net/03b8c6c5-104b-43e2-aed3-abb07df387cc/&quot;
    ],
    &quot;name_id&quot;: &quot;ab260d59-0317-47f5-9afb-885c7a1257ab&quot;,
    &quot;name_id_format&quot;: &quot;urn:oasis:names:tc:SAML:2.0:nameid-format:persistent&quot;,
    &quot;name_id_spnamequalifier&quot;: null,
    &quot;name_id_namequalifier&quot;: null,
    &quot;destination&quot;: &quot;https://dh-gitlab.agounder.com/users/auth/saml/callback&quot;,
    &quot;audiences&quot;: [
      &quot;https://dh-gitlab.agounder.com/16.11.6&quot;
    ],
    &quot;attributes&quot;: {
      &quot;http://schemas.microsoft.com/identity/claims/tenantid&quot;: [
        &quot;03b8c6c5-104b-43e2-aed3-abb07df387cc&quot;
      ],
      &quot;http://schemas.microsoft.com/identity/claims/objectidentifier&quot;: [
        &quot;ab260d59-0317-47f5-9afb-885c7a1257ab&quot;
      ],
      &quot;http://schemas.microsoft.com/identity/claims/identityprovider&quot;: [
        &quot;https://sts.windows.net/03b8c6c5-104b-43e2-aed3-abb07df387cc/&quot;
      ],
      &quot;http://schemas.microsoft.com/claims/authnmethodsreferences&quot;: [
        &quot;http://schemas.microsoft.com/ws/2008/06/identity/authenticationmethod/password&quot;
      ],
      &quot;email&quot;: [
        &quot;bbtest@agounder.com&quot;
      ],
      &quot;firstname&quot;: [
        &quot;BB&quot;
      ],
      &quot;name&quot;: [
        &quot;bbtest@agounder.onmicrosoft.com&quot;
      ],
      &quot;lastname&quot;: [
        &quot;Test&quot;
      ]
    },
    &quot;in_response_to&quot;: &quot;_f8863f68-b5f1-43f0-9534-e73933e6ed39&quot;,
    &quot;allowed_clock_drift&quot;: 2.220446049250313e-16,
    &quot;success&quot;: true,
    &quot;status_code&quot;: &quot;urn:oasis:names:tc:SAML:2.0:status:Success&quot;,
    &quot;status_message&quot;: null,
    &quot;session_index&quot;: &quot;_b4f253e2-aa61-46a4-902b-43592fe30800&quot;,
    &quot;assertion_encrypted&quot;: false,
    &quot;response_id&quot;: &quot;_392cc747-7c8b-41de-8be0-23f5590d5ded&quot;,
    &quot;assertion_id&quot;: &quot;_b4f253e2-aa61-46a4-902b-43592fe30800&quot;
  }
}
</code></pre>
<h2>Testing GitLab SAML</h2>
<p>You can use one of the following to troubleshoot SAML:</p>
<ul>
<li>A <a href="https://gitlab.com/gitlab-com/support/toolbox/replication/tree/master/compose_files">complete GitLab with SAML testing environment using Docker compose</a>.</li>
<li>A <a href="../../../administration/troubleshooting/test_environments.md#saml">quick start guide to start a Docker container</a>
  with a plug and play SAML 2.0 identity provider if you only require a SAML provider.</li>
<li>A local environment by
  <a href="../../../integration/saml.md#configure-group-saml-sso-on-gitlab-self-managed">enabling SAML for groups on a GitLab Self-Managed instance</a>.</li>
</ul>
<h2>Verify configuration</h2>
<p>For convenience, some <a href="example_saml_config.html">example resources</a> used by the GitLab
Support Team are included. While they may help you verify the SAML app configuration,
they are not guaranteed to reflect the current state of third-party products.</p>
<h3>Calculate the fingerprint</h3>
<p>When configuring the <code>idp_cert_fingerprint</code>, you should use a SHA256 fingerprint whenever possible. SHA1 is also supported, but is not recommended. To calculate the fingerprint, run the following command on the certificate file:</p>
<pre><code class="language-shell">openssl x509 -in &lt;certificate.crt&gt; -noout -fingerprint -sha256
</code></pre>
<p>Replace <code>&lt;certificate.crt&gt;</code> with the name of the certificate file.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>In GitLab 17.11 and later, the fingerprint algorithm is
<a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/184530">automatically detected</a>
based on fingerprint length.</p>
<p>In GitLab 17.10 and earlier, SHA1 is the default fingerprint algorithm.
To use a SHA256 fingerprint, you must specify the algorithm:</p>
<pre><code class="language-ruby">idp_cert_fingerprint_algorithm: &quot;http://www.w3.org/2001/04/xmlenc#sha256&quot;
</code></pre>
<p>{{&lt; /alert &gt;}}</p>
<h2>SSO Certificate updates</h2>
<p>When the certificate used for your identity provider changes (for example when updating or renewing the certificate), you must update the certificate fingerprint as well. You can find the certificate fingerprint in your identity provider's UI. If you cannot get the certificate in the identity provider UI, follow the steps in the <a href="#calculate-the-fingerprint">calculate the fingerprint</a> documentation.</p>
<h2>Configuration errors</h2>
<h3>Invalid audience</h3>
<p>This error means that the identity provider doesn't recognize GitLab as a valid sender and
receiver of SAML requests. Make sure to:</p>
<ul>
<li>Add the GitLab callback URL to the approved audiences of the identity provider server.</li>
<li>Avoid trailing whitespace in the <code>issuer</code> string.</li>
</ul>
<h3>Key validation error, Digest mismatch or Fingerprint mismatch</h3>
<p>These errors all come from a similar place, the SAML certificate. SAML requests
must be validated using either a fingerprint, a certificate, or a validator.</p>
<p>For this requirement, be sure to take the following into account:</p>
<ul>
<li>If you use a fingerprint, confirm your SHA256 fingerprint:</li>
<li>Re-download the certificate file.</li>
<li><a href="#calculate-the-fingerprint">Calculate the fingerprint</a>.</li>
<li>Compare the fingerprint to the value provided in <code>idp_cert_fingerprint</code>. The values should be the same.</li>
<li>If no certificate is provided in the settings, a fingerprint or fingerprint
  validator needs to be provided and the response from the server must contain
  a certificate (<code>&lt;ds:KeyInfo&gt;&lt;ds:X509Data&gt;&lt;ds:X509Certificate&gt;</code>).</li>
<li>If a certificate is provided in the settings, it is no longer necessary for
  the request to contain one. In this case the fingerprint or fingerprint
  validators are optional.</li>
</ul>
<p>If none of the previously described scenarios is valid, the request
fails with one of the mentioned errors.</p>
<h3>Missing claims, or <code>Email can't be blank</code> errors</h3>
<p>The identity provider server needs to pass certain information in order for GitLab to either
create an account, or match the login information to an existing account. <code>email</code>
is the minimum amount of information that needs to be passed. If the identity provider server
is not providing this information, all SAML requests fail.</p>
<p>Make sure this information is provided.</p>
<p>Another issue that can result in this error is when the correct information is being sent by
the identity provider, but the attributes don't match the names in the OmniAuth <code>info</code> hash. In this case,
you must set <code>attribute_statements</code> in the SAML configuration to
<a href="../../../integration/saml.md#map-saml-response-attribute-names">map the attribute names in your SAML Response to the corresponding OmniAuth <code>info</code> hash names</a>.</p>
<h2>User sign in banner error messages</h2>
<h3>Message: <code>SAML authentication failed: SAML NameID is missing from your SAML response.</code></h3>
<p>You might get an error that states <code>SAML authentication failed: SAML NameID is missing from your SAML response. Please contact your administrator.</code></p>
<p>This issue occurs when you try sign into GitLab using Group SSO, but your SAML response did not include a <code>NameID</code>.</p>
<p>To resolve this issue:</p>
<ul>
<li>Contact your administrator to ensure your IdP account has an assigned <code>NameID</code>.</li>
<li>Use a <a href="#saml-debugging-tools">SAML debugging tool</a> to verify that your SAML response has a valid <code>NameID</code>.</li>
</ul>
<h3>Message: <code>SAML authentication failed: Extern uid has already been taken.</code></h3>
<p>You might get an error that states <code>SAML authentication failed: Extern uid has already been taken. Please contact your administrator to generate a unique external_uid (NameID).</code></p>
<p>This issue occurs when you try to link your existing GitLab account to a SAML identity using Group SSO, but there is an existing GitLab account with your current <code>NameID</code>.</p>
<p>To resolve this issue, tell your administrator to re-generate a unique <code>Extern UID</code> (<code>NameID</code>) for your IdP account. Make sure this new <code>Extern UID</code> adheres to the <a href="_index.md#manage-user-saml-identity">GitLab <code>NameID</code> constraints</a>.</p>
<p>If you do not wish to use that GitLab user with the SAML login, you can <a href="_index.md#unlink-accounts">unlink the GitLab account from the SAML app</a>.</p>
<h3>Message: <code>SAML authentication failed: User has already been taken</code></h3>
<p>The user that you're signed in with already has SAML linked to a different identity, or the <code>NameID</code> value has changed.
Here are possible causes and solutions:</p>
<table>
<thead>
<tr>
<th>Cause</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td>You've tried to link multiple SAML identities to the same user, for a given identity provider.</td>
<td>Change the identity that you sign in with. To do so, <a href="_index.md#unlink-accounts">unlink the previous SAML identity</a> from this GitLab account before attempting to sign in again.</td>
</tr>
<tr>
<td>The <code>NameID</code> changes every time the user requests SSO identification</td>
<td><a href="#verify-nameid">Check the <code>NameID</code></a> is not set with <code>Transient</code> format, or the <code>NameID</code> is not changing on subsequent requests.</td>
</tr>
</tbody>
</table>
<h3>Message: <code>SAML authentication failed: Email has already been taken</code></h3>
<table>
<thead>
<tr>
<th>Cause</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td>If a GitLab user account exists with the same email address, but the account is not associated with a SAML identity.</td>
<td>On GitLab.com, the user needs to <a href="_index.md#user-access-and-management">link their account</a>. On GitLab Self-Managed, administrators can configure the instance to <a href="../../../integration/saml.md#link-saml-identity-for-an-existing-user">automatically link the SAML identity with the GitLab user account</a> when they first sign in.</td>
</tr>
</tbody>
</table>
<p>User accounts are created in one of the following ways:</p>
<ul>
<li>User registration</li>
<li>Sign in through OAuth</li>
<li>Sign in through SAML</li>
<li>SCIM provisioning</li>
</ul>
<h3>Error: user has already been taken</h3>
<p>Getting both of these errors at the same time suggests the <code>NameID</code> capitalization provided by the identity provider didn't exactly match the previous value for that user:</p>
<ul>
<li><code>SAML authentication failed: Extern UID has already been taken</code></li>
<li><code>User has already been taken</code></li>
</ul>
<p>This can be prevented by configuring the <code>NameID</code> to return a consistent value. Fixing this for an individual user involves changing the identifier for the user. For GitLab.com, the user needs to <a href="_index.md#unlink-accounts">unlink their SAML from the GitLab account</a>.</p>
<h3>Message: <code>Request to link SAML account must be authorized</code></h3>
<p>Ensure that the user who is trying to link their GitLab account has been added as a user within the identity provider's SAML app.</p>
<p>Alternatively, the SAML response may be missing the <code>InResponseTo</code> attribute in the
<code>samlp:Response</code> tag, which is <a href="https://github.com/onelogin/ruby-saml/blob/9f710c5028b069bfab4b9e2b66891e0549765af5/lib/onelogin/ruby-saml/response.rb#L307-L316">expected by the SAML gem</a>.
The identity provider administrator should ensure that the login is
initiated by the service provider and not only the identity provider.</p>
<h3>Message: <code>There is already a GitLab account associated with this email address.</code></h3>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>A user can see this message when they are trying to <a href="_index.md#link-saml-to-your-existing-gitlabcom-account">manually link SAML to their existing GitLab.com account</a>:</p>
<pre><code class="language-plaintext">There is already a GitLab account associated with this email address.
Sign in with your existing credentials to connect your organization's account
</code></pre>
<p>To resolve this problem, the user should check they are using the correct GitLab password to sign in. The user first needs
to <a href="https://gitlab.com/users/password/new">reset their password</a> if both:</p>
<ul>
<li>The account was provisioned by SCIM.</li>
<li>They are signing in with username and password for the first time.</li>
</ul>
<h3>Message: <code>SAML Name ID and email address do not match your user account</code></h3>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>Users might get an error that states "SAML Name ID and email address do not match your user account. Contact an administrator."
This means:</p>
<ul>
<li>The NameID value sent by SAML does not match the existing SAML identity <code>extern_uid</code> value. Both the NameID and the <code>extern_uid</code> are case-sensitive. For more information, see  <a href="_index.md#manage-user-saml-identity">manage user SAML identity</a>.</li>
<li>Either the SAML response did not include an email address or the email address did not match the user's GitLab email address.</li>
</ul>
<p>The workaround is that a GitLab group Owner uses the <a href="../../../api/saml.html">SAML API</a> to update the user's SAML <code>extern_uid</code>.
The <code>extern_uid</code> value must match the Name ID value sent by the SAML identity provider (IdP). Depending on the IdP configuration
this may be a generated unique ID, an email address, or other value.</p>
<h3>Error: <code>Certificate element missing in response (ds:x509certificate)</code></h3>
<p>This error suggests that the IdP is not configured to include the X.509 certificate in the SAML response:</p>
<pre><code class="language-plaintext">Certificate element missing in response (ds:x509certificate) and not cert provided at settings
</code></pre>
<p>The X.509 certificate must be included in the response.
To resolve this problem, configure your IdP to include the X.509 certificate in the SAML response.</p>
<p>For more information, see the documentation on <a href="../../../integration/saml.md#additional-configuration-for-saml-apps-on-your-idp">additional configuration for SAML apps on your IdP</a>.</p>
<h2>Other user sign in issues</h2>
<h3>Verify <code>NameID</code></h3>
<p>In troubleshooting, any authenticated user can use the API to verify the <code>NameID</code> GitLab already has linked to their user by visiting <a href="https://gitlab.com/api/v4/user"><code>https://gitlab.com/api/v4/user</code></a> and checking the <code>extern_uid</code> under identities.</p>
<p>For GitLab Self-Managed, administrators can use the <a href="../../../api/users.html">users API</a> to see the same information.</p>
<p>When using SAML for groups, group members of a role with the appropriate permissions can make use of the <a href="../../../api/members.html">members API</a> to view group SAML identity information for members of the group.</p>
<p>This can then be compared to the <code>NameID</code> sent by the identity provider by decoding the
message with a <a href="#saml-debugging-tools">SAML debugging tool</a>. These values must match to
identify users.</p>
<h3>Stuck in a login "loop"</h3>
<p>Ensure that the <strong>GitLab single sign-on URL</strong> (for GitLab.com) or the instance URL (for GitLab Self-Managed) has been configured as "Login URL" (or similarly named field) in the identity provider's SAML app.</p>
<p>For GitLab.com, alternatively, when users need to <a href="_index.md#link-saml-to-your-existing-gitlabcom-account">link SAML to their existing GitLab.com account</a>, provide the <strong>GitLab single sign-on URL</strong> and instruct users not to use the SAML app on first sign in.</p>
<h3>Users receive a 404</h3>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>If the user receives a <code>404</code> after signing in successfully, check if you have IP restrictions configured. IP restriction settings are configured:</p>
<ul>
<li>On GitLab.com, <a href="../access_and_permissions.md#restrict-group-access-by-ip-address">at the group level</a>.</li>
<li>For GitLab Self-Managed, <a href="../../../administration/reporting/ip_addr_restrictions.html">at the instance level</a>.</li>
</ul>
<p>Because SAML SSO for groups is a paid feature, your subscription expiring can result in a <code>404</code> error when you're signing in using SAML SSO on GitLab.com.
If all users are receiving a <code>404</code> when attempting to sign in using SAML, confirm
<a href="../../../subscriptions/manage_subscription.md#view-subscription">there is an active subscription</a> being used in this SAML SSO namespace.</p>
<p>If you receive a <code>404</code> during setup when using "verify configuration", make sure you have used the correct
<a href="../../../integration/saml.md#configure-saml-on-your-idp">SHA-1 generated fingerprint</a>.</p>
<p>If a user is trying to sign in for the first time and the GitLab single sign-on URL has not <a href="_index.md#set-up-your-identity-provider">been configured</a>, they may see a 404.
As outlined in the <a href="_index.md#link-saml-to-your-existing-gitlabcom-account">user access section</a>, a group Owner needs to provide the URL to users.</p>
<p>If the top-level group has <a href="../access_and_permissions.md#restrict-group-access-by-domain">restricted membership by email domain</a>, and a user with an email domain that is not allowed tries to sign in with SSO, that user might receive a 404. Users might have multiple accounts, and their SAML identity might be linked to their personal account which has an email address that is different than the company domain. To check this, verify the following:</p>
<ul>
<li>That the top-level group has restricted membership by email domain.</li>
<li>That, in <a href="../../../administration/compliance/audit_event_reports.html">audit events</a> for the top-level group:</li>
<li>You can see <strong>Signed in with GROUP_SAML authentication</strong> action for that user.</li>
<li>That the user's username is the same as the username you configured for SAML SSO, by selecting the <strong>Author</strong> name.<ul>
<li>If the username is different to the username you configured for SAML SSO, ask the user to <a href="_index.md#unlink-accounts">unlink the SAML identity</a> from their personal account.</li>
</ul>
</li>
</ul>
<p>If all users are receiving a <code>404</code> after signing in to the identity provider (IdP):</p>
<ul>
<li>
<p>Verify the <code>assertion_consumer_service_url</code>:</p>
</li>
<li>
<p>In the GitLab configuration by <a href="../../../integration/saml.md#configure-saml-support-in-gitlab">matching it to the HTTPS endpoint of GitLab</a>.</p>
</li>
<li>
<p>As the <code>Assertion Consumer Service URL</code> or equivalent when setting up the SAML app on your IdP.</p>
</li>
<li>
<p>Verify if the <code>404</code> is related to <a href="group_sync.md#microsoft-azure-active-directory-integration">the user having too many groups assigned to them in their Azure IdP</a>.</p>
</li>
<li>
<p>Verify the clocks on the IdP server and GitLab are synced to the same time.</p>
</li>
</ul>
<p>If a subset of users receive a <code>404</code> error after they sign in to the IdP, first verify what audit events are returned if the user is added to the group and then immediately removed. Alternatively, if the user can successfully sign in, but they do not show as <a href="../_index.md#search-a-group">a member of the top-level group</a>:</p>
<ul>
<li>Ensure the user has been <a href="_index.md#user-access-and-management">added to the SAML identity provider</a>, and <a href="scim_setup.html">SCIM</a> if configured.</li>
<li>
<p>Ensure the user's SCIM identity's <code>active</code> attribute is <code>true</code> using the <a href="../../../api/scim.html">SCIM API</a>.
  If the <code>active</code> attribute is <code>false</code>, you can do one of the following to possibly resolve the issue:</p>
</li>
<li>
<p>Trigger a sync for the user in the SCIM identity provider. For example, Azure has a "Provision on demand" option.</p>
</li>
<li>Remove and re-add the user in the SCIM identity provider.</li>
<li>Have the user <a href="_index.md#unlink-accounts">unlink their account</a> if possible, then <a href="_index.md#link-saml-to-your-existing-gitlabcom-account">link their account</a>.</li>
<li>
<p>Use the <a href="../../../development/internal_api/_index.md#update-a-single-scim-provisioned-user">internal SCIM API</a> to update the user's SCIM identity using your group's SCIM token.
    If you do not know your group's SCIM token, reset the token and update the SCIM identity provider app with the new token.
    Example request:</p>
<p><code>plaintext
curl --request PATCH "https://gitlab.example.com/api/scim/v2/groups/test_group/Users/f0b1d561c-21ff-4092-beab-8154b17f82f2" --header "Authorization: Bearer &lt;SCIM_TOKEN&gt;" --header "Content-Type: application/scim+json" --data '{ "Operations": [{"op":"Replace","path":"active","value":"true"}] }'</code></p>
</li>
</ul>
<h3>500 error after login</h3>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Free, Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>If you see a "500 error" in GitLab when you are redirected back from the SAML
sign-in page, this could indicate that:</p>
<ul>
<li>GitLab couldn't get the email address for the SAML user. Ensure the identity provider provides a claim containing the user's
  email address using the claim name <code>email</code> or <code>mail</code>.</li>
<li>The certificate set your <code>gitlab.rb</code> file for <code>identity provider_cert_fingerprint</code> or <code>identity provider_cert</code> file is incorrect.</li>
<li>Your <code>gitlab.rb</code> file is set to enable <code>identity provider_cert_fingerprint</code>, and <code>identity provider_cert</code> is being provided, or the reverse.</li>
</ul>
<h3>422 error after login</h3>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Free, Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>If you see a "422 error" in GitLab when you are redirected from the SAML
sign-in page, you might have an incorrectly configured Assertion Consumer
Service (ACS) URL on the identity provider.</p>
<p>Make sure the ACS URL points to <code>https://gitlab.example.com/users/auth/saml/callback</code>, where
<code>gitlab.example.com</code> is the URL of your GitLab instance.</p>
<p>If the ACS URL is correct, and you still have errors, review the other
Troubleshooting sections.</p>
<h4>422 error with non-allowed email</h4>
<p>You might get a 422 error that states "Email is not allowed for sign-up. Please use your regular email address."</p>
<p>This message might indicate that you must add or remove a domain from your domain allowlist or denylist settings.</p>
<p>To implement this workaround:</p>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>Select <strong>Settings</strong> &gt; <strong>General</strong>.</li>
<li>Expand <strong>Sign-up restrictions</strong>.</li>
<li>Add or remove a domain as appropriate to <strong>Allowed domains for sign-ups</strong> and <strong>Denied domains for sign-ups</strong>.</li>
<li>Select <strong>Save changes</strong>.</li>
</ol>
<h3>User is blocked when signing in through SAML</h3>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Free, Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>The following are the most likely reasons that a user is blocked when signing in through SAML:</p>
<ul>
<li>In the configuration, <code>gitlab_rails['omniauth_block_auto_created_users'] = true</code> is set and this is the user's first time signing in.</li>
<li><a href="../../../integration/saml.md#required-groups"><code>required_groups</code></a> are configured but the user is not a member of one.</li>
</ul>
<h2>Google workspace troubleshooting tips</h2>
<p>The Google Workspace documentation on <a href="https://support.google.com/a/answer/6301076?hl=en">SAML app error messages</a> is helpful for debugging if you are seeing an error from Google while signing in.
Pay particular attention to the following 403 errors:</p>
<ul>
<li><code>app_not_configured</code></li>
<li><code>app_not_configured_for_user</code></li>
</ul>
<h2>Message: <code>The member's email address is not linked to a SAML account</code></h2>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>This error appears when you try to invite a user to a GitLab.com group (or subgroup or project within a group) that has <a href="_index.md#sso-enforcement">SAML SSO enforcement</a> enabled.</p>
<p>If you see this message after trying to invite a user to a group:</p>
<ol>
<li>Ensure the user has been <a href="_index.md#user-access-and-management">added to the SAML identity provider</a>.</li>
<li>Ask the user to <a href="_index.md#link-saml-to-your-existing-gitlabcom-account">link SAML to their existing GitLab.com account</a>, if they have one. Otherwise, ask the user to create a GitLab.com account by <a href="_index.md#user-access-and-management">accessing GitLab.com through the identity provider's dashboard</a>, or by <a href="https://gitlab.com/users/sign_up">signing up manually</a> and linking SAML to their new account.</li>
<li>Ensure the user is a <a href="../_index.md#search-a-group">member of the top-level group</a>.</li>
</ol>
<p>Additionally, see <a href="#users-receive-a-404">troubleshooting users receiving a 404 after sign in</a>.</p>
<h2>Message: <code>The SAML response did not contain an email address.</code></h2>
<p>If you see this error:</p>
<pre><code class="language-plaintext">The SAML response did not contain an email address.
Either the SAML identity provider is not configured to send the attribute, or the
identity provider directory does not have an email address value for your user
</code></pre>
<p>This error appears when:</p>
<ul>
<li>the SAML response does not contain the user's email address in an <strong>email</strong> or <strong>mail</strong> attribute.</li>
<li>a user attempts to <a href="_index.md#user-access-and-management">link SAML</a> to their account but has not yet completed the <a href="../../../security/identity_verification.html">identity verification process</a>.</li>
</ul>
<p>Ensure the SAML identity provider is configured to send a <a href="../../../integration/saml.html">supported mail attribute</a>:</p>
<pre><code class="language-xml">&lt;Attribute Name=&quot;email&quot;&gt;
  &lt;AttributeValue&gt;user@example.com‹/AttributeValue&gt;
&lt;/Attribute&gt;
</code></pre>
<p>Attribute names starting with phrases such as <code>http://schemas.xmlsoap.org/ws/2005/05/identity/claims</code> and <code>http://schemas.microsoft.com/ws/2008/06/identity/claims/</code> are supported by default beginning in GitLab 16.7.</p>
<pre><code class="language-xml">&lt;Attribute Name=&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/emailaddress&quot;&gt;
  &lt;AttributeValue&gt;user@example.com‹/AttributeValue&gt;
&lt;/Attribute&gt;
</code></pre>
<h2>Cannot add service accounts with global SAML group memberships lock</h2>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Offering: GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>If the <a href="group_sync.md#global-saml-group-memberships-lock">global SAML group membership lock</a> is enabled, only administrators can manage group members and service accounts through the UI. If a group Owner needs to manage service accounts, they can use the <a href="../../../api/members.html">group members API</a> instead.</p></code></pre>
</body>
</html>
