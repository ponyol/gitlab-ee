<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># User cannot be added after they are removed</title>
    <link rel="stylesheet" href="/../../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Fulfillment
group: Seat Management
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Troubleshooting SCIM</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Free, Premium, Ultimate</li>
<li>Offering: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>This section contains possible solutions for problems you might encounter.</p>
<h2>User cannot be added after they are removed</h2>
<p>When you remove a user, they are removed from the group but their account is not deleted
(see <a href="scim_setup.md#remove-access">remove access</a>).</p>
<p>When the user is added back to the SCIM app, GitLab does not create a new user because the user already exists.</p>
<p>From August 11, 2023, the <code>skip_saml_identity_destroy_during_scim_deprovision</code> feature flag is enabled.</p>
<p>For a user de-provisioned by SCIM from that date, their SAML identity is not removed.
When that user is added back to the SCIM app:</p>
<ul>
<li>Their SCIM identity <code>active</code> attribute is set to <code>true</code>.</li>
<li>They can sign in using SSO.</li>
</ul>
<p>For users de-provisioned by SCIM before that date, their SAML identity is destroyed.
To solve this problem, the user must <a href="_index.md#link-saml-to-your-existing-gitlabcom-account">link SAML to their existing GitLab.com account</a>.</p>
<h3>GitLab Self-Managed</h3>
<p>For GitLab Self-Managed, administrators of that instance can instead <a href="../../../administration/admin_area.md#user-identities">add the user identity themselves</a>. This might save time if administrators need to re-add multiple identities.</p>
<h2>User cannot sign in</h2>
<p>The following are possible solutions for problems where users cannot sign in:</p>
<ul>
<li>Ensure that the user was added to the SCIM app.</li>
<li>If you receive the <code>User is not linked to a SAML account</code> error, the user probably already exists in GitLab. Have the
  user follow the <a href="scim_setup.md#link-scim-and-saml-identities">Link SCIM and SAML identities</a> instructions.
  Alternatively, self-managed administrators can <a href="../../../administration/admin_area.md#user-identities">add a user identity</a>.</li>
<li>The <strong>Identity</strong> (<code>extern_uid</code>) value stored by GitLab is updated by SCIM whenever <code>id</code> or <code>externalId</code> changes. Users
  cannot sign in unless the GitLab identifier (<code>extern_uid</code>) of the sign-in method matches the ID sent by the provider, such as
  the <code>NameId</code> sent by SAML. This value is also used by SCIM to match users on the <code>id</code>, and is updated by SCIM whenever the <code>id</code> or <code>externalId</code> values change.</li>
<li>On GitLab.com, the SCIM <code>id</code> and SCIM <code>externalId</code> must be configured to the same value as the SAML <code>NameId</code>. You can trace SAML responses
  using <a href="troubleshooting.md#saml-debugging-tools">debugging tools</a>, and check any errors against the
  <a href="troubleshooting.html">SAML troubleshooting</a> information.</li>
</ul>
<h2>Unsure if user's SAML <code>NameId</code> matches the SCIM <code>externalId</code></h2>
<p>To check if a user's SAML <code>NameId</code> matches their SCIM <code>externalId</code>:</p>
<ul>
<li>Administrators can use the <strong>Admin</strong> area to <a href="../../../administration/admin_area.md#user-identities">list SCIM identities for a user</a>.</li>
<li>Group owners can see the list of users and the identifier stored for each user in the group SAML SSO Settings page.</li>
<li>You can use the <a href="../../../api/scim.html">SCIM API</a> to manually retrieve the <code>extern_uid</code> GitLab has stored for users and compare the value for each user from the <a href="../../../api/saml.html">SAML API</a> .</li>
<li>Have the user use a <a href="troubleshooting.md#saml-debugging-tools">SAML Tracer</a> and compare the <code>extern_uid</code> to
  the value returned as the SAML <code>NameId</code>.</li>
</ul>
<h2>Mismatched SCIM <code>extern_uid</code> and SAML <code>NameId</code></h2>
<p>Whether the value was changed or you need to map to a different field, the following must map to the same field:</p>
<ul>
<li><code>extern_Id</code></li>
<li><code>NameId</code></li>
</ul>
<p>If the SCIM <code>extern_uid</code> does not match the SAML <code>NameId</code>, you must update the SCIM <code>extern_uid</code> to enable the user to sign in.</p>
<p>Be cautious if you revise the fields used by your SCIM identity provider, typically <code>extern_Id</code>.
Your identity provider should be configured to do this update.
In some cases the identity provider cannot do the update, for example when a user lookup fails.</p>
<p>GitLab uses these IDs to look up users.
If the identity provider does not know the current values for these fields,
that provider may create duplicate users, or fail to complete expected actions.</p>
<p>To change the identifier values to match, you can do one of the following:</p>
<ul>
<li>Have users unlink and relink themselves, based on the
  <a href="troubleshooting.md#message-saml-authentication-failed-user-has-already-been-taken">SAML authentication failed: User has already been taken</a>
  section.</li>
<li>Unlink all users simultaneously by removing all users from the SCIM app while provisioning is turned on.</li>
</ul>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>This resets all users' roles in the top-level group and subgroups to the <a href="_index.md#configure-gitlab">configured default membership role</a>.</p>
<p>{{&lt; /alert &gt;}}</p>
<ul>
<li>Use the <a href="../../../api/saml.html">SAML API</a> or <a href="../../../api/scim.html">SCIM API</a> to manually correct the <code>extern_uid</code> stored for users to match the SAML
  <code>NameId</code> or SCIM <code>externalId</code>.</li>
</ul>
<p>You must not:</p>
<ul>
<li>Update these to incorrect values because this causes users to be unable to sign in.</li>
<li>Assign a value to the wrong user because this causes users to be signed in to the wrong account.</li>
</ul>
<p>Additionally, the user's primary email must match the email in your SCIM identity provider.</p>
<h2>Change SCIM app</h2>
<p>When the SCIM app changes:</p>
<ul>
<li>Users can follow the instructions in the <a href="_index.md#change-the-identity-provider">Change the SAML app</a> section.</li>
<li>Administrators of the identity provider can:</li>
<li>Remove users from the SCIM app, which:<ul>
<li>In GitLab.com, removes all removed users from the group.</li>
<li>In GitLab Self-Managed, blocks users.</li>
</ul>
</li>
<li>Turn on sync for the new SCIM app to <a href="scim_setup.md#link-scim-and-saml-identities">link existing users</a>.</li>
</ul>
<h2>SCIM app returns <code>"User has already been taken","status":409</code> error</h2>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>Changing the SAML or SCIM configuration or provider can cause the following problems:</p>
<ul>
<li>SAML and SCIM identity mismatch. To solve this problem:</li>
<li><a href="#unsure-if-users-saml-nameid-matches-the-scim-externalid">Verify that the user's SAML <code>NameId</code> matches the SCIM <code>extern_uid</code></a>.</li>
<li><a href="#mismatched-scim-extern_uid-and-saml-nameid">Update or fix the mismatched SCIM <code>extern_uid</code> and SAML <code>NameId</code></a>.</li>
<li>SCIM identity mismatch between GitLab and the identity provider SCIM app. To solve this problem:</li>
<li>Use the <a href="../../../api/scim.html">SCIM API</a>, which displays the user's <code>extern_uid</code> stored in GitLab and compares it with the user <code>externalId</code> in
     the SCIM app.</li>
<li>Use the same SCIM API to update the SCIM <code>extern_uid</code> for the user on GitLab.com.</li>
</ul>
<h2>The member's email address is not allowed for this group</h2>
<p>SCIM provisioning may fail with HTTP status <code>412</code> and the following error message:</p>
<pre><code class="language-plaintext">The member's email address is not allowed for this group. Check with your administrator.
</code></pre>
<p>This error occurs when both of the following are true:</p>
<ul>
<li><a href="../access_and_permissions.html">Restrict group access by domain</a> is configured
  for the group.</li>
<li>The user account being provisioned has an email domain that is not allowed.</li>
</ul>
<p>To resolve this issue, you can do either of the following:</p>
<ul>
<li>Add the user account's email domain to the list of allowed domains.</li>
<li>Disable the <a href="../access_and_permissions.html">Restrict group access by domain</a>
  feature by removing all domains.</li>
</ul>
<h2>Search Rails logs for SCIM requests</h2>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>GitLab.com administrators can search for SCIM requests in the <code>api_json.log</code> using the <code>pubsub-rails-inf-gprd-*</code> index in
Kibana. Use the following filters based
on the internal <a href="../../../development/internal_api/_index.md#group-scim-api">group SCIM API</a>:</p>
<ul>
<li><code>json.path</code>: <code>/scim/v2/groups/&lt;group-path&gt;</code></li>
<li><code>json.params.value</code>: <code>&lt;externalId&gt;</code></li>
</ul>
<p>In a relevant log entry, the <code>json.params.value</code> shows the values of SCIM parameters GitLab receives. Use these values
to verify if SCIM parameters configured in an identity provider's SCIM app are communicated to GitLab as intended.</p>
<p>For example, use these values as a definitive source on why an account was provisioned with a certain set of
details. This information can help where an account was SCIM provisioned with details that do not match
the SCIM app configuration.</p>
<h2>Member's email address is not linked error in SCIM log</h2>
<p>When you attempt to provision a SCIM user on GitLab.com, GitLab checks to see if
a user with that email address already exists. You might see the following error
when the:</p>
<ul>
<li>User exists, but does not have a SAML identity linked.</li>
<li>User exists, has a SAML identity, <strong>and</strong> has a SCIM identity that is set to <code>active: false</code>.</li>
<li>User exists, but is not a member of the associated top-level group and SAML SSO enforcement is enabled.</li>
</ul>
<pre><code class="language-plaintext">The member's email address is not linked to a SAML account or has an inactive
SCIM identity.
</code></pre>
<p>This error message is returned with the status <code>412</code>.</p>
<p>This might prevent the affected end user from accessing their account correctly.</p>
<p>The first workaround is:</p>
<ol>
<li>Have the end user <a href="_index.md#link-saml-to-your-existing-gitlabcom-account">link SAML to their existing GitLab.com account</a>.</li>
<li>After the user has done this, initiate a SCIM sync from your identity provider.
   If the SCIM sync completes without the same error, GitLab has
   successfully linked the SCIM identity to the existing user account, and the user
   should now be able to sign in using SAML SSO.</li>
</ol>
<p>If the error persists, the user most likely already exists, has both a SAML and
SCIM identity, and a SCIM identity that is set to <code>active: false</code>. To resolve
this:</p>
<ol>
<li>Optional. If you did not save your SCIM token when you first configured SCIM, <a href="scim_setup.md#configure-gitlab">generate a new token</a>. If you generate a new SCIM token, you <strong>must</strong> update the token in your identity provider's SCIM configuration, or SCIM will stop working.</li>
<li>Locate your SCIM token.</li>
<li>Use the API to <a href="../../../development/internal_api/_index.md#get-a-single-scim-provisioned-user">get a single SCIM provisioned user</a>.</li>
<li>
<p>Check the returned information to make sure that:</p>
</li>
<li>
<p>The user's identifier (<code>id</code>) and email match what your identity provider is sending.</p>
</li>
<li><code>active</code> is set to <code>false</code>.</li>
</ol>
<p>If any of this information does not match, <a href="https://support.gitlab.com/">contact GitLab Support</a>.
1. Use the API to <a href="../../../development/internal_api/_index.md#update-a-single-scim-provisioned-user">update the SCIM provisioned user's <code>active</code> value to <code>true</code></a>.
1. If the update returns a status code <code>204</code>, have the user attempt to sign in
   using SAML SSO.</p>
<h2>Azure Active Directory</h2>
<p>The following troubleshooting information is specifically for SCIM provisioned through Azure Active Directory.</p>
<h3>Verify my SCIM configuration is correct</h3>
<p>Ensure that:</p>
<ul>
<li>The matching precedence for <code>externalId</code> is 1.</li>
<li>The SCIM value for <code>externalId</code> matches the SAML value for <code>NameId</code>.</li>
</ul>
<p>Review the following SCIM parameters for sensible values:</p>
<ul>
<li><code>userName</code></li>
<li><code>displayName</code></li>
<li><code>emails[type eq "work"].value</code></li>
</ul>
<h3><code>invalid credentials</code> error when testing connection</h3>
<p>When testing the connection, you may encounter an error:</p>
<pre><code class="language-plaintext">You appear to have entered invalid credentials. Please confirm
you are using the correct information for an administrative account
</code></pre>
<p>If <code>Tenant URL</code> and <code>secret token</code> are correct, check whether your group path contains characters that may be considered
invalid JSON primitives (such as <code>.</code>). Removing or URL encoding these characters in the group path typically resolves the error.</p>
<h3><code>(Field) can't be blank</code> sync error</h3>
<p>When checking the audit events for the provisioning, you sometimes see a
<code>Namespace can't be blank, Name can't be blank, and User can't be blank.</code> error.</p>
<p>This error can occur because not all required fields (such as first name and last name) are present for all users
being mapped.</p>
<p>As a workaround, try an alternate mapping:</p>
<ol>
<li>Follow the <a href="scim_setup.md#configure-attribute-mappings">Azure mapping instructions</a>.</li>
<li>Delete the <code>name.formatted</code> target attribute entry.</li>
<li>Change the <code>displayName</code> source attribute to have <code>name.formatted</code> target attribute.</li>
</ol>
<h3><code>Failed to match an entry in the source and target systems Group 'Group-Name'</code> error</h3>
<p>Group provisioning in Azure can fail with the <code>Failed to match an entry in the source and target systems Group 'Group-Name'</code>
error. The error response can include a HTML result of the GitLab URL <code>https://gitlab.com/users/sign_in</code>.</p>
<p>This error is harmless and occurs because group provisioning was turned on but GitLab SCIM integration does not support
it nor require it. To remove the error, follow the instructions in the Azure configuration guide to disable the option
to <a href="scim_setup.md#configure-microsoft-entra-id-formerly-azure-active-directory">synchronize Azure Active Directory groups to AppName</a>.</p>
<h2>Okta</h2>
<p>The following troubleshooting information is specifically for SCIM provisioned through Okta.</p>
<h3><code>Error authenticating: null</code> message when testing API SCIM credentials</h3>
<p>When testing the API credentials in your Okta SCIM application, you may encounter an error:</p>
<pre><code class="language-plaintext">Error authenticating: null
</code></pre>
<p>Okta needs to be able to connect to your GitLab instance to provision or deprovision users.</p>
<p>In your Okta SCIM application, check that the SCIM <strong>Base URL</strong> is correct and pointing to a valid GitLab
SCIM API endpoint URL. Check the following documentation to find information on this URL for:</p>
<ul>
<li><a href="scim_setup.md#configure-gitlab">GitLab.com groups</a>.</li>
<li><a href="../../../administration/settings/scim_setup.md#configure-gitlab">GitLab Self-Managed</a>.</li>
</ul>
<p>For GitLab Self-Managed, ensure your instance is publicly available so Okta can connect to it. If needed,
you can <a href="https://help.okta.com/en-us/Content/Topics/Security/ip-address-allow-listing.htm">allow access to Okta IP addresses</a>
on your firewall.</p></code></pre>
</body>
</html>
