<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Configure GitLab-managed Kubernetes resources</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Verify
group: Runner Core
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://about.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: GitLab-managed Kubernetes resources</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/groups/gitlab-org/-/epics/16130">Introduced</a> in GitLab 17.9 <a href="../../../administration/feature_flags/_index.html">with a flag</a> named <code>gitlab_managed_cluster_resources</code>. Disabled by default.</li>
<li>Feature flag <code>gitlab_managed_cluster_resources</code> <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/520042">removed</a> in GitLab 18.1.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>Use GitLab-managed Kubernetes resources to provision Kubernetes resources with environment templates. An environment template can:</p>
<ul>
<li>Create namespaces and service accounts automatically for new environments</li>
<li>Manage access permissions through role bindings</li>
<li>Configure other required Kubernetes resources</li>
</ul>
<p>When developers deploy applications, GitLab creates the resources based on the environment template.</p>
<h2>Configure GitLab-managed Kubernetes resources</h2>
<p>Prerequisites:</p>
<ul>
<li>You must have a configured <a href="install/_index.html">GitLab agent for Kubernetes</a>.</li>
<li>You have <a href="ci_cd_workflow.md#authorize-agent-access">authorized the agent</a> to access relevant projects or groups.</li>
<li>(Optional) You have configured <a href="ci_cd_workflow.md#restrict-project-and-group-access-by-using-impersonation">agent impersonation</a> to prevent privilege escalations. The default environment template assumes you have configured <a href="ci_cd_workflow.md#impersonate-the-cicd-job-that-accesses-the-cluster"><code>ci_job</code> impersonation</a>.</li>
</ul>
<h3>Turn on Kubernetes resource management</h3>
<h4>In your agent configuration file</h4>
<p>To turn on resource management, modify the agent configuration file to include the required permissions:</p>
<pre><code class="language-yaml">ci_access:
  projects:
    - id: &lt;your_group/your_project&gt;
      access_as:
        ci_job: {}
      resource_management:
        enabled: true
  groups:
    - id: &lt;your_other_group&gt;
      access_as:
        ci_job: {}
      resource_management:
        enabled: true
</code></pre>
<h4>In your CI/CD jobs</h4>
<p>To have the agent manage resources for an environment, specify the agent in your deployment job. For example:</p>
<pre><code class="language-yaml">deploy_review:
  stage: deploy
  script:
    - echo &quot;Deploy a review app&quot;
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    kubernetes:
      agent: path/to/agent/project:agent-name
</code></pre>
<p>CI/CD variables can be used in the agent path. For more information, see
<a href="../../../ci/variables/where_variables_can_be_used.html">Where variables can be used</a>.</p>
<h3>Create environment templates</h3>
<p>Environment templates define what Kubernetes resources are created, updated, or removed.</p>
<p>The <a href="https://gitlab.com/gitlab-org/cluster-integration/gitlab-agent/-/blob/master/internal/module/managed_resources/server/default_template.yaml">default environment template</a> creates a <code>Namespace</code> and configures a <code>RoleBinding</code> for the CI/CD job.</p>
<p>To overwrite the default template, add a template configuration file called <code>default.yaml</code> in the agent directory:</p>
<pre><code class="language-plaintext">.gitlab/agents/&lt;agent-name&gt;/environment_templates/default.yaml
</code></pre>
<h4>Supported Kubernetes resources</h4>
<p>The following Kubernetes resources (<code>kind</code>) are supported:</p>
<ul>
<li><code>Namespace</code></li>
<li><code>ServiceAccount</code></li>
<li><code>RoleBinding</code></li>
<li>FluxCD Source Controller objects:</li>
<li><code>GitRepository</code></li>
<li><code>HelmRepository</code></li>
<li><code>HelmChart</code></li>
<li><code>Bucket</code></li>
<li><code>OCIRepository</code></li>
<li>FluxCD Kustomize Controller objects:</li>
<li><code>Kustomization</code></li>
<li>FluxCD Helm Controller objects:</li>
<li><code>HelmRelease</code></li>
<li>FluxCD Notification Controller objects:</li>
<li><code>Alert</code></li>
<li><code>Provider</code></li>
<li><code>Receiver</code></li>
</ul>
<h4>Example environment template</h4>
<p>The following example creates a namespace and grants a group administrator access to a cluster.</p>
<pre><code class="language-yaml">objects:
  - apiVersion: v1
    kind: Namespace
    metadata:
      name: '{{ .environment.slug }}-{{ .project.id }}-{{ .agent.id }}'
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: bind-{{ .environment.slug }}-{{ .project.id }}-{{ .agent.id }}
      namespace: '{{ .environment.slug }}-{{ .project.id }}-{{ .agent.id }}'
    subjects:
      - kind: Group
        apiGroup: rbac.authorization.k8s.io
        name: gitlab:project_env:{{ .project.id }}:{{ .environment.slug }}
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: admin

# Resource lifecycle configuration
apply_resources: on_start    # Resources are applied when environment is started/restarted
delete_resources: on_stop    # Resources are removed when environment is stopped
</code></pre>
<h3>Template variables</h3>
<p>Environment templates support limited variable substitution.
The following variables are available:</p>
<table>
<thead>
<tr>
<th>Category</th>
<th>Variable</th>
<th>Description</th>
<th>Type</th>
<th>Default value when not set</th>
</tr>
</thead>
<tbody>
<tr>
<td>Agent</td>
<td><code>{{ .agent.id }}</code></td>
<td>The agent ID.</td>
<td>Integer</td>
<td>N/A</td>
</tr>
<tr>
<td>Agent</td>
<td><code>{{ .agent.name }}</code></td>
<td>The agent name.</td>
<td>String</td>
<td>N/A</td>
</tr>
<tr>
<td>Agent</td>
<td><code>{{ .agent.url }}</code></td>
<td>The agent URL.</td>
<td>String</td>
<td>N/A</td>
</tr>
<tr>
<td>Environment</td>
<td><code>{{ .environment.id }}</code></td>
<td>The environment ID.</td>
<td>Integer</td>
<td>N/A</td>
</tr>
<tr>
<td>Environment</td>
<td><code>{{ .environment.name }}</code></td>
<td>The environment name.</td>
<td>String</td>
<td>N/A</td>
</tr>
<tr>
<td>Environment</td>
<td><code>{{ .environment.slug }}</code></td>
<td>The environment slug based on the environment name. Maximum 24 lowercase alphanumeric characters, including <code>-</code>, beginning with a letter, and not ending with <code>-</code>.</td>
<td>String</td>
<td>N/A</td>
</tr>
<tr>
<td>Environment</td>
<td><code>{{ .environment.url }}</code></td>
<td>The environment URL.</td>
<td>String</td>
<td>Empty string</td>
</tr>
<tr>
<td>Environment</td>
<td><code>{{ .environment.page_url }}</code></td>
<td>The environment page URL.</td>
<td>String</td>
<td>N/A</td>
</tr>
<tr>
<td>Environment</td>
<td><code>{{ .environment.tier }}</code></td>
<td>The environment tier.</td>
<td>String</td>
<td>N/A</td>
</tr>
<tr>
<td>Project</td>
<td><code>{{ .project.id }}</code></td>
<td>The project ID.</td>
<td>Integer</td>
<td>N/A</td>
</tr>
<tr>
<td>Project</td>
<td><code>{{ .project.slug }}</code></td>
<td>The project slug. This is the unmodified last component of the project path.</td>
<td>String</td>
<td>N/A</td>
</tr>
<tr>
<td>Project</td>
<td><code>{{ .project.path }}</code></td>
<td>The project path.</td>
<td>String</td>
<td>N/A</td>
</tr>
<tr>
<td>Project</td>
<td><code>{{ .project.url }}</code></td>
<td>The project URL.</td>
<td>String</td>
<td>N/A</td>
</tr>
<tr>
<td>CI/CD Pipeline</td>
<td><code>{{ .ci_pipeline.id }}</code></td>
<td>The pipeline ID.</td>
<td>Integer</td>
<td>Zero</td>
</tr>
<tr>
<td>CI/CD Job</td>
<td><code>{{ .ci_job.id }}</code></td>
<td>The CI/CD job ID.</td>
<td>Integer</td>
<td>Zero</td>
</tr>
<tr>
<td>User</td>
<td><code>{{ .user.id }}</code></td>
<td>The user ID.</td>
<td>Integer</td>
<td>N/A</td>
</tr>
<tr>
<td>User</td>
<td><code>{{ .user.username }}</code></td>
<td>The username.</td>
<td>String</td>
<td>N/A</td>
</tr>
<tr>
<td>Namespace</td>
<td><code>{{ .legacy_namespace }}</code></td>
<td>The Kubernetes namespace that the deprecated certificate-based cluster integration would have produced for this environment. This namespace is only intended for migration from certificate-based cluster integration to GitLab-managed resources. Don't use it for any other purpose.</td>
<td>String</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<p>All variables should be referenced using the double curly brace syntax, for example: <code>{{ .project.id }}</code>.
See <a href="https://pkg.go.dev/text/template"><code>text/template</code></a> documentation for more information on the templating system used.</p>
<h3>Template functions</h3>
<p>Environment templates support limited functions to manipulate the variable values.
The following functions are available:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Arguments</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lower</code></td>
<td><code>&lt;string&gt;</code></td>
<td>Convert to lower case.</td>
<td><code>lower "HELLO"</code> -&gt; <code>"hello"</code></td>
</tr>
<tr>
<td><code>substr</code></td>
<td><code>&lt;start&gt; &lt;end&gt; &lt;string&gt;</code></td>
<td>Take a substring from a string.</td>
<td><code>substr 0 5 "hello world"</code> -&gt; <code>"hello"</code></td>
</tr>
<tr>
<td><code>replace</code></td>
<td><code>&lt;old&gt; &lt;new&gt; &lt;string&gt;</code></td>
<td>Replace all occurrences of a substring in the string.</td>
<td><code>replace "_" "-" "foo_bar"</code> -&gt; <code>"foo-bar"</code></td>
</tr>
<tr>
<td><code>trimPrefix</code></td>
<td><code>&lt;prefix&gt; &lt;string&gt;</code></td>
<td>Remove the prefix from the string.</td>
<td><code>trimPrefix "-" "-hello"</code> -&gt; <code>"hello"</code></td>
</tr>
<tr>
<td><code>trimSuffix</code></td>
<td><code>&lt;suffix&gt; &lt;string&gt;</code></td>
<td>Remove the suffix from the string.</td>
<td><code>trimSuffix "-" "hello-"</code> -&gt; <code>"hello"</code></td>
</tr>
<tr>
<td><code>slugify</code></td>
<td><code>[&lt;len&gt;] &lt;string&gt;</code></td>
<td>Slugify the given string according to RFC1123. By default, trims to <code>63</code> characters.</td>
<td><code>slugify "hello WORLD"</code> -&gt; <code>"hello-world"</code></td>
</tr>
</tbody>
</table>
<p>To make variables compliant for Kubernetes values, the number of functions is intentionally
limited to a minimum set of functions, like namespace names or labels.</p>
<h3>Resource lifecycle management</h3>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/507486">Introduced</a> in GitLab 18.0.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>Use the following settings to configure when Kubernetes resources should be removed:</p>
<pre><code class="language-yaml"># Never delete resources
delete_resources: never

# Delete resources when environment is stopped
delete_resources: on_stop
</code></pre>
<p>The default value is <code>on_stop</code>, which is specified in the
<a href="https://gitlab.com/gitlab-org/cluster-integration/gitlab-agent/-/blob/master/internal/module/managed_resources/server/default_template.yaml">default environment template</a>.</p>
<h3>Managed resource labels and annotations</h3>
<p>The resources created by GitLab use a series of labels and annotations for tracking and troubleshooting purposes.</p>
<p>The following labels are defined on every resource created by GitLab. The values are intentionally left empty:</p>
<ul>
<li><code>agent.gitlab.com/id-&lt;agent_id&gt;: ""</code></li>
<li><code>agent.gitlab.com/project_id-&lt;project_id&gt;: ""</code></li>
<li><code>agent.gitlab.com/env-&lt;gitlab_environment_slug&gt;-&lt;project_id&gt;-&lt;agent_id&gt;: ""</code></li>
<li><code>agent.gitlab.com/environment_slug-&lt;gitlab_environment_slug&gt;: ""</code></li>
</ul>
<p>On every resource created by GitLab, an <code>agent.gitlab.com/env-&lt;gitlab_environment_slug&gt;-&lt;project_id&gt;-&lt;agent_id&gt;</code> annotation is defined.
The value of the annotation is a JSON object with the following keys:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>environment_id</code></td>
<td>The GitLab environment ID.</td>
</tr>
<tr>
<td><code>environment_name</code></td>
<td>The GitLab environment name.</td>
</tr>
<tr>
<td><code>environment_slug</code></td>
<td>The GitLab environment slug.</td>
</tr>
<tr>
<td><code>environment_url</code></td>
<td>The link to the environment. Optional.</td>
</tr>
<tr>
<td><code>environment_page_url</code></td>
<td>The link to the GitLab environment page.</td>
</tr>
<tr>
<td><code>environment_tier</code></td>
<td>The GitLab environment deployment tier.</td>
</tr>
<tr>
<td><code>agent_id</code></td>
<td>The agent ID.</td>
</tr>
<tr>
<td><code>agent_name</code></td>
<td>The agent name.</td>
</tr>
<tr>
<td><code>agent_url</code></td>
<td>The agent URL in the agent registration project.</td>
</tr>
<tr>
<td><code>project_id</code></td>
<td>The GitLab project ID.</td>
</tr>
<tr>
<td><code>project_slug</code></td>
<td>The GitLab project slug.</td>
</tr>
<tr>
<td><code>project_path</code></td>
<td>The full GitLab project path.</td>
</tr>
<tr>
<td><code>project_url</code></td>
<td>The link to the GitLab project.</td>
</tr>
<tr>
<td><code>template_name</code></td>
<td>The name of the template used.</td>
</tr>
</tbody>
</table>
<h3>Disable GitLab-managed Kubernetes resources</h3>
<p>You can disable GitLab-managed Kubernetes resources for specific environments while still
using other Kubernetes features like the dashboard. Disabling managed resources helps when
working with global agents that have managed resources enabled by default, but you need to
opt out specific projects or environments.</p>
<p>To disable managed resources for an environment, add the <code>managed_resources.enabled: false</code>
configuration:</p>
<pre><code class="language-yaml">deploy_review:
  stage: deploy
  script:
    - echo &quot;Deploy a review app&quot;
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    kubernetes:
      agent: path/to/agent/project:agent-name
      managed_resources:
        enabled: false
</code></pre>
<h2>Troubleshooting</h2>
<p>Any errors related to managed Kubernetes resources can be found on:</p>
<ul>
<li>The environment page in your GitLab project</li>
<li>The CI/CD job logs when using the feature in pipelines</li>
</ul></code></pre>
</body>
</html>
