<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Prerequisites</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Package
group: Package Registry
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Virtual registry
description: Use the GitLab virtual registry to proxy, cache, and distribute packages from multiple upstream registries.</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li>
<li>Status: Beta</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/groups/gitlab-org/-/epics/14137">Introduced</a> in GitLab 18.0 <a href="../../../administration/feature_flags/_index.html">with a flag</a> named <code>virtual_registry_maven</code>. Disabled by default.</li>
<li>Feature flag <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/540276">changed</a> to <code>maven_virtual_registry</code> in GitLab 18.1. Disabled by default. Feature flag <code>virtual_registry_maven</code> removed.</li>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/540276">Changed</a> from experiment to beta in GitLab 18.1.</li>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/197432">Enabled on GitLab.com, GitLab Self-Managed, and GitLab Dedicated</a> in GitLab 18.2.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>{{&lt; alert type="flag" &gt;}}</p>
<p>The availability of this feature is controlled by a feature flag.
For more information, see the history.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>The GitLab virtual registry is available as part of the GitLab <a href="../../../policy/development_stages_support.md#beta">beta</a> program. While it is currently available on Premium and Ultimate, final availability and pricing will be announced when the virtual registry is generally available.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>Use the GitLab virtual registry to proxy, cache, and distribute packages from multiple upstream registries behind a single, well-known URL.</p>
<p>With this approach, you can configure your applications to use one virtual registry instead of multiple upstream registries.</p>
<h2>Prerequisites</h2>
<p>To configure the virtual registry:</p>
<ul>
<li>You need a top-level group with at least the Maintainer role.</li>
<li>Make sure you enable the virtual registries setting. It's enabled by default, but <a href="#turn-off-the-virtual-registry">administrators can turn it off</a>.</li>
<li>Make sure you enable the dependency proxy setting. It's enabled by default, but <a href="../../../administration/packages/dependency_proxy.html">administrators can turn it off</a>.</li>
<li>You must configure authentication for your supported <a href="#supported-package-formats">package format</a>.</li>
</ul>
<h2>Turn off the virtual registry</h2>
<p>The virtual registry is turned on by default.</p>
<p>Prerequisites:</p>
<ul>
<li>To turn off the virtual registry, you must be an administrator.</li>
</ul>
<p>To turn off the virtual registry:</p>
<ol>
<li>On the top bar, select <strong>Search or go to</strong> and find your group. This group must be at the top level.</li>
<li>Select <strong>Settings</strong> &gt; <strong>Packages and registries</strong>.</li>
<li>Under <strong>Virtual Registry</strong>, turn off the <strong>Enable Virtual Registry</strong> toggle.</li>
</ol>
<h2>Supported package formats</h2>
<ul>
<li><a href="maven/_index.html">Maven packages</a></li>
<li><a href="container/_index.html">Container images</a></li>
</ul>
<h2>Authenticate to the virtual registry</h2>
<p>The virtual registry endpoint can be used by any of following tokens:</p>
<ul>
<li>A <a href="../../profile/personal_access_tokens.html">personal access token</a>.</li>
<li>A <a href="../../project/deploy_tokens/_index.html">group deploy token</a> for the top-level group hosting the considered virtual registry.</li>
<li>A <a href="../../group/settings/group_access_tokens.html">group access token</a> for the top-level group hosting the considered virtual registry.</li>
<li>A <a href="../../../ci/jobs/ci_job_token.html">CI/CD job token</a>.</li>
</ul>
<p>Tokens need one of the following scopes:</p>
<ul>
<li><code>api</code></li>
<li><code>read_virtual_registry</code></li>
</ul>
<p>Access tokens and the CI/CD job token are resolved to users. The resolved user must be either:</p>
<ul>
<li>A direct member of the top-level group with at least the Guest role.</li>
<li>A GitLab instance administrator.</li>
<li>A direct member of one of the projects included in the top-level group.</li>
</ul>
<h2>Manage virtual registries</h2>
<p>Manage virtual registries for a top-level group.</p>
<h3>Creating a virtual registry</h3>
<p>You can create a virtual registry for any of the
<a href="#supported-package-formats">supported package formats</a>.</p>
<p>When you create a virtual registry:</p>
<ul>
<li>The registry is hosted at a top-level group for a given package format. Projects and subgroups are not supported.</li>
<li>The virtual registry object links to an ordered list of available upstreams (up to 20). Each upstream points to an external registry.</li>
<li>External registries can be public or private. Credentials for private registries are stored in the upstream itself, so you do not need to store them in the package manager configuration.</li>
</ul>
<h3>View a virtual registry</h3>
<p>To view a virtual registry:</p>
<ol>
<li>On the top bar, select <strong>Search or go to</strong> and find your group. This group must be at the top level.</li>
<li>Select <strong>Deploy</strong> &gt; <strong>Virtual registry</strong>.</li>
</ol>
<h3>Edit a virtual registry</h3>
<p>To edit an existing virtual registry:</p>
<ol>
<li>On the top bar, select <strong>Search or go to</strong> and find your group. This group must be at the top level.</li>
<li>Select <strong>Deploy</strong> &gt; <strong>Virtual registry</strong>.</li>
<li>Under <strong>Registry types</strong>, select <strong>View registries</strong>.</li>
<li>In the row of the registry you want to edit, select <strong>Edit</strong> ({{&lt; icon name="pencil" &gt;}}).</li>
<li>Make your changes and select <strong>Save changes</strong>.</li>
</ol>
<h3>Delete a virtual registry</h3>
<p>To delete a virtual registry:</p>
<ol>
<li>On the top bar, select <strong>Search or go to</strong> and find your group. This group must be at the top level.</li>
<li>Select <strong>Deploy</strong> &gt; <strong>Virtual registry</strong>.</li>
<li>Under <strong>Registry types</strong>, select <strong>View registries</strong>.</li>
<li>Under the <strong>Registries</strong> tab, in the row of the registry you want to delete, select <strong>Edit</strong> ({{&lt; icon name="pencil" &gt;}}).</li>
<li>Select <strong>Delete registry</strong>.</li>
<li>On the confirmation dialog, select <strong>Delete</strong>.</li>
</ol>
<h2>Manage upstream registries</h2>
<p>Manage upstream registries in a virtual registry
for a top-level group.</p>
<h3>View upstream registries</h3>
<p>To view upstream registries:</p>
<ol>
<li>On the top bar, select <strong>Search or go to</strong> and find your group. This group must be at the top level.</li>
<li>Select <strong>Deploy</strong> &gt; <strong>Virtual registry</strong>.</li>
<li>Under <strong>Registry types</strong>, select <strong>View registries</strong>.</li>
<li>Select the <strong>Upstreams</strong> tab to view all available upstreams.</li>
</ol>
<h3>Edit an upstream registry</h3>
<p>To edit an upstream registry:</p>
<ol>
<li>On the top bar, select <strong>Search or go to</strong> and find your group. This group must be at the top level.</li>
<li>Select <strong>Deploy</strong> &gt; <strong>Virtual registry</strong>.</li>
<li>Under <strong>Registry types</strong>, select <strong>View registries</strong>.</li>
<li>Select the <strong>Upstreams</strong> tab.</li>
<li>In the row of the upstream you want to edit, select <strong>Edit</strong> ({{&lt; icon name="pencil" &gt;}}).</li>
<li>Make your changes and select <strong>Save changes</strong>.</li>
</ol>
<h3>Reorder upstream registries</h3>
<p>The order of upstream registries determines the priority
in which they are queried for packages.</p>
<p>To change the order of upstream registries:</p>
<ol>
<li>On the top bar, select <strong>Search or go to</strong> and find your group. This group must be at the top level.</li>
<li>Select <strong>Deploy</strong> &gt; <strong>Virtual registries</strong>.</li>
<li>Under <strong>Registry types</strong>, select <strong>View registries</strong>.</li>
<li>Under the <strong>Registries</strong> tab, select a registry.</li>
<li>Under <strong>Upstreams</strong>, select <strong>Move upstream up</strong> or <strong>Move upstream down</strong> to reorder upstreams.</li>
</ol>
<p>Best practices for upstream ordering:</p>
<ul>
<li>Position private registries before public ones to prioritize internal packages.</li>
<li>Prioritize registries with the most packages at the top of the list. This approach:</li>
<li>Increases the chances that a high-priority registry can fulfill the request</li>
<li>Prevents walking the entire ordered list to find a valid upstream registry</li>
<li>Place faster or more reliable registries higher in the list.</li>
<li>Put public registries last as fallbacks for public dependencies.</li>
<li>Put registries with the least amount of packages at the bottom of the list.</li>
</ul>
<p>For more information about the order of upstreams, see <a href="#upstream-prioritization">Upstream prioritization</a>.</p>
<h2>Caching system</h2>
<p>All upstream registries have a caching system that:</p>
<ul>
<li>Stores requests in a cache entry</li>
<li>Serves the responses for identical requests from the GitLab virtual registry</li>
</ul>
<p>This way, the virtual registry does not have to contact the upstream again when the same package is requested.</p>
<p>If a requested path has not been cached in any of the available upstreams:</p>
<ol>
<li>The virtual registry walks through the ordered list of upstreams to find one that can fulfill the request.</li>
<li>When an upstream is found that can fulfill the request, the virtual registry pulls the response from the upstream with the provided credentials if necessary.</li>
</ol>
<p>If the requested path has been cached in any of the available upstreams:</p>
<ol>
<li>The virtual registry checks the <a href="#cache-validity-period">cache validity period</a> to see if the cache entry needs to be refreshed before forwarding the response.</li>
<li>If the cache is valid, the cache entry of the upstream fulfills the request.</li>
<li>If a lower priority upstream has the request in its cache, and a higher priority contains the file but has not cached the request, the lower priority upstream fulfills the request. The virtual registry does not walk the ordered list of upstreams again.</li>
</ol>
<p>The virtual registry returns a <code>404 Not Found</code> error if it cannot find an upstream to fulfill the request.</p>
<h3>Cache validity period</h3>
<p>The cache validity period sets the amount of time, in hours,
that a cache entry is considered valid to fulfill a request.</p>
<p>Before the virtual registry pulls from an existing cache entry,
it checks the cache validity period to determine if the entry must be refreshed or not.</p>
<p>If the entry is outside the validity period, the virtual registry checks
if the upstream response is identical to the one in the cache. If:</p>
<ul>
<li>The response is identical, the entry is used to fulfill the request.</li>
<li>The response is not identical, the response is downloaded again from the upstream to overwrite the upstream cache entry.</li>
</ul>
<p>If the virtual registry cannot connect to an upstream due to network conditions,
the upstream serves the request with the available cache entry.</p>
<p>As long as the virtual registry has the response related to
a request in the cache, that request is fulfilled,
even when outside the validity period.</p>
<h3>Set the cache validity period</h3>
<p>The cache validity period is important in the overall performance of the virtual registry to fulfill requests. Contacting external registries is a costly operation. Smaller validity periods increase the amount of checks, and longer periods decrease them.</p>
<p>You can turn off cache validity checks by setting it to <code>0</code>.</p>
<p>The default value of the cache validity period is <code>24</code> hours.</p>
<p>You should set the cache validity period to <code>0</code> when the external registry targeted by the upstream is known to have immutable responses. This is often the case with official public registries. For more information, check your <a href="#supported-package-formats">supported package format</a>.</p>
<p>You configure the cache validity period when you create or edit an upstream.</p>
<h3>View cached packages</h3>
<p>To view packages that have been cached from upstream registries:</p>
<ol>
<li>On the top bar, select <strong>Search or go to</strong> and find your group. This group must be at the top level.</li>
<li>Select <strong>Deploy</strong> &gt; <strong>Virtual registry</strong>.</li>
<li>Under <strong>Registry types</strong>, select <strong>View registries</strong>.</li>
<li>Under the <strong>Upstreams</strong> tab, select an upstream.</li>
<li>View the cache metadata for cached packages.</li>
</ol>
<h3>Delete cache entries</h3>
<p>To delete cache entries:</p>
<ol>
<li>On the top bar, select <strong>Search or go to</strong> and find your group. This group must be at the top level.</li>
<li>Select <strong>Deploy</strong> &gt; <strong>Virtual registry</strong>.</li>
<li>Under <strong>Registry types</strong>, select <strong>View registries</strong>.</li>
<li>Under the <strong>Registries</strong> tab, select a registry.</li>
<li>Next to <strong>Upstreams</strong>, select <strong>Clear all caches</strong>.</li>
<li>To delete a specific cache entry, next to an upstream, select <strong>Clear cache</strong>.</li>
</ol>
<p>When you delete a cache entry, the next time the virtual registry receives a request for that file, it walks the list of upstreams again to find an upstream that can fulfill the request.</p>
<h3>Object storage usage</h3>
<p>Cache entries save their files in object storage in the <a href="../../../administration/object_storage.md#configure-the-parameters-of-each-object"><code>dependency_proxy</code> bucket</a>.</p>
<p>Object storage usage counts towards the top-level group <a href="../../storage_usage_quotas.md#view-storage">object storage usage limit</a>.</p>
<h2>Cleanup policies</h2>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/572839">Introduced</a> in GitLab 18.6 <a href="../../../administration/feature_flags/_index.html">with a flag</a> named <code>maven_virtual_registry</code>. Enabled by default.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>Virtual registries cache packages from upstream registries to improve performance and availability. Over time, these cached entries can accumulate and consume significant storage space. Use cleanup policies to automatically manage cached content and reduce storage usage.</p>
<p>A cleanup policy is a scheduled job that removes cached entries based on configurable rules. When a cleanup policy runs, it identifies cached entries that haven't been downloaded recently and removes them from storage.</p>
<h3>Cleanup policies workflow</h3>
<p>In the virtual registry, cleanup policies:</p>
<ol>
<li>Identify cached entries that have not been downloaded within the specified retention period.</li>
<li>Remove unused cached entries from object storage.</li>
<li>Preserve frequently accessed cached entries to maintain performance.</li>
</ol>
<p>A cleanup policy affects only cached content from upstream registries. It does not affect:</p>
<ul>
<li>Virtual registry configurations</li>
<li>Upstream registry settings</li>
<li>Packages stored in your project's package registry</li>
</ul>
<h3>Manage cleanup policies</h3>
<p>Prerequisites:</p>
<ul>
<li>You must have the Owner role for the top-level group.</li>
<li>The virtual registry must be turned on for the group.</li>
</ul>
<p>Each top-level group can have only one cleanup policy.
The cleanup policy applies to all virtual registries in that group.</p>
<p>You can manage cleanup policies using the <a href="../../../api/virtual_registries_cleanup_policies.html">Virtual registries cleanup policies API</a>.</p>
<h3>Cleanup policy settings</h3>
<p>Use the following settings to control a cleanup policy:</p>
<ul>
<li><strong>Cadence</strong>: Controls how frequently the cleanup policy runs. Available options include daily, weekly, and monthly intervals.</li>
<li><strong>Retention period</strong>: Determines how long cached entries are kept after their last download. Entries that haven't been downloaded within this period are eligible for removal.</li>
</ul>
<h3>Monitor cleanup policy execution</h3>
<p>After a cleanup policy runs, you can view the following execution metrics:</p>
<ul>
<li>When the policy last ran.</li>
<li>When the policy is scheduled to run next.</li>
<li>How many cached entries were removed.</li>
<li>Total storage space freed.</li>
<li>Any errors that occurred during execution.</li>
</ul>
<p>These metrics help you understand the effectiveness of your cleanup policy
so you can adjust settings as needed.</p>
<h2>Performance considerations</h2>
<p>Virtual registry performance might vary based on factors like:</p>
<ul>
<li>Whether or not a requested file is cached from an upstream registry</li>
<li>How quickly upstream registries can respond if a file exists or not</li>
<li>Which client is pulling dependencies, and the proximity of the client to the GitLab instance</li>
</ul>
<h3>Tradeoffs</h3>
<p>Virtual registries are more advanced than public registries.
When you pull dependencies with a virtual registry,
it might take longer than other registries, such as public, official registries.</p>
<p>Compared with public registries, virtual registries
also support multiple upstream registries and authentication.</p>
<h3>Upstream prioritization</h3>
<p>Upstream registries are organized in ordered lists. When a virtual registry receives a request for a package:</p>
<ul>
<li>The registry walks through the ordered list of upstreams to find one that can fulfill the request.</li>
<li>If the requested file is found in an upstream, the virtual registry returns that file and caches it for future requests. Caching increases the availability of dependencies if you've pulled them at least once through the virtual registry.</li>
<li>If a requested file is not found in a cache, the virtual registry walks the ordered list to find the
upstream with the highest priority that can fulfill the request.</li>
</ul>
<p>This system noticeably impacts the performance of a virtual registry.</p>
<h3>Performance improvements with usage</h3>
<p>When you create a virtual registry, the cache of each configured upstream is empty. Each request requires the virtual registry to walk the list of available upstream registries to fulfill a request. These initial requests take longer to fulfill.</p>
<p>When an upstream registry caches a request, the time to fulfill an identical request decreases. Over time, the overall performance of the virtual registry improves as more upstream registries cache more requests.</p>
<h3>Use the CI/CD cache</h3>
<p>You can use <a href="../../../ci/caching/_index.html">caching in GitLab CI/CD</a> so that jobs do not have to download dependencies from the virtual registry.</p>
<p>This method improves execution time, but also duplicates storage for each dependency (dependencies are stored in the CI/CD cache and virtual registry).</p></code></pre>
</body>
</html>
