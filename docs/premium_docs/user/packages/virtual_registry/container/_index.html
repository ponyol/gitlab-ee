<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Prerequisites</title>
    <link rel="stylesheet" href="../../../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Package
group: Container Registry
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Container virtual registry
description: Use the container virtual registry to cache container images from upstream registries.</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li>
<li>Status: Experiment</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/548794">Introduced</a> in GitLab 18.5 <a href="../../../../administration/feature_flags/_index.html">with a flag</a> named <code>container_virtual_registries</code>. Disabled by default.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>{{&lt; alert type="flag" &gt;}}</p>
<p>The availability of this feature is controlled by a feature flag.
For more information, see the history.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>The GitLab container virtual registry is a local proxy you can use to cache container images from
upstream registries. It acts as a pull-through cache, storing frequently-accessed images locally
to reduce bandwidth usage and improve build performance.</p>
<h2>Prerequisites</h2>
<p>Before you can use the container virtual registry:</p>
<ul>
<li>Review the <a href="../_index.md#prerequisites">prerequisites</a> to use the virtual registry.</li>
</ul>
<p>When using the container virtual registry, remember the following restrictions:</p>
<ul>
<li>You can create up to <code>5</code> container virtual registries per top-level group.</li>
<li>You can set only <code>5</code> upstreams to a given container virtual registry.</li>
<li>For technical reasons, the <code>proxy_download</code> setting is force enabled, no matter what the value in the <a href="../../../../administration/object_storage.md#proxy-download">object storage configuration</a> is configured to.</li>
<li>Geo support is not implemented.</li>
</ul>
<h2>Manage virtual registries</h2>
<p>To create, edit, or delete a container virtual registry, see the
<a href="../../../../api/container_virtual_registries.html">Container virtual registry API</a>.</p>
<h2>Authenticate with the container virtual registry</h2>
<p>The container virtual registry stores and
associates container images in a registry associated
with your top-level group.
To access container images, you must authenticate
with your group's container virtual registry.</p>
<p>To authenticate manually, run the following command:</p>
<pre><code class="language-shell">echo &quot;$CONTAINER_REGISTRY_PASSWORD&quot; | docker login gitlab.example.com/virtual_registries/container/1 --username &lt;your_username&gt; --password-stdin
</code></pre>
<p>Or, configure authentication with any of the methods described in <a href="../_index.md#authenticate-to-the-virtual-registry">Authenticate to the virtual registry</a>.</p>
<p>The container virtual registry follows the <a href="https://distribution.github.io/distribution/spec/auth/token/">Docker v2 token authentication flow</a>:</p>
<ol>
<li>After client authentication, a JWT token issued to the client authorizes the client to pull container images.</li>
<li>The token expires according to its expiration time.</li>
<li>When the token expires, most Docker clients store user credentials and automatically request a new token without further action.</li>
</ol>
<h2>Pull container images from the virtual registry</h2>
<p>To pull a container image through the virtual registry:</p>
<ol>
<li>Authenticate with the virtual registry.</li>
<li>Use the virtual registry URL format to pull images:</li>
</ol>
<p><code>plaintext
   gitlab.example.com/virtual_registries/container/&lt;registry_id&gt;/&lt;image_path&gt;:&lt;tag&gt;</code></p>
<p>For example:</p>
<ul>
<li>Pull an image by its tag:</li>
</ul>
<p><code>shell
  docker pull gitlab.example.com/virtual_registries/container/1/library/alpine:latest</code></p>
<ul>
<li>Pull an image by digest:</li>
</ul>
<p><code>shell
  docker pull gitlab.example.com/virtual_registries/container/1/library/alpine@sha256:c9375e662992791e3f39e919b26f510e5254b42792519c180aad254e6b38f4dc</code></p>
<ul>
<li>Pull an image in a <code>Dockerfile</code>:</li>
</ul>
<p><code>dockerfile
  FROM gitlab.example.com/virtual_registries/container/1/library/alpine:latest</code></p>
<ul>
<li>Pull an image in a <code>.gitlab-ci.yml</code> file:</li>
</ul>
<p><code>yaml
  image: gitlab.example.com/virtual_registries/container/1/library/alpine:latest</code></p>
<p>When you pull an image, the virtual registry:</p>
<ol>
<li>Checks if the image is already cached.</li>
<li>If the image is cached and still valid based on the upstream's <code>cache_validity_hours</code> setting, the image is served from the cache.</li>
<li>If the image is not cached or the cache is invalid, the image is fetched from the configured upstream registry and cached.</li>
<li>Serves the image to your Docker client.</li>
</ol>
<h3>Virtual registry cache validation for images</h3>
<p>An image tag like <code>alpine:latest</code> always pulls the most recent version of the image. The new version contains an updated image manifest. The container virtual registry does not pull a new image when the manifest changes.</p>
<p>Instead, the container virtual registry:</p>
<ol>
<li>Checks the <code>cache_validity_hours</code> setting in the upstream to determine when an image manifest is invalid.</li>
<li>Sends a HEAD request to the upstream. If the manifest is invalid, a new image is pulled.</li>
</ol>
<p>For example, if your pipeline pulls <code>node:latest</code> and you've set the <code>cache_validity_period</code> to 24 hours, the virtual registry caches the image and updates it either when the cache expires or <code>node:latest</code> changes in the upstream.</p>
<h2>Troubleshooting</h2>
<h3>Authentication error: <code>HTTP Basic: Access Denied</code></h3>
<p>If you receive an <code>HTTP Basic: Access denied</code> error when authenticating against the virtual registry,
refer to <a href="../../../profile/account/two_factor_authentication_troubleshooting.md#error-http-basic-access-denied-if-a-password-was-provided-for-git-authentication-">two-factor authentication troubleshooting</a>.</p>
<h3>Virtual registry connection failure</h3>
<p>If a service alias is not set, the <code>docker:20.10.16</code> image is unable to find the
<code>dind</code> service, and an error like the following is thrown:</p>
<pre><code class="language-plaintext">error during connect: Get http://docker:2376/v1.39/info: dial tcp: lookup docker on 192.168.0.1:53: no such host
</code></pre>
<p>To resolve this error, set a service alias for the Docker service:</p>
<pre><code class="language-yaml">services:
  - name: docker:20.10.16-dind
    alias: docker
</code></pre>
<h3>Virtual registry authentication issues from CI/CD jobs</h3>
<p>GitLab Runner authenticates automatically using the CI/CD job token. However, the underlying Docker engine
is still subject to its <a href="https://docs.gitlab.com/runner/configuration/advanced-configuration.html#precedence-of-docker-authorization-resolving">authorization resolving process</a>.</p>
<p>Misconfigurations in the authentication mechanism may cause <code>HTTP Basic: Access denied</code> and <code>403: Access forbidden</code> errors.</p>
<p>You can use the job logs to view the authentication mechanism used to authenticate against the virtual registry:</p>
<pre><code class="language-plaintext">Authenticating with credentials from $DOCKER_AUTH_CONFIG
</code></pre>
<pre><code class="language-plaintext">Authenticating with credentials from /root/.docker/config.json
</code></pre>
<pre><code class="language-plaintext">Authenticating with credentials from job payload (GitLab Registry)
</code></pre>
<p>Make sure you are using the expected authentication mechanism.</p>
<h3><code>Not Found</code> or <code>404</code> error when pulling image</h3>
<p>Errors like these might indicate that:</p>
<ul>
<li>The user running the job does not have at least the Guest role for the group that owns the virtual registry.</li>
<li>The virtual registry ID in the URL is incorrect.</li>
<li>The upstream registry does not contain the requested image.</li>
<li>The virtual registry has no upstreams configured.</li>
</ul>
<p>Example error messages:</p>
<pre><code class="language-plaintext">ERROR: gitlab.example.com/virtual_registries/container/1/library/alpine:latest: not found
</code></pre>
<pre><code class="language-plaintext">ERROR: Job failed: failed to pull image &quot;gitlab.example.com/virtual_registries/container/1/library/alpine:latest&quot; with specified policies [always]:
Error response from daemon: error parsing HTTP 404 response body: unexpected end of JSON input: &quot;&quot; (manager.go:237:1s)
</code></pre>
<p>To resolve these errors:</p>
<ol>
<li>Verify you have at least the Guest role for the group.</li>
<li>Confirm the virtual registry ID is correct.</li>
<li>Check that the virtual registry has at least one upstream configured.</li>
<li>Verify the image exists in the upstream registry.</li>
</ol></code></pre>
</body>
</html>
