<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Enforce 2FA for all users</title>
    <link rel="stylesheet" href="/../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Software Supply Chain Security
group: Authentication
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Enforce two-factor authentication</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Free, Premium, Ultimate</li>
<li>Offering: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p><a href="../user/profile/account/two_factor_authentication.html">Two-factor authentication (2FA)</a>
is an authentication method that requires the user to provide two different factors
to prove their identity:</p>
<ul>
<li>Username and password.</li>
<li>A second authentication method, such as a code generated by an application.</li>
</ul>
<p>2FA makes it harder for an unauthorized person to access an account because
they would need both factors.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>If you are <a href="../user/group/saml_sso/_index.md#sso-enforcement">using and enforcing SSO</a>, you might already be enforcing 2FA on the identity provider (IdP) side. Enforcing 2FA on GitLab as well might be unnecessary.</p>
<p>{{&lt; /alert &gt;}}</p>
<h2>Enforce 2FA for all users</h2>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Free, Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>Administrators can enforce 2FA for all users in two different ways:</p>
<ul>
<li>Enforce on next sign in.</li>
<li>Suggest on next sign in, but allow a grace period before enforcing.</li>
</ul>
<p>After the configured grace period has elapsed, users can sign in but
  cannot leave the 2FA configuration area at <code>/-/profile/two_factor_auth</code>.</p>
<p>You can use the UI or the API to enforce 2FA for all users.</p>
<h3>Use the UI</h3>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>Select <strong>Settings</strong> &gt; <strong>General</strong>.</li>
<li>Expand <strong>Sign-in restrictions</strong>:</li>
<li>Select <strong>Enforce two-factor authentication</strong> to enable this feature.</li>
<li>In <strong>Two-factor grace period</strong>, enter a number of hours. If you want to
     enforce 2FA on next sign-in attempt, enter <code>0</code>.</li>
</ol>
<h3>Use the API</h3>
<p>Use the <a href="../api/settings.html">application settings API</a> to modify the following settings:</p>
<ul>
<li><code>require_two_factor_authentication</code>.</li>
<li><code>two_factor_grace_period</code>.</li>
</ul>
<p>For more information, see the <a href="../api/settings.md#available-settings">list of settings that can be accessed through API calls</a>.</p>
<h2>Enforce 2FA for Administrator users</h2>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Free, Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/427549">Introduced</a> in GitLab 16.8.</li>
<li>Support for enforcing 2FA for regular users who have custom admin roles <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/556110">introduced</a> in GitLab 18.3.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>Administrators can enforce 2FA for both:</p>
<ul>
<li>Administrator users.</li>
<li>
<p>Regular users who have been assigned a <a href="../user/custom_roles/_index.html">custom admin role</a>.</p>
</li>
<li>
<p>In the upper-right corner, select <strong>Admin</strong>.</p>
</li>
<li>On the left sidebar, select <strong>Settings</strong> &gt; <strong>General</strong>.</li>
<li>Expand the <strong>Sign-in restrictions</strong> section:</li>
<li>Select <strong>Require administrators to enable 2FA</strong>.</li>
<li>In <strong>Two-factor grace period</strong>, enter a number of hours. If you want to
     enforce 2FA on the next sign-in attempt, enter <code>0</code>.</li>
<li>Select <strong>Save changes</strong>.</li>
</ul>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>If you are using an external provider to sign in into GitLab, this setting will <strong>not</strong> enforce 2FA for users. 2FA should be enabled on that external provider.</p>
<p>{{&lt; /alert &gt;}}</p>
<h2>Enforce 2FA for all users in a group</h2>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Free, Premium, Ultimate</li>
<li>Offering: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>You can enforce 2FA for all users in a group or subgroup.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<ul>
<li>2FA enforcement applies to both
  <a href="../user/project/members/_index.md#membership-types">direct and inherited members</a> group members.</li>
<li>If 2FA is enforced on a subgroup, inherited members must enroll an authentication factor.
  Inherited members are members of the ancestor groups.</li>
<li>Email OTP does not satisfy the 2FA requirement. Members must configure either an app-based TOTP or WebAuthn.</li>
</ul>
<p>{{&lt; /alert &gt;}}</p>
<p>Prerequisites:</p>
<ul>
<li>You must have the Owner role for the group.</li>
</ul>
<p>To enforce 2FA for a group:</p>
<ol>
<li>On the top bar, select <strong>Search or go to</strong> and find your group.</li>
<li>Select <strong>Settings</strong> &gt; <strong>General</strong>.</li>
<li>Expand <strong>Permissions and group features</strong>.</li>
<li>Select <strong>All users in this group must set up two-factor authentication</strong>.</li>
<li>Optional. In <strong>Delay 2FA enforcement (hours)</strong>, enter the number of hours you
   want the grace period to last for.
   If there are multiple different grace periods in a top-level group and its subgroups
   and projects, the shortest grace period is used.</li>
<li>Select <strong>Save changes</strong>.</li>
</ol>
<p>Access tokens are not required to provide a second factor for authentication because
they are API-based. Tokens generated before 2FA is enforced remain valid.</p>
<p>The GitLab <a href="../administration/incoming_email.html">incoming email</a> feature does not follow 2FA enforcement. Users can use incoming email features such as creating issues or commenting on merge requests without having to authenticate themselves using 2FA first. This applies even if 2FA is enforced.</p>
<h3>2FA in subgroups</h3>
<p>By default, each subgroup can configure 2FA requirements that might differ from the top-level group.</p>
<p>When a user is a member of multiple groups in a hierarchy, the most restrictive 2FA requirement applies across all levels.</p>
<p>For example, when 2FA is enforced in a top-level group:</p>
<ul>
<li>All members of the top-level group must use 2FA.</li>
<li>All members of descendant subgroups must use 2FA.</li>
</ul>
<p>When 2FA is not enforced in a top-level group:</p>
<ul>
<li>If <strong>Allow more restrictive 2FA enforcement for subgroups</strong> is enabled, each subgroup
  can enforce a 2FA requirement independently.
  If a subgroup enables a 2FA requirement:</li>
<li>All members of the top-level group must use 2FA.</li>
<li>
<p>All members of any sibling subgroups must use 2FA.</p>
</li>
<li>
<p>If <strong>Allow more restrictive 2FA enforcement for subgroups</strong> is disabled, subgroups
  cannot enforce a 2FA requirement independently. 2FA is not required for any members in the hierarchy.</p>
</li>
</ul>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>When <strong>All users in this group must set up two-factor authentication</strong> is enabled, it always
takes precedence over <strong>Allow more restrictive 2FA enforcement for subgroups</strong>.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>To prevent subgroups from setting individual 2FA requirements:</p>
<ol>
<li>Go to the top-level group's <strong>Settings</strong> &gt; <strong>General</strong>.</li>
<li>Expand the <strong>Permissions and group features</strong> section.</li>
<li>Clear the <strong>Allow more restrictive 2FA enforcement for subgroups</strong> checkbox.</li>
</ol>
<h3>2FA in projects</h3>
<p>If a project belonging to a group that enables or enforces 2FA is <a href="../user/project/members/sharing_projects_groups.html">shared</a>
with a group that does not enable or enforce 2FA, members of the non-2FA group can access that project
without using 2FA. For example:</p>
<ul>
<li>Group A has 2FA enabled and enforced. Group B does not have 2FA enabled.</li>
<li>If a project, P, that belongs to group A is shared with group B, members
  of group B can access project P without 2FA.</li>
</ul>
<p>To ensure this does not occur, <a href="../user/project/members/sharing_projects_groups.md#prevent-a-project-from-being-shared-with-groups">prevent sharing of projects</a>
for the 2FA group.</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>If you add members to a project in a group or subgroup that has 2FA
enabled, 2FA is <strong>not</strong> required for those individually added members.</p>
<p>{{&lt; /alert &gt;}}</p>
<h2>Disable 2FA</h2>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Free, Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>You can disable 2FA for a single user or all users.</p>
<p>This action is permanent and irreversible. Users must reactivate 2FA to use it again.</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>Disabling 2FA for users does not disable the <a href="#enforce-2fa-for-all-users">enforce 2FA for all users</a>
or <a href="#enforce-2fa-for-all-users-in-a-group">enforce 2FA for all users in a group</a>
settings. You must also disable any enforced 2FA settings so users aren't asked to set up 2FA again
when they next sign in to GitLab.</p>
<p>{{&lt; /alert &gt;}}</p>
<h3>For all users</h3>
<p>To disable 2FA for all users even when forced 2FA is disabled, use the following Rake task.</p>
<ul>
<li>For installations that use the Linux package:</li>
</ul>
<p><code>shell
  sudo gitlab-rake gitlab:two_factor:disable_for_all_users</code></p>
<ul>
<li>For self-compiled installations:</li>
</ul>
<p><code>shell
  sudo -u git -H bundle exec rake gitlab:two_factor:disable_for_all_users RAILS_ENV=production</code></p>
<h3>For a single user</h3>
<h4>Administrators</h4>
<p>It is possible to use the <a href="../administration/operations/rails_console.html">Rails console</a>
to disable 2FA for a single administrator:</p>
<pre><code class="language-ruby">admin = User.find_by_username('&lt;USERNAME&gt;')
user_to_disable = User.find_by_username('&lt;USERNAME&gt;')

TwoFactor::DestroyService.new(admin, user: user_to_disable).execute
</code></pre>
<p>The administrator is notified that 2FA has been disabled.</p>
<h4>Non-administrators</h4>
<p>You can use either the Rails console or the
<a href="../api/users.md#disable-two-factor-authentication-for-a-user">API endpoint</a> to disable 2FA
for a non-administrator.</p>
<p>You can disable 2FA for your own account.</p>
<p>You cannot use the API endpoint to disable 2FA for administrators.</p>
<h4>Enterprise users</h4>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>Top-level group Owners can disable two-factor authentication (2FA) for enterprise users.</p>
<p>To disable 2FA:</p>
<ol>
<li>On the top bar, select <strong>Search or go to</strong> and find your group.</li>
<li>Select <strong>Manage</strong> &gt; <strong>Members</strong>.</li>
<li>Find a user with the <strong>Enterprise</strong> and <strong>2FA</strong> badges.</li>
<li>Select <strong>More actions</strong> ({{&lt; icon name="ellipsis_v" &gt;}}) and select <strong>Disable two-factor authentication</strong>.</li>
</ol>
<p>You can also <a href="../api/group_enterprise_users.md#disable-two-factor-authentication-for-an-enterprise-user">use the API</a> to disable 2FA for enterprise users, including enterprise users who are no longer a member of the group.</p>
<h2>2FA for Git over SSH operations</h2>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; alert type="flag" &gt;}}</p>
<p>By default this feature is not available. To make it available, an administrator can <a href="../administration/feature_flags/_index.html">enable the feature flag</a> named <code>two_factor_for_cli</code>. This feature is not ready for production use. This feature flag also affects <a href="../administration/settings/account_and_limit_settings.md#customize-session-duration-for-git-operations-when-2fa-is-enabled">session duration for Git Operations when 2FA is enabled</a>.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>You can enforce 2FA for Git over SSH operations. However, you should use <code>ED25519_SK</code> or <code>ECDSA_SK</code>
SSH keys instead. For more information, see <a href="../user/ssh.md#supported-ssh-key-types">supported SSH key types</a>.
2FA is enforced for Git operations only, and internal commands from GitLab Shell such as
<code>personal_access_token</code> are excluded.</p>
<p>To perform one-time password (OTP) verification, run:</p>
<pre><code class="language-shell">ssh git@&lt;hostname&gt; 2fa_verify
</code></pre>
<p>Then authenticate by either:</p>
<ul>
<li>Entering the correct OTP.</li>
<li>Responding to a device push notification if
  <a href="../user/profile/account/two_factor_authentication.md#add-a-fortiauthenticator-authenticator">FortiAuthenticator is enabled</a>.</li>
</ul>
<p>After successful authentication, you can perform Git over SSH operations for 15 minutes (default) with the associated
SSH key.</p>
<h3>Security limitation</h3>
<p>2FA does not protect users with compromised private SSH keys.</p>
<p>Once an OTP is verified, anyone can run Git over SSH with that private SSH key for
the configured <a href="../administration/settings/account_and_limit_settings.md#customize-session-duration-for-git-operations-when-2fa-is-enabled">session duration</a>.</p></code></pre>
</body>
</html>
