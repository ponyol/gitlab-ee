<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Add new endpoints</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Create
group: Source Code
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Internal API</p>
<hr />
<p>The internal API is used by different GitLab components, it cannot be
used by other consumers. This documentation is intended for people
working on the GitLab codebase.</p>
<p>This documentation does not yet include the internal API used by
GitLab Pages.</p>
<p>For information on the GitLab Subscriptions internal API, see <a href="gitlab_subscriptions.html">the dedicated page</a>.</p>
<h2>Add new endpoints</h2>
<p>API endpoints should be externally accessible by default, with proper authentication and authorization.
Before adding a new internal endpoint, consider if the API would benefit the wider GitLab community and can be made externally accessible.</p>
<p>One reason we might favor internal API endpoints sometimes is when using such an endpoint requires
internal data that external actors cannot have. For example, in the internal Pages API we might use
a secret token that identifies a request as internal or sign a request with a public key that is
not available to a wider community.</p>
<p>Another reason to separate something into an internal API is when request to such API endpoint
should never go through an edge (public) load balancer. This way we can configure different rate
limiting rules and policies around how the endpoint is being accessed, because we know that only
internal requests can be made to that endpoint going through an internal load balancer.</p>
<h2>Authentication</h2>
<p>These methods are all authenticated using a shared secret. This secret
is stored in a file at the path configured in <code>config/gitlab.yml</code> by
default this is in the root of the rails app named
<code>.gitlab_shell_secret</code></p>
<p>To authenticate using that token, clients:</p>
<ol>
<li>Read the contents of that file.</li>
<li>Use the file contents to generate a JSON Web Token (<code>JWT</code>).</li>
<li>Pass the JWT in the <code>Gitlab-Shell-Api-Request</code> header.</li>
</ol>
<h2>Git Authentication</h2>
<p>Called by <a href="https://gitlab.com/gitlab-org/gitaly">Gitaly</a> and
<a href="https://gitlab.com/gitlab-org/gitlab-shell">GitLab Shell</a> to check access to a
repository.</p>
<ul>
<li>When called from GitLab Shell: No changes are passed, and the internal
  API replies with the information needed to pass the request on to Gitaly.</li>
<li>When called from Gitaly in a <code>pre-receive</code> hook: The changes are passed
  and validated to determine if the push is allowed.</li>
</ul>
<p>Calls are limited to 50 seconds each.</p>
<p>This endpoint is covered in more detail on <a href="internal_api_allowed.html">its own page</a>, due to the scope of what it covers.</p>
<pre><code class="language-plaintext">POST /internal/allowed
</code></pre>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>key_id</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">ID of the SSH-key used to connect to GitLab Shell</td>
</tr>
<tr>
<td style="text-align: left;"><code>username</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Username from the certificate used to connect to GitLab Shell</td>
</tr>
<tr>
<td style="text-align: left;"><code>project</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no (if <code>gl_repository</code> is passed)</td>
<td style="text-align: left;">Path to the project</td>
</tr>
<tr>
<td style="text-align: left;"><code>gl_repository</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no (if <code>project</code> is passed)</td>
<td style="text-align: left;">Repository identifier, such as <code>project-7</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>protocol</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">SSH when called from GitLab Shell, HTTP or SSH when called from Gitaly</td>
</tr>
<tr>
<td style="text-align: left;"><code>action</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">Git command being run (<code>git-upload-pack</code>, <code>git-receive-pack</code>, <code>git-upload-archive</code>)</td>
</tr>
<tr>
<td style="text-align: left;"><code>changes</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;"><code>&lt;oldrev&gt; &lt;newrev&gt; &lt;refname&gt;</code> when called from Gitaly, the magic string <code>_any</code> when called from GitLab Shell</td>
</tr>
<tr>
<td style="text-align: left;"><code>check_ip</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">IP address from which call to GitLab Shell was made</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre><code class="language-shell">curl --request POST --header &quot;Gitlab-Shell-Api-Request: &lt;JWT token&gt;&quot; \
     --data &quot;key_id=11&amp;project=gnuwget/wget2&amp;action=git-upload-pack&amp;protocol=ssh&quot; \
     &quot;http://localhost:3001/api/v4/internal/allowed&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;status&quot;: true,
  &quot;gl_repository&quot;: &quot;project-3&quot;,
  &quot;gl_project_path&quot;: &quot;gnuwget/wget2&quot;,
  &quot;gl_id&quot;: &quot;user-1&quot;,
  &quot;gl_username&quot;: &quot;root&quot;,
  &quot;git_config_options&quot;: [],
  &quot;gitaly&quot;: {
    &quot;repository&quot;: {
      &quot;storage_name&quot;: &quot;default&quot;,
      &quot;relative_path&quot;: &quot;@hashed/4e/07/4e07408562bedb8b60ce05c1decfe3ad16b72230967de01f640b7e4729b49fce.git&quot;,
      &quot;git_object_directory&quot;: &quot;&quot;,
      &quot;git_alternate_object_directories&quot;: [],
      &quot;gl_repository&quot;: &quot;project-3&quot;,
      &quot;gl_project_path&quot;: &quot;gnuwget/wget2&quot;
    },
    &quot;address&quot;: &quot;unix:/Users/bvl/repos/gitlab/gitaly.socket&quot;,
    &quot;token&quot;: null
  },
  &quot;gl_console_messages&quot;: []
}
</code></pre>
<h3>Known consumers</h3>
<ul>
<li>Gitaly</li>
<li>GitLab Shell</li>
</ul>
<h2>LFS Authentication</h2>
<p>This is the endpoint that gets called from GitLab Shell to provide
information for LFS clients when the repository is accessed over SSH.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>key_id</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">ID of the SSH-key used to connect to GitLab Shell</td>
</tr>
<tr>
<td style="text-align: left;"><code>username</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Username from the certificate used to connect to GitLab Shell</td>
</tr>
<tr>
<td style="text-align: left;"><code>project</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Path to the project</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre><code class="language-shell">curl --request POST --header &quot;Gitlab-Shell-Api-Request: &lt;JWT token&gt;&quot; \
     --data &quot;key_id=11&amp;project=gnuwget/wget2&quot; &quot;http://localhost:3001/api/v4/internal/lfs_authenticate&quot;
</code></pre>
<pre><code class="language-json">{
  &quot;username&quot;: &quot;root&quot;,
  &quot;lfs_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7ImFjdG9yIjoicm9vdCJ9LCJqdGkiOiIyYWJhZDcxZC0xNDFlLTQ2NGUtOTZlMi1mODllYWRiMGVmZTYiLCJpYXQiOjE1NzAxMTc2NzYsIm5iZiI6MTU3MDExNzY3MSwiZXhwIjoxNTcwMTE5NDc2fQ.g7atlBw1QMY7QEBVPE0LZ8ZlKtaRzaMRmNn41r2YITM&quot;,
  &quot;repository_http_path&quot;: &quot;http://localhost:3001/gnuwget/wget2.git&quot;,
  &quot;expires_in&quot;: 1800
}
</code></pre>
<h3>Known consumers</h3>
<ul>
<li>GitLab Shell</li>
</ul>
<h2>Authorized Keys Check</h2>
<p>This endpoint is called by the GitLab Shell authorized keys
check. Which is called by OpenSSH or GitLab SSHD for
<a href="../../administration/operations/fast_ssh_key_lookup.html">fast SSH key lookup</a>.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>key</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">An authorized key used for public key authentication.</td>
</tr>
</tbody>
</table>
<pre><code class="language-plaintext">GET /internal/authorized_keys
</code></pre>
<p>Example request:</p>
<pre><code class="language-shell">curl --request GET --header &quot;Gitlab-Shell-Api-Request: &lt;JWT token&gt;&quot; &quot;http://localhost:3001/api/v4/internal/authorized_keys?key=&lt;key&gt;&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;id&quot;: 11,
  &quot;title&quot;: &quot;admin@example.com&quot;,
  &quot;key&quot;: &quot;ssh-rsa ...&quot;,
  &quot;created_at&quot;: &quot;2019-06-27T15:29:02.219Z&quot;
}
</code></pre>
<h3>Known consumers</h3>
<ul>
<li>GitLab Shell</li>
</ul>
<h2>Authorized Certs</h2>
<p>This endpoint is called by the GitLab Shell to get the namespace that has a particular CA SSH certificate
configured. It also accepts <code>user_identifier</code> to return a GitLab user for specified identifier.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>key</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">The fingerprint of the SSH certificate.</td>
</tr>
<tr>
<td style="text-align: left;"><code>user_identifier</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">The identifier of the user to whom the SSH certificate has been issued (username or primary email).</td>
</tr>
</tbody>
</table>
<pre><code class="language-plaintext">GET /internal/authorized_certs
</code></pre>
<p>Example request:</p>
<pre><code class="language-shell">curl --request GET --header &quot;Gitlab-Shell-Api-Request: &lt;JWT token&gt;&quot; &quot;http://localhost:3001/api/v4/internal/authorized_certs?key=&lt;key&gt;&amp;user_identifier=&lt;user_identifier&gt;&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;success&quot;: true,
  &quot;namespace&quot;: &quot;gitlab-org&quot;,
  &quot;username&quot;: &quot;root&quot;
}
</code></pre>
<h3>Known consumers</h3>
<ul>
<li>GitLab Shell</li>
</ul>
<h2>Get user for user ID or key</h2>
<p>This endpoint is used when a user performs <code>ssh git@gitlab.com</code>. It
discovers the user associated with an SSH key.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>key_id</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The ID of the SSH key used as found in the authorized-keys file or through the <code>/authorized_keys</code> check</td>
</tr>
<tr>
<td style="text-align: left;"><code>username</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Username of the user being looked up, used by GitLab Shell when authenticating using a certificate</td>
</tr>
</tbody>
</table>
<pre><code class="language-plaintext">GET /internal/discover
</code></pre>
<p>Example request:</p>
<pre><code class="language-shell">curl --request GET --header &quot;Gitlab-Shell-Api-Request: &lt;JWT token&gt;&quot; &quot;http://localhost:3001/api/v4/internal/discover?key_id=7&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;id&quot;: 7,
  &quot;name&quot;: &quot;Dede Eichmann&quot;,
  &quot;username&quot;: &quot;rubi&quot;
}
</code></pre>
<h3>Known consumers</h3>
<ul>
<li>GitLab Shell</li>
</ul>
<h2>Instance information</h2>
<p>This gets some generic information about the instance. It's used
by Geo nodes to get information about each other.</p>
<pre><code class="language-plaintext">GET /internal/check
</code></pre>
<p>Example request:</p>
<pre><code class="language-shell">curl --request GET --header &quot;Gitlab-Shell-Api-Request: &lt;JWT token&gt;&quot; &quot;http://localhost:3001/api/v4/internal/check&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;api_version&quot;: &quot;v4&quot;,
  &quot;gitlab_version&quot;: &quot;12.3.0-pre&quot;,
  &quot;gitlab_rev&quot;: &quot;d69c988e6a6&quot;,
  &quot;redis&quot;: true
}
</code></pre>
<h3>Known consumers</h3>
<ul>
<li>GitLab Geo</li>
<li>GitLab Shell's <code>bin/check</code></li>
<li>Gitaly</li>
</ul>
<h2>Get new 2FA recovery codes using an SSH key</h2>
<p>This is called from GitLab Shell and allows users to get new 2FA
recovery codes based on their SSH key.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>key_id</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The ID of the SSH key used as found in the authorized-keys file or through the <code>/authorized_keys</code> check</td>
</tr>
<tr>
<td style="text-align: left;"><code>user_id</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Deprecated. User ID for which to generate new recovery codes</td>
</tr>
</tbody>
</table>
<pre><code class="language-plaintext">GET /internal/two_factor_recovery_codes
</code></pre>
<p>Example request:</p>
<pre><code class="language-shell">curl --request POST --header &quot;Gitlab-Shell-Api-Request: &lt;JWT token&gt;&quot; \
     --data &quot;key_id=7&quot; &quot;http://localhost:3001/api/v4/internal/two_factor_recovery_codes&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;success&quot;: true,
  &quot;recovery_codes&quot;: [
    &quot;d93ee7037944afd5&quot;,
    &quot;19d7b84862de93dd&quot;,
    &quot;1e8c52169195bf71&quot;,
    &quot;be50444dddb7ca84&quot;,
    &quot;26048c77d161d5b7&quot;,
    &quot;482d5c03d1628c47&quot;,
    &quot;d2c695e309ce7679&quot;,
    &quot;dfb4748afc4f12a7&quot;,
    &quot;0e5f53d1399d7979&quot;,
    &quot;af04d5622153b020&quot;
  ]
}
</code></pre>
<h3>Known consumers</h3>
<ul>
<li>GitLab Shell</li>
</ul>
<h2>Get new personal access-token</h2>
<p>Called from GitLab Shell and allows users to generate a new
personal access token.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>name</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">The name of the new token</td>
</tr>
<tr>
<td style="text-align: left;"><code>scopes</code></td>
<td style="text-align: left;">string array</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">The authorization scopes for the new token, these must be valid token scopes</td>
</tr>
<tr>
<td style="text-align: left;"><code>expires_at</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Expiration date of the access token in ISO format (<code>YYYY-MM-DD</code>).</td>
</tr>
<tr>
<td style="text-align: left;"><code>key_id</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The ID of the SSH key used as found in the authorized-keys file or through the <code>/authorized_keys</code> check</td>
</tr>
<tr>
<td style="text-align: left;"><code>user_id</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">User ID for which to generate the new token</td>
</tr>
</tbody>
</table>
<pre><code class="language-plaintext">POST /internal/personal_access_token
</code></pre>
<p>Example request:</p>
<pre><code class="language-shell">curl --request POST --header &quot;Gitlab-Shell-Api-Request: &lt;JWT token&gt;&quot; \
     --data &quot;user_id=29&amp;name=mytokenname&amp;scopes[]=read_user&amp;scopes[]=read_repository&amp;expires_at=2020-07-24&quot; \
     &quot;http://localhost:3001/api/v4/internal/personal_access_token&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;success&quot;: true,
  &quot;token&quot;: &quot;Hf_79B288hRv_3-TSD1R&quot;,
  &quot;scopes&quot;: [&quot;read_user&quot;,&quot;read_repository&quot;],
  &quot;expires_at&quot;: &quot;2020-07-24&quot;
}
</code></pre>
<h3>Known consumers</h3>
<ul>
<li>GitLab Shell</li>
</ul>
<h2>Authenticate Error Tracking requests</h2>
<p>This endpoint is called by the error tracking Go REST API application to authenticate a project.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>project_id</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">The ID of the project which has the associated key.</td>
</tr>
<tr>
<td style="text-align: left;"><code>public_key</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">The <a href="../../api/error_tracking.md#create-a-client-key">public key</a> generated by the integrated Error Tracking feature.</td>
</tr>
</tbody>
</table>
<pre><code class="language-plaintext">POST /internal/error_tracking/allowed
</code></pre>
<p>Example request:</p>
<pre><code class="language-shell">curl --request POST --header &quot;Gitlab-Shell-Api-Request: &lt;JWT token&gt;&quot; \
     --data &quot;project_id=111&amp;public_key=generated-error-tracking-key&quot; \
          &quot;http://localhost:3001/api/v4/internal/error_tracking/allowed&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{ &quot;enabled&quot;: true }
</code></pre>
<h3>Known consumers</h3>
<ul>
<li>OpsTrace</li>
</ul>
<h2>Incrementing counter on pre-receive</h2>
<p>This is called from the Gitaly hooks increasing the reference counter
for a push that might be accepted.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>gl_repository</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">repository identifier for the repository receiving the push</td>
</tr>
</tbody>
</table>
<pre><code class="language-plaintext">POST /internal/pre_receive
</code></pre>
<p>Example request:</p>
<pre><code class="language-shell">curl --request POST --header &quot;Gitlab-Shell-Api-Request: &lt;JWT token&gt;&quot; \
     --data &quot;gl_repository=project-7&quot; &quot;http://localhost:3001/api/v4/internal/pre_receive&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;reference_counter_increased&quot;: true
}
</code></pre>
<h2>PostReceive</h2>
<p>Called from Gitaly after a receiving a push. This triggers the
<code>PostReceive</code>-worker in Sidekiq, processes the passed push options and
builds the response including messages that need to be displayed to
the user.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>identifier</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;"><code>user-[id]</code> or <code>key-[id]</code> Identifying the user performing the push</td>
</tr>
<tr>
<td style="text-align: left;"><code>gl_repository</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">identifier of the repository being pushed to</td>
</tr>
<tr>
<td style="text-align: left;"><code>push_options</code></td>
<td style="text-align: left;">string array</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">array of push options</td>
</tr>
<tr>
<td style="text-align: left;"><code>changes</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">refs to be updated in the push in the format <code>oldrev newrev refname\n</code>.</td>
</tr>
</tbody>
</table>
<pre><code class="language-plaintext">POST /internal/post_receive
</code></pre>
<p>Example Request:</p>
<pre><code class="language-shell">curl --request POST --header &quot;Gitlab-Shell-Api-Request: &lt;JWT token&gt;&quot; \
     --data &quot;gl_repository=project-7&quot; --data &quot;identifier=user-1&quot; \
     --data &quot;changes=0000000000000000000000000000000000000000 fd9e76b9136bdd9fe217061b497745792fe5a5ee gh-pages\n&quot; \
     &quot;http://localhost:3001/api/v4/internal/post_receive&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;messages&quot;: [
    {
      &quot;message&quot;: &quot;Hello from post-receive&quot;,
      &quot;type&quot;: &quot;alert&quot;
    }
  ],
  &quot;reference_counter_decreased&quot;: true
}
</code></pre>
<h2>GitLab agent for Kubernetes endpoints</h2>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/432773">Feature flag removed</a> in GitLab 16.7.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>The following endpoints are used by the GitLab agent server for Kubernetes (<code>kas</code>)
for various purposes.</p>
<p>These endpoints are all authenticated using JWT. The JWT secret is stored in a file
specified in <code>config/gitlab.yml</code>. By default, the location is in the root of the
GitLab Rails app in a file called <code>.gitlab_kas_secret</code>.</p>
<h3>GitLab agent for Kubernetes information</h3>
<p>Called from the GitLab agent server for Kubernetes (<code>kas</code>) to retrieve agent
information for the given agent token. This returns the Gitaly connection
information for the agent's project in order for <code>kas</code> to fetch and update
the agent's configuration.</p>
<pre><code class="language-plaintext">GET /internal/kubernetes/agent_info
</code></pre>
<p>Example Request:</p>
<pre><code class="language-shell">curl --request GET --header &quot;Gitlab-Kas-Api-Request: &lt;JWT token&gt;&quot; \
     --header &quot;Authorization: Bearer &lt;agent token&gt;&quot; &quot;http://localhost:3000/api/v4/internal/kubernetes/agent_info&quot;
</code></pre>
<h3>GitLab agent for Kubernetes project information</h3>
<p>Called from the GitLab agent server for Kubernetes (<code>kas</code>) to retrieve project
information for the given agent token. This returns the Gitaly
connection for the requested project. GitLab <code>kas</code> uses this to configure
the agent to fetch Kubernetes resources from the project repository to
sync.</p>
<p>Only public projects are supported. For private projects, the ability for the
agent to be authorized is <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/220912">not yet implemented</a>.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>id</code></td>
<td style="text-align: left;">integer/string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">The ID or <a href="../../api/rest/_index.md#namespaced-paths">URL-encoded path of the project</a></td>
</tr>
</tbody>
</table>
<pre><code class="language-plaintext">GET /internal/kubernetes/project_info
</code></pre>
<p>Example Request:</p>
<pre><code class="language-shell">curl --request GET --header &quot;Gitlab-Kas-Api-Request: &lt;JWT token&gt;&quot; \
     --header &quot;Authorization: Bearer &lt;agent token&gt;&quot; &quot;http://localhost:3000/api/v4/internal/kubernetes/project_info?id=7&quot;
</code></pre>
<h3>GitLab agent for Kubernetes usage metrics</h3>
<p>Called from the GitLab agent server for Kubernetes (<code>kas</code>) to increase the usage
metric counters.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>counters</code></td>
<td style="text-align: left;">hash</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Hash of counters</td>
</tr>
<tr>
<td style="text-align: left;"><code>counters["k8s_api_proxy_request"]</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The number to increase the <code>k8s_api_proxy_request</code> counter by</td>
</tr>
<tr>
<td style="text-align: left;"><code>counters["flux_git_push_notifications_total"]</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The number to increase the <code>flux_git_push_notifications_total</code> counter by</td>
</tr>
<tr>
<td style="text-align: left;"><code>counters["k8s_api_proxy_requests_via_ci_access"]</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The number to increase the <code>k8s_api_proxy_requests_via_ci_access</code> counter by</td>
</tr>
<tr>
<td style="text-align: left;"><code>counters["k8s_api_proxy_requests_via_user_access"]</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The number to increase the <code>k8s_api_proxy_requests_via_user_access</code> counter by</td>
</tr>
<tr>
<td style="text-align: left;"><code>counters["k8s_api_proxy_requests_via_pat_access"]</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The number to increase the <code>k8s_api_proxy_requests_via_pat_access</code> counter by</td>
</tr>
<tr>
<td style="text-align: left;"><code>unique_counters</code></td>
<td style="text-align: left;">hash</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Array of unique numbers</td>
</tr>
<tr>
<td style="text-align: left;"><code>unique_counters["k8s_api_proxy_requests_unique_users_via_ci_access"]</code></td>
<td style="text-align: left;">integer array</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The set of unique user ids that have interacted a CI Tunnel via <code>ci_access</code> to track the <code>k8s_api_proxy_requests_unique_users_via_ci_access</code> metric event</td>
</tr>
<tr>
<td style="text-align: left;"><code>unique_counters["k8s_api_proxy_requests_unique_agents_via_ci_access"]</code></td>
<td style="text-align: left;">integer array</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The set of unique agent ids that have interacted a CI Tunnel via <code>ci_access</code> to track the <code>k8s_api_proxy_requests_unique_agents_via_ci_access</code> metric event</td>
</tr>
<tr>
<td style="text-align: left;"><code>unique_counters["k8s_api_proxy_requests_unique_users_via_user_access"]</code></td>
<td style="text-align: left;">integer array</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The set of unique user ids that have interacted a CI Tunnel via <code>user_access</code> to track the <code>k8s_api_proxy_requests_unique_users_via_user_access</code> metric event</td>
</tr>
<tr>
<td style="text-align: left;"><code>unique_counters["k8s_api_proxy_requests_unique_agents_via_user_access"]</code></td>
<td style="text-align: left;">integer array</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The set of unique agent ids that have interacted a CI Tunnel via <code>user_access</code> to track the <code>k8s_api_proxy_requests_unique_agents_via_user_access</code> metric event</td>
</tr>
<tr>
<td style="text-align: left;"><code>unique_counters["k8s_api_proxy_requests_unique_users_via_pat_access"]</code></td>
<td style="text-align: left;">integer array</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The set of unique user ids that have used the KAS Kubernetes API proxy with PAT to track the <code>k8s_api_proxy_requests_unique_users_via_pat_access</code> metric event</td>
</tr>
<tr>
<td style="text-align: left;"><code>unique_counters["k8s_api_proxy_requests_unique_agents_via_pat_access"]</code></td>
<td style="text-align: left;">integer array</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The set of unique agent ids that have used the KAS Kubernetes API proxy with PAT to track the <code>k8s_api_proxy_requests_unique_agents_via_pat_access</code> metric event</td>
</tr>
<tr>
<td style="text-align: left;"><code>unique_counters["flux_git_push_notified_unique_projects"]</code></td>
<td style="text-align: left;">integer array</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The set of unique projects ids that have been notified to reconcile their Flux workloads to track the <code>flux_git_push_notified_unique_projects</code> metric event</td>
</tr>
</tbody>
</table>
<pre><code class="language-plaintext">POST /internal/kubernetes/usage_metrics
</code></pre>
<p>Example Request:</p>
<pre><code class="language-shell">curl --request POST --header &quot;Gitlab-Kas-Api-Request: &lt;JWT token&gt;&quot; --header &quot;Content-Type: application/json&quot; \
     --data '{&quot;counters&quot;: {&quot;k8s_api_proxy_request&quot;:1}}' &quot;http://localhost:3000/api/v4/internal/kubernetes/usage_metrics&quot;
</code></pre>
<h3>GitLab agent for Kubernetes events</h3>
<p>Called from the GitLab agent server for Kubernetes (<code>kas</code>) to track events.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>events</code></td>
<td style="text-align: left;">hash</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Hash of events</td>
</tr>
<tr>
<td style="text-align: left;"><code>events["k8s_api_proxy_requests_unique_users_via_ci_access"]</code></td>
<td style="text-align: left;">hash array</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Array of events for <code>k8s_api_proxy_requests_unique_users_via_ci_access</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>events["k8s_api_proxy_requests_unique_users_via_ci_access"]["user_id"]</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The user ID for the event</td>
</tr>
<tr>
<td style="text-align: left;"><code>events["k8s_api_proxy_requests_unique_users_via_ci_access"]["project_id"]</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The project ID for the event</td>
</tr>
<tr>
<td style="text-align: left;"><code>events["k8s_api_proxy_requests_unique_users_via_user_access"]</code></td>
<td style="text-align: left;">hash array</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Array of events for <code>k8s_api_proxy_requests_unique_users_via_user_access</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>events["k8s_api_proxy_requests_unique_users_via_user_access"]["user_id"]</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The user ID for the event</td>
</tr>
<tr>
<td style="text-align: left;"><code>events["k8s_api_proxy_requests_unique_users_via_user_access"]["project_id"]</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The project ID for the event</td>
</tr>
<tr>
<td style="text-align: left;"><code>events["k8s_api_proxy_requests_unique_users_via_pat_access"]</code></td>
<td style="text-align: left;">hash array</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Array of events for <code>k8s_api_proxy_requests_unique_users_via_pat_access</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>events["k8s_api_proxy_requests_unique_users_via_pat_access"]["user_id"]</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The user ID for the event</td>
</tr>
<tr>
<td style="text-align: left;"><code>events["k8s_api_proxy_requests_unique_users_via_pat_access"]["project_id"]</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The project ID for the event</td>
</tr>
</tbody>
</table>
<pre><code class="language-plaintext">POST /internal/kubernetes/agent_events
</code></pre>
<p>Example Request:</p>
<pre><code class="language-shell">curl --request POST \
  --url &quot;http://localhost:3000/api/v4/internal/kubernetes/agent_events&quot; \
  --header &quot;Gitlab-Kas-Api-Request: &lt;JWT token&gt;&quot; \
  --header &quot;Content-Type: application/json&quot; \
  --data '{
    &quot;events&quot;: {
      &quot;k8s_api_proxy_requests_unique_users_via_ci_access&quot;: [
        {
          &quot;user_id&quot;: 1,
          &quot;project_id&quot;: 1
        }
      ]
    }
  }'
</code></pre>
<h3>Create Starboard vulnerability</h3>
<p>Called from the GitLab agent server for Kubernetes (<code>kas</code>) to create a security vulnerability
from a Starboard vulnerability report. This request is idempotent. Multiple requests with the same data
create a single vulnerability. The response contains the UUID of the created vulnerability finding.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>vulnerability</code></td>
<td style="text-align: left;">Hash</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">Vulnerability data matching the security report schema <a href="https://gitlab.com/gitlab-org/security-products/security-report-schemas/-/blob/master/src/security-report-format.json"><code>vulnerability</code> field</a>.</td>
</tr>
<tr>
<td style="text-align: left;"><code>scanner</code></td>
<td style="text-align: left;">Hash</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">Scanner data matching the security report schema <a href="https://gitlab.com/gitlab-org/security-products/security-report-schemas/-/blob/master/src/security-report-format.json"><code>scanner</code> field</a>.</td>
</tr>
</tbody>
</table>
<pre><code class="language-plaintext">PUT internal/kubernetes/modules/starboard_vulnerability
</code></pre>
<p>Example Request:</p>
<pre><code class="language-shell">curl --request PUT --header &quot;Gitlab-Kas-Api-Request: &lt;JWT token&gt;&quot; \
     --header &quot;Authorization: Bearer &lt;agent token&gt;&quot; --header &quot;Content-Type: application/json&quot; \
     --url &quot;http://localhost:3000/api/v4/internal/kubernetes/modules/starboard_vulnerability&quot; \
     --data '{
  &quot;vulnerability&quot;: {
    &quot;name&quot;: &quot;CVE-123-4567 in libc&quot;,
    &quot;severity&quot;: &quot;high&quot;,
    &quot;confidence&quot;: &quot;unknown&quot;,
    &quot;location&quot;: {
      &quot;kubernetes_resource&quot;: {
        &quot;namespace&quot;: &quot;production&quot;,
        &quot;kind&quot;: &quot;deployment&quot;,
        &quot;name&quot;: &quot;nginx&quot;,
        &quot;container&quot;: &quot;nginx&quot;
      }
    },
    &quot;identifiers&quot;: [
      {
        &quot;type&quot;: &quot;cve&quot;,
        &quot;name&quot;: &quot;CVE-123-4567&quot;,
        &quot;value&quot;: &quot;CVE-123-4567&quot;
      }
    ]
  },
  &quot;scanner&quot;: {
    &quot;id&quot;: &quot;starboard_trivy&quot;,
    &quot;name&quot;: &quot;Trivy (via Starboard Operator)&quot;,
    &quot;vendor&quot;: &quot;GitLab&quot;
  }
}'
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;uuid&quot;: &quot;4773b2ee-5ba5-5e9f-b48c-5f7a17f0faac&quot;
}
</code></pre>
<h3>Resolve Starboard vulnerabilities</h3>
<p>Called from the GitLab agent server for Kubernetes (<code>kas</code>) to resolve Starboard security vulnerabilities.
Accepts a list of finding UUIDs and marks all Starboard vulnerabilities not identified by
the list as resolved.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>uuids</code></td>
<td style="text-align: left;">string array</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">UUIDs of detected vulnerabilities, as collected from <a href="#create-starboard-vulnerability">Create Starboard vulnerability</a> responses.</td>
</tr>
</tbody>
</table>
<pre><code class="language-plaintext">POST internal/kubernetes/modules/starboard_vulnerability/scan_result
</code></pre>
<p>Example Request:</p>
<pre><code class="language-shell">curl --request POST --header &quot;Gitlab-Kas-Api-Request: &lt;JWT token&gt;&quot; \
     --header &quot;Authorization: Bearer &lt;agent token&gt;&quot; --header &quot;Content-Type: application/json&quot; \
     --url &quot;http://localhost:3000/api/v4/internal/kubernetes/modules/starboard_vulnerability/scan_result&quot; \
     --data '{ &quot;uuids&quot;: [&quot;102e8a0a-fe29-59bd-b46c-57c3e9bc6411&quot;, &quot;5eb12985-0ed5-51f4-b545-fd8871dc2870&quot;] }'
</code></pre>
<h3>Scan Execution Policies</h3>
<p>Called from GitLab agent server for Kubernetes (<code>kas</code>) to retrieve <code>scan_execution_policies</code>
configured for the project belonging to the agent token. GitLab <code>kas</code> uses
this to configure the agent to scan images in the Kubernetes cluster based on the policy.</p>
<pre><code class="language-plaintext">GET /internal/kubernetes/modules/starboard_vulnerability/scan_execution_policies
</code></pre>
<p>Example Request:</p>
<pre><code class="language-shell">curl --request GET --header &quot;Gitlab-Kas-Api-Request: &lt;JWT token&gt;&quot; \
     --header &quot;Authorization: Bearer &lt;agent token&gt;&quot; &quot;http://localhost:3000/api/v4/internal/kubernetes/modules/starboard_vulnerability/scan_execution_policies&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;policies&quot;: [
    {
      &quot;name&quot;: &quot;Policy&quot;,
      &quot;description&quot;: &quot;Policy description&quot;,
      &quot;enabled&quot;: true,
      &quot;yaml&quot;: &quot;---\nname: Policy\ndescription: 'Policy description'\nenabled: true\nactions:\n- scan: container_scanning\nrules:\n- type: pipeline\n  branches:\n  - main\n&quot;,
      &quot;updated_at&quot;: &quot;2022-06-02T05:36:26+00:00&quot;
    }
  ]
}
</code></pre>
<h3>Policy Configuration</h3>
<p>Called from GitLab agent server for Kubernetes (<code>kas</code>) to retrieve <code>policies_configuration</code>
configured for the project belonging to the agent token. GitLab <code>kas</code> uses
this to configure the agent to scan images in the Kubernetes cluster based on the configuration.</p>
<pre><code class="language-plaintext">GET /internal/kubernetes/modules/starboard_vulnerability/policies_configuration
</code></pre>
<p>Example Request:</p>
<pre><code class="language-shell">curl --request GET --header &quot;Gitlab-Kas-Api-Request: &lt;JWT token&gt;&quot; \
     --header &quot;Authorization: Bearer &lt;agent token&gt;&quot; &quot;http://localhost:3000/api/v4/internal/kubernetes/modules/starboard_vulnerability/policies_configuration&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;configurations&quot;: [
    {
      &quot;cadence&quot;: &quot;30 2 * * *&quot;,
      &quot;namespaces&quot;: [
        &quot;namespace-a&quot;,
        &quot;namespace-b&quot;
      ],
      &quot;updated_at&quot;: &quot;2022-06-02T05:36:26+00:00&quot;
    }
  ]
}
</code></pre>
<h2>Storage limit exclusions</h2>
<p>The namespace storage limit exclusion endpoints manage storage limit exclusions on top-level namespaces on GitLab.com.
These endpoints can only be consumed in the <strong>Admin</strong> area of GitLab.com.</p>
<h3>Retrieve storage limit exclusions</h3>
<p>Use a GET request to retrieve all <code>Namespaces::Storage::LimitExclusion</code> records.</p>
<pre><code class="language-plaintext">GET /namespaces/storage/limit_exclusions
</code></pre>
<p>Example request:</p>
<pre><code class="language-shell">curl --request GET \
  --url &quot;https://gitlab.com/v4/namespaces/storage/limit_exclusions&quot; \
  --header 'PRIVATE-TOKEN: &lt;admin access token&gt;'
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">[
    {
      &quot;id&quot;: 1,
      &quot;namespace_id&quot;: 1234,
      &quot;namespace_name&quot;: &quot;A Namespace Name&quot;,
      &quot;reason&quot;: &quot;a reason to exclude the Namespace&quot;
    },
    {
      &quot;id&quot;: 2,
      &quot;namespace_id&quot;: 4321,
      &quot;namespace_name&quot;: &quot;Another Namespace Name&quot;,
      &quot;reason&quot;: &quot;another reason to exclude the Namespace&quot;
    },
]
</code></pre>
<h3>Create a storage limit exclusion</h3>
<p>Use a POST request to create an <code>Namespaces::Storage::LimitExclusion</code>.</p>
<pre><code class="language-plaintext">POST /namespaces/:id/storage/limit_exclusion
</code></pre>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>reason</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">The reason to exclude the namespace.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre><code class="language-shell">curl --request POST \
  --url &quot;https://gitlab.com/v4/namespaces/123/storage/limit_exclusion&quot; \
  --header 'Content-Type: application/json' \
  --header 'PRIVATE-TOKEN: &lt;admin access token&gt;' \
  --data '{
    &quot;reason&quot;: &quot;a reason to exclude the Namespace&quot;
  }'
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;id&quot;: 1,
  &quot;namespace_id&quot;: 1234,
  &quot;namespace_name&quot;: &quot;A Namespace Name&quot;,
  &quot;reason&quot;: &quot;a reason to exclude the Namespace&quot;
}
</code></pre>
<h3>Delete a storage limit exclusion</h3>
<p>Use a DELETE request to delete a <code>Namespaces::Storage::LimitExclusion</code> for a namespace.</p>
<pre><code class="language-plaintext">DELETE /namespaces/:id/storage/limit_exclusion
</code></pre>
<p>Example request:</p>
<pre><code class="language-shell">curl --request DELETE \
  --url &quot;https://gitlab.com/v4/namespaces/123/storage/limit_exclusion&quot; \
  --header 'PRIVATE-TOKEN: &lt;admin access token&gt;'
</code></pre>
<p>Example response:</p>
<pre><code class="language-plaintext">204
</code></pre>
<h3>Known consumers</h3>
<ul>
<li>GitLab.com <strong>Admin</strong> area</li>
</ul>
<h2>Group SCIM API</h2>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>The group SCIM API partially implements the <a href="https://www.rfc-editor.org/rfc/rfc7644">RFC7644 protocol</a>. This API provides the <code>/groups/:group_path/Users</code> and <code>/groups/:group_path/Users/:id</code> endpoints. The base URL is <code>&lt;http|https&gt;://&lt;GitLab host&gt;/api/scim/v2</code>. Because this API is for
system use for SCIM provider integration, it is subject to change without notice.</p>
<p>To use this API, enable <a href="../../user/group/saml_sso/_index.html">Group SSO</a> for the group.
This API is only in use where <a href="../../user/group/saml_sso/scim_setup.html">SCIM for Group SSO</a> is enabled. It's a prerequisite to the creation of SCIM identities.</p>
<p>This group SCIM API:</p>
<ul>
<li>Is for system use for SCIM provider integration.</li>
<li>Implements the <a href="https://www.rfc-editor.org/rfc/rfc7644">RFC7644 protocol</a>.</li>
<li>Gets a list of SCIM provisioned users for the group.</li>
<li>Creates, deletes and updates SCIM provisioned users for the group.</li>
</ul>
<p>The <a href="#instance-scim-api">instance SCIM API</a> does the same for instances.</p>
<p>This group SCIM API is different to the <a href="../../api/scim.html">SCIM API</a>. The SCIM API:</p>
<ul>
<li>Is not an internal API.</li>
<li>Does not implement the <a href="https://www.rfc-editor.org/rfc/rfc7644">RFC7644 protocol</a>.</li>
<li>Gets, checks, updates, and deletes SCIM identities in groups.</li>
</ul>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>This API does not require the <code>Gitlab-Shell-Api-Request</code> header.</p>
<p>{{&lt; /alert &gt;}}</p>
<h3>Get a list of SCIM provisioned users</h3>
<p>This endpoint is used as part of the SCIM syncing mechanism. It returns a list of users depending on the filter used.</p>
<pre><code class="language-plaintext">GET /api/scim/v2/groups/:group_path/Users
</code></pre>
<p>Parameters:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>filter</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">A <a href="#available-filters">filter</a> expression.</td>
</tr>
<tr>
<td style="text-align: left;"><code>group_path</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">Full path to the group.</td>
</tr>
<tr>
<td style="text-align: left;"><code>startIndex</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The 1-based index indicating where to start returning results from. A value of less than one is interpreted as 1.</td>
</tr>
<tr>
<td style="text-align: left;"><code>count</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Desired maximum number of query results.</td>
</tr>
</tbody>
</table>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>Pagination follows the <a href="https://www.rfc-editor.org/rfc/rfc7644#section-3.4.2.4">SCIM spec</a> rather than GitLab pagination as used elsewhere. If records change between requests it is possible for a page to either be missing records that have moved to a different page or repeat records from a previous request.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>Example request filtering on a specific identifier:</p>
<pre><code class="language-shell">curl &quot;https://gitlab.example.com/api/scim/v2/groups/test_group/Users?filter=id%20eq%20%220b1d561c-21ff-4092-beab-8154b17f82f2%22&quot; \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; \
     --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;schemas&quot;: [
    &quot;urn:ietf:params:scim:api:messages:2.0:ListResponse&quot;
  ],
  &quot;totalResults&quot;: 1,
  &quot;itemsPerPage&quot;: 20,
  &quot;startIndex&quot;: 1,
  &quot;Resources&quot;: [
    {
      &quot;schemas&quot;: [
        &quot;urn:ietf:params:scim:schemas:core:2.0:User&quot;
      ],
      &quot;id&quot;: &quot;0b1d561c-21ff-4092-beab-8154b17f82f2&quot;,
      &quot;active&quot;: true,
      &quot;name.formatted&quot;: &quot;Test User&quot;,
      &quot;userName&quot;: &quot;username&quot;,
      &quot;meta&quot;: { &quot;resourceType&quot;:&quot;User&quot; },
      &quot;emails&quot;: [
        {
          &quot;type&quot;: &quot;work&quot;,
          &quot;value&quot;: &quot;name@example.com&quot;,
          &quot;primary&quot;: true
        }
      ]
    }
  ]
}
</code></pre>
<h3>Get a single SCIM provisioned user</h3>
<pre><code class="language-plaintext">GET /api/scim/v2/groups/:group_path/Users/:id
</code></pre>
<p>Parameters:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>id</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">External UID of the user.</td>
</tr>
<tr>
<td style="text-align: left;"><code>group_path</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">Full path to the group.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre><code class="language-shell">curl &quot;https://gitlab.example.com/api/scim/v2/groups/test_group/Users/f0b1d561c-21ff-4092-beab-8154b17f82f2&quot; \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;schemas&quot;: [
    &quot;urn:ietf:params:scim:schemas:core:2.0:User&quot;
  ],
  &quot;id&quot;: &quot;0b1d561c-21ff-4092-beab-8154b17f82f2&quot;,
  &quot;active&quot;: true,
  &quot;name.formatted&quot;: &quot;Test User&quot;,
  &quot;userName&quot;: &quot;username&quot;,
  &quot;meta&quot;: { &quot;resourceType&quot;:&quot;User&quot; },
  &quot;emails&quot;: [
    {
      &quot;type&quot;: &quot;work&quot;,
      &quot;value&quot;: &quot;name@example.com&quot;,
      &quot;primary&quot;: true
    }
  ]
}
</code></pre>
<h3>Create a SCIM provisioned user</h3>
<pre><code class="language-plaintext">POST /api/scim/v2/groups/:group_path/Users/
</code></pre>
<p>Parameters:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>externalId</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">External UID of the user.</td>
</tr>
<tr>
<td style="text-align: left;"><code>userName</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">Username of the user.</td>
</tr>
<tr>
<td style="text-align: left;"><code>emails</code></td>
<td style="text-align: left;">JSON string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">Work email.</td>
</tr>
<tr>
<td style="text-align: left;"><code>name</code></td>
<td style="text-align: left;">JSON string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">Name of the user.</td>
</tr>
<tr>
<td style="text-align: left;"><code>meta</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Resource type (<code>User</code>).</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre><code class="language-shell">curl --verbose --request POST &quot;https://gitlab.example.com/api/scim/v2/groups/test_group/Users&quot; \
     --data '{&quot;externalId&quot;:&quot;test_uid&quot;,&quot;active&quot;:null,&quot;userName&quot;:&quot;username&quot;,&quot;emails&quot;:[{&quot;primary&quot;:true,&quot;type&quot;:&quot;work&quot;,&quot;value&quot;:&quot;name@example.com&quot;}],&quot;name&quot;:{&quot;formatted&quot;:&quot;Test User&quot;,&quot;familyName&quot;:&quot;User&quot;,&quot;givenName&quot;:&quot;Test&quot;},&quot;schemas&quot;:[&quot;urn:ietf:params:scim:schemas:core:2.0:User&quot;],&quot;meta&quot;:{&quot;resourceType&quot;:&quot;User&quot;}}' \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;schemas&quot;: [
    &quot;urn:ietf:params:scim:schemas:core:2.0:User&quot;
  ],
  &quot;id&quot;: &quot;0b1d561c-21ff-4092-beab-8154b17f82f2&quot;,
  &quot;active&quot;: true,
  &quot;name.formatted&quot;: &quot;Test User&quot;,
  &quot;userName&quot;: &quot;username&quot;,
  &quot;meta&quot;: { &quot;resourceType&quot;:&quot;User&quot; },
  &quot;emails&quot;: [
    {
      &quot;type&quot;: &quot;work&quot;,
      &quot;value&quot;: &quot;name@example.com&quot;,
      &quot;primary&quot;: true
    }
  ]
}
</code></pre>
<p>Returns a <code>201</code> status code if successful.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>After you create a group SCIM identity for a user, you can see that SCIM identity in the <strong>Admin</strong> area.</p>
<p>{{&lt; /alert &gt;}}</p>
<h3>Update a single SCIM provisioned user</h3>
<p>Fields that can be updated are:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">SCIM/IdP field</th>
<th style="text-align: left;">GitLab field</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>id/externalId</code></td>
<td style="text-align: left;"><code>extern_uid</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>name.formatted</code></td>
<td style="text-align: left;"><code>name</code> (<a href="https://gitlab.com/gitlab-org/gitlab/-/issues/363058">Removed</a>)</td>
</tr>
<tr>
<td style="text-align: left;"><code>emails\[type eq "work"\].value</code></td>
<td style="text-align: left;"><code>email</code> (<a href="https://gitlab.com/gitlab-org/gitlab/-/issues/363058">Removed</a>)</td>
</tr>
<tr>
<td style="text-align: left;"><code>active</code></td>
<td style="text-align: left;">Identity removal if <code>active</code> = <code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>userName</code></td>
<td style="text-align: left;"><code>username</code> (<a href="https://gitlab.com/gitlab-org/gitlab/-/issues/363058">Removed</a>)</td>
</tr>
</tbody>
</table>
<pre><code class="language-plaintext">PATCH /api/scim/v2/groups/:group_path/Users/:id
</code></pre>
<p>Parameters:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>id</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">External UID of the user.</td>
</tr>
<tr>
<td style="text-align: left;"><code>group_path</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">Full path to the group.</td>
</tr>
<tr>
<td style="text-align: left;"><code>Operations</code></td>
<td style="text-align: left;">JSON string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">An <a href="#available-operations">operations</a> expression.</td>
</tr>
</tbody>
</table>
<p>Example request to update the user's <code>id</code>:</p>
<pre><code class="language-shell">curl --verbose --request PATCH &quot;https://gitlab.example.com/api/scim/v2/groups/test_group/Users/f0b1d561c-21ff-4092-beab-8154b17f82f2&quot; \
     --data '{ &quot;Operations&quot;: [{&quot;op&quot;:&quot;replace&quot;,&quot;path&quot;:&quot;id&quot;,&quot;value&quot;:&quot;1234abcd&quot;}] }' \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Returns an empty response with a <code>204</code> status code if successful.</p>
<p>Example request to set the user's <code>active</code> state:</p>
<pre><code class="language-shell">curl --verbose --request PATCH &quot;https://gitlab.example.com/api/scim/v2/groups/test_group/Users/f0b1d561c-21ff-4092-beab-8154b17f82f2&quot; \
     --data '{ &quot;Operations&quot;: [{&quot;op&quot;:&quot;replace&quot;,&quot;path&quot;:&quot;active&quot;,&quot;value&quot;:&quot;true&quot;}] }' \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Returns an empty response with a <code>204</code> status code if successful.</p>
<h3>Remove a single SCIM provisioned user</h3>
<p>Removes the user's SSO identity and group membership.</p>
<pre><code class="language-plaintext">DELETE /api/scim/v2/groups/:group_path/Users/:id
</code></pre>
<p>Parameters:</p>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>string</td>
<td>yes</td>
<td>External UID of the user.</td>
</tr>
<tr>
<td><code>group_path</code></td>
<td>string</td>
<td>yes</td>
<td>Full path to the group.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre><code class="language-shell">curl --verbose --request DELETE &quot;https://gitlab.example.com/api/scim/v2/groups/test_group/Users/f0b1d561c-21ff-4092-beab-8154b17f82f2&quot; \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Returns an empty response with a <code>204</code> status code if successful.</p>
<h2>Instance SCIM API</h2>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; history &gt;}}</p>
<ul>
<li>Group sync support <a href="https://gitlab.com/groups/gitlab-org/-/epics/15990">added</a> in GitLab 18.0.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>The instance SCIM API partially implements the <a href="https://www.rfc-editor.org/rfc/rfc7644">RFC7644 protocol</a>. This API provides endpoints for managing users and groups. The base URL is <code>&lt;http|https&gt;://&lt;GitLab host&gt;/api/scim/v2</code>. Because this API is for system use for SCIM provider integration, it is subject to change without notice.</p>
<p>To use this API, enable <a href="../../integration/saml.html">SAML SSO</a> for the instance.</p>
<p>This instance SCIM API:</p>
<ul>
<li>Is for system use for SCIM provider integration.</li>
<li>Implements the <a href="https://www.rfc-editor.org/rfc/rfc7644">RFC7644 protocol</a>.</li>
<li>Gets a list of SCIM provisioned users.</li>
<li>Creates, deletes, and updates SCIM provisioned users.</li>
<li>Manages group memberships through <a href="../../user/group/saml_sso/group_sync.md#configure-saml-group-links">SAML group links</a>.</li>
</ul>
<p>The <a href="#group-scim-api">group SCIM API</a> does the same for groups.</p>
<p>This instance SCIM API is different to the <a href="../../api/scim.html">SCIM API</a>. The SCIM API:</p>
<ul>
<li>Is not an internal API.</li>
<li>Does not implement the <a href="https://www.rfc-editor.org/rfc/rfc7644">RFC7644 protocol</a>.</li>
<li>Gets, checks, updates, and deletes SCIM identities within groups.</li>
</ul>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>This API does not require the <code>Gitlab-Shell-Api-Request</code> header.</p>
<p>{{&lt; /alert &gt;}}</p>
<h3>User endpoints</h3>
<p>Use user endpoints to manage SCIM provisioned users.</p>
<h4>Get a list of SCIM provisioned users</h4>
<p>This endpoint is used as part of the SCIM syncing mechanism. It returns a list of users depending on the filter used.</p>
<pre><code class="language-plaintext">GET /api/scim/v2/application/Users
</code></pre>
<p>Parameters:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>filter</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">A <a href="#available-filters">filter</a> expression.</td>
</tr>
<tr>
<td style="text-align: left;"><code>startIndex</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The 1-based index indicating where to start returning results from. A value of less than one is interpreted as 1.</td>
</tr>
<tr>
<td style="text-align: left;"><code>count</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Desired maximum number of query results.</td>
</tr>
</tbody>
</table>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>Pagination follows the <a href="https://www.rfc-editor.org/rfc/rfc7644#section-3.4.2.4">SCIM spec</a> rather than GitLab pagination as used elsewhere. If records change between requests it is possible for a page to either be missing records that have moved to a different page or repeat records from a previous request.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>Example request:</p>
<pre><code class="language-shell">curl &quot;https://gitlab.example.com/api/scim/v2/application/Users?filter=id%20eq%20%220b1d561c-21ff-4092-beab-8154b17f82f2%22&quot; \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; \
     --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;schemas&quot;: [
    &quot;urn:ietf:params:scim:api:messages:2.0:ListResponse&quot;
  ],
  &quot;totalResults&quot;: 1,
  &quot;itemsPerPage&quot;: 20,
  &quot;startIndex&quot;: 1,
  &quot;Resources&quot;: [
    {
      &quot;schemas&quot;: [
        &quot;urn:ietf:params:scim:schemas:core:2.0:User&quot;
      ],
      &quot;id&quot;: &quot;0b1d561c-21ff-4092-beab-8154b17f82f2&quot;,
      &quot;active&quot;: true,
      &quot;name.formatted&quot;: &quot;Test User&quot;,
      &quot;userName&quot;: &quot;username&quot;,
      &quot;meta&quot;: { &quot;resourceType&quot;:&quot;User&quot; },
      &quot;emails&quot;: [
        {
          &quot;type&quot;: &quot;work&quot;,
          &quot;value&quot;: &quot;name@example.com&quot;,
          &quot;primary&quot;: true
        }
      ]
    }
  ]
}
</code></pre>
<h4>Get a single SCIM provisioned user</h4>
<pre><code class="language-plaintext">GET /api/scim/v2/application/Users/:id
</code></pre>
<p>Parameters:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>id</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">External UID of the user.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre><code class="language-shell">curl &quot;https://gitlab.example.com/api/scim/v2/application/Users/f0b1d561c-21ff-4092-beab-8154b17f82f2&quot; \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;schemas&quot;: [
    &quot;urn:ietf:params:scim:schemas:core:2.0:User&quot;
  ],
  &quot;id&quot;: &quot;0b1d561c-21ff-4092-beab-8154b17f82f2&quot;,
  &quot;active&quot;: true,
  &quot;name.formatted&quot;: &quot;Test User&quot;,
  &quot;userName&quot;: &quot;username&quot;,
  &quot;meta&quot;: { &quot;resourceType&quot;:&quot;User&quot; },
  &quot;emails&quot;: [
    {
      &quot;type&quot;: &quot;work&quot;,
      &quot;value&quot;: &quot;name@example.com&quot;,
      &quot;primary&quot;: true
    }
  ]
}
</code></pre>
<h4>Create a SCIM provisioned user</h4>
<pre><code class="language-plaintext">POST /api/scim/v2/application/Users
</code></pre>
<p>Parameters:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>externalId</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">External UID of the user.</td>
</tr>
<tr>
<td style="text-align: left;"><code>userName</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">Username of the user.</td>
</tr>
<tr>
<td style="text-align: left;"><code>emails</code></td>
<td style="text-align: left;">JSON string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">Work email.</td>
</tr>
<tr>
<td style="text-align: left;"><code>name</code></td>
<td style="text-align: left;">JSON string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">Name of the user.</td>
</tr>
<tr>
<td style="text-align: left;"><code>meta</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Resource type (<code>User</code>).</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre><code class="language-shell">curl --verbose --request POST &quot;https://gitlab.example.com/api/scim/v2/application/Users&quot; \
     --data '{&quot;externalId&quot;:&quot;test_uid&quot;,&quot;active&quot;:null,&quot;userName&quot;:&quot;username&quot;,&quot;emails&quot;:[{&quot;primary&quot;:true,&quot;type&quot;:&quot;work&quot;,&quot;value&quot;:&quot;name@example.com&quot;}],&quot;name&quot;:{&quot;formatted&quot;:&quot;Test User&quot;,&quot;familyName&quot;:&quot;User&quot;,&quot;givenName&quot;:&quot;Test&quot;},&quot;schemas&quot;:[&quot;urn:ietf:params:scim:schemas:core:2.0:User&quot;],&quot;meta&quot;:{&quot;resourceType&quot;:&quot;User&quot;}}' \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;schemas&quot;: [
    &quot;urn:ietf:params:scim:schemas:core:2.0:User&quot;
  ],
  &quot;id&quot;: &quot;0b1d561c-21ff-4092-beab-8154b17f82f2&quot;,
  &quot;active&quot;: true,
  &quot;name.formatted&quot;: &quot;Test User&quot;,
  &quot;userName&quot;: &quot;username&quot;,
  &quot;meta&quot;: { &quot;resourceType&quot;:&quot;User&quot; },
  &quot;emails&quot;: [
    {
      &quot;type&quot;: &quot;work&quot;,
      &quot;value&quot;: &quot;name@example.com&quot;,
      &quot;primary&quot;: true
    }
  ]
}
</code></pre>
<p>Returns a <code>201</code> status code if successful.</p>
<h4>Update a single SCIM provisioned user</h4>
<p>Fields that can be updated are:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">SCIM/IdP field</th>
<th style="text-align: left;">GitLab field</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>id/externalId</code></td>
<td style="text-align: left;"><code>extern_uid</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>active</code></td>
<td style="text-align: left;">If <code>false</code>, the user is blocked, but the SCIM identity remains linked.</td>
</tr>
</tbody>
</table>
<pre><code class="language-plaintext">PATCH /api/scim/v2/application/Users/:id
</code></pre>
<p>Parameters:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>id</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">External UID of the user.</td>
</tr>
<tr>
<td style="text-align: left;"><code>Operations</code></td>
<td style="text-align: left;">JSON string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">An <a href="#available-operations">operations</a> expression.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre><code class="language-shell">curl --verbose --request PATCH &quot;https://gitlab.example.com/api/scim/v2/application/Users/f0b1d561c-21ff-4092-beab-8154b17f82f2&quot; \
     --data '{ &quot;Operations&quot;: [{&quot;op&quot;:&quot;Update&quot;,&quot;path&quot;:&quot;active&quot;,&quot;value&quot;:&quot;false&quot;},{&quot;op&quot;:&quot;Update&quot;,&quot;path&quot;:&quot;id&quot;,&quot;value&quot;:&quot;foo&quot;}] }' \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Returns an empty response with a <code>204</code> status code if successful.</p>
<h4>Block a single SCIM provisioned user</h4>
<p>The user is placed in a <code>blocked</code> state and signed out. This means
the user cannot sign in or push or pull code.</p>
<pre><code class="language-plaintext">DELETE /api/scim/v2/application/Users/:id
</code></pre>
<p>Parameters:</p>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>string</td>
<td>yes</td>
<td>External UID of the user.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre><code class="language-shell">curl --verbose --request DELETE &quot;https://gitlab.example.com/api/scim/v2/application/Users/f0b1d561c-21ff-4092-beab-8154b17f82f2&quot; \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Returns an empty response with a <code>204</code> status code if successful.</p>
<h3>Group endpoints</h3>
<p>Use group endpoints to automatically synchronize GitLab with the SCIM identity provider.</p>
<p>This API uses <a href="../../user/group/saml_sso/group_sync.md#configure-saml-group-links">SAML group links</a> to connect IdP groups with GitLab groups.
Before using these endpoints, you must create the necessary SAML group links for the groups you want to synchronize.</p>
<h4>Get a list of SCIM groups</h4>
<p>This endpoint returns a list of groups that have SCIM IDs assigned.</p>
<pre><code class="language-plaintext">GET /api/scim/v2/application/Groups
</code></pre>
<p>Parameters:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>filter</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">A filter expression to search groups by name.</td>
</tr>
<tr>
<td style="text-align: left;"><code>startIndex</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">The 1-based index indicating where to start returning results from.</td>
</tr>
<tr>
<td style="text-align: left;"><code>count</code></td>
<td style="text-align: left;">integer</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Desired maximum number of query results.</td>
</tr>
<tr>
<td style="text-align: left;"><code>excludedAttributes</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Comma-separated list of attributes to exclude from the response.</td>
</tr>
</tbody>
</table>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>Pagination follows the <a href="https://www.rfc-editor.org/rfc/rfc7644#section-3.4.2.4">SCIM spec</a>, not the GitLab pagination.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>Example request:</p>
<pre><code class="language-shell">curl &quot;https://gitlab.example.com/api/scim/v2/application/Groups?filter=displayName%20eq%20%22Developers%22&quot; \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; \
     --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;schemas&quot;: [
    &quot;urn:ietf:params:scim:api:messages:2.0:ListResponse&quot;
  ],
  &quot;totalResults&quot;: 1,
  &quot;itemsPerPage&quot;: 20,
  &quot;startIndex&quot;: 1,
  &quot;Resources&quot;: [
    {
      &quot;schemas&quot;: [
        &quot;urn:ietf:params:scim:schemas:core:2.0:Group&quot;
      ],
      &quot;id&quot;: &quot;86e7d437-1a55-4731-b3a3-2867fb4d2a94&quot;,
      &quot;displayName&quot;: &quot;Developers&quot;,
      &quot;members&quot;: [],
      &quot;meta&quot;: {
        &quot;resourceType&quot;: &quot;Group&quot;
      }
    }
  ]
}
</code></pre>
<h4>Get a single SCIM group</h4>
<pre><code class="language-plaintext">GET /api/scim/v2/application/Groups/:id
</code></pre>
<p>Parameters:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>id</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">SCIM group ID (UUID format).</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre><code class="language-shell">curl &quot;https://gitlab.example.com/api/scim/v2/application/Groups/86e7d437-1a55-4731-b3a3-2867fb4d2a94&quot; \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;schemas&quot;: [
    &quot;urn:ietf:params:scim:schemas:core:2.0:Group&quot;
  ],
  &quot;id&quot;: &quot;86e7d437-1a55-4731-b3a3-2867fb4d2a94&quot;,
  &quot;displayName&quot;: &quot;Developers&quot;,
  &quot;members&quot;: [],
  &quot;meta&quot;: {
    &quot;resourceType&quot;: &quot;Group&quot;
  }
}
</code></pre>
<h4>Create a SCIM group</h4>
<p>This endpoint associates a SCIM group ID with existing SAML group links that have the same name.</p>
<pre><code class="language-plaintext">POST /api/scim/v2/application/Groups
</code></pre>
<p>Parameters:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>displayName</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">Name of the group as configured in GitLab SAML group links.</td>
</tr>
<tr>
<td style="text-align: left;"><code>externalId</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">Optional SCIM group ID. If not provided, a UUID is generated.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre><code class="language-shell">curl --verbose --request POST &quot;https://gitlab.example.com/api/scim/v2/application/Groups&quot; \
     --data '{&quot;displayName&quot;:&quot;Developers&quot;,&quot;schemas&quot;:[&quot;urn:ietf:params:scim:schemas:core:2.0:Group&quot;]}' \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;schemas&quot;: [
    &quot;urn:ietf:params:scim:schemas:core:2.0:Group&quot;
  ],
  &quot;id&quot;: &quot;86e7d437-1a55-4731-b3a3-2867fb4d2a94&quot;,
  &quot;displayName&quot;: &quot;Developers&quot;,
  &quot;members&quot;: [],
  &quot;meta&quot;: {
    &quot;resourceType&quot;: &quot;Group&quot;
  }
}
</code></pre>
<p>Returns a <code>201</code> status code if successful.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>This endpoint does not create GitLab groups. It only associates a SCIM ID with existing SAML group links that have the specified display name.</p>
<p>{{&lt; /alert &gt;}}</p>
<h4>Update a SCIM group</h4>
<p>Updates the members of a SCIM group. Used to add or remove users from GitLab groups associated with the SCIM group.</p>
<pre><code class="language-plaintext">PATCH /api/scim/v2/application/Groups/:id
</code></pre>
<p>Parameters:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Required</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>id</code></td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">SCIM group ID.</td>
</tr>
<tr>
<td style="text-align: left;"><code>Operations</code></td>
<td style="text-align: left;">JSON array</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">Array of operations to perform. Each operation includes <code>op</code> (operation type), <code>path</code> (attribute to modify), and <code>value</code> (new value).</td>
</tr>
</tbody>
</table>
<p>Supported operations:</p>
<ul>
<li><code>add</code> with path <code>members</code> to add members to the group</li>
<li><code>remove</code> with path <code>members</code> to remove members from the group</li>
</ul>
<p>Example request to add a member:</p>
<pre><code class="language-shell">curl --verbose --request PATCH &quot;https://gitlab.example.com/api/scim/v2/application/Groups/86e7d437-1a55-4731-b3a3-2867fb4d2a94&quot; \
     --data '{&quot;schemas&quot;:[&quot;urn:ietf:params:scim:api:messages:2.0:PatchOp&quot;],&quot;Operations&quot;:[{&quot;op&quot;:&quot;add&quot;,&quot;path&quot;:&quot;members&quot;,&quot;value&quot;:[{&quot;value&quot;:&quot;f0b1d561c-21ff-4092-beab-8154b17f82f2&quot;}]}]}' \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Example request to remove a member:</p>
<pre><code class="language-shell">curl --verbose --request PATCH &quot;https://gitlab.example.com/api/scim/v2/application/Groups/86e7d437-1a55-4731-b3a3-2867fb4d2a94&quot; \
     --data '{&quot;schemas&quot;:[&quot;urn:ietf:params:scim:api:messages:2.0:PatchOp&quot;],&quot;Operations&quot;:[{&quot;op&quot;:&quot;remove&quot;,&quot;path&quot;:&quot;members&quot;,&quot;value&quot;:[{&quot;value&quot;:&quot;f0b1d561c-21ff-4092-beab-8154b17f82f2&quot;}]}]}' \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Returns an empty response with a <code>204</code> status code if successful.</p>
<h4>Replace a SCIM group</h4>
<p>Replaces all members of a SCIM group with a new set of members.</p>
<pre><code class="language-plaintext">PUT /api/scim/v2/application/Groups/:id
</code></pre>
<p>Parameters:</p>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>string</td>
<td>yes</td>
<td>SCIM group ID.</td>
</tr>
<tr>
<td><code>schemas</code></td>
<td>array</td>
<td>yes</td>
<td>SCIM schemas array. Must include <code>["urn:ietf:params:scim:schemas:core:2.0:Group"]</code>.</td>
</tr>
<tr>
<td><code>displayName</code></td>
<td>string</td>
<td>yes</td>
<td>Group display name.</td>
</tr>
<tr>
<td><code>members</code></td>
<td>array</td>
<td>no</td>
<td>Array of members, each with a <code>value</code> attribute containing the user's SCIM ID.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre><code class="language-shell">curl --verbose --request PUT &quot;https://gitlab.example.com/api/scim/v2/application/Groups/86e7d437-1a55-4731-b3a3-2867fb4d2a94&quot; \
     --data '{&quot;schemas&quot;:[&quot;urn:ietf:params:scim:schemas:core:2.0:Group&quot;],&quot;displayName&quot;:&quot;Developers&quot;,&quot;members&quot;:[{&quot;value&quot;:&quot;f0b1d561c-21ff-4092-beab-8154b17f82f2&quot;}]}' \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Response includes the updated group information.</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>The <code>PUT</code> operation replaces all group members. Any existing members not included in the request are removed from all GitLab groups associated with this SCIM group.</p>
<p>{{&lt; /alert &gt;}}</p>
<h4>Delete a SCIM group</h4>
<p>Removes SCIM management from existing SAML group links by clearing the SCIM group ID. This endpoint also schedules background cleanup of SCIM group membership tracking records.</p>
<pre><code class="language-plaintext">DELETE /api/scim/v2/application/Groups/:id
</code></pre>
<p>Parameters:</p>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>string</td>
<td>yes</td>
<td>SCIM group ID (UUID format).</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre><code class="language-shell">curl --verbose --request DELETE &quot;https://gitlab.example.com/api/scim/v2/application/Groups/86e7d437-1a55-4731-b3a3-2867fb4d2a94&quot; \
     --header &quot;Authorization: Bearer &lt;your_scim_token&gt;&quot; --header &quot;Content-Type: application/scim+json&quot;
</code></pre>
<p>Returns an empty response with a <code>204</code> status code if successful.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>This endpoint does not delete GitLab groups. It only removes SCIM management from SAML group links with the specified SCIM group ID, allowing identity providers to deprovision unneeded SCIM groups.</p>
<p>{{&lt; /alert &gt;}}</p>
<h3>Available filters</h3>
<p>They match an expression as specified in <a href="https://www.rfc-editor.org/rfc/rfc7644#section-3.4.2.2">the RFC7644 filtering section</a>.</p>
<table>
<thead>
<tr>
<th>Filter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>eq</code></td>
<td>The attribute matches exactly the specified value.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre><code class="language-plaintext">id eq a-b-c-d
</code></pre>
<h3>Available operations</h3>
<p>They perform an operation as specified in <a href="https://www.rfc-editor.org/rfc/rfc7644#section-3.5.2">the RFC7644 update section</a>.</p>
<table>
<thead>
<tr>
<th>Operator</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Replace</code></td>
<td>The attribute's value is updated.</td>
</tr>
<tr>
<td><code>Add</code></td>
<td>The attribute has a new value.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre><code class="language-json">{ &quot;op&quot;: &quot;Add&quot;, &quot;path&quot;: &quot;name.formatted&quot;, &quot;value&quot;: &quot;New Name&quot; }
</code></pre></code></pre>
</body>
</html>
