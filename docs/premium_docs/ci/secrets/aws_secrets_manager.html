<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Use AWS Secrets Manager secrets in a CI/CD job</title>
    <link rel="stylesheet" href="/../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Software Supply Chain Security
group: Pipeline Security
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Use AWS Secrets Manager secrets in GitLab CI/CD</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/groups/gitlab-org/-/epics/17822">Introduced</a> in GitLab 18.2 <a href="../../administration/feature_flags/_index.html">with a flag</a> named <code>ci_aws_secrets_manager</code>. Disabled by default.</li>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/553970">Generally available</a> in GitLab 18.3.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>You can use secrets stored in <a href="https://aws.amazon.com/secrets-manager/">AWS Secrets Manager</a>
in your GitLab CI/CD pipelines.</p>
<p>Prerequisites:</p>
<ul>
<li>Have access to AWS Secrets Manager in your AWS account.</li>
<li>Configure authentication using one of the following methods:</li>
<li><strong>IAM Role</strong>: Use the IAM role assigned to your GitLab Runner instance.</li>
<li><strong>OpenID Connect</strong>: <a href="../cloud_services/aws/_index.html">Configure OpenID Connect in AWS</a> to retrieve temporary credentials.</li>
<li>Add <a href="../variables/_index.md#for-a-project">CI/CD variables to your project</a> to provide details about your AWS configuration:</li>
<li><code>AWS_REGION</code>: The AWS region where your secrets are stored.</li>
<li><code>AWS_ROLE_ARN</code>: The ARN of the AWS IAM role to assume (required when using OpenID Connect).</li>
<li><code>AWS_ROLE_SESSION_NAME</code>: Optional. Custom session name for the assumed role.</li>
</ul>
<h2>Use AWS Secrets Manager secrets in a CI/CD job</h2>
<h3>With IAM Role authentication</h3>
<p>You can use a secret stored in AWS Secrets Manager in a job by defining it with the
<code>aws_secrets_manager</code> keyword.</p>
<p>This method uses the IAM role assigned to your GitLab Runner instance. When using the
<a href="https://docs.gitlab.com/runner/executors/kubernetes/">Kubernetes executor</a> or <a href="https://docs.gitlab.com/runner/runner_autoscale/">autoscaling</a>,
make sure the IAM role is applied to your runner manager.</p>
<p>Prerequisites:</p>
<ul>
<li>GitLab Runner 18.3 or later.</li>
</ul>
<p>For example:</p>
<pre><code class="language-yaml">variables:
  AWS_REGION: us-east-1

database-migration:
  secrets:
    DATABASE_PASSWORD:
      aws_secrets_manager:
        secret_id: app-secrets/database
        field: 'password'
      file: false
  stage: deploy
  script:
    - echo &quot;Running database migration...&quot;
    - mysql -h $DB_HOST -u $DB_USER -p$DATABASE_PASSWORD &lt; migration.sql
    - echo &quot;Migration completed successfully.&quot;
</code></pre>
<h3>With OpenID Connect authentication</h3>
<p>For enhanced security, you can use OpenID Connect to authenticate with AWS and assume a specific IAM role.
By default, the runner looks for an ID token named <code>AWS_ID_TOKEN</code>. For example:</p>
<pre><code class="language-yaml">variables:
  AWS_REGION: us-east-1
  AWS_ROLE_ARN: 'arn:aws:iam::123456789012:role/gitlab-secrets-role'

database-migration:
  id_tokens:
    AWS_ID_TOKEN:
      aud: 'sts.amazonaws.com'
  secrets:
    DATABASE_PASSWORD:
      aws_secrets_manager:
        secret_id: app-secrets/database
        field: 'password'
      file: false
  stage: deploy
  script:
    - echo &quot;Connecting to production database...&quot;
    - psql postgresql://$DB_USER:$DATABASE_PASSWORD@$DB_HOST:5432/$DB_NAME -c &quot;SELECT version();&quot;
    - echo &quot;Database connection successful.&quot;
</code></pre>
<p>You can also specify a custom token using the <code>token</code> option. For example:</p>
<pre><code class="language-yaml">variables:
  AWS_REGION: us-east-1
  AWS_ROLE_ARN: 'arn:aws:iam::123456789012:role/gitlab-secrets-role'

database-migration:
  id_tokens:
    CUSTOM_AWS_TOKEN:
      aud: 'sts.amazonaws.com'
  secrets:
    DATABASE_PASSWORD:
      aws_secrets_manager:
        secret_id: app-secrets/database
        field: 'password'
      token: $CUSTOM_AWS_TOKEN
      file: false
  stage: deploy
  script:
    - echo &quot;Connecting to production database with custom token...&quot;
    - psql postgresql://$DB_USER:$DATABASE_PASSWORD@$DB_HOST:5432/$DB_NAME -c &quot;SELECT version();&quot;
    - echo &quot;Database connection successful.&quot;
</code></pre>
<h3>Short form syntax</h3>
<p>You can use a simplified syntax by specifying the secret ID as a string.
You can optionally specify a field by separating it with a <code>#</code> character.
For example:</p>
<pre><code class="language-yaml">variables:
  AWS_REGION: us-east-1

api-deployment:
  secrets:
    API_KEY:
      aws_secrets_manager: 'app-secrets/api#api_key'
      file: false
    FULL_SECRET:
      aws_secrets_manager: 'app-secrets/api'
      file: false
  stage: deploy
  script:
    - echo &quot;Deploying API with specific field...&quot;
    - curl --header &quot;Authorization: Bearer $API_KEY&quot; https://api.example.com/deploy
    - echo &quot;Using full secret...&quot;
    - curl --header &quot;Authorization: Bearer $(cat $FULL_SECRET | jq --raw-output '.api_key')&quot; https://api.example.com/status
</code></pre>
<h2>Secret versioning</h2>
<p>AWS Secrets Manager supports multiple versions of secrets. You can specify a particular version
using either <code>version_id</code> or <code>version_stage</code>. For example:</p>
<pre><code class="language-yaml">variables:
  AWS_REGION: us-east-1

production-deployment:
  secrets:
    DATABASE_PASSWORD:
      aws_secrets_manager:
        secret_id: prod-app-secrets/database
        field: 'password'
        version_stage: 'AWSCURRENT'
      file: false
    STAGING_DATABASE_PASSWORD:
      aws_secrets_manager:
        secret_id: prod-app-secrets/database
        field: 'password'
        version_id: '01234567-89ab-cdef-0123-456789abcdef'
      file: false
  stage: deploy
  script:
    - echo &quot;Deploying to production with current secret version...&quot;
    - deploy-prod.sh --db-password $DATABASE_PASSWORD
    - echo &quot;Testing with specific secret version...&quot;
    - test-with-version.sh --db-password $STAGING_DATABASE_PASSWORD
</code></pre>
<h2>Cross-account secret access</h2>
<p>To retrieve secrets from another AWS account, you must use the full ARN.
For example:</p>
<pre><code class="language-yaml">variables:
  AWS_REGION: us-east-1
  AWS_ROLE_ARN: 'arn:aws:iam::123456789012:role/cross-account-secrets-role'

cross-account-deployment:
  id_tokens:
    AWS_ID_TOKEN:
      aud: 'sts.amazonaws.com'
  secrets:
    SHARED_API_KEY:
      aws_secrets_manager:
        secret_id: 'arn:aws:secretsmanager:us-east-1:987654321098:secret:shared-api-keys-AbCdEf'
        field: 'production_key'
      file: false
  stage: deploy
  script:
    - echo &quot;Accessing shared secret from another account...&quot;
    - curl --header &quot;Authorization: Bearer $SHARED_API_KEY&quot; https://shared-api.example.com/deploy
</code></pre>
<h2>Per-secret configuration overrides</h2>
<p>You can override global AWS settings on a per-secret basis. For example:</p>
<pre><code class="language-yaml">variables:
  AWS_REGION: us-east-1
  AWS_ROLE_ARN: 'arn:aws:iam::123456789012:role/default-role'

multi-region-deployment:
  id_tokens:
    AWS_ID_TOKEN:
      aud: 'sts.amazonaws.com'
    EU_AWS_TOKEN:
      aud: 'sts.amazonaws.com'
  secrets:
    EU_DATABASE_PASSWORD:
      aws_secrets_manager:
        secret_id: eu-app-secrets/database
        field: 'password'
        region: 'eu-west-1'
        role_arn: 'arn:aws:iam::123456789012:role/eu-deployment-role'
        role_session_name: 'gitlab-eu-deployment'
      token: $EU_AWS_TOKEN
      file: false
    US_DATABASE_PASSWORD:
      aws_secrets_manager:
        secret_id: us-app-secrets/database
        field: 'password'
      file: false
  stage: deploy
  script:
    - echo &quot;Deploying to EU region...&quot;
    - deploy-to-eu.sh --db-password $EU_DATABASE_PASSWORD
    - echo &quot;Deploying to US region...&quot;
    - deploy-to-us.sh --db-password $US_DATABASE_PASSWORD
</code></pre>
<p>In these examples:</p>
<ul>
<li><code>aud</code>: The audience, which must match the audience used when <a href="../cloud_services/aws/_index.html">creating the federated identity credentials</a>.</li>
<li><code>secret_id</code>: The name or ARN of the secret in AWS Secrets Manager. To retrieve a secret from another account, you must use an ARN.</li>
<li><code>field</code>: Is the specific key in the JSON secret to retrieve. If not specified, the entire secret is retrieved.
  Field access is only supported for flat JSON secrets (top-level keys only) and supports string, number, and boolean values.
  For example:</li>
<li><code>password</code>: Accesses the <code>password</code> field.</li>
<li><code>api_key</code>: Accesses the <code>api_key</code> field.
  <code>token</code>: Specifies which ID token to use for authentication. If not specified, the runner looks for a token named <code>AWS_ID_TOKEN</code>.</li>
<li><code>version_id</code>: Is the unique identifier of a specific version of the secret.
  If you don't specify either <code>version_id</code> or <code>version_stage</code>, AWS Secrets Manager returns the <code>AWSCURRENT</code> version.</li>
<li><code>version_stage</code>: The staging label of the version of the secret to retrieve (such as <code>AWSCURRENT</code> or <code>AWSPENDING</code>).
  You cannot specify both <code>version_id</code> and <code>version_stage</code> for the same secret.</li>
<li><code>region</code>: Overrides the global <code>AWS_REGION</code> for this specific secret.</li>
<li><code>role_arn</code>: Overrides the global <code>AWS_ROLE_ARN</code> for this specific secret.</li>
<li><code>role_session_name</code>: Overrides the global <code>AWS_ROLE_SESSION_NAME</code> for this specific secret.</li>
<li>GitLab fetches the secret from AWS Secrets Manager and stores the value in a temporary file.
  The path to this file is stored in a CI/CD variable, similar to
  <a href="../variables/_index.md#use-file-type-cicd-variables">file type CI/CD variables</a>.</li>
</ul>
<h2>Troubleshooting</h2>
<p>Refer to <a href="../cloud_services/aws/_index.md#troubleshooting">OIDC for AWS troubleshooting</a> for general
problems when setting up OIDC with AWS.</p>
<h3>Error: <code>no EC2 IMDS role found</code></h3>
<p>The following error might happen if both of these conditions are true:</p>
<ul>
<li>The CI/CD job is configured to <a href="#with-iam-role-authentication">use IAM role authentication</a>.</li>
<li>The job is executed by a runner with the <a href="https://docs.gitlab.com/runner/executors/kubernetes/">Kubernetes executor</a> hosted on AWS EKS.</li>
</ul>
<pre><code class="language-plaintext">Resolving secrets
Resolving secret &quot;MY_AWS_SECRET&quot;...
Using &quot;aws_secrets_manager&quot; secret resolver...
ERROR: Job failed (system failure): resolving secrets: operation error Secrets Manager: GetSecretValue, get identity: get credentials: failed to refresh cached credentials, no EC2 IMDS role found, operation error ec2imds: GetMetadata, canceled, context deadline exceeded
</code></pre>
<p>The <code>Resolving secrets</code> step is handled by the runner manager. This step accesses IAM credentials
cached in <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html">EC2 IMDS</a>.
If the IAM role has not been applied to the runner manager, the <code>Resolving secrets</code> step fails.</p>
<p>To address this error, apply the correct IAM role to the runner manager.</p>
<p>Applying the IAM role to the runner pods that are spawned and managed by the runner manager does not resolve this issue.</p></code></pre>
</body>
</html>
