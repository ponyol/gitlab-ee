<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Prerequisites</title>
    <link rel="stylesheet" href="/../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Software Supply Chain Security
group: Pipeline Security
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: 'Tutorial: Authenticating and reading secrets with HashiCorp Vault'</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>This tutorial demonstrates how to authenticate, configure, and read secrets with HashiCorp's Vault from GitLab CI/CD.</p>
<h2>Prerequisites</h2>
<p>This tutorial assumes you are familiar with GitLab CI/CD and Vault.</p>
<p>To follow along, you must have:</p>
<ul>
<li>An account on GitLab.</li>
<li>Access to a running Vault server (at least v1.2.0) to configure authentication and to create roles and policies.
  For HashiCorp Vaults, this can be the Open Source or Enterprise version.</li>
</ul>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>You must replace the <code>vault.example.com</code> URL in the following example with the URL of your Vault server,
and <code>gitlab.example.com</code> with the URL of your GitLab instance.</p>
<p>{{&lt; /alert &gt;}}</p>
<h2>Configure the vault</h2>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>JWTs are credentials, which can grant access to resources. Be careful where you paste them!</p>
<p>{{&lt; /alert &gt;}}</p>
<p>Consider a scenario where you store passwords for your staging and production databases in a Vault server.
This scenario assumes you use the <a href="https://developer.hashicorp.com/vault/docs/secrets/kv#kv-version-2">KV v2</a> secret engine.
If you are using <a href="https://developer.hashicorp.com/vault/docs/secrets/kv#version-comparison">KV v1</a>,
remove <code>/data/</code> from the following policy paths, and see <a href="convert-to-id-tokens.md#kv-secrets-engine-v1">how to configure your CI/CD jobs</a>.</p>
<p>You can retrieve the passwords with the <code>vault kv get</code> command.</p>
<pre><code class="language-shell">$ vault kv get -field=password secret/myproject/staging/db
pa$$w0rd

$ vault kv get -field=password secret/myproject/production/db
real-pa$$w0rd
</code></pre>
<p>Your staging password is <code>pa$$w0rd</code>,
and your production password is <code>real-pa$$w0rd</code>.</p>
<p>To configure your Vault server, start by enabling the <a href="https://developer.hashicorp.com/vault/docs/auth/jwt">JWT Auth</a> method:</p>
<pre><code class="language-shell">$ vault auth enable jwt
Success! Enabled jwt auth method at: jwt/
</code></pre>
<p>Then create policies that allow you to read these secrets (one for each secret):</p>
<pre><code class="language-shell">$ vault policy write myproject-staging - &lt;&lt;EOF
# Policy name: myproject-staging
#
# Read-only permission on 'secret/data/myproject/staging/*' path
path &quot;secret/data/myproject/staging/*&quot; {
  capabilities = [ &quot;read&quot; ]
}
EOF
Success! Uploaded policy: myproject-staging

$ vault policy write myproject-production - &lt;&lt;EOF
# Policy name: myproject-production
#
# Read-only permission on 'secret/data/myproject/production/*' path
path &quot;secret/data/myproject/production/*&quot; {
  capabilities = [ &quot;read&quot; ]
}
EOF
Success! Uploaded policy: myproject-production
</code></pre>
<p>You also need roles that link the JWT with these policies.</p>
<p>For example, one role for staging named <code>myproject-staging</code>. The <a href="https://developer.hashicorp.com/vault/api-docs/auth/jwt#bound_claims">bound claims</a>
is configured to only allow the policy to be used for the <code>main</code> branch in the project with ID <code>22</code>:</p>
<pre><code class="language-json">$ vault write auth/jwt/role/myproject-staging - &lt;&lt;EOF
{
  &quot;role_type&quot;: &quot;jwt&quot;,
  &quot;policies&quot;: [&quot;myproject-staging&quot;],
  &quot;token_explicit_max_ttl&quot;: 60,
  &quot;user_claim&quot;: &quot;user_email&quot;,
  &quot;bound_audiences&quot;: &quot;https://vault.example.com&quot;,
  &quot;bound_claims&quot;: {
    &quot;project_id&quot;: &quot;22&quot;,
    &quot;ref&quot;: &quot;main&quot;,
    &quot;ref_type&quot;: &quot;branch&quot;
  }
}
EOF
</code></pre>
<p>And one role for production named <code>myproject-production</code>. The <code>bound_claims</code> section
for this role only allows protected branches that match the <code>auto-deploy-*</code> pattern to access the secrets.</p>
<pre><code class="language-json">$ vault write auth/jwt/role/myproject-production - &lt;&lt;EOF
{
  &quot;role_type&quot;: &quot;jwt&quot;,
  &quot;policies&quot;: [&quot;myproject-production&quot;],
  &quot;token_explicit_max_ttl&quot;: 60,
  &quot;user_claim&quot;: &quot;user_email&quot;,
  &quot;bound_audiences&quot;: &quot;https://vault.example.com&quot;,
  &quot;bound_claims_type&quot;: &quot;glob&quot;,
  &quot;bound_claims&quot;: {
    &quot;project_id&quot;: &quot;22&quot;,
    &quot;ref_protected&quot;: &quot;true&quot;,
    &quot;ref_type&quot;: &quot;branch&quot;,
    &quot;ref&quot;: &quot;auto-deploy-*&quot;
  }
}
EOF
</code></pre>
<p>Combined with <a href="../../user/project/repository/branches/protected.html">protected branches</a>,
you can restrict who is able to authenticate and read the secrets.</p>
<p>Any of the claims <a href="id_token_authentication.md#token-payload">included in the JWT</a>
can be matched against a list of values in the bound claims. For example:</p>
<pre><code class="language-json">&quot;bound_claims&quot;: {
  &quot;user_login&quot;: [&quot;alice&quot;, &quot;bob&quot;, &quot;mallory&quot;]
}

&quot;bound_claims&quot;: {
  &quot;ref&quot;: [&quot;main&quot;, &quot;develop&quot;, &quot;test&quot;]
}

&quot;bound_claims&quot;: {
  &quot;namespace_id&quot;: [&quot;10&quot;, &quot;20&quot;, &quot;30&quot;]
}

&quot;bound_claims&quot;: {
  &quot;project_id&quot;: [&quot;12&quot;, &quot;22&quot;, &quot;37&quot;]
}
</code></pre>
<ul>
<li>If only <code>namespace_id</code> is used, all projects in the namespace are allowed. Nested projects are not included,
  so their namespace IDs must also be added to the list if needed.</li>
<li>If both <code>namespace_id</code> and <code>project_id</code> are used, Vault first checks if the project's namespace
  is in <code>namespace_id</code> then checks if the project is in <code>project_id</code>.</li>
</ul>
<p><a href="https://developer.hashicorp.com/vault/api-docs/auth/jwt#token_explicit_max_ttl"><code>token_explicit_max_ttl</code></a>
specifies that the token issued by Vault, upon successful authentication, has a hard lifetime limit of 60 seconds.</p>
<p><a href="https://developer.hashicorp.com/vault/api-docs/auth/jwt#user_claim"><code>user_claim</code></a>
specifies the name for the Identity alias created by Vault upon a successful login.</p>
<p><a href="https://developer.hashicorp.com/vault/api-docs/auth/jwt#bound_claims_type"><code>bound_claims_type</code></a>
configures the interpretation of the <code>bound_claims</code> values. If set to <code>glob</code>, the values are interpreted as globs,
with <code>*</code> matching any number of characters.</p>
<p>The <a href="id_token_authentication.md#token-payload">claim fields</a> can also be accessed for
<a href="https://developer.hashicorp.com/vault/tutorials/policies/policy-templating?in=vault%2Fpolicies">Vault's policy path templating</a>
purposes by using the accessor name of the JWT auth in Vault.
The <a href="https://developer.hashicorp.com/vault/tutorials/auth-methods/identity#step-1-create-an-entity-with-alias">mount accessor name</a>
(<code>ACCESSOR_NAME</code> in the following example) can be retrieved by running <code>vault auth list</code>.</p>
<p>Policy template example making use of a named metadata field named <code>project_path</code>:</p>
<pre><code class="language-plaintext">path &quot;secret/data/{{identity.entity.aliases.ACCESSOR_NAME.metadata.project_path}}/staging/*&quot; {
  capabilities = [ &quot;read&quot; ]
}
</code></pre>
<p>Role example to support the previous templated policy mapping the claim field, <code>project_path</code>,
as a metadata field through use of <a href="https://developer.hashicorp.com/vault/api-docs/auth/jwt#claim_mappings"><code>claim_mappings</code></a>
configuration:</p>
<pre><code class="language-json">{
  &quot;role_type&quot;: &quot;jwt&quot;,
  ...
  &quot;claim_mappings&quot;: {
    &quot;project_path&quot;: &quot;project_path&quot;
  }
}
</code></pre>
<p>For the full list of options, see Vault's <a href="https://developer.hashicorp.com/vault/api-docs/auth/jwt#create-role">Create Role documentation</a>.</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>Always restrict your roles to project or namespace by using one of the provided claims
(for example, <code>project_id</code> or <code>namespace_id</code>). Otherwise any JWT generated by this instance
may be allowed to authenticate using this role.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>Now, configure the JWT Authentication method:</p>
<pre><code class="language-shell">$ vault write auth/jwt/config \
    oidc_discovery_url=&quot;https://gitlab.example.com&quot; \
    bound_issuer=&quot;https://gitlab.example.com&quot;
</code></pre>
<p><a href="https://developer.hashicorp.com/vault/api-docs/auth/jwt#bound_issuer"><code>bound_issuer</code></a>
specifies that only a JWT with the issuer (that is, the <code>iss</code> claim) set to <code>gitlab.example.com</code>
can use this method to authenticate, and that the <code>oidc_discovery_url</code> (<code>https://gitlab.example.com</code>)
should be used to validate the token.</p>
<p>For the full list of available configuration options, see Vault's <a href="https://developer.hashicorp.com/vault/api-docs/auth/jwt#configure">API documentation</a>.</p>
<p>In GitLab, create the following <a href="../variables/_index.md#for-a-project">CI/CD variables</a>
to provide details about your Vault server:</p>
<ul>
<li><code>VAULT_SERVER_URL</code>: The URL of your Vault server, for example <code>https://vault.example.com:8200</code>.</li>
<li><code>VAULT_AUTH_ROLE</code>: Optional. Name of the Vault JWT Auth role to use when attempting to authenticate. In this tutorial,
  you already created two roles with the names <code>myproject-staging</code> and <code>myproject-production</code>. If no role is specified,
  Vault uses the <a href="https://developer.hashicorp.com/vault/api-docs/auth/jwt#default_role">default role</a>
  specified when the authentication method was configured.</li>
<li><code>VAULT_AUTH_PATH</code>: Optional. The path where the authentication method is mounted.
  Default is <code>jwt</code>.</li>
<li><code>VAULT_NAMESPACE</code>: Optional. The <a href="https://developer.hashicorp.com/vault/docs/enterprise/namespaces">Vault Enterprise namespace</a>
  to use for reading secrets and authentication. If no namespace is specified, Vault uses the root (<code>/</code>) namespace.
  The setting is ignored by Vault Open Source.</li>
</ul>
<h2>Automatic ID token authentication</h2>
<p>The following job, when run for the default branch, can read secrets under <code>secret/myproject/staging/</code>,
but not the secrets under <code>secret/myproject/production/</code>:</p>
<pre><code class="language-yaml">job_with_secrets:
  id_tokens:
    VAULT_ID_TOKEN:
      aud: https://vault.example.com
  secrets:
    STAGING_DB_PASSWORD:
      vault: myproject/staging/db/password@secret  # translates to a path of 'secret/myproject/staging/db' and field 'password'. Authenticates using $VAULT_ID_TOKEN.
  script:
    - access-staging-db.sh --token $STAGING_DB_PASSWORD
</code></pre>
<p>In this example:</p>
<ul>
<li><code>id_tokens</code> - The JSON Web Token (JWT) used for OIDC authentication. The <code>aud</code> claim
  is set to match the <code>bound_audiences</code> parameter of the <code>role</code> used for the Vault JWT authentication method.</li>
<li><code>@secret</code> - The vault name, where your Secrets Engines are enabled.</li>
<li><code>myproject/staging/db</code> - The path location of the secret in Vault.</li>
<li><code>password</code> The field to be fetched in the referenced secret.</li>
</ul>
<p>If more than one ID token is defined, use the <code>token</code> keyword to specify which token should be used. For example:</p>
<pre><code class="language-yaml">job_with_secrets:
  id_tokens:
    FIRST_ID_TOKEN:
      aud: https://first.service.com
    SECOND_ID_TOKEN:
      aud: https://second.service.com
  secrets:
    FIRST_DB_PASSWORD:
      vault: first/db/password
      token: $FIRST_ID_TOKEN
    SECOND_DB_PASSWORD:
      vault: second/db/password
      token: $SECOND_ID_TOKEN
  script:
    - access-first-db.sh --token $FIRST_DB_PASSWORD
    - access-second-db.sh --token $SECOND_DB_PASSWORD
</code></pre>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>Starting in Vault 1.17, <a href="https://developer.hashicorp.com/vault/docs/upgrading/upgrade-to-1.17.x#jwt-auth-login-requires-bound-audiences-on-the-role">JWT auth login requires bound audiences on the role</a>
when the JWT contains an <code>aud</code> claim. The <code>aud</code> claim can be a single string or a list of strings.</p>
<p>{{&lt; /alert &gt;}}</p>
<h3>Manual authentication</h3>
<p>You can use ID tokens to authenticate with HashiCorp Vault manually. For example:</p>
<pre><code class="language-yaml">manual_authentication:
  variables:
    VAULT_ADDR: http://vault.example.com:8200
  image: vault:latest
  id_tokens:
    VAULT_ID_TOKEN:
      aud: http://vault.example.com
  script:
    - export VAULT_TOKEN=&quot;$(vault write -field=token auth/jwt/login role=myproject-example jwt=$VAULT_ID_TOKEN)&quot;
    - export PASSWORD=&quot;$(vault kv get -field=password secret/myproject/example/db)&quot;
    - my-authentication-script.sh $VAULT_TOKEN $PASSWORD
</code></pre>
<h2>Limit token access to Vault secrets</h2>
<p>You can control ID token access to Vault secrets by using Vault protections
and GitLab features. For example, restrict the token by:</p>
<ul>
<li>Using Vault <a href="https://developer.hashicorp.com/vault/docs/auth/jwt#bound-audiences">bound audiences</a>
  for specific ID token <code>aud</code> claims.</li>
<li>Using Vault <a href="https://developer.hashicorp.com/vault/docs/auth/jwt#bound-claims">bound claims</a>
  for specific groups using <code>group_claim</code>.</li>
<li>Hard coding values for Vault bound claims based on the <code>user_login</code> and <code>user_email</code>
  of specific users.</li>
<li>Setting Vault time limits for TTL of the token as specified in <a href="https://developer.hashicorp.com/vault/api-docs/auth/jwt#token_explicit_max_ttl"><code>token_explicit_max_ttl</code></a>,
  where the token expires after authentication.</li>
<li>Scoping the JWT to <a href="../../user/project/repository/branches/protected.html">GitLab protected branches</a>
  that are restricted to a subset of project users.</li>
<li>Scoping the JWT to <a href="../../user/project/protected_tags.html">GitLab protected tags</a>,
  that are restricted to a subset of project users.</li>
</ul>
<h2>Troubleshooting</h2>
<h3><code>The secrets provider can not be found. Check your CI/CD variables and try again.</code> message</h3>
<p>You might receive this error when attempting to start a job configured to access HashiCorp Vault:</p>
<pre><code class="language-plaintext">The secrets provider can not be found. Check your CI/CD variables and try again.
</code></pre>
<p>The job can't be created because the required variable is not defined:</p>
<ul>
<li><code>VAULT_SERVER_URL</code></li>
</ul>
<h3><code>api error: status code 400: missing role</code> error</h3>
<p>You might receive a <code>missing role</code> error when attempting to start a job configured to access HashiCorp Vault.
The error could be because the <code>VAULT_AUTH_ROLE</code> variable is not defined, so the job cannot authenticate
with the vault server.</p>
<h3><code>audience claim does not match any expected audience</code> error</h3>
<p>If there is a mismatch between values of <code>aud:</code> claim of the ID token specified in the YAML file
and the <code>bound_audiences</code> parameter of the <code>role</code> used for JWT authentication, you can get this error:</p>
<p><code>invalid audience (aud) claim: audience claim does not match any expected audience</code></p>
<p>Make sure these values are the same.</p></code></pre>
</body>
</html>
