<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Configure GCP IAM Workload Identity Federation (WIF)</title>
    <link rel="stylesheet" href="/../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Software Supply Chain Security
group: Pipeline Security
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Use GCP Secret Manager secrets in GitLab CI/CD</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/groups/gitlab-org/-/epics/11739">Introduced</a> in GitLab and GitLab Runner 16.8.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>You can use secrets stored in the <a href="https://cloud.google.com/security/products/secret-manager">Google Cloud (GCP) Secret Manager</a>
in your GitLab CI/CD pipelines.</p>
<p>The flow for using GitLab with GCP Secret Manager is:</p>
<ol>
<li>GitLab issues an ID token to the CI/CD job.</li>
<li>The runner authenticates to GCP using the ID token.</li>
<li>GCP verifies the ID token with GitLab.</li>
<li>GCP issues a short-lived access token.</li>
<li>The runner accesses the secret data using the access token.</li>
<li>GCP checks IAM secret permission on the access token's principal.</li>
<li>GCP returns the secret data to the runner.</li>
</ol>
<p>To use GitLab with GCP Secret Manager, you must:</p>
<ul>
<li>Have secrets stored in <a href="https://cloud.google.com/security/products/secret-manager">GCP Secret Manager</a>.</li>
<li>Configure <a href="#configure-gcp-iam-workload-identity-federation-wif">GCP Workload Identity Federation</a> to include GitLab as an identity provider.</li>
<li>Configure <a href="#grant-access-to-gcp-iam-principal">GCP IAM</a> permissions to grant access to GCP Secret Manager.</li>
<li>Configure <a href="#configure-gitlab-cicd-to-use-gcp-secret-manager-secrets">GitLab CI/CD with GCP Secret Manager</a>.</li>
</ul>
<h2>Configure GCP IAM Workload Identity Federation (WIF)</h2>
<p>GCP IAM WIF must be configured to recognize ID tokens issued by GitLab and assign an appropriate principal to them.
The principal is used to authorize access to the Secret Manager resources:</p>
<ol>
<li>In GCP Console, go to <strong>IAM &amp; Admin</strong> &gt; <strong>Workload Identity Federation</strong>.</li>
<li>Select <strong>CREATE POOL</strong> and create a new identity pool with a unique name, for example <code>gitlab-pool</code>.</li>
<li>Select <strong>ADD PROVIDER</strong> to add a new OIDC Provider to the Identity Pool with a unique name, for example <code>gitlab-provider</code>.</li>
<li>Set <strong>Issuer (URL)</strong> to the GitLab URL, for example <code>https://gitlab.com</code>.</li>
<li>Select <strong>Default audience</strong>, or select <strong>Allowed audiences</strong> for a custom audience, which is used in the <code>aud</code> for the GitLab CI/CD ID token.</li>
<li>
<p>Under <strong>Attribute Mapping</strong>, create the following mappings, where:</p>
</li>
<li>
<p><code>attribute.X</code> is the name of the attribute to include as a claim in the Google token.</p>
</li>
<li><code>assertion.X</code> is the value to extract from the <a href="../cloud_services/_index.md#id-token-authentication-for-cloud-services">GitLab claim</a>.</li>
</ol>
<table>
<thead>
<tr>
<th>Attribute (on Google)</th>
<th>Assertion (from GitLab)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>google.subject</code></td>
<td><code>assertion.sub</code></td>
</tr>
<tr>
<td><code>attribute.gitlab_project_id</code></td>
<td><code>assertion.project_id</code></td>
</tr>
</tbody>
</table>
<h2>Grant access to GCP IAM principal</h2>
<p>After setting up WIF, you must grant the WIF principal access to the secrets in Secret Manager.</p>
<ol>
<li>In GCP Console, go to <strong>Security</strong> &gt; <strong>Secret Manager</strong>.</li>
<li>Select the name of the secret you wish to grant access to, to view the secret's details.</li>
<li>From the <strong>PERMISSIONS</strong> tab, select <strong>GRANT ACCESS</strong> to grant access to the principal set created through the WIF provider.
   The external identity format is:</li>
</ol>
<p><code>plaintext
   principalSet://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/attribute.gitlab_project_id/GITLAB_PROJECT_ID</code></p>
<p>In this example:</p>
<ul>
<li><code>PROJECT_NUMBER</code>: Your Google Cloud project number (not ID) which can be found in the
     <a href="https://console.cloud.google.com/home/dashboard">Project's dashboard</a>.</li>
<li><code>POOL_ID</code>: The ID (not name) of the workload identity pool created in the first section,
     for example <code>gitlab-pool</code>.</li>
<li>
<p><code>GITLAB_PROJECT_ID</code>: The GitLab project ID found on the <a href="../../user/project/working_with_projects.md#find-the-project-id">project overview page</a>.</p>
</li>
<li>
<p>Assign the role <strong>Secret Manager Secret Accessor</strong>.</p>
</li>
</ul>
<h2>Configure GitLab CI/CD to use GCP Secret Manager secrets</h2>
<p>You must <a href="../variables/_index.md#for-a-project">add these CI/CD variables</a> to provide details about
your GCP Secret Manager:</p>
<ul>
<li><code>GCP_PROJECT_NUMBER</code>: The GCP <a href="https://cloud.google.com/resource-manager/docs/creating-managing-projects">Project Number</a>.</li>
<li><code>GCP_WORKLOAD_IDENTITY_FEDERATION_POOL_ID</code>: The WIF Pool ID, for example <code>gitlab-pool</code>.</li>
<li><code>GCP_WORKLOAD_IDENTITY_FEDERATION_PROVIDER_ID</code>: The WIF Provider ID, for example <code>gitlab-provider</code>.</li>
</ul>
<p>Then you can use secrets stored in GCP Secret Manager in CI/CD jobs by defining them
with the <code>gcp_secret_manager</code> keyword:</p>
<pre><code class="language-yaml">job_using_gcp_sm:
  id_tokens:
    GCP_ID_TOKEN:
      # `aud` must match the audience defined in the WIF Identity Pool.
      aud: https://iam.googleapis.com/projects/${GCP_PROJECT_NUMBER}/locations/global/workloadIdentityPools/${GCP_WORKLOAD_IDENTITY_FEDERATION_POOL_ID}/providers/${GCP_WORKLOAD_IDENTITY_FEDERATION_PROVIDER_ID}
  secrets:
    DATABASE_PASSWORD:
      gcp_secret_manager:
        name: my-project-secret  # This is the name of the secret defined in GCP Secret Manager
        version: 1               # optional: default to `latest`.
      token: $GCP_ID_TOKEN
</code></pre>
<h3>Use secrets from a different GCP project</h3>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab-runner/-/issues/37487">Introduced</a> in GitLab 17.0.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>Secret names in GCP are per-project. By default the secret named in <code>gcp_secret_manager:name</code>
is read from the project specified in <code>GCP_PROJECT_NUMBER</code>.</p>
<p>To read a secret from a different project than the project containing the WIF pool, use the
fully-qualified secret name formatted as <code>projects/&lt;project-number&gt;/secrets/&lt;secret-name&gt;</code>.</p>
<p>For example, if <code>my-project-secret</code> is in the GCP project number <code>123456789</code>,
then you can access the secret with:</p>
<pre><code class="language-yaml">job_using_gcp_sm:
  # ... as previously configured ...
  secrets:
    DATABASE_PASSWORD:
      gcp_secret_manager:
        name: projects/123456789/secrets/my-project-secret  # fully-qualified name of the secret defined in GCP Secret Manager
        version: 1                                          # optional: defaults to `latest`.
      token: $GCP_ID_TOKEN
</code></pre>
<h2>Troubleshooting</h2>
<h3>Error: The size of mapped attribute <code>google.subject</code> exceeds the 127 bytes limit</h3>
<p>Long branch paths can cause a job to fail with this error, because the
<a href="id_token_authentication.md#token-payload"><code>assertion.sub</code> attribute</a> becomes longer than 127 characters:</p>
<pre><code class="language-plaintext">ERROR: Job failed (system failure): resolving secrets: failed to exchange sts token: googleapi: got HTTP response code 400 with body:
{&quot;error&quot;:&quot;invalid_request&quot;,&quot;error_description&quot;:&quot;The size of mapped attribute google.subject exceeds the 127 bytes limit.
Either modify your attribute mapping or the incoming assertion to produce a mapped attribute that is less than 127 bytes.&quot;}
</code></pre>
<p>Long branch paths can be caused by:</p>
<ul>
<li>Deeply nested subgroups.</li>
<li>Long group, repository, or branch names.</li>
</ul>
<p>For example, for a <code>gitlab-org/gitlab</code> branch, the payload is <code>project_path:gitlab-org/gitlab:ref_type:branch:ref:{branch_name}</code>.
For the string to remain shorter than 127 characters, the branch name must be 76 characters or fewer.
This limit is imposed by Google Cloud IAM, tracked in <a href="https://issuetracker.google.com/issues/264362370?pli=1">Google issue #264362370</a>.</p>
<p>The only fix for this issue is to use shorter names
<a href="https://github.com/google-github-actions/auth/blob/main/docs/TROUBLESHOOTING.md#subject-exceeds-the-127-byte-limit">for your branch and repository</a>.</p>
<h3><code>The secrets provider can not be found. Check your CI/CD variables and try again.</code> message</h3>
<p>You might receive this error when attempting to start a job configured to access GCP Secret Manager:</p>
<pre><code class="language-plaintext">The secrets provider can not be found. Check your CI/CD variables and try again.
</code></pre>
<p>The job can't be created because one or more of the required variables are not defined:</p>
<ul>
<li><code>GCP_PROJECT_NUMBER</code></li>
<li><code>GCP_WORKLOAD_IDENTITY_FEDERATION_POOL_ID</code></li>
<li><code>GCP_WORKLOAD_IDENTITY_FEDERATION_PROVIDER_ID</code></li>
</ul>
<h3><code>WARNING: Not resolved: no resolver that can handle the secret</code> warning</h3>
<p>The Google Cloud Secret Manager integration requires at least GitLab 16.8 and GitLab Runner 16.8.
This warning appears if the job is executed by a runner using a version earlier than 16.8.</p>
<p>On GitLab.com, there is a <a href="https://gitlab.com/gitlab-org/ci-cd/shared-runners/infrastructure/-/issues/176">known issue</a>
causing SaaS runners to run an older version. As a workaround until this issue is fixed,
you can register your own GitLab Runner with version 16.8 or later.</p></code></pre>
</body>
</html>
