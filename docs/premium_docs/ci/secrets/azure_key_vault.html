<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Use Azure Key Vault secrets in a CI/CD job</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Software Supply Chain Security
group: Pipeline Security
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Use Azure Key Vault secrets in GitLab CI/CD</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/271271">Introduced</a> in GitLab and GitLab Runner 16.3. Due to <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/424746">issue 424746</a> this feature did not work as expected.</li>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/424746">Issue 424746</a> resolved and this feature made generally available in GitLab Runner 16.6.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>You can use secrets stored in the <a href="https://azure.microsoft.com/en-us/products/key-vault/">Azure Key Vault</a>
in your GitLab CI/CD pipelines.</p>
<p>Prerequisites:</p>
<ul>
<li>Have a <a href="https://learn.microsoft.com/en-us/azure/key-vault/general/quick-create-portal">Key Vault</a> on Azure.</li>
<li>Your IAM user must be <a href="https://learn.microsoft.com/en-us/azure/role-based-access-control/quickstart-assign-role-user-portal#grant-access">granted the <strong>Key Vault Administrator</strong> role assignment</a>
    for the <strong>resource group</strong> assigned to the Key Vault. Otherwise, you can't create secrets inside the Key Vault.</li>
<li><a href="../cloud_services/azure/_index.html">Configure OpenID Connect in Azure to retrieve temporary credentials</a>. These
  steps include instructions on how to create an Azure AD application for Key Vault access.</li>
<li>Add <a href="../variables/_index.md#for-a-project">CI/CD variables to your project</a> to provide details about your Vault server:</li>
<li><code>AZURE_KEY_VAULT_SERVER_URL</code>: The URL of your Azure Key Vault server, such as <code>https://vault.example.com</code>.</li>
<li><code>AZURE_CLIENT_ID</code>: The client ID of the Azure application.</li>
<li><code>AZURE_TENANT_ID</code>: The tenant ID of the Azure application.</li>
</ul>
<h2>Use Azure Key Vault secrets in a CI/CD job</h2>
<p>You can use a secret stored in your Azure Key Vault in a job by defining it with the
<a href="../yaml/_index.md#secretsazure_key_vault"><code>azure_key_vault</code></a> keyword:</p>
<pre><code class="language-yaml">job:
  id_tokens:
    AZURE_JWT:
      aud: 'https://gitlab.com'
  secrets:
    DATABASE_PASSWORD:
      token: $AZURE_JWT
      azure_key_vault:
        name: 'DATABASE-PASSWORD'
        version: '00000000000000000000000000000000'
</code></pre>
<p>To use multiple secrets from Azure Key Vault in the same job, define each secret under the <code>secrets</code> keyword:</p>
<pre><code class="language-yaml">job:
  id_tokens:
    AZURE_JWT:
      aud: 'https://gitlab.com'
  secrets:
    REDIS_PASSWORD:
      token: $AZURE_JWT
      azure_key_vault:
        name: 'REDIS-PASSWORD'
        version: '00000000000000000000000000000000'
    DATABASE_PASSWORD:
      token: $AZURE_JWT
      azure_key_vault:
        name: 'DATABASE-PASSWORD'
        version: '00000000000000000000000000000000'
</code></pre>
<p>In these examples:</p>
<ul>
<li><code>aud</code> is the audience, which must match the audience used when <a href="../cloud_services/azure/_index.md#create-azure-ad-federated-identity-credentials">creating the federated identity credentials</a></li>
<li><code>name</code> is the name of the secret in Azure Key Vault.</li>
<li><code>version</code> is the version of the secret in Azure Key Vault. The version is a generated
  GUID without dashes, which can be found on the Azure Key Vault secrets page.</li>
<li>GitLab fetches the secret from Azure Key Vault and stores the value in a temporary file.
  The path to this file is stored in a CI/CD variable with the name you defined under secrets
  (such as <code>DATABASE_PASSWORD</code> or <code>REDIS_PASSWORD</code>), similar to
  <a href="../variables/_index.md#use-file-type-cicd-variables">file type CI/CD variables</a>.</li>
</ul>
<h2>Troubleshooting</h2>
<p>Refer to <a href="../cloud_services/azure/_index.md#troubleshooting">OIDC for Azure troubleshooting</a> for general
problems when setting up OIDC with Azure.</p>
<h3><code>JWT token is invalid or malformed</code> message</h3>
<p>You might receive this error when fetching secrets from Azure Key Vault:</p>
<pre><code class="language-plaintext">RESPONSE 400 Bad Request
AADSTS50027: JWT token is invalid or malformed.
</code></pre>
<p>This occurs due to a <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/424746">known issue</a> in GitLab Runner where the JWT token isn't parsed correctly.
To resolve this, upgrade to GitLab Runner 16.6 or later.</p>
<h3><code>Caller is not authorized to perform action on resource</code> message</h3>
<p>You might receive this error when fetching secrets from Azure Key Vault:</p>
<pre><code class="language-plaintext">RESPONSE 403: 403 Forbidden
ERROR CODE: Forbidden
Caller is not authorized to perform action on resource.\r\nIf role assignments, deny assignments or role definitions were changed recently, please observe propagation time.
ForbiddenByRbac
</code></pre>
<p>If your Azure Key Vault is using RBAC, you must add the <strong>Key Vault Secrets User</strong> role assignment to your Azure AD
application.</p>
<p>For example:</p>
<pre><code class="language-shell">appId=$(az ad app list --display-name gitlab-oidc --query '[0].appId' -otsv)
az role assignment create --assignee $appId --role &quot;Key Vault Secrets User&quot; --scope /subscriptions/&lt;subscription-id&gt;
</code></pre>
<p>You can find your subscription ID in:</p>
<ul>
<li>The <a href="https://learn.microsoft.com/en-us/azure/azure-portal/get-subscription-tenant-id#find-your-azure-subscription">Azure Portal</a>.</li>
<li>The <a href="https://learn.microsoft.com/en-us/cli/azure/manage-azure-subscriptions-azure-cli#get-the-active-subscription">Azure CLI</a>.</li>
</ul>
<h3><code>The secrets provider can not be found. Check your CI/CD variables and try again.</code> message</h3>
<p>You might receive this error when attempting to start a job configured to access Azure Key Vault:</p>
<pre><code class="language-plaintext">The secrets provider can not be found. Check your CI/CD variables and try again.
</code></pre>
<p>The job can't be created because one or more of the required variables are not defined:</p>
<ul>
<li><code>AZURE_KEY_VAULT_SERVER_URL</code></li>
<li><code>AZURE_CLIENT_ID</code></li>
<li><code>AZURE_TENANT_ID</code></li>
</ul></code></pre>
</body>
</html>
