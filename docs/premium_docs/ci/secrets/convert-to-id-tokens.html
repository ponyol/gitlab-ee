<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Prerequisites</title>
    <link rel="stylesheet" href="/../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Software Supply Chain Security
group: Pipeline Security
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: 'Tutorial: Update HashiCorp Vault configuration to use ID Tokens'</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>Starting in Vault 1.17, <a href="https://developer.hashicorp.com/vault/docs/upgrading/upgrade-to-1.17.x#jwt-auth-login-requires-bound-audiences-on-the-role">JWT auth login requires bound audiences on the role</a>
when the JWT contains an <code>aud</code> claim. The <code>aud</code> claim can be a single string or a list of strings.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>This tutorial demonstrates how to convert your existing CI/CD secrets configuration to use <a href="id_token_authentication.html">ID Tokens</a>.</p>
<p>The <code>CI_JOB_JWT</code> variables are deprecated, but updating to ID tokens requires some
important configuration changes to work with Vault. If you have more than a handful of jobs,
converting everything at once is a daunting task.</p>
<p>There isn't one standard method to migrate to <a href="id_token_authentication.html">ID tokens</a>, so this tutorial
includes two variations for how to convert your existing CI/CD secrets. Choose the method that is most appropriate for
your use case:</p>
<ol>
<li>Update your Vault configuration:</li>
<li>Method A: Migrate JWT roles to the new Vault auth method<ol>
<li><a href="#create-a-second-jwt-authentication-path-in-vault">Create a second JWT authentication path in Vault</a></li>
<li><a href="#recreate-roles-to-use-the-new-authentication-path">Recreate roles to use the new authentication path</a></li>
</ol>
</li>
<li>Method B: Move <code>iss</code> claim to roles for the migration window<ol>
<li><a href="#add-bound_issuers-claim-map-to-each-role">Add <code>bound_issuers</code> claim map to each role</a></li>
<li><a href="#remove-bound_issuers-claim-from-auth-method">Remove <code>bound_issuers</code> claim from auth method</a></li>
</ol>
</li>
<li><a href="#update-your-cicd-jobs">Update your CI/CD Jobs</a></li>
</ol>
<h2>Prerequisites</h2>
<p>This tutorial assumes you are familiar with GitLab CI/CD and Vault.</p>
<p>To follow along, you must have:</p>
<ul>
<li>An instance running GitLab 16.0 or later, or be on GitLab.com.</li>
<li>A Vault server that you are already using.</li>
<li>CI/CD jobs retrieving secrets from Vault with <code>CI_JOB_JWT</code>.</li>
</ul>
<p>In the following examples, replace:</p>
<ul>
<li><code>vault.example.com</code> with the URL of your Vault server.</li>
<li><code>gitlab.example.com</code> with the URL of your GitLab instance.</li>
<li><code>jwt</code> or <code>jwt_v2</code> with your auth method names.</li>
</ul>
<h2>Method A: Migrate JWT roles to the new Vault auth method</h2>
<p>This method creates a second JWT auth method in parallel to the existing one in use. Afterwards all Vault roles used for the GitLab integration are recreated in this new auth method.</p>
<h3>Create a second JWT authentication path in Vault</h3>
<p>As part of the transition from <code>CI_JOB_JWT</code> to ID tokens, you must update the <code>bound_issuer</code> in Vault to include <code>https://</code>:</p>
<pre><code class="language-shell">$ vault write auth/jwt/config \
    oidc_discovery_url=&quot;https://gitlab.example.com&quot; \
    bound_issuer=&quot;https://gitlab.example.com&quot;
</code></pre>
<p>After you make this change, jobs that use <code>CI_JOB_JWT</code> start to fail.</p>
<p>You can create multiple authentication paths in Vault, which enable you to transition to ID Tokens on a project by job basis without disruption.</p>
<ol>
<li>Configure a new authentication path with the name <code>jwt_v2</code>, run:</li>
</ol>
<p><code>shell
   vault auth enable -path jwt_v2 jwt</code></p>
<p>You can choose a different name, but the rest of these examples assume you used <code>jwt_v2</code>, so update the examples as needed.</p>
<ol>
<li>Configure the new authentication path for your instance:</li>
</ol>
<p><code>shell
   $ vault write auth/jwt_v2/config \
       oidc_discovery_url="https://gitlab.example.com" \
       bound_issuer="https://gitlab.example.com"</code></p>
<h3>Recreate roles to use the new authentication path</h3>
<p>Roles are bound to a specific authentication path so you need to add new roles for each job.
The <code>bound_audiences</code> parameter for the role is mandatory if the JWT contains an
audience and must match at least one of the associated <code>aud</code> claims of the JWT.</p>
<ol>
<li>Recreate the role for staging named <code>myproject-staging</code>:</li>
</ol>
<p>```shell
   $ vault write auth/jwt_v2/role/myproject-staging - &lt;</p></code></pre>
</body>
</html>
