<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Requirements</title>
    <link rel="stylesheet" href="/../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: GitLab Delivery
group: Operate
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: 'Reference architecture: Up to 60 RPS or 3,000 users'</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>This page describes the GitLab reference architecture designed to target a peak load of 60 requests per second (RPS), the typical peak load of up to 3,000 users, both manual and automated, based on real data.</p>
<p>This architecture is the smallest one available with HA built in. If you require HA but
have a lower user count or total load the <a href="#supported-modifications-for-lower-user-counts-ha">Supported Modifications for lower user counts</a>
section details how to reduce this architecture's size while maintaining HA.</p>
<p>For a full list of reference architectures, see
<a href="_index.md#available-reference-architectures">Available reference architectures</a>.</p>
<ul>
<li><strong>Target Load</strong>: API: 60 RPS, Web: 6 RPS, Git (Pull): 6 RPS, Git (Push): 1 RPS</li>
<li><strong>High Availability</strong>: Yes, although <a href="#configure-praefect-postgresql">Praefect</a> needs a third-party PostgreSQL solution</li>
<li><strong>Cloud Native Hybrid Alternative</strong>: <a href="#cloud-native-hybrid-reference-architecture-with-helm-charts-alternative">Yes</a></li>
<li><strong>Unsure which Reference Architecture to use</strong>? <a href="_index.md#deciding-which-architecture-to-start-with">Go to this guide for more info</a>.</li>
</ul>
<table>
<thead>
<tr>
<th>Service</th>
<th>Nodes</th>
<th>Configuration</th>
<th>GCP example<sup>1</sup></th>
<th>AWS example<sup>1</sup></th>
<th>Azure example<sup>1</sup></th>
</tr>
</thead>
<tbody>
<tr>
<td>External load balancer<sup>4</sup></td>
<td>1</td>
<td>4 vCPU, 3.6 GB memory</td>
<td><code>n1-highcpu-4</code></td>
<td><code>c5n.xlarge</code></td>
<td><code>F4s v2</code></td>
</tr>
<tr>
<td>Consul<sup>2</sup></td>
<td>3</td>
<td>2 vCPU, 1.8 GB memory</td>
<td><code>n1-highcpu-2</code></td>
<td><code>c5.large</code></td>
<td><code>F2s v2</code></td>
</tr>
<tr>
<td>PostgreSQL<sup>2</sup></td>
<td>3</td>
<td>2 vCPU, 7.5 GB memory</td>
<td><code>n1-standard-2</code></td>
<td><code>m5.large</code></td>
<td><code>D2s v3</code></td>
</tr>
<tr>
<td>PgBouncer<sup>2</sup></td>
<td>3</td>
<td>2 vCPU, 1.8 GB memory</td>
<td><code>n1-highcpu-2</code></td>
<td><code>c5.large</code></td>
<td><code>F2s v2</code></td>
</tr>
<tr>
<td>Internal load balancer<sup>4</sup></td>
<td>1</td>
<td>4 vCPU, 3.6 GB memory</td>
<td><code>n1-highcpu-4</code></td>
<td><code>c5n.xlarge</code></td>
<td><code>F4s v2</code></td>
</tr>
<tr>
<td>Redis/Sentinel<sup>3</sup></td>
<td>3</td>
<td>2 vCPU, 7.5 GB memory</td>
<td><code>n1-standard-2</code></td>
<td><code>m5.large</code></td>
<td><code>D2s v3</code></td>
</tr>
<tr>
<td>Gitaly<sup>6</sup><sup>7</sup></td>
<td>3</td>
<td>4 vCPU, 15 GB memory</td>
<td><code>n1-standard-4</code></td>
<td><code>m5.xlarge</code></td>
<td><code>D4s v3</code></td>
</tr>
<tr>
<td>Praefect<sup>6</sup></td>
<td>3</td>
<td>2 vCPU, 1.8 GB memory</td>
<td><code>n1-highcpu-2</code></td>
<td><code>c5.large</code></td>
<td><code>F2s v2</code></td>
</tr>
<tr>
<td>Praefect PostgreSQL<sup>2</sup></td>
<td>1+</td>
<td>2 vCPU, 1.8 GB memory</td>
<td><code>n1-highcpu-2</code></td>
<td><code>c5.large</code></td>
<td><code>F2s v2</code></td>
</tr>
<tr>
<td>Sidekiq<sup>8</sup></td>
<td>2</td>
<td>4 vCPU, 15 GB memory</td>
<td><code>n1-standard-4</code></td>
<td><code>m5.xlarge</code></td>
<td><code>D2s v3</code></td>
</tr>
<tr>
<td>GitLab Rails<sup>8</sup></td>
<td>3</td>
<td>8 vCPU, 7.2 GB memory</td>
<td><code>n1-highcpu-8</code></td>
<td><code>c5.2xlarge</code></td>
<td><code>F8s v2</code></td>
</tr>
<tr>
<td>Monitoring node</td>
<td>1</td>
<td>2 vCPU, 1.8 GB memory</td>
<td><code>n1-highcpu-2</code></td>
<td><code>c5.large</code></td>
<td><code>F2s v2</code></td>
</tr>
<tr>
<td>Object storage<sup>5</sup></td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><strong>Footnotes</strong>:</p>
<!-- Disable ordered list rule https://github.com/DavidAnson/markdownlint/blob/main/doc/Rules.md#md029---ordered-list-item-prefix -->
<!-- markdownlint-disable MD029 -->
<ol>
<li>Machine type examples are given for illustration purposes. These types are used in <a href="_index.md#validation-and-test-results">validation and testing</a> but are not intended as prescriptive defaults. Switching to other machine types that meet the requirements as listed is supported, including ARM variants if available. See <a href="_index.md#supported-machine-types">Supported machine types</a> for more information.</li>
<li>Can be optionally run on reputable third-party external PaaS PostgreSQL solutions. See <a href="#provide-your-own-postgresql-instance">Provide your own PostgreSQL instance</a> for more information.</li>
<li>Can be optionally run on reputable third-party external PaaS Redis solutions. See <a href="#provide-your-own-redis-instance">Provide your own Redis instance</a> for more information.</li>
<li>Recommended to be run with a reputable third-party load balancer or service (LB PaaS) which can provide HA capabilities.
   Sizing depends on selected Load Balancer and additional factors such as Network Bandwidth. Refer to <a href="_index.md#load-balancers">Load Balancers</a> for more information.</li>
<li>Should be run on reputable Cloud Provider or Self Managed solutions. See <a href="#configure-the-object-storage">Configure the object storage</a> for more information.</li>
<li>Gitaly Cluster (Praefect) provides the benefits of fault tolerance, but comes with additional complexity of setup and management.
   Review the existing <a href="../gitaly/praefect/_index.md#before-deploying-gitaly-cluster-praefect">technical limitations and considerations before deploying Gitaly Cluster (Praefect)</a>. If you want sharded Gitaly, use the same specs listed in the previous table for <code>Gitaly</code>.</li>
<li>Gitaly specifications are based on high percentiles of both usage patterns and repository sizes in good health.
   However, if you have <a href="_index.md#large-monorepos">large monorepos</a> (larger than several gigabytes) or <a href="_index.md#additional-workloads">additional workloads</a> these can significantly impact Git and Gitaly performance and further adjustments will likely be required.</li>
<li>Can be placed in Auto Scaling Groups (ASGs) as the component doesn't store any <a href="_index.md#autoscaling-of-stateful-nodes">stateful data</a>.
   However, <a href="#cloud-native-hybrid-reference-architecture-with-helm-charts-alternative">Cloud Native Hybrid setups</a> are generally preferred as certain components
   such as like <a href="#gitlab-rails-post-configuration">migrations</a> and <a href="../incoming_email.html">Mailroom</a> can only be run on one node, which is handled better in Kubernetes.</li>
</ol>
<!-- markdownlint-enable MD029 -->

<p>{{&lt; alert type="note" &gt;}}</p>
<p>For all PaaS solutions that involve configuring instances, it's recommended to implement a minimum of three nodes in three different availability zones to align with resilient cloud architecture practices.</p>
<p>{{&lt; /alert &gt;}}</p>
<pre><code class="language-plantuml">@startuml 3k
skinparam linetype ortho

card &quot;**External Load Balancer**&quot; as elb #6a9be7
card &quot;**Internal Load Balancer**&quot; as ilb #9370DB

together {
  collections &quot;**GitLab Rails** x3&quot; as gitlab #32CD32
  collections &quot;**Sidekiq** x2&quot; as sidekiq #ff8dd1
}

together {
  card &quot;**Prometheus**&quot; as monitor #7FFFD4
  collections &quot;**Consul** x3&quot; as consul #e76a9b
}

card &quot;Gitaly Cluster&quot; as gitaly_cluster {
  collections &quot;**Praefect** x3&quot; as praefect #FF8C00
  collections &quot;**Gitaly** x3&quot; as gitaly #FF8C00
  card &quot;**Praefect PostgreSQL***\n//Non fault-tolerant//&quot; as praefect_postgres #FF8C00

  praefect -[#FF8C00]-&gt; gitaly
  praefect -[#FF8C00]&gt; praefect_postgres
}

card &quot;Database&quot; as database {
  collections &quot;**PGBouncer** x3&quot; as pgbouncer #4EA7FF
  card &quot;**PostgreSQL** //Primary//&quot; as postgres_primary #4EA7FF
  collections &quot;**PostgreSQL** //Secondary// x2&quot; as postgres_secondary #4EA7FF

  pgbouncer -[#4EA7FF]-&gt; postgres_primary
  postgres_primary .[#4EA7FF]&gt; postgres_secondary
}

card &quot;Redis&quot; as redis {
  collections &quot;**Redis** x3&quot; as redis_nodes #FF6347
}

cloud &quot;**Object Storage**&quot; as object_storage #white

elb -[#6a9be7]-&gt; gitlab
elb -[#6a9be7,norank]--&gt; monitor

gitlab -[#32CD32,norank]--&gt; ilb
gitlab -[#32CD32]r-&gt; object_storage
gitlab -[#32CD32]----&gt; redis
gitlab .[#32CD32]----&gt; database
gitlab -[hidden]-&gt; monitor
gitlab -[hidden]-&gt; consul

sidekiq -[#ff8dd1,norank]--&gt; ilb
sidekiq -[#ff8dd1]r-&gt; object_storage
sidekiq -[#ff8dd1]----&gt; redis
sidekiq .[#ff8dd1]----&gt; database
sidekiq -[hidden]-&gt; monitor
sidekiq -[hidden]-&gt; consul

ilb -[#9370DB]--&gt; gitaly_cluster
ilb -[#9370DB]--&gt; database
ilb -[hidden]--&gt; redis
ilb -[hidden]u-&gt; consul
ilb -[hidden]u-&gt; monitor

consul .[#e76a9b]u-&gt; gitlab
consul .[#e76a9b]u-&gt; sidekiq
consul .[#e76a9b]r-&gt; monitor
consul .[#e76a9b]-&gt; database
consul .[#e76a9b]-&gt; gitaly_cluster
consul .[#e76a9b,norank]--&gt; redis

monitor .[#7FFFD4]u-&gt; gitlab
monitor .[#7FFFD4]u-&gt; sidekiq
monitor .[#7FFFD4]&gt; consul
monitor .[#7FFFD4]-&gt; database
monitor .[#7FFFD4]-&gt; gitaly_cluster
monitor .[#7FFFD4,norank]--&gt; redis
monitor .[#7FFFD4]&gt; ilb
monitor .[#7FFFD4,norank]u--&gt; elb

@enduml
</code></pre>
<h2>Requirements</h2>
<p>Before proceeding, review the <a href="_index.md#requirements">requirements</a> for the reference architectures.</p>
<h2>Testing methodology</h2>
<p>The 60 RPS / 3k user reference architecture is designed to accommodate most common workflows. GitLab regularly conducts smoke and performance testing against the following endpoint throughput targets:</p>
<table>
<thead>
<tr>
<th>Endpoint type</th>
<th>Target throughput</th>
</tr>
</thead>
<tbody>
<tr>
<td>API</td>
<td>60 RPS</td>
</tr>
<tr>
<td>Web</td>
<td>6 RPS</td>
</tr>
<tr>
<td>Git (Pull)</td>
<td>6 RPS</td>
</tr>
<tr>
<td>Git (Push)</td>
<td>1 RPS</td>
</tr>
</tbody>
</table>
<p>These targets are based on actual customer data reflecting total environmental loads for the specified user count, including CI pipelines and other workloads.</p>
<p>For more information about our testing methodology, see the <a href="_index.md#validation-and-test-results">validation and test results</a> section.</p>
<h3>Performance Considerations</h3>
<p>You may need additional adjustments if your environment has:</p>
<ul>
<li>Consistently higher throughput than the listed targets</li>
<li><a href="_index.md#large-monorepos">Large monorepos</a></li>
<li>Significant <a href="_index.md#additional-workloads">additional workloads</a></li>
</ul>
<p>In these cases, refer to <a href="_index.md#scaling-an-environment">scaling an environment</a> for more information. If you believe these considerations may apply to you, contact us for additional guidance as required.</p>
<h3>Load Balancer configuration</h3>
<p>Our testing environment uses:</p>
<ul>
<li>HAProxy for Linux package environments</li>
<li>Cloud Provider equivalents with NGINX Ingress for Cloud Native Hybrids</li>
</ul>
<h2>Set up components</h2>
<p>To set up GitLab and its components to accommodate up to 60 RPS or 3,000 users:</p>
<ol>
<li><a href="#configure-the-external-load-balancer">Configure the external load balancer</a>
   to handle the load balancing of the GitLab application services nodes.</li>
<li><a href="#configure-the-internal-load-balancer">Configure the internal load balancer</a>
   to handle the load balancing of GitLab application internal connections.</li>
<li><a href="#configure-consul">Configure Consul</a> for service discovery and health checking.</li>
<li><a href="#configure-postgresql">Configure PostgreSQL</a>, the database for GitLab.</li>
<li><a href="#configure-pgbouncer">Configure PgBouncer</a> for database connection pooling and management.</li>
<li><a href="#configure-redis">Configure Redis</a>, which stores session data, temporary
   cache information, and background job queues.</li>
<li><a href="#configure-gitaly-cluster-praefect">Configure Gitaly Cluster (Praefect)</a>,
   provides access to the Git repositories.</li>
<li><a href="#configure-sidekiq">Configure Sidekiq</a> for background job processing.</li>
<li><a href="#configure-gitlab-rails">Configure the main GitLab Rails application</a>
   to run Puma, Workhorse, GitLab Shell, and to serve all frontend
   requests (which include UI, API, and Git over HTTP/SSH).</li>
<li><a href="#configure-prometheus">Configure Prometheus</a> to monitor your GitLab
   environment.</li>
<li><a href="#configure-the-object-storage">Configure the object storage</a>
   used for shared data objects.</li>
<li><a href="#configure-advanced-search">Configure advanced search</a> (optional) for faster,
   more advanced code search across your entire GitLab instance.</li>
</ol>
<p>The servers start on the same 10.6.0.0/24 private network range, and can
connect to each other freely on these addresses.</p>
<p>The following list includes descriptions of each server and its assigned IP:</p>
<ul>
<li><code>10.6.0.10</code>: External Load Balancer</li>
<li><code>10.6.0.11</code>: Consul/Sentinel 1</li>
<li><code>10.6.0.12</code>: Consul/Sentinel 2</li>
<li><code>10.6.0.13</code>: Consul/Sentinel 3</li>
<li><code>10.6.0.21</code>: PostgreSQL primary</li>
<li><code>10.6.0.22</code>: PostgreSQL secondary 1</li>
<li><code>10.6.0.23</code>: PostgreSQL secondary 2</li>
<li><code>10.6.0.31</code>: PgBouncer 1</li>
<li><code>10.6.0.32</code>: PgBouncer 2</li>
<li><code>10.6.0.33</code>: PgBouncer 3</li>
<li><code>10.6.0.20</code>: Internal Load Balancer</li>
<li><code>10.6.0.61</code>: Redis Primary</li>
<li><code>10.6.0.62</code>: Redis Replica 1</li>
<li><code>10.6.0.63</code>: Redis Replica 2</li>
<li><code>10.6.0.51</code>: Gitaly 1</li>
<li><code>10.6.0.52</code>: Gitaly 2</li>
<li><code>10.6.0.93</code>: Gitaly 3</li>
<li><code>10.6.0.131</code>: Praefect 1</li>
<li><code>10.6.0.132</code>: Praefect 2</li>
<li><code>10.6.0.133</code>: Praefect 3</li>
<li><code>10.6.0.141</code>: Praefect PostgreSQL 1 (non HA)</li>
<li><code>10.6.0.71</code>: Sidekiq 1</li>
<li><code>10.6.0.72</code>: Sidekiq 2</li>
<li><code>10.6.0.41</code>: GitLab application 1</li>
<li><code>10.6.0.42</code>: GitLab application 2</li>
<li><code>10.6.0.43</code>: GitLab application 3</li>
<li><code>10.6.0.81</code>: Prometheus</li>
</ul>
<h2>Configure the external load balancer</h2>
<p>In a multi-node GitLab configuration, you'll need an external load balancer to route
traffic to the application servers.</p>
<p>The specifics on which load balancer to use, or its exact configuration
is beyond the scope of GitLab documentation but refer to <a href="_index.html">Load Balancers</a> for more information around
general requirements. This section will focus on the specifics of
what to configure for your load balancer of choice.</p>
<h3>Readiness checks</h3>
<p>Ensure the external load balancer only routes to working services with built
in monitoring endpoints. The <a href="../monitoring/health_check.html">readiness checks</a>
all require <a href="../monitoring/ip_allowlist.html">additional configuration</a>
on the nodes being checked, otherwise, the external load balancer will not be able to
connect.</p>
<h3>Ports</h3>
<p>The basic ports to be used are shown in the table below.</p>
<table>
<thead>
<tr>
<th>LB Port</th>
<th>Backend Port</th>
<th>Protocol</th>
</tr>
</thead>
<tbody>
<tr>
<td>80</td>
<td>80</td>
<td>HTTP (<em>1</em>)</td>
</tr>
<tr>
<td>443</td>
<td>443</td>
<td>TCP or HTTPS (<em>1</em>) (<em>2</em>)</td>
</tr>
<tr>
<td>22</td>
<td>22</td>
<td>TCP</td>
</tr>
</tbody>
</table>
<ul>
<li>(<em>1</em>): <a href="../../ci/environments/_index.md#web-terminals-deprecated">Web terminal</a> support requires
  your load balancer to correctly handle WebSocket connections. When using
  HTTP or HTTPS proxying, this means your load balancer must be configured
  to pass through the <code>Connection</code> and <code>Upgrade</code> hop-by-hop headers. See the
  <a href="../integration/terminal.html">web terminal</a> integration guide for
  more details.</li>
<li>(<em>2</em>): When using HTTPS protocol for port 443, you must add an SSL
  certificate to the load balancers. If you wish to terminate SSL at the
  GitLab application server instead, use TCP protocol.</li>
</ul>
<p>If you're using GitLab Pages with custom domain support you will need some
additional port configurations.
GitLab Pages requires a separate virtual IP address. Configure DNS to point the
<code>pages_external_url</code> from <code>/etc/gitlab/gitlab.rb</code> at the new virtual IP address. See the
<a href="../pages/_index.html">GitLab Pages documentation</a> for more information.</p>
<table>
<thead>
<tr>
<th>LB Port</th>
<th>Backend Port</th>
<th>Protocol</th>
</tr>
</thead>
<tbody>
<tr>
<td>80</td>
<td>Varies (<em>1</em>)</td>
<td>HTTP</td>
</tr>
<tr>
<td>443</td>
<td>Varies (<em>1</em>)</td>
<td>TCP (<em>2</em>)</td>
</tr>
</tbody>
</table>
<ul>
<li>(<em>1</em>): The backend port for GitLab Pages depends on the
  <code>gitlab_pages['external_http']</code> and <code>gitlab_pages['external_https']</code>
  setting. See <a href="../pages/_index.html">GitLab Pages documentation</a> for more details.</li>
<li>(<em>2</em>): Port 443 for GitLab Pages should always use the TCP protocol. Users can
  configure custom domains with custom SSL, which would not be possible
  if SSL was terminated at the load balancer.</li>
</ul>
<h4>Alternate SSH Port</h4>
<p>Some organizations have policies against opening SSH port 22. In this case,
it may be helpful to configure an alternate SSH hostname that allows users
to use SSH on port 443. An alternate SSH hostname will require a new virtual IP address
compared to the other GitLab HTTP configuration documented previously.</p>
<p>Configure DNS for an alternate SSH hostname such as <code>altssh.gitlab.example.com</code>.</p>
<table>
<thead>
<tr>
<th>LB Port</th>
<th>Backend Port</th>
<th>Protocol</th>
</tr>
</thead>
<tbody>
<tr>
<td>443</td>
<td>22</td>
<td>TCP</td>
</tr>
</tbody>
</table>
<h3>SSL</h3>
<p>The next question is how you will handle SSL in your environment.
There are several different options:</p>
<ul>
<li><a href="#application-node-terminates-ssl">The application node terminates SSL</a>.</li>
<li><a href="#load-balancer-terminates-ssl-without-backend-ssl">The load balancer terminates SSL without backend SSL</a>
  and communication is not secure between the load balancer and the application node.</li>
<li><a href="#load-balancer-terminates-ssl-with-backend-ssl">The load balancer terminates SSL with backend SSL</a>
  and communication is secure between the load balancer and the application node.</li>
</ul>
<h4>Application node terminates SSL</h4>
<p>Configure your load balancer to pass connections on port 443 as <code>TCP</code> rather
than <code>HTTP(S)</code> protocol. This will pass the connection to the application node's
NGINX service untouched. NGINX will have the SSL certificate and listen on port 443.</p>
<p>See the <a href="https://docs.gitlab.com/omnibus/settings/ssl/">HTTPS documentation</a>
for details on managing SSL certificates and configuring NGINX.</p>
<h4>Load balancer terminates SSL without backend SSL</h4>
<p>Configure your load balancer to use the <code>HTTP(S)</code> protocol rather than <code>TCP</code>.
The load balancer will then be responsible for managing SSL certificates and
terminating SSL.</p>
<p>Because communication between the load balancer and GitLab will not be secure,
there is some additional configuration needed. See the
<a href="https://docs.gitlab.com/omnibus/settings/ssl/#configure-a-reverse-proxy-or-load-balancer-ssl-termination">proxied SSL documentation</a>
for details.</p>
<h4>Load balancer terminates SSL with backend SSL</h4>
<p>Configure your load balancers to use the 'HTTP(S)' protocol rather than 'TCP'.
The load balancers will be responsible for managing SSL certificates that
end users will see.</p>
<p>Traffic will also be secure between the load balancers and NGINX in this
scenario. There is no requirement to add configuration for proxied SSL because the
connection will be secure all the way. However, configuration must be
added to GitLab to configure SSL certificates. See
the <a href="https://docs.gitlab.com/omnibus/settings/ssl/">HTTPS documentation</a>
for details on managing SSL certificates and configuring NGINX.</p>
<div align="right">
  <a type="button" class="btn btn-default" href="#set-up-components">
    Back to set up components <i class="fa fa-angle-double-up" aria-hidden="true"></i>
  </a>
</div>

<h2>Configure the internal load balancer</h2>
<p>In a multi-node GitLab configuration, you'll need an internal load balancer to route
traffic for select internal components if configured
such as connections to <a href="#configure-pgbouncer">PgBouncer</a> and <a href="#configure-praefect">Gitaly Cluster (Praefect)</a>.</p>
<p>The specifics on which load balancer to use, or its exact configuration
is beyond the scope of GitLab documentation but refer to <a href="_index.html">Load Balancers</a> for more information around
general requirements. This section will focus on the specifics of
what to configure for your load balancer of choice.</p>
<p>The following IP will be used as an example:</p>
<ul>
<li><code>10.6.0.40</code>: Internal Load Balancer</li>
</ul>
<p>Here's how you could do it with <a href="https://www.haproxy.org/">HAProxy</a>:</p>
<pre><code class="language-plaintext">global
    log /dev/log local0
    log localhost local1 notice
    log stdout format raw local0

defaults
    log global
    default-server inter 10s fall 3 rise 2
    balance leastconn

frontend internal-pgbouncer-tcp-in
    bind *:6432
    mode tcp
    option tcplog

    default_backend pgbouncer

frontend internal-praefect-tcp-in
    bind *:2305
    mode tcp
    option tcplog
    option clitcpka

    default_backend praefect

backend pgbouncer
    mode tcp
    option tcp-check

    server pgbouncer1 10.6.0.31:6432 check
    server pgbouncer2 10.6.0.32:6432 check
    server pgbouncer3 10.6.0.33:6432 check

backend praefect
    mode tcp
    option tcp-check
    option srvtcpka

    server praefect1 10.6.0.131:2305 check
    server praefect2 10.6.0.132:2305 check
    server praefect3 10.6.0.133:2305 check
</code></pre>
<p>Refer to your preferred Load Balancer's documentation for further guidance.</p>
<div align="right">
  <a type="button" class="btn btn-default" href="#set-up-components">
    Back to set up components <i class="fa fa-angle-double-up" aria-hidden="true"></i>
  </a>
</div>

<h2>Configure Consul</h2>
<p>Next, we set up the Consul servers.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>Consul must be deployed in an odd number of 3 nodes or more. This is to ensure the nodes can take votes as part of a quorum.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>The following IPs will be used as an example:</p>
<ul>
<li><code>10.6.0.11</code>: Consul 1</li>
<li><code>10.6.0.12</code>: Consul 2</li>
<li><code>10.6.0.13</code>: Consul 3</li>
</ul>
<p>To configure Consul:</p>
<ol>
<li>SSH in to the server that will host Consul.</li>
<li><a href="../../install/package/_index.md#supported-platforms">Download and install</a> the Linux
   package of your choice. Be sure to only add the GitLab package repository and install GitLab
   for your chosen operating system. Select the same version
   and type (Community or Enterprise editions) as your current install.</li>
<li>Edit <code>/etc/gitlab/gitlab.rb</code> and add the contents:</li>
</ol>
<p>```ruby
   roles(['consul_role'])</p>
<p>## Enable service discovery for Prometheus
   consul['monitoring_service_discovery'] =  true</p>
<p>## The IPs of the Consul server nodes
   ## You can also use FQDNs and intermix them with IPs
   consul['configuration'] = {
      server: true,
      retry_join: %w(10.6.0.11 10.6.0.12 10.6.0.13),
   }</p>
<p># Set the network addresses that the exporters will listen on
   node_exporter['listen_address'] = '0.0.0.0:9100'</p>
<p># Prevent database migrations from running on upgrade automatically
   gitlab_rails['auto_migrate'] = false
   ```</p>
<ol>
<li>
<p>Copy the <code>/etc/gitlab/gitlab-secrets.json</code> file from the first Linux package node you configured and add or replace
   the file of the same name on this server. If this is the first Linux package node you are configuring then you can skip this step.</p>
</li>
<li>
<p><a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">Reconfigure GitLab</a> for the changes to take effect.</p>
</li>
<li>
<p>Go through the steps again for all the other Consul nodes, and
   make sure you set up the correct IPs.</p>
</li>
</ol>
<p>A Consul leader is elected when the provisioning of the third Consul server is
complete. Viewing the Consul logs <code>sudo gitlab-ctl tail consul</code> displays
<code>...[INFO] consul: New leader elected: ...</code>.</p>
<p>You can list the current Consul members (server, client):</p>
<pre><code class="language-shell">sudo /opt/gitlab/embedded/bin/consul members
</code></pre>
<p>You can verify the GitLab services are running:</p>
<pre><code class="language-shell">sudo gitlab-ctl status
</code></pre>
<p>The output should be similar to the following:</p>
<pre><code class="language-plaintext">run: consul: (pid 30074) 76834s; run: log: (pid 29740) 76844s
run: logrotate: (pid 30925) 3041s; run: log: (pid 29649) 76861s
run: node-exporter: (pid 30093) 76833s; run: log: (pid 29663) 76855s
</code></pre>
<div align="right">
  <a type="button" class="btn btn-default" href="#set-up-components">
    Back to set up components <i class="fa fa-angle-double-up" aria-hidden="true"></i>
  </a>
</div>

<h2>Configure PostgreSQL</h2>
<p>In this section, you are guided through configuring a highly available PostgreSQL
cluster to be used with GitLab.</p>
<h3>Provide your own PostgreSQL instance</h3>
<p>Instead of the Linux package-bundled PostgreSQL, PgBouncer, and Consul service discovery components, you can use a
<a href="../postgresql/external.html">third-party external service for PostgreSQL</a>.</p>
<p>Use a reputable provider that runs a <a href="../../install/requirements.md#postgresql">supported PostgreSQL version</a>. These services are known to work well:</p>
<ul>
<li><a href="https://cloud.google.com/sql/docs/postgres/high-availability#normal">Google Cloud SQL</a>.</li>
<li><a href="https://aws.amazon.com/rds/">Amazon RDS</a>.</li>
</ul>
<p>For more information, including guidance on high availability and database load balancing, see:</p>
<ul>
<li><a href="_index.md#recommended-cloud-providers-and-services">Recommended cloud providers and services</a>.</li>
<li><a href="_index.md#best-practices-for-the-database-services">Best practices for the database services</a>.</li>
</ul>
<p>If you use a third party external service:</p>
<ol>
<li>Set up PostgreSQL according to the <a href="../../install/requirements.md#postgresql">database requirements document</a>.</li>
<li>Configure the required <a href="../postgresql/external.html">users and databases</a>.</li>
<li>Configure the GitLab application servers with the appropriate connection details by following <a href="#configure-gitlab-rails">configure GitLab Rails</a>.</li>
</ol>
<h3>Standalone PostgreSQL using the Linux package</h3>
<p>The recommended Linux package configuration for a PostgreSQL cluster with
replication and failover requires:</p>
<ul>
<li>A minimum of three PostgreSQL nodes.</li>
<li>A minimum of three Consul server nodes.</li>
<li>A minimum of three PgBouncer nodes that track and handle primary database reads and writes.</li>
<li>An <a href="#configure-the-internal-load-balancer">internal load balancer</a> (TCP) to balance requests between the PgBouncer nodes.</li>
<li><a href="../postgresql/database_load_balancing.html">Database Load Balancing</a> enabled.</li>
</ul>
<p>A local PgBouncer service to be configured on each PostgreSQL node. This is separate from the main PgBouncer cluster that tracks the primary.</p>
<p>The following IPs are used as an example:</p>
<ul>
<li><code>10.6.0.21</code>: PostgreSQL primary</li>
<li><code>10.6.0.22</code>: PostgreSQL secondary 1</li>
<li><code>10.6.0.23</code>: PostgreSQL secondary 2</li>
</ul>
<p>First, make sure to <a href="../../install/package/_index.md#supported-platforms">install</a>
the Linux GitLab package <strong>on each node</strong>. Be sure to only add the GitLab
package repository and install GitLab for your chosen operating system,
but do <strong>not</strong> provide the <code>EXTERNAL_URL</code> value.</p>
<h4>PostgreSQL nodes</h4>
<ol>
<li>SSH in to one of the PostgreSQL nodes.</li>
<li>Generate a password hash for the PostgreSQL username/password pair. This assumes you use the default
   username of <code>gitlab</code> (recommended). The command requests a password
   and confirmation. Use the value that is output by this command in the next
   step as the value of <code>&lt;postgresql_password_hash&gt;</code>:</li>
</ol>
<p><code>shell
   sudo gitlab-ctl pg-password-md5 gitlab</code></p>
<ol>
<li>Generate a password hash for the PgBouncer username/password pair. This assumes you use the default
   username of <code>pgbouncer</code> (recommended). The command requests a password
   and confirmation. Use the value that is output by this command in the next
   step as the value of <code>&lt;pgbouncer_password_hash&gt;</code>:</li>
</ol>
<p><code>shell
   sudo gitlab-ctl pg-password-md5 pgbouncer</code></p>
<ol>
<li>Generate a password hash for the PostgreSQL replication username/password pair. This assumes you use the default
   username of <code>gitlab_replicator</code> (recommended). The command requests a password
   and a confirmation. Use the value that is output by this command in the next step
   as the value of <code>&lt;postgresql_replication_password_hash&gt;</code>:</li>
</ol>
<p><code>shell
   sudo gitlab-ctl pg-password-md5 gitlab_replicator</code></p>
<ol>
<li>Generate a password hash for the Consul database username/password pair. This assumes you use the default
   username of <code>gitlab-consul</code> (recommended). The command requests a password
   and confirmation. Use the value that is output by this command in the next
   step as the value of <code>&lt;consul_password_hash&gt;</code>:</li>
</ol>
<p><code>shell
   sudo gitlab-ctl pg-password-md5 gitlab-consul</code></p>
<ol>
<li>On every database node, edit <code>/etc/gitlab/gitlab.rb</code> replacing values noted in the <code># START user configuration</code> section:</li>
</ol>
<p>```ruby
   # Disable all components except Patroni, PgBouncer and Consul
   roles(['patroni_role', 'pgbouncer_role'])</p>
<p># PostgreSQL configuration
   postgresql['listen_address'] = '0.0.0.0'</p>
<p># Sets <code>max_replication_slots</code> to double the number of database nodes.
   # Patroni uses one extra slot per node when initiating the replication.
   patroni['postgresql']['max_replication_slots'] = 6</p>
<p># Set <code>max_wal_senders</code> to one more than the number of replication slots in the cluster.
   # This is used to prevent replication from using up all of the
   # available database connections.
   patroni['postgresql']['max_wal_senders'] = 7</p>
<p># Prevent database migrations from running on upgrade automatically
   gitlab_rails['auto_migrate'] = false</p>
<p># Configure the Consul agent
   consul['services'] = %w(postgresql)
   ## Enable service discovery for Prometheus
   consul['monitoring_service_discovery'] =  true</p>
<p># START user configuration
   # Please set the real values as explained in Required Information section
   #
   # Replace PGBOUNCER_PASSWORD_HASH with a generated md5 value
   postgresql['pgbouncer_user_password'] = '<pgbouncer_password_hash>'
   # Replace POSTGRESQL_REPLICATION_PASSWORD_HASH with a generated md5 value
   postgresql['sql_replication_password'] = '<postgresql_replication_password_hash>'
   # Replace POSTGRESQL_PASSWORD_HASH with a generated md5 value
   postgresql['sql_user_password'] = '<postgresql_password_hash>'</p>
<p># Set up basic authentication for the Patroni API (use the same username/password in all nodes).
   patroni['username'] = '<patroni_api_username>'
   patroni['password'] = '<patroni_api_password>'</p>
<p># Replace 10.6.0.0/24 with Network Address
   postgresql['trust_auth_cidr_addresses'] = %w(10.6.0.0/24 127.0.0.1/32)</p>
<p># Local PgBouncer service for Database Load Balancing
   pgbouncer['databases'] = {
      gitlabhq_production: {
         host: "127.0.0.1",
         user: "pgbouncer",
         password: '<pgbouncer_password_hash>'
      }
   }</p>
<p># Set the network addresses that the exporters will listen on for monitoring
   node_exporter['listen_address'] = '0.0.0.0:9100'
   postgres_exporter['listen_address'] = '0.0.0.0:9187'</p>
<p>## The IPs of the Consul server nodes
   ## You can also use FQDNs and intermix them with IPs
   consul['configuration'] = {
      retry_join: %w(10.6.0.11 10.6.0.12 10.6.0.13),
   }
   #
   # END user configuration
   ```</p>
<p>PostgreSQL, with Patroni managing its failover, defaults to use <code>pg_rewind</code> by default to handle conflicts.
Like most failover handling methods, this has a small chance of leading to data loss.
For more information, see the various <a href="../postgresql/replication_and_failover.md#selecting-the-appropriate-patroni-replication-method">Patroni replication methods</a>.</p>
<ol>
<li>
<p>Copy the <code>/etc/gitlab/gitlab-secrets.json</code> file from the first Linux package node you configured and add or replace
   the file of the same name on this server. If this is the first Linux package node you are configuring then you can skip this step.</p>
</li>
<li>
<p><a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">Reconfigure GitLab</a> for the changes to take effect.</p>
</li>
</ol>
<p>Advanced <a href="https://docs.gitlab.com/omnibus/settings/database.html">configuration options</a>
are supported and can be added if needed.</p>
<div align="right">
  <a type="button" class="btn btn-default" href="#set-up-components">
    Back to set up components <i class="fa fa-angle-double-up" aria-hidden="true"></i>
  </a>
</div>

<h4>PostgreSQL post-configuration</h4>
<p>SSH in to any of the Patroni nodes on the <strong>primary site</strong>:</p>
<ol>
<li>Check the status of the leader and cluster:</li>
</ol>
<p><code>shell
   gitlab-ctl patroni members</code></p>
<p>The output should be similar to the following:</p>
<p><code>plaintext
   | Cluster       | Member                            |  Host     | Role   | State   | TL  | Lag in MB | Pending restart |
   |---------------|-----------------------------------|-----------|--------|---------|-----|-----------|-----------------|
   | postgresql-ha | &lt;PostgreSQL primary hostname&gt;     | 10.6.0.21 | Leader | running | 175 |           | *               |
   | postgresql-ha | &lt;PostgreSQL secondary 1 hostname&gt; | 10.6.0.22 |        | running | 175 | 0         | *               |
   | postgresql-ha | &lt;PostgreSQL secondary 2 hostname&gt; | 10.6.0.23 |        | running | 175 | 0         | *               |</code></p>
<p>If the 'State' column for any node doesn't say "running", check the
<a href="../postgresql/replication_and_failover_troubleshooting.md#pgbouncer-error-error-pgbouncer-cannot-connect-to-server">PostgreSQL replication and failover troubleshooting section</a>
before proceeding.</p>
<div align="right">
  <a type="button" class="btn btn-default" href="#set-up-components">
    Back to set up components <i class="fa fa-angle-double-up" aria-hidden="true"></i>
  </a>
</div>

<h3>Configure PgBouncer</h3>
<p>Now that the PostgreSQL servers are all set up, let's configure PgBouncer
for tracking and handling reads/writes to the primary database.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>PgBouncer is single threaded and doesn't significantly benefit from an increase in CPU cores.
Refer to the <a href="_index.md#scaling-an-environment">scaling documentation</a> for more information.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>The following IPs are used as an example:</p>
<ul>
<li><code>10.6.0.31</code>: PgBouncer 1</li>
<li><code>10.6.0.32</code>: PgBouncer 2</li>
<li>
<p><code>10.6.0.33</code>: PgBouncer 3</p>
</li>
<li>
<p>On each PgBouncer node, edit <code>/etc/gitlab/gitlab.rb</code>, and replace
   <code>&lt;consul_password_hash&gt;</code> and <code>&lt;pgbouncer_password_hash&gt;</code> with the
   password hashes you <a href="#postgresql-nodes">set up previously</a>:</p>
</li>
</ul>
<p>```ruby
   # Disable all components except Pgbouncer and Consul agent
   roles(['pgbouncer_role'])</p>
<p># Configure PgBouncer
   pgbouncer['admin_users'] = %w(pgbouncer gitlab-consul)
   pgbouncer['users'] = {
      'gitlab-consul': {
         password: '<consul_password_hash>'
      },
      'pgbouncer': {
         password: '<pgbouncer_password_hash>'
      }
   }</p>
<p># Configure Consul agent
   consul['watchers'] = %w(postgresql)
   consul['configuration'] = {
   retry_join: %w(10.6.0.11 10.6.0.12 10.6.0.13)
   }</p>
<p># Enable service discovery for Prometheus
   consul['monitoring_service_discovery'] = true</p>
<p># Set the network addresses that the exporters will listen on
   node_exporter['listen_address'] = '0.0.0.0:9100'
   pgbouncer_exporter['listen_address'] = '0.0.0.0:9188'
   ```</p>
<ol>
<li>
<p>Copy the <code>/etc/gitlab/gitlab-secrets.json</code> file from the first Linux package node you configured and add or replace
   the file of the same name on this server. If this is the first Linux package node you are configuring then you can skip this step.</p>
</li>
<li>
<p><a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">Reconfigure GitLab</a> for the changes to take effect.</p>
</li>
<li>
<p>Create a <code>.pgpass</code> file so Consul is able to
   reload PgBouncer. Enter the PgBouncer password twice when asked:</p>
</li>
</ol>
<p><code>shell
   gitlab-ctl write-pgpass --host 127.0.0.1 --database pgbouncer --user pgbouncer --hostuser gitlab-consul</code></p>
<ol>
<li>Ensure each node is talking to the current master:</li>
</ol>
<p><code>shell
   gitlab-ctl pgb-console # You will be prompted for PGBOUNCER_PASSWORD</code></p>
<p>If there is an error <code>psql: ERROR:  Auth failed</code> after typing in the
   password, ensure you previously generated the MD5 password hashes with the correct
   format. The correct format is to concatenate the password and the username:
   <code>PASSWORDUSERNAME</code>. For example, <code>Sup3rS3cr3tpgbouncer</code> would be the text
   needed to generate an MD5 password hash for the <code>pgbouncer</code> user.</p>
<ol>
<li>Once the console prompt is available, run the following queries:</li>
</ol>
<p><code>shell
   show databases ; show clients ;</code></p>
<p>The output should be similar to the following:</p>
<p>```plaintext
           name         |  host       | port |      database       | force_user | pool_size | reserve_pool | pool_mode | max_connections | current_connections
   ---------------------+-------------+------+---------------------+------------+-----------+--------------+-----------+-----------------+---------------------
    gitlabhq_production | MASTER_HOST | 5432 | gitlabhq_production |            |        20 |            0 |           |               0 |                   0
    pgbouncer           |             | 6432 | pgbouncer           | pgbouncer  |         2 |            0 | statement |               0 |                   0
   (2 rows)</p>
<pre><code>type |   user    |      database       |  state  |   addr         | port  | local_addr | local_port |    connect_time     |    request_time     |    ptr    | link | remote_pid | tls
</code></pre>
<p>------+-----------+---------------------+---------+----------------+-------+------------+------------+---------------------+---------------------+-----------+------+------------+-----
    C    | pgbouncer | pgbouncer           | active  | 127.0.0.1      | 56846 | 127.0.0.1  |       6432 | 2017-08-21 18:09:59 | 2017-08-21 18:10:48 | 0x22b3880 |      |          0 |
   (2 rows)
   ```</p>
<ol>
<li>Verify the GitLab services are running:</li>
</ol>
<p><code>shell
   sudo gitlab-ctl status</code></p>
<p>The output should be similar to the following:</p>
<p><code>plaintext
   run: consul: (pid 31530) 77150s; run: log: (pid 31106) 77182s
   run: logrotate: (pid 32613) 3357s; run: log: (pid 30107) 77500s
   run: node-exporter: (pid 31550) 77149s; run: log: (pid 30138) 77493s
   run: pgbouncer: (pid 32033) 75593s; run: log: (pid 31117) 77175s
   run: pgbouncer-exporter: (pid 31558) 77148s; run: log: (pid 31498) 77156s</code></p>
<div align="right">
  <a type="button" class="btn btn-default" href="#set-up-components">
    Back to set up components <i class="fa fa-angle-double-up" aria-hidden="true"></i>
  </a>
</div>

<h2>Configure Redis</h2>
<p>Using <a href="https://redis.io/">Redis</a> in scalable environment is possible using a <strong>Primary</strong> x <strong>Replica</strong>
topology with a <a href="https://redis.io/docs/latest/operate/oss_and_stack/management/sentinel/">Redis Sentinel</a> service to watch and automatically
start the failover procedure.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>Redis clusters must each be deployed in an odd number of 3 nodes or more. This is to ensure Redis Sentinel can take votes as part of a quorum. This does not apply when configuring Redis externally, such as a cloud provider service.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>Redis is primarily single threaded and doesn't significantly benefit from an increase in CPU cores.
Refer to the <a href="_index.md#scaling-an-environment">scaling documentation</a> for more information.
{{&lt; /alert &gt;}}</p>
<p>Redis requires authentication if used with Sentinel. See
<a href="https://redis.io/docs/latest/operate/rc/security/">Redis Security</a> documentation for more
information. We recommend using a combination of a Redis password and tight
firewall rules to secure your Redis service.
You are highly encouraged to read the <a href="https://redis.io/docs/latest/operate/oss_and_stack/management/sentinel/">Redis Sentinel</a> documentation
before configuring Redis with GitLab to fully understand the topology and
architecture.</p>
<p>The requirements for a Redis setup are the following:</p>
<ol>
<li>All Redis nodes must be able to talk to each other and accept incoming
   connections over Redis (<code>6379</code>) and Sentinel (<code>26379</code>) ports (unless you
   change the default ones).</li>
<li>The server that hosts the GitLab application must be able to access the
   Redis nodes.</li>
<li>Protect the nodes from access from external networks (Internet), using options such as a firewall.</li>
</ol>
<p>In this section, you'll be guided through configuring two external Redis clusters
to be used with GitLab. The following IPs will be used as an example:</p>
<ul>
<li><code>10.6.0.61</code>: Redis Primary</li>
<li><code>10.6.0.62</code>: Redis Replica 1</li>
<li><code>10.6.0.63</code>: Redis Replica 2</li>
</ul>
<h3>Provide your own Redis instance</h3>
<p>You can optionally use a <a href="../redis/replication_and_failover_external.md#redis-as-a-managed-service-in-a-cloud-provider">third party external service for the Redis instance</a> with the following guidance:</p>
<ul>
<li>A reputable provider or solution should be used for this. <a href="https://cloud.google.com/memorystore/docs/redis/memorystore-for-redis-overview">Google Memorystore</a> and <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/WhatIs.html">AWS ElastiCache</a> are known to work.</li>
<li>Redis Cluster mode is specifically not supported, but Redis Standalone with HA is.</li>
<li>You must set the <a href="../redis/replication_and_failover_external.md#setting-the-eviction-policy">Redis eviction mode</a> according to your setup.</li>
</ul>
<p>For more information, see <a href="_index.md#recommended-cloud-providers-and-services">Recommended cloud providers and services</a>.</p>
<h3>Configure the Redis cluster</h3>
<p>This is the section where we install and set up the new Redis instances.</p>
<p>Both the primary and replica Redis nodes need the same password defined in
<code>redis['password']</code>. At any time during a failover, the Sentinels can reconfigure
a node and change its status from primary to replica (and vice versa).</p>
<h4>Configure the primary Redis node</h4>
<ol>
<li>SSH in to the <strong>Primary</strong> Redis server.</li>
<li><a href="../../install/package/_index.md#supported-platforms">Download and install</a> the Linux
   package of your choice. Be sure to only add the GitLab package repository and install GitLab
   for your chosen operating system. Select the same version
   and type (Community or Enterprise editions) as your current install.</li>
<li>Edit <code>/etc/gitlab/gitlab.rb</code> and add the contents:</li>
</ol>
<p>```ruby
   # Specify server roles as 'redis_master_role' with Sentinel and the Consul agent
   roles ['redis_sentinel_role', 'redis_master_role', 'consul_role']</p>
<p># Set IP bind address and Quorum number for Redis Sentinel service
   sentinel['bind'] = '0.0.0.0'
   sentinel['quorum'] = 2</p>
<p># IP address pointing to a local IP that the other machines can reach to.
   # You can also set bind to '0.0.0.0' which listen in all interfaces.
   # If you really must bind to an external accessible IP, make
   # sure you add extra firewall rules to prevent unauthorized access.
   redis['bind'] = '10.6.0.61'</p>
<p># Define a port so Redis can listen for TCP requests which will allow other
   # machines to connect to it.
   redis['port'] = 6379</p>
<p>## Port of primary Redis server for Sentinel, uncomment to change to non default. Defaults
   ## to <code>6379</code>.
   #redis['master_port'] = 6379</p>
<p># Set up password authentication for Redis and replicas (use the same password in all nodes).
   redis['password'] = 'REDIS_PRIMARY_PASSWORD'
   redis['master_password'] = 'REDIS_PRIMARY_PASSWORD'</p>
<p>## Must be the same in every Redis node
   redis['master_name'] = 'gitlab-redis'</p>
<p>## The IP of this primary Redis node.
   redis['master_ip'] = '10.6.0.61'</p>
<p>## Enable service discovery for Prometheus
   consul['monitoring_service_discovery'] =  true</p>
<p>## The IPs of the Consul server nodes
   ## You can also use FQDNs and intermix them with IPs
   consul['configuration'] = {
      retry_join: %w(10.6.0.11 10.6.0.12 10.6.0.13),
   }</p>
<p># Set the network addresses that the exporters will listen on
   node_exporter['listen_address'] = '0.0.0.0:9100'
   redis_exporter['listen_address'] = '0.0.0.0:9121'</p>
<p># Prevent database migrations from running on upgrade automatically
   gitlab_rails['auto_migrate'] = false
   ```</p>
<ol>
<li>
<p>Copy the <code>/etc/gitlab/gitlab-secrets.json</code> file from the first Linux package node you configured and add or replace
   the file of the same name on this server. If this is the first Linux package node you are configuring then you can skip this step.</p>
</li>
<li>
<p><a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">Reconfigure GitLab</a> for the changes to take effect.</p>
</li>
</ol>
<h4>Configure the replica Redis nodes</h4>
<ol>
<li>SSH in to the <strong>replica</strong> Redis server.</li>
<li><a href="../../install/package/_index.md#supported-platforms">Download and install</a> the Linux
   package of your choice. Be sure to only add the GitLab package repository and install GitLab
   for your chosen operating system. Select the same version
   and type (Community or Enterprise editions) as your current install.</li>
<li>Edit <code>/etc/gitlab/gitlab.rb</code> and add the contents:</li>
</ol>
<p>```ruby
   # Specify server roles as 'redis_sentinel_role' and 'redis_replica_role'
   roles ['redis_sentinel_role', 'redis_replica_role', 'consul_role']</p>
<p># Set IP bind address and Quorum number for Redis Sentinel service
   sentinel['bind'] = '0.0.0.0'
   sentinel['quorum'] = 2</p>
<p># IP address pointing to a local IP that the other machines can reach to.
   # You can also set bind to '0.0.0.0' which listen in all interfaces.
   # If you really must bind to an external accessible IP, make
   # sure you add extra firewall rules to prevent unauthorized access.
   redis['bind'] = '10.6.0.62'</p>
<p># Define a port so Redis can listen for TCP requests which will allow other
   # machines to connect to it.
   redis['port'] = 6379</p>
<p>## Port of primary Redis server for Sentinel, uncomment to change to non default. Defaults
   ## to <code>6379</code>.
   #redis['master_port'] = 6379</p>
<p># The same password for Redis authentication you set up for the primary node.
   redis['password'] = 'REDIS_PRIMARY_PASSWORD'
   redis['master_password'] = 'REDIS_PRIMARY_PASSWORD'</p>
<p>## Must be the same in every Redis node
   redis['master_name'] = 'gitlab-redis'</p>
<p># The IP of the primary Redis node.
   redis['master_ip'] = '10.6.0.61'</p>
<p>## Enable service discovery for Prometheus
   consul['monitoring_service_discovery'] =  true</p>
<p>## The IPs of the Consul server nodes
   ## You can also use FQDNs and intermix them with IPs
   consul['configuration'] = {
      retry_join: %w(10.6.0.11 10.6.0.12 10.6.0.13),
   }</p>
<p># Set the network addresses that the exporters will listen on
   node_exporter['listen_address'] = '0.0.0.0:9100'
   redis_exporter['listen_address'] = '0.0.0.0:9121'</p>
<p># Prevent database migrations from running on upgrade automatically
   gitlab_rails['auto_migrate'] = false
   ```</p>
<ol>
<li>
<p>Copy the <code>/etc/gitlab/gitlab-secrets.json</code> file from the first Linux package node you configured and add or replace
   the file of the same name on this server. If this is the first Linux package node you are configuring then you can skip this step.</p>
</li>
<li>
<p><a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">Reconfigure GitLab</a> for the changes to take effect.</p>
</li>
<li>Go through the steps again for all the other replica nodes, and
   make sure to set up the IPs correctly.</li>
</ol>
<p>Advanced <a href="https://docs.gitlab.com/omnibus/settings/redis.html">configuration options</a>
are supported and can be added if needed.</p>
<div align="right">
  <a type="button" class="btn btn-default" href="#set-up-components">
    Back to set up components <i class="fa fa-angle-double-up" aria-hidden="true"></i>
  </a>
</div>

<h2>Configure Gitaly Cluster (Praefect)</h2>
<p><a href="../gitaly/praefect/_index.html">Gitaly Cluster (Praefect)</a> is a GitLab-provided and recommended fault tolerant solution for storing Git
repositories. In this configuration, every Git repository is stored on every Gitaly node in the cluster, with one being
designated the primary, and failover occurs automatically if the primary node goes down.</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>Gitaly specifications are based on high percentiles of both usage patterns and repository sizes in good health.
However, if you have <a href="_index.md#large-monorepos">large monorepos</a> (larger than several gigabytes) or <a href="_index.md#additional-workloads">additional workloads</a> these can significantly impact the performance of the environment and further adjustments may be required.
If you believe this applies to you, contact us for additional guidance as required.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>Gitaly Cluster (Praefect) provides the benefits of fault tolerance, but comes with additional complexity of setup and management.
Review the existing <a href="../gitaly/praefect/_index.md#before-deploying-gitaly-cluster-praefect">technical limitations and considerations before deploying Gitaly Cluster (Praefect)</a>.</p>
<p>For guidance on:</p>
<ul>
<li>Implementing sharded Gitaly instead, follow the <a href="../gitaly/configure_gitaly.html">separate Gitaly documentation</a>
  instead of this section. Use the same Gitaly specs.</li>
<li>Migrating existing repositories that aren't managed by Gitaly Cluster (Praefect), see
  <a href="../gitaly/praefect/_index.md#migrate-to-gitaly-cluster-praefect">migrate to Gitaly Cluster (Praefect)</a>.</li>
</ul>
<p>The recommended cluster setup includes the following components:</p>
<ul>
<li>3 Gitaly nodes: Replicated storage of Git repositories.</li>
<li>3 Praefect nodes: Router and transaction manager for Gitaly Cluster (Praefect).</li>
<li>1 Praefect PostgreSQL node: Database server for Praefect. A third-party solution
  is required for Praefect database connections to be made highly available.</li>
<li>1 load balancer: A load balancer is required for Praefect. The
  <a href="#configure-the-internal-load-balancer">internal load balancer</a> is used.</li>
</ul>
<p>This section details how to configure the recommended standard setup in order.
For more advanced setups refer to the <a href="../gitaly/praefect/_index.html">standalone Gitaly Cluster (Praefect) documentation</a>.</p>
<h3>Configure Praefect PostgreSQL</h3>
<p>Praefect, the routing and transaction manager for Gitaly Cluster (Praefect), requires its own database server to store data on Gitaly Cluster (Praefect) status.</p>
<p>If you want to have a highly available setup, Praefect requires a third-party PostgreSQL database.
A built-in solution is being <a href="https://gitlab.com/gitlab-org/omnibus-gitlab/-/issues/7292">worked on</a>.</p>
<h4>Praefect non-HA PostgreSQL standalone using the Linux package</h4>
<p>The following IPs will be used as an example:</p>
<ul>
<li><code>10.6.0.141</code>: Praefect PostgreSQL</li>
</ul>
<p>First, make sure to <a href="../../install/package/_index.md#supported-platforms">install</a>
the Linux package on the Praefect PostgreSQL node. Be sure to only add the GitLab
package repository and install GitLab for your chosen operating system,
but do <strong>not</strong> provide the <code>EXTERNAL_URL</code> value.</p>
<ol>
<li>SSH in to the Praefect PostgreSQL node.</li>
<li>Create a strong password to be used for the Praefect PostgreSQL user. Take note of this password as <code>&lt;praefect_postgresql_password&gt;</code>.</li>
<li>Generate the password hash for the Praefect PostgreSQL username/password pair. This assumes you will use the default
   username of <code>praefect</code> (recommended). The command will request the password <code>&lt;praefect_postgresql_password&gt;</code>
   and confirmation. Use the value that is output by this command in the next
   step as the value of <code>&lt;praefect_postgresql_password_hash&gt;</code>:</li>
</ol>
<p><code>shell
   sudo gitlab-ctl pg-password-md5 praefect</code></p>
<ol>
<li>Edit <code>/etc/gitlab/gitlab.rb</code> replacing values noted in the <code># START user configuration</code> section:</li>
</ol>
<p>```ruby
   # Disable all components except PostgreSQL and Consul
   roles(['postgres_role', 'consul_role'])</p>
<p># PostgreSQL configuration
   postgresql['listen_address'] = '0.0.0.0'</p>
<p># Prevent database migrations from running on upgrade automatically
   gitlab_rails['auto_migrate'] = false</p>
<p># Configure the Consul agent
   ## Enable service discovery for Prometheus
   consul['monitoring_service_discovery'] =  true</p>
<p># START user configuration
   # Please set the real values as explained in Required Information section
   #
   # Replace PRAEFECT_POSTGRESQL_PASSWORD_HASH with a generated md5 value
   postgresql['sql_user_password'] = "<praefect_postgresql_password_hash>"</p>
<p># Replace XXX.XXX.XXX.XXX/YY with Network Address
   postgresql['trust_auth_cidr_addresses'] = %w(10.6.0.0/24 127.0.0.1/32)</p>
<p># Set the network addresses that the exporters will listen on for monitoring
   node_exporter['listen_address'] = '0.0.0.0:9100'
   postgres_exporter['listen_address'] = '0.0.0.0:9187'</p>
<p>## The IPs of the Consul server nodes
   ## You can also use FQDNs and intermix them with IPs
   consul['configuration'] = {
      retry_join: %w(10.6.0.11 10.6.0.12 10.6.0.13),
   }
   #
   # END user configuration
   ```</p>
<ol>
<li>
<p>Copy the <code>/etc/gitlab/gitlab-secrets.json</code> file from the first Linux package node you configured and add or replace
   the file of the same name on this server. If this is the first Linux package node you are configuring then you can skip this step.</p>
</li>
<li>
<p><a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">Reconfigure GitLab</a> for the changes to take effect.</p>
</li>
<li>Follow the <a href="#praefect-postgresql-post-configuration">post configuration</a>.</li>
</ol>
<div align="right">
  <a type="button" class="btn btn-default" href="#set-up-components">
    Back to set up components <i class="fa fa-angle-double-up" aria-hidden="true"></i>
  </a>
</div>

<h4>Praefect HA PostgreSQL third-party solution</h4>
<p><a href="#configure-praefect-postgresql">As noted</a>, a third-party PostgreSQL solution for
Praefect's database is recommended if aiming for full High Availability.</p>
<p>There are many third-party solutions for PostgreSQL HA. The solution selected must have the following to work with Praefect:</p>
<ul>
<li>A static IP for all connections that doesn't change on failover.</li>
<li><a href="https://www.postgresql.org/docs/16/sql-listen.html"><code>LISTEN</code></a> SQL functionality must be supported.</li>
</ul>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>With a third-party setup, it's possible to colocate Praefect's database on the same server as
the main <a href="#provide-your-own-postgresql-instance">GitLab</a> database. However, if you are using Geo, separate database instances are required for handling replication correctly.
In this setup, the specs of the main database setup don't have to be changed because the impact should be
minimal.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>A reputable provider or solution should be used for this. <a href="https://cloud.google.com/sql/docs/postgres/high-availability#normal">Google Cloud SQL</a>
and <a href="https://aws.amazon.com/rds/">Amazon RDS</a> are known to work. However, Amazon Aurora is <strong>incompatible</strong> with load balancing enabled by default from
<a href="https://archives.docs.gitlab.com/17.3/ee/update/versions/gitlab_14_changes/#1440">14.4.0</a>.</p>
<p>See <a href="_index.md#recommended-cloud-providers-and-services">Recommended cloud providers and services</a> for more information.</p>
<p>Once the database is set up, follow the <a href="#praefect-postgresql-post-configuration">post configuration</a>.</p>
<h4>Praefect PostgreSQL post-configuration</h4>
<p>After the Praefect PostgreSQL server has been set up, you must configure the user and database for Praefect to use.</p>
<p>We recommend the user be named <code>praefect</code> and the database <code>praefect_production</code>, and these can be configured as standard in PostgreSQL.
The password for the user is the same as the one you configured earlier as <code>&lt;praefect_postgresql_password&gt;</code>.</p>
<p>This is how this would work with a Linux package PostgreSQL setup:</p>
<ol>
<li>SSH in to the Praefect PostgreSQL node.</li>
<li>Connect to the PostgreSQL server with administrative access.
   The <code>gitlab-psql</code> user should be used here for this as it's added by default in the Linux package.
   The database <code>template1</code> is used because it is created by default on all PostgreSQL servers.</li>
</ol>
<p><code>shell
   /opt/gitlab/embedded/bin/psql -U gitlab-psql -d template1 -h POSTGRESQL_SERVER_ADDRESS</code></p>
<ol>
<li>Create the new user <code>praefect</code>, replacing <code>&lt;praefect_postgresql_password&gt;</code>:</li>
</ol>
<p><code>shell
   CREATE ROLE praefect WITH LOGIN CREATEDB PASSWORD '&lt;praefect_postgresql_password&gt;';</code></p>
<ol>
<li>Reconnect to the PostgreSQL server, this time as the <code>praefect</code> user:</li>
</ol>
<p><code>shell
   /opt/gitlab/embedded/bin/psql -U praefect -d template1 -h POSTGRESQL_SERVER_ADDRESS</code></p>
<ol>
<li>Create a new database <code>praefect_production</code>:</li>
</ol>
<p><code>shell
   CREATE DATABASE praefect_production WITH ENCODING=UTF8;</code></p>
<div align="right">
  <a type="button" class="btn btn-default" href="#set-up-components">
    Back to set up components <i class="fa fa-angle-double-up" aria-hidden="true"></i>
  </a>
</div>

<h3>Configure Praefect</h3>
<p>Praefect is the router and transaction manager for Gitaly Cluster (Praefect) and all connections to Gitaly go through
it. This section details how to configure it.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>Praefect must be deployed in an odd number of 3 nodes or more. This is to ensure the nodes can take votes as part of a quorum.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>Praefect requires several secret tokens to secure communications across the cluster:</p>
<ul>
<li><code>&lt;praefect_external_token&gt;</code>: Used for repositories hosted on Gitaly Cluster (Praefect) and can only be accessed by Gitaly clients that carry this token.</li>
<li><code>&lt;praefect_internal_token&gt;</code>: Used for replication traffic inside Gitaly Cluster (Praefect). This is distinct from <code>praefect_external_token</code>
  because Gitaly clients must not be able to access internal nodes of Gitaly Cluster (Praefect) directly; that could lead to data loss.</li>
<li><code>&lt;praefect_postgresql_password&gt;</code>: The Praefect PostgreSQL password defined in the previous section is also required as part of this setup.</li>
</ul>
<p>Gitaly Cluster (Praefect) nodes are configured in Praefect via a <code>virtual storage</code>. Each storage contains
the details of each Gitaly node that makes up the cluster. Each storage is also given a name
and this name is used in several areas of the configuration. In this guide, the name of the storage will be
<code>default</code>. Also, this guide is geared towards new installs, if upgrading an existing environment
to use Gitaly Cluster (Praefect), you might have to use a different name.
Refer to the <a href="../gitaly/praefect/configure.md#praefect">Gitaly Cluster (Praefect) documentation</a> for more information.</p>
<p>The following IPs will be used as an example:</p>
<ul>
<li><code>10.6.0.131</code>: Praefect 1</li>
<li><code>10.6.0.132</code>: Praefect 2</li>
<li><code>10.6.0.133</code>: Praefect 3</li>
</ul>
<p>To configure the Praefect nodes, on each one:</p>
<ol>
<li>SSH in to the Praefect server.</li>
<li><a href="../../install/package/_index.md#supported-platforms">Download and install</a> the Linux
   package of your choice. Be sure to only add the GitLab package repository and install GitLab
   for your chosen operating system.</li>
<li>Edit the <code>/etc/gitlab/gitlab.rb</code> file to configure Praefect:</li>
</ol>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>You can't remove the <code>default</code> entry from <code>virtual_storages</code> because <a href="../gitaly/configure_gitaly.md#gitlab-requires-a-default-repository-storage">GitLab requires it</a>.</p>
<p>{{&lt; /alert &gt;}}</p>
<!--
   Updates to example must be made at:
   - https://gitlab.com/gitlab-org/gitlab/-/blob/master/doc/administration/gitaly/praefect/_index.md
   - all reference architecture pages
   -->

<p>```ruby
   # Avoid running unnecessary services on the Praefect server
   gitaly['enable'] = false
   postgresql['enable'] = false
   redis['enable'] = false
   nginx['enable'] = false
   puma['enable'] = false
   sidekiq['enable'] = false
   gitlab_workhorse['enable'] = false
   prometheus['enable'] = false
   alertmanager['enable'] = false
   gitlab_exporter['enable'] = false
   gitlab_kas['enable'] = false</p>
<p># Praefect Configuration
   praefect['enable'] = true</p>
<p># Prevent database migrations from running on upgrade automatically
   praefect['auto_migrate'] = false
   gitlab_rails['auto_migrate'] = false</p>
<p># Configure the Consul agent
   consul['enable'] = true
   ## Enable service discovery for Prometheus
   consul['monitoring_service_discovery'] = true</p>
<p># START user configuration
   # Please set the real values as explained in Required Information section
   #</p>
<p>praefect['configuration'] = {
      # ...
      listen_addr: '0.0.0.0:2305',
      auth: {
         # ...
         #
         # Praefect External Token
         # This is needed by clients outside the cluster (like GitLab Shell) to communicate with the Praefect cluster
         token: '<praefect_external_token>',
      },
      # Praefect Database Settings
      database: {
         # ...
         host: '10.6.0.141',
         port: 5432,
         dbname: 'praefect_production',
         user: 'praefect',
         password: '<praefect_postgresql_password>',
      },
      # Praefect Virtual Storage config
      # Name of storage hash must match storage name in gitlab_rails['repositories_storages'] on the GitLab
      # server ('praefect') and in gitaly['configuration'][:storage] on Gitaly nodes ('gitaly-1')
      virtual_storage: [
         {
            # ...
            name: 'default',
            node: [
               {
                  storage: 'gitaly-1',
                  address: 'tcp://10.6.0.91:8075',
                  token: '<praefect_internal_token>'
               },
               {
                  storage: 'gitaly-2',
                  address: 'tcp://10.6.0.92:8075',
                  token: '<praefect_internal_token>'
               },
               {
                  storage: 'gitaly-3',
                  address: 'tcp://10.6.0.93:8075',
                  token: '<praefect_internal_token>'
               },
            ],
         },
      ],
      # Set the network address Praefect will listen on for monitoring
      prometheus_listen_addr: '0.0.0.0:9652',
   }</p>
<p># Set the network address the node exporter will listen on for monitoring
   node_exporter['listen_address'] = '0.0.0.0:9100'</p>
<p>## The IPs of the Consul server nodes
   ## You can also use FQDNs and intermix them with IPs
   consul['configuration'] = {
      retry_join: %w(10.6.0.11 10.6.0.12 10.6.0.13),
   }
   #
   # END user configuration
   ```</p>
<ol>
<li>
<p>Copy the <code>/etc/gitlab/gitlab-secrets.json</code> file from the first Linux package node you configured and add or replace
   the file of the same name on this server. If this is the first Linux package node you are configuring then you can skip this step.</p>
</li>
<li>
<p>Praefect requires to run some database migrations, much like the main GitLab application. For this
   you should select <strong>one Praefect node only to run the migrations</strong>, AKA the <em>Deploy Node</em>. This node
   must be configured first before the others as follows:</p>
</li>
<li>
<p>In the <code>/etc/gitlab/gitlab.rb</code> file, change the <code>praefect['auto_migrate']</code> setting value from <code>false</code> to <code>true</code></p>
</li>
<li>
<p>To ensure database migrations are only run during reconfigure and not automatically on upgrade, run:</p>
</li>
</ol>
<p><code>shell
   sudo touch /etc/gitlab/skip-auto-reconfigure</code></p>
<ol>
<li>
<p><a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">Reconfigure GitLab</a> for the changes to take effect and
      to run the Praefect database migrations.</p>
</li>
<li>
<p>On all other Praefect nodes, <a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">reconfigure GitLab</a> for the changes to take effect.</p>
</li>
</ol>
<h3>Configure Gitaly</h3>
<p>The <a href="../gitaly/_index.html">Gitaly</a> server nodes that make up the cluster have
requirements that are dependent on data and load.</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>Gitaly specifications are based on high percentiles of both usage patterns and repository sizes in good health.
However, if you have <a href="_index.md#large-monorepos">large monorepos</a> (larger than several gigabytes) or <a href="_index.md#additional-workloads">additional workloads</a> these can significantly impact the performance of the environment and further adjustments may be required.
If you believe this applies to you, contact us for additional guidance as required.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>Gitaly has certain <a href="../gitaly/_index.md#disk-requirements">disk requirements</a> for Gitaly storages.</p>
<p>Gitaly servers must not be exposed to the public internet because network traffic
on Gitaly is unencrypted by default. The use of a firewall is highly recommended
to restrict access to the Gitaly server. Another option is to
<a href="#gitaly-cluster-praefect-tls-support">use TLS</a>.</p>
<p>For configuring Gitaly you should note the following:</p>
<ul>
<li><code>gitaly['configuration'][:storage]</code> should be configured to reflect the storage path for the specific Gitaly node</li>
<li><code>auth_token</code> should be the same as <code>praefect_internal_token</code></li>
</ul>
<p>The following IPs will be used as an example:</p>
<ul>
<li><code>10.6.0.91</code>: Gitaly 1</li>
<li><code>10.6.0.92</code>: Gitaly 2</li>
<li><code>10.6.0.93</code>: Gitaly 3</li>
</ul>
<p>On each node:</p>
<ol>
<li><a href="../../install/package/_index.md#supported-platforms">Download and install</a> the Linux package
   of your choice. Be sure to only add the GitLab
   package repository and install GitLab for your chosen operating system,
   but do <strong>not</strong> provide the <code>EXTERNAL_URL</code> value.</li>
<li>Edit the Gitaly server node's <code>/etc/gitlab/gitlab.rb</code> file to configure
   storage paths, enable the network listener, and to configure the token:</li>
</ol>
<!--
   Updates to example must be made at:
   - https://gitlab.com/gitlab-org/charts/gitlab/blob/master/doc/advanced/external-gitaly/external-omnibus-gitaly.md#configure-omnibus-gitlab
   - https://gitlab.com/gitlab-org/gitlab/blob/master/doc/administration/gitaly/index.md#gitaly-server-configuration
   - all reference architecture pages
   -->

<p>```ruby
   # https://docs.gitlab.com/omnibus/roles/#gitaly-roles
   roles(["gitaly_role"])</p>
<p># Prevent database migrations from running on upgrade automatically
   gitlab_rails['auto_migrate'] = false</p>
<p># Configure the gitlab-shell API callback URL. Without this, <code>git push</code> will
   # fail. This can be your 'front door' GitLab URL or an internal load
   # balancer.
   gitlab_rails['internal_api_url'] = 'https://gitlab.example.com'</p>
<p># Configure the Consul agent
   consul['enable'] = true
   ## Enable service discovery for Prometheus
   consul['monitoring_service_discovery'] = true</p>
<p># START user configuration
   # Please set the real values as explained in Required Information section
   #
   ## The IPs of the Consul server nodes
   ## You can also use FQDNs and intermix them with IPs
   consul['configuration'] = {
      retry_join: %w(10.6.0.11 10.6.0.12 10.6.0.13),
   }</p>
<p># Set the network address that the node exporter will listen on for monitoring
   node_exporter['listen_address'] = '0.0.0.0:9100'</p>
<p>gitaly['configuration'] = {
      # ...
      #
      # Make Gitaly accept connections on all network interfaces. You must use
      # firewalls to restrict access to this address/port.
      # Comment out following line if you only want to support TLS connections
      listen_addr: '0.0.0.0:8075',
      # Set the network address that Gitaly will listen on for monitoring
      prometheus_listen_addr: '0.0.0.0:9236',
      # Gitaly Auth Token
      # Should be the same as praefect_internal_token
      auth: {
         # ...
         token: '<praefect_internal_token>',
      },
      # Gitaly Pack-objects cache
      # Recommended to be enabled for improved performance but can notably increase disk I/O
      # Refer to https://docs.gitlab.com/ee/administration/gitaly/configure_gitaly.html#pack-objects-cache for more info
      pack_objects_cache: {
         # ...
         enabled: true,
      },
   }</p>
<p>#
   # END user configuration
   ```</p>
<ol>
<li>Append the following to <code>/etc/gitlab/gitlab.rb</code> for each respective server:</li>
<li>
<p>On Gitaly node 1:</p>
<p><code>ruby
 gitaly['configuration'] = {
    # ...
    storage: [
       {
          name: 'gitaly-1',
          path: '/var/opt/gitlab/git-data',
       },
    ],
 }</code></p>
</li>
<li>
<p>On Gitaly node 2:</p>
<p><code>ruby
 gitaly['configuration'] = {
    # ...
    storage: [
       {
          name: 'gitaly-2',
          path: '/var/opt/gitlab/git-data',
       },
    ],
 }</code></p>
</li>
<li>
<p>On Gitaly node 3:</p>
<p><code>ruby
 gitaly['configuration'] = {
    # ...
    storage: [
       {
          name: 'gitaly-3',
          path: '/var/opt/gitlab/git-data',
       },
    ],
 }</code></p>
</li>
<li>
<p>Copy the <code>/etc/gitlab/gitlab-secrets.json</code> file from the first Linux package node you configured and add or replace
   the file of the same name on this server. If this is the first Linux package node you are configuring then you can skip this step.</p>
</li>
<li>
<p>Save the file, and then <a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">reconfigure GitLab</a>.</p>
</li>
</ol>
<h3>Gitaly Cluster (Praefect) TLS support</h3>
<p>Praefect supports TLS encryption. To communicate with a Praefect instance that listens
for secure connections, you must:</p>
<ul>
<li>Use a <code>tls://</code> URL scheme in the <code>gitaly_address</code> of the corresponding storage entry
  in the GitLab configuration.</li>
<li>Bring your own certificates because this isn't provided automatically. The certificate
  corresponding to each Praefect server must be installed on that Praefect server.</li>
</ul>
<p>Additionally the certificate, or its certificate authority, must be installed on all Gitaly servers
and on all Praefect clients that communicate with it following the procedure described in
<a href="https://docs.gitlab.com/omnibus/settings/ssl/#install-custom-public-certificates">GitLab custom certificate configuration</a> (and repeated below).</p>
<p>Note the following:</p>
<ul>
<li>The certificate must specify the address you use to access the Praefect server. You must add the hostname or IP
  address as a Subject Alternative Name to the certificate.</li>
<li>You can configure Praefect servers with both an unencrypted listening address
  <code>listen_addr</code> and an encrypted listening address <code>tls_listen_addr</code> at the same time.
  This allows you to do a gradual transition from unencrypted to encrypted traffic, if
  necessary. To disable the unencrypted listener, set <code>praefect['configuration'][:listen_addr] = nil</code>.</li>
<li>The Internal Load Balancer will also access to the certificates and must be configured
  to allow for TLS passthrough.
  Refer to the load balancers documentation on how to configure this.</li>
</ul>
<p>To configure Praefect with TLS:</p>
<ol>
<li>
<p>Create certificates for Praefect servers.</p>
</li>
<li>
<p>On the Praefect servers, create the <code>/etc/gitlab/ssl</code> directory and copy your key
   and certificate there:</p>
</li>
</ol>
<p><code>shell
   sudo mkdir -p /etc/gitlab/ssl
   sudo chmod 755 /etc/gitlab/ssl
   sudo cp key.pem cert.pem /etc/gitlab/ssl/
   sudo chmod 644 key.pem cert.pem</code></p>
<ol>
<li>Edit <code>/etc/gitlab/gitlab.rb</code> and add:</li>
</ol>
<p><code>ruby
   praefect['configuration'] = {
      # ...
      tls_listen_addr: '0.0.0.0:3305',
      tls: {
         # ...
         certificate_path: '/etc/gitlab/ssl/cert.pem',
         key_path: '/etc/gitlab/ssl/key.pem',
      },
   }</code></p>
<ol>
<li>
<p>Save the file and <a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">reconfigure</a>.</p>
</li>
<li>
<p>On the Praefect clients (including each Gitaly server), copy the certificates,
   or their certificate authority, into <code>/etc/gitlab/trusted-certs</code>:</p>
</li>
</ol>
<p><code>shell
   sudo cp cert.pem /etc/gitlab/trusted-certs/</code></p>
<ol>
<li>On the Praefect clients (except Gitaly servers), edit <code>gitlab_rails['repositories_storages']</code> in
   <code>/etc/gitlab/gitlab.rb</code> as follows:</li>
</ol>
<p><code>ruby
   gitlab_rails['repositories_storages'] = {
     "default" =&gt; {
       "gitaly_address" =&gt; 'tls://LOAD_BALANCER_SERVER_ADDRESS:3305',
       "gitaly_token" =&gt; 'PRAEFECT_EXTERNAL_TOKEN'
     }
   }</code></p>
<ol>
<li>Save the file and <a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">reconfigure GitLab</a>.</li>
</ol>
<div align="right">
  <a type="button" class="btn btn-default" href="#set-up-components">
    Back to set up components <i class="fa fa-angle-double-up" aria-hidden="true"></i>
  </a>
</div>

<h2>Configure Sidekiq</h2>
<p>Sidekiq requires connection to the <a href="#configure-redis">Redis</a>,
<a href="#configure-postgresql">PostgreSQL</a> and <a href="#configure-gitaly">Gitaly</a> instances.
It also requires a connection to <a href="#configure-the-object-storage">Object Storage</a> as recommended.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p><a href="../object_storage.html">Because it's recommended to use Object storage</a> instead of NFS for data objects, the following
examples include the Object storage configuration.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>If you find that the environment's Sidekiq job processing is slow with long queues
you can scale it accordingly. Refer to the <a href="_index.md#scaling-an-environment">scaling documentation</a> for more information.
{{&lt; /alert &gt;}}</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>When configuring additional GitLab functionality such as Container Registry, SAML, or LDAP,
update the Sidekiq configuration in addition to the Rails configuration.
Refer to the <a href="../sidekiq/_index.html">external Sidekiq documentation</a> for more information.
{{&lt; /alert &gt;}}</p>
<p>The following IPs will be used as an example:</p>
<ul>
<li><code>10.6.0.71</code>: Sidekiq 1</li>
<li><code>10.6.0.72</code>: Sidekiq 2</li>
</ul>
<p>To configure the Sidekiq nodes, on each one:</p>
<ol>
<li>SSH in to the Sidekiq server.</li>
<li>Confirm that you can access the PostgreSQL, Gitaly, and Redis ports:</li>
</ol>
<p><code>shell
   telnet &lt;GitLab host&gt; 5432 # PostgreSQL
   telnet &lt;GitLab host&gt; 8075 # Gitaly
   telnet &lt;GitLab host&gt; 6379 # Redis</code></p>
<ol>
<li><a href="../../install/package/_index.md#supported-platforms">Download and install</a> the Linux
   package of your choice. Be sure to only add the GitLab package repository and install GitLab
   for your chosen operating system.</li>
<li>Create or edit <code>/etc/gitlab/gitlab.rb</code> and use the following configuration:</li>
</ol>
<p>```ruby
   # https://docs.gitlab.com/omnibus/roles/#sidekiq-roles
   roles(["sidekiq_role"])</p>
<p># External URL
   ## This should match the URL of the external load balancer
   external_url 'https://gitlab.example.com'</p>
<p># Redis
   redis['master_name'] = 'gitlab-redis'</p>
<p>## The same password for Redis authentication you set up for the master node.
   redis['master_password'] = '<redis_primary_password>'</p>
<p>## A list of sentinels with <code>host</code> and <code>port</code>
   gitlab_rails['redis_sentinels'] = [
      {'host' =&gt; '10.6.0.11', 'port' =&gt; 26379},
      {'host' =&gt; '10.6.0.12', 'port' =&gt; 26379},
      {'host' =&gt; '10.6.0.13', 'port' =&gt; 26379},
   ]</p>
<p># Gitaly Cluster
   ## repositories_storages gets configured for the Praefect virtual storage
   ## Address is the Internal Load Balancer for Praefect
   ## Token is the praefect_external_token
   gitlab_rails['repositories_storages'] = {
     "default" =&gt; {
       "gitaly_address" =&gt; "tcp://10.6.0.40:2305", # internal load balancer IP
       "gitaly_token" =&gt; '<praefect_external_token>'
     }
   }</p>
<p># PostgreSQL
   gitlab_rails['db_host'] = '10.6.0.40' # internal load balancer IP
   gitlab_rails['db_port'] = 6432
   gitlab_rails['db_password'] = '<postgresql_user_password>'
   gitlab_rails['db_load_balancing'] = { 'hosts' =&gt; ['10.6.0.21', '10.6.0.22', '10.6.0.23'] } # PostgreSQL IPs</p>
<p>## Prevent database migrations from running on upgrade automatically
   gitlab_rails['auto_migrate'] = false</p>
<p># Sidekiq
   sidekiq['listen_address'] = "0.0.0.0"</p>
<p>## Set number of Sidekiq queue processes to the same number as available CPUs
   sidekiq['queue_groups'] = ['*'] * 4</p>
<p># Monitoring
   consul['enable'] = true
   consul['monitoring_service_discovery'] =  true</p>
<p>consul['configuration'] = {
      retry_join: %w(10.6.0.11 10.6.0.12 10.6.0.13)
   }</p>
<p>## Set the network addresses that the exporters will listen on
   node_exporter['listen_address'] = '0.0.0.0:9100'</p>
<p>## Add the monitoring node's IP address to the monitoring whitelist
   gitlab_rails['monitoring_whitelist'] = ['10.6.0.81/32', '127.0.0.0/8']
   gitlab_rails['prometheus_address'] = '10.6.0.81:9090'</p>
<p># Object Storage
   ## This is an example for configuring Object Storage on GCP
   ## Replace this config with your chosen Object Storage provider as desired
   gitlab_rails['object_store']['enabled'] = true
   gitlab_rails['object_store']['connection'] = {
     'provider' =&gt; 'Google',
     'google_project' =&gt; '<gcp-project-name>',
     'google_json_key_location' =&gt; '<path-to-gcp-service-account-key>'
   }
   gitlab_rails['object_store']['objects']['artifacts']['bucket'] = "<gcp-artifacts-bucket-name>"
   gitlab_rails['object_store']['objects']['external_diffs']['bucket'] = "<gcp-external-diffs-bucket-name>"
   gitlab_rails['object_store']['objects']['lfs']['bucket'] = "<gcp-lfs-bucket-name>"
   gitlab_rails['object_store']['objects']['uploads']['bucket'] = "<gcp-uploads-bucket-name>"
   gitlab_rails['object_store']['objects']['packages']['bucket'] = "<gcp-packages-bucket-name>"
   gitlab_rails['object_store']['objects']['dependency_proxy']['bucket'] = "<gcp-dependency-proxy-bucket-name>"
   gitlab_rails['object_store']['objects']['terraform_state']['bucket'] = "<gcp-terraform-state-bucket-name>"</p>
<p>gitlab_rails['backup_upload_connection'] = {
     'provider' =&gt; 'Google',
     'google_project' =&gt; '<gcp-project-name>',
     'google_json_key_location' =&gt; '<path-to-gcp-service-account-key>'
   }
   gitlab_rails['backup_upload_remote_directory'] = "<gcp-backups-state-bucket-name>"</p>
<p>gitlab_rails['ci_secure_files_object_store_enabled'] = true
   gitlab_rails['ci_secure_files_object_store_remote_directory'] = "<gcp-ci_secure_files-bucket-name>"</p>
<p>gitlab_rails['ci_secure_files_object_store_connection'] = {
      'provider' =&gt; 'Google',
      'google_project' =&gt; '<gcp-project-name>',
      'google_json_key_location' =&gt; '<path-to-gcp-service-account-key>'
   }
   ```</p>
<ol>
<li>
<p>Copy the <code>/etc/gitlab/gitlab-secrets.json</code> file from the first Linux package node you configured and add or replace
   the file of the same name on this server. If this is the first Linux package node you are configuring then you can skip this step.</p>
</li>
<li>
<p>To ensure database migrations are only run during reconfigure and not automatically on upgrade, run:</p>
</li>
</ol>
<p><code>shell
   sudo touch /etc/gitlab/skip-auto-reconfigure</code></p>
<p>Only a single designated node should handle migrations as detailed in the
   <a href="#gitlab-rails-post-configuration">GitLab Rails post-configuration</a> section.</p>
<ol>
<li>
<p>Save the file and <a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">reconfigure GitLab</a>.</p>
</li>
<li>
<p>Verify the GitLab services are running:</p>
</li>
</ol>
<p><code>shell
   sudo gitlab-ctl status</code></p>
<p>The output should be similar to the following:</p>
<p><code>plaintext
   run: consul: (pid 30114) 77353s; run: log: (pid 29756) 77367s
   run: logrotate: (pid 9898) 3561s; run: log: (pid 29653) 77380s
   run: node-exporter: (pid 30134) 77353s; run: log: (pid 29706) 77372s
   run: sidekiq: (pid 30142) 77351s; run: log: (pid 29638) 77386s</code></p>
<div align="right">
  <a type="button" class="btn btn-default" href="#set-up-components">
    Back to set up components <i class="fa fa-angle-double-up" aria-hidden="true"></i>
  </a>
</div>

<h2>Configure GitLab Rails</h2>
<p>This section describes how to configure the GitLab application (Rails) component.</p>
<p>Rails requires connections to the <a href="#configure-redis">Redis</a>,
<a href="#configure-postgresql">PostgreSQL</a> and <a href="#configure-gitaly">Gitaly</a> instances.
It also requires a connection to <a href="#configure-the-object-storage">Object Storage</a> as recommended.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p><a href="../object_storage.html">Because it's recommended to use Object storage</a> instead of NFS for data objects, the following
examples include the Object storage configuration.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>On each node perform the following:</p>
<ol>
<li><a href="../../install/package/_index.md#supported-platforms">Download and install</a> the Linux
   package of your choice. Be sure to only add the GitLab package repository and install GitLab
   for your chosen operating system.</li>
<li>Create or edit <code>/etc/gitlab/gitlab.rb</code> and use the following configuration.
   To maintain uniformity of links across nodes, the <code>external_url</code>
   on the application server should point to the external URL that users will use
   to access GitLab. This would be the URL of the <a href="#configure-the-external-load-balancer">external load balancer</a>
   which will route traffic to the GitLab application server:</li>
</ol>
<p>```ruby
   external_url 'https://gitlab.example.com'</p>
<p># gitlab_rails['repositories_storages'] gets configured for the Praefect virtual storage
   # Address is the Internal Load Balancer for Praefect
   # Token is the praefect_external_token
   gitlab_rails['repositories_storages'] = {
     "default" =&gt; {
       "gitaly_address" =&gt; "tcp://10.6.0.40:2305", # internal load balancer IP
       "gitaly_token" =&gt; '<praefect_external_token>'
     }
   }</p>
<p>## Disable components that will not be on the GitLab application server
   roles(['application_role'])
   gitaly['enable'] = false
   sidekiq['enable'] = false</p>
<p>## PostgreSQL connection details
   # Disable PostgreSQL on the application node
   postgresql['enable'] = false
   gitlab_rails['db_host'] = '10.6.0.20' # internal load balancer IP
   gitlab_rails['db_port'] = 6432
   gitlab_rails['db_password'] = '<postgresql_user_password>'
   gitlab_rails['db_load_balancing'] = { 'hosts' =&gt; ['10.6.0.21', '10.6.0.22', '10.6.0.23'] } # PostgreSQL IPs</p>
<p># Prevent database migrations from running on upgrade automatically
   gitlab_rails['auto_migrate'] = false</p>
<p>## Redis connection details
   ## Must be the same in every sentinel node
   redis['master_name'] = 'gitlab-redis'</p>
<p>## The same password for Redis authentication you set up for the Redis primary node.
   redis['master_password'] = '<redis_primary_password>'</p>
<p>## A list of sentinels with <code>host</code> and <code>port</code>
   gitlab_rails['redis_sentinels'] = [
     {'host' =&gt; '10.6.0.11', 'port' =&gt; 26379},
     {'host' =&gt; '10.6.0.12', 'port' =&gt; 26379},
     {'host' =&gt; '10.6.0.13', 'port' =&gt; 26379}
   ]</p>
<p>## Enable service discovery for Prometheus
   consul['enable'] = true
   consul['monitoring_service_discovery'] =  true</p>
<p># Set the network addresses that the exporters used for monitoring will listen on
   node_exporter['listen_address'] = '0.0.0.0:9100'
   gitlab_workhorse['prometheus_listen_addr'] = '0.0.0.0:9229'
   sidekiq['listen_address'] = "0.0.0.0"
   puma['listen'] = '0.0.0.0'</p>
<p>## The IPs of the Consul server nodes
   ## You can also use FQDNs and intermix them with IPs
   consul['configuration'] = {
      retry_join: %w(10.6.0.11 10.6.0.12 10.6.0.13),
   }</p>
<p># Add the monitoring node's IP address to the monitoring whitelist and allow it to
   # scrape the NGINX metrics
   gitlab_rails['monitoring_whitelist'] = ['10.6.0.81/32', '127.0.0.0/8']
   nginx['status']['options']['allow'] = ['10.6.0.81/32', '127.0.0.0/8']
   gitlab_rails['prometheus_address'] = '10.6.0.81:9090'</p>
<p>## Uncomment and edit the following options if you have set up NFS
   ##
   ## Prevent GitLab from starting if NFS data mounts are not available
   ##
   #high_availability['mountpoint'] = '/var/opt/gitlab/git-data'
   ##
   ## Ensure UIDs and GIDs match between servers for permissions via NFS
   ##
   #user['uid'] = 9000
   #user['gid'] = 9000
   #web_server['uid'] = 9001
   #web_server['gid'] = 9001
   #registry['uid'] = 9002
   #registry['gid'] = 9002</p>
<p># Object storage
   # This is an example for configuring Object Storage on GCP
   # Replace this config with your chosen Object Storage provider as desired
   gitlab_rails['object_store']['enabled'] = true
   gitlab_rails['object_store']['connection'] = {
     'provider' =&gt; 'Google',
     'google_project' =&gt; '<gcp-project-name>',
     'google_json_key_location' =&gt; '<path-to-gcp-service-account-key>'
   }
   gitlab_rails['object_store']['objects']['artifacts']['bucket'] = "<gcp-artifacts-bucket-name>"
   gitlab_rails['object_store']['objects']['external_diffs']['bucket'] = "<gcp-external-diffs-bucket-name>"
   gitlab_rails['object_store']['objects']['lfs']['bucket'] = "<gcp-lfs-bucket-name>"
   gitlab_rails['object_store']['objects']['uploads']['bucket'] = "<gcp-uploads-bucket-name>"
   gitlab_rails['object_store']['objects']['packages']['bucket'] = "<gcp-packages-bucket-name>"
   gitlab_rails['object_store']['objects']['dependency_proxy']['bucket'] = "<gcp-dependency-proxy-bucket-name>"
   gitlab_rails['object_store']['objects']['terraform_state']['bucket'] = "<gcp-terraform-state-bucket-name>"</p>
<p>gitlab_rails['backup_upload_connection'] = {
     'provider' =&gt; 'Google',
     'google_project' =&gt; '<gcp-project-name>',
     'google_json_key_location' =&gt; '<path-to-gcp-service-account-key>'
   }
   gitlab_rails['backup_upload_remote_directory'] = "<gcp-backups-state-bucket-name>"
   gitlab_rails['ci_secure_files_object_store_enabled'] = true
   gitlab_rails['ci_secure_files_object_store_remote_directory'] = "<gcp-ci_secure_files-bucket-name>"</p>
<p>gitlab_rails['ci_secure_files_object_store_connection'] = {
      'provider' =&gt; 'Google',
      'google_project' =&gt; '<gcp-project-name>',
      'google_json_key_location' =&gt; '<path-to-gcp-service-account-key>'
   }
   ```</p>
<ol>
<li>If you're using <a href="#gitaly-cluster-praefect-tls-support">Gitaly with TLS support</a>, make sure the
   <code>gitlab_rails['repositories_storages']</code> entry is configured with <code>tls</code> instead of <code>tcp</code>:</li>
</ol>
<p><code>ruby
   gitlab_rails['repositories_storages'] = {
     "default" =&gt; {
       "gitaly_address" =&gt; "tls://10.6.0.40:2305", # internal load balancer IP
       "gitaly_token" =&gt; '&lt;praefect_external_token&gt;'
     }
   }</code></p>
<ol>
<li>
<p>Copy the cert into <code>/etc/gitlab/trusted-certs</code>:</p>
<p><code>shell
  sudo cp cert.pem /etc/gitlab/trusted-certs/</code></p>
</li>
<li>
<p>Copy the <code>/etc/gitlab/gitlab-secrets.json</code> file from the first Linux package node you configured and add or replace
   the file of the same name on this server. If this is the first Linux package node you are configuring then you can skip this step.</p>
</li>
<li>Copy the SSH host keys (all in the name format <code>/etc/ssh/ssh_host_*_key*</code>) from the first Rails node you configured and
   add or replace the files of the same name on this server. This ensures host mismatch errors aren't thrown
   for your users as they hit the load balanced Rails nodes. If this is the first Linux package node you are configuring,
   then you can skip this step.</li>
<li>To ensure database migrations are only run during reconfigure and not automatically on upgrade, run:</li>
</ol>
<p><code>shell
   sudo touch /etc/gitlab/skip-auto-reconfigure</code></p>
<p>Only a single designated node should handle migrations as detailed in the
   <a href="#gitlab-rails-post-configuration">GitLab Rails post-configuration</a> section.</p>
<ol>
<li><a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">Reconfigure GitLab</a> for the changes to take effect.</li>
<li><a href="#enable-incremental-logging">Enable incremental logging</a>.</li>
<li>Run <code>sudo gitlab-rake gitlab:gitaly:check</code> to confirm the node can connect to Gitaly.</li>
<li>Tail the logs to see the requests:</li>
</ol>
<p><code>shell
   sudo gitlab-ctl tail gitaly</code></p>
<ol>
<li>Verify the GitLab services are running:</li>
</ol>
<p><code>shell
   sudo gitlab-ctl status</code></p>
<p>The output should be similar to the following:</p>
<p><code>plaintext
   run: consul: (pid 4890) 8647s; run: log: (pid 29962) 79128s
   run: gitlab-exporter: (pid 4902) 8647s; run: log: (pid 29913) 79134s
   run: gitlab-workhorse: (pid 4904) 8646s; run: log: (pid 29713) 79155s
   run: logrotate: (pid 12425) 1446s; run: log: (pid 29798) 79146s
   run: nginx: (pid 4925) 8646s; run: log: (pid 29726) 79152s
   run: node-exporter: (pid 4931) 8645s; run: log: (pid 29855) 79140s
   run: puma: (pid 4936) 8645s; run: log: (pid 29656) 79161s</code></p>
<p>When you specify <code>https</code> in the <code>external_url</code>, as in the previous example,
GitLab expects that the SSL certificates are in <code>/etc/gitlab/ssl/</code>. If the
certificates aren't present, NGINX will fail to start. For more information, see
the <a href="https://docs.gitlab.com/omnibus/settings/ssl/">HTTPS documentation</a>.</p>
<h3>GitLab Rails post-configuration</h3>
<ol>
<li>Ensure that all migrations ran:</li>
</ol>
<p><code>shell
   gitlab-rake gitlab:db:configure</code></p>
<p>This operation requires configuring the Rails node to connect to the primary database
   directly, <a href="../postgresql/pgbouncer.md#procedure-for-bypassing-pgbouncer">bypassing PgBouncer</a>.
   After migrations have completed, you must configure the node to pass through PgBouncer again.</p>
<ol>
<li><a href="../operations/fast_ssh_key_lookup.html">Configure fast lookup of authorized SSH keys in the database</a>.</li>
</ol>
<div align="right">
  <a type="button" class="btn btn-default" href="#set-up-components">
    Back to set up components <i class="fa fa-angle-double-up" aria-hidden="true"></i>
  </a>
</div>

<h2>Configure Prometheus</h2>
<p>The Linux package can be used to configure a standalone Monitoring node
running <a href="../monitoring/prometheus/_index.html">Prometheus</a>:</p>
<ol>
<li>SSH in to the Monitoring node.</li>
<li><a href="../../install/package/_index.md#supported-platforms">Download and install</a> the Linux
   package of your choice. Be sure to only add the GitLab package repository and install GitLab
   for your chosen operating system.</li>
<li>Edit <code>/etc/gitlab/gitlab.rb</code> and add the contents:</li>
</ol>
<p>```ruby
   roles(['monitoring_role', 'consul_role'])</p>
<p>external_url 'http://gitlab.example.com'</p>
<p># Prometheus
   prometheus['listen_address'] = '0.0.0.0:9090'
   prometheus['monitor_kubernetes'] = false</p>
<p># Enable service discovery for Prometheus
   consul['monitoring_service_discovery'] =  true
   consul['configuration'] = {
      retry_join: %w(10.6.0.11 10.6.0.12 10.6.0.13)
   }</p>
<p># Configure Prometheus to scrape services not covered by discovery
   prometheus['scrape_configs'] = [
      {
         'job_name': 'pgbouncer',
         'static_configs' =&gt; [
            'targets' =&gt; [
            "10.6.0.31:9188",
            "10.6.0.32:9188",
            "10.6.0.33:9188",
            ],
         ],
      },
      {
         'job_name': 'praefect',
         'static_configs' =&gt; [
            'targets' =&gt; [
            "10.6.0.131:9652",
            "10.6.0.132:9652",
            "10.6.0.133:9652",
            ],
         ],
      },
   ]</p>
<p>nginx['enable'] = false
   ```</p>
<ol>
<li>Save the file and <a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">reconfigure GitLab</a>.</li>
<li>Verify the GitLab services are running:</li>
</ol>
<p><code>shell
   sudo gitlab-ctl status</code></p>
<p>The output should be similar to the following:</p>
<p><code>plaintext
   run: consul: (pid 31637) 17337s; run: log: (pid 29748) 78432s
   run: logrotate: (pid 31809) 2936s; run: log: (pid 29581) 78462s
   run: nginx: (pid 31665) 17335s; run: log: (pid 29556) 78468s
   run: prometheus: (pid 31672) 17335s; run: log: (pid 29633) 78456s</code></p>
<div align="right">
  <a type="button" class="btn btn-default" href="#set-up-components">
    Back to set up components <i class="fa fa-angle-double-up" aria-hidden="true"></i>
  </a>
</div>

<h2>Configure the object storage</h2>
<p>GitLab supports using an <a href="../object_storage.html">object storage</a> service for holding numerous types of data.
It's recommended over <a href="../nfs.html">NFS</a> for data objects and in general it's better
in larger setups as object storage is typically much more performant, reliable,
and scalable. See <a href="_index.md#recommended-cloud-providers-and-services">Recommended cloud providers and services</a> for more information.</p>
<p>There are two ways of specifying object storage configuration in GitLab:</p>
<ul>
<li><a href="../object_storage.md#configure-a-single-storage-connection-for-all-object-types-consolidated-form">Consolidated form</a>: A single credential is
  shared by all supported object types.</li>
<li><a href="../object_storage.md#configure-each-object-type-to-define-its-own-storage-connection-storage-specific-form">Storage-specific form</a>: Every object defines its
  own object storage <a href="../object_storage.md#configure-the-connection-settings">connection and configuration</a>.</li>
</ul>
<p>The consolidated form is used in the following examples when available.</p>
<p>Using separate buckets for each data type is the recommended approach for GitLab.
This ensures there are no collisions across the various types of data GitLab stores.
There are plans to <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/292958">enable the use of a single bucket</a>
in the future.</p>
<div align="right">
  <a type="button" class="btn btn-default" href="#set-up-components">
    Back to set up components <i class="fa fa-angle-double-up" aria-hidden="true"></i>
  </a>
</div>

<h3>Enable incremental logging</h3>
<p>GitLab Runner returns job logs in chunks which the Linux package caches temporarily on disk in <code>/var/opt/gitlab/gitlab-ci/builds</code> by default, even when using consolidated object storage. With default configuration, this directory needs to be shared through NFS on any GitLab Rails and Sidekiq nodes.</p>
<p>While sharing the job logs through NFS is supported, avoid the need to use NFS by enabling <a href="../cicd/job_logs.md#incremental-logging">incremental logging</a> (required when no NFS node has been deployed). Incremental logging uses Redis instead of disk space for temporary caching of job logs.</p>
<h2>Configure advanced search</h2>
<p>You can leverage Elasticsearch and <a href="../../integration/advanced_search/elasticsearch.html">enable advanced search</a>
for faster, more advanced code search across your entire GitLab instance.</p>
<p>Elasticsearch cluster design and requirements are dependent on your specific
data. For recommended best practices about how to set up your Elasticsearch
cluster alongside your instance, read how to
<a href="../../integration/advanced_search/elasticsearch.md#guidance-on-choosing-optimal-cluster-configuration">choose the optimal cluster configuration</a>.</p>
<div align="right">
  <a type="button" class="btn btn-default" href="#set-up-components">
    Back to set up components <i class="fa fa-angle-double-up" aria-hidden="true"></i>
  </a>
</div>

<h2>Supported modifications for lower user counts (HA)</h2>
<p>The 60 RPS or 3,000 users GitLab reference architecture is the smallest we recommend that achieves High Availability (HA).
However, for environments that must serve fewer users or a lower RPS but maintain HA, there are several
supported modifications you can make to this architecture to reduce complexity and cost.</p>
<p>It should be noted that to achieve HA with GitLab, the 60 RPS or 3,000 users architecture's makeup is ultimately what is
required. Each component has various considerations and rules to follow, and the architecture
meets all of these. Smaller versions of this architecture will be fundamentally the same,
but with smaller performance requirements, the following modifications are supported as follows:</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>If not stated below, no other modifications are supported for lower use counts.</p>
<p>{{&lt; /alert &gt;}}</p>
<ul>
<li>Lowering node specs: Depending on your user count, you can lower all suggested node specs as desired. However, it's recommended that you don't go lower than the <a href="../../install/requirements.html">general requirements</a>.</li>
<li>Combining select nodes: The following specific components are supported to be combined onto the same nodes to reduce complexity at the cost of some performance:</li>
<li>GitLab Rails and Sidekiq: Sidekiq nodes can be removed, and the component instead enabled on the GitLab Rails nodes.</li>
<li>PostgreSQL and PgBouncer: PgBouncer nodes could be removed and instead be enabled on PostgreSQL nodes with the Internal Load Balancer pointing to them. However, to enable <a href="../postgresql/database_load_balancing.html">Database Load Balancing</a>, a separate PgBouncer array is still required.</li>
<li>Reducing the node counts: Some node types do not need consensus and can run with fewer nodes (but more than one for redundancy):</li>
<li>GitLab Rails and Sidekiq: Stateless services don't have a minimum node count. Two are enough for redundancy.</li>
<li>PostgreSQL and PgBouncer: A quorum is not strictly necessary. Two PostgreSQL nodes and two PgBouncer nodes are enough for redundancy.</li>
<li>Consul, Redis Sentinel, and Praefect: Require an odd number, and a minimum of three nodes, for a voting quorum.</li>
<li>Running select components in reputable Cloud PaaS solutions: The following specific components are supported to be run on reputable Cloud Provider PaaS solutions. By doing this, additional dependent components can also be removed:</li>
<li>PostgreSQL: Can be run on reputable Cloud PaaS solutions such as Google Cloud SQL or Amazon RDS. In this setup, the PgBouncer and Consul nodes are no longer required:<ul>
<li>Consul may still be desired if <a href="../monitoring/prometheus/_index.html">Prometheus</a> auto discovery is a requirement, otherwise you must <a href="../monitoring/prometheus/_index.md#adding-custom-scrape-configurations">manually add scrape configurations</a> for all nodes.</li>
</ul>
</li>
<li>Redis: Can be run on reputable Cloud PaaS solutions such as Google Memorystore and AWS ElastiCache. In this setup, the Redis Sentinel is no longer required.</li>
</ul>
<h2>Cloud Native Hybrid reference architecture with Helm Charts (alternative)</h2>
<p>An alternative approach is to run specific GitLab components in Kubernetes.
The following services are supported:</p>
<ul>
<li>GitLab Rails</li>
<li>Sidekiq</li>
<li>NGINX</li>
<li>Toolbox</li>
<li>Migrations</li>
<li>Prometheus</li>
</ul>
<p>Hybrid installations leverage the benefits of both cloud native and traditional
compute deployments. With this, stateless components can benefit from cloud native
workload management benefits while stateful components are deployed in compute VMs
with Linux package installations to benefit from increased permanence.</p>
<p>Refer to the Helm charts <a href="https://docs.gitlab.com/charts/advanced/">Advanced configuration</a>
documentation for setup instructions including guidance on what GitLab secrets to sync
between Kubernetes and the backend components.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>This is an <strong>advanced</strong> setup. Running services in Kubernetes is well known
to be complex. <strong>This setup is only recommended</strong> if you have strong working
knowledge and experience in Kubernetes. The rest of this
section assumes this.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>For information about Gitaly on Kubernetes availability, limitations, and deployment considerations, see <a href="../gitaly/kubernetes.html">Gitaly on Kubernetes</a>.</p>
<h3>Cluster topology</h3>
<p>The following tables and diagram detail the hybrid environment using the same formats
as the typical environment documented previously.</p>
<p>First are the components that run in Kubernetes. These run across several node groups, although you can change
the overall makeup as desired as long as the minimum CPU and Memory requirements are observed.</p>
<table>
<thead>
<tr>
<th>Component Node Group</th>
<th>Target Node Pool Totals</th>
<th>GCP Example</th>
<th>AWS Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Webservice</td>
<td>16 vCPU<br/>20 GB memory (request)<br/>28 GB memory (limit)</td>
<td>2 x <code>n1-standard-16</code></td>
<td>2 x <code>c5.4xlarge</code></td>
</tr>
<tr>
<td>Sidekiq</td>
<td>7.2 vCPU<br/>16 GB memory (request)<br/>32 GB memory (limit)</td>
<td>3 x <code>n1-standard-4</code></td>
<td>3 x <code>m5.xlarge</code></td>
</tr>
<tr>
<td>Supporting services</td>
<td>4 vCPU<br/>15 GB memory</td>
<td>2 x <code>n1-standard-2</code></td>
<td>2 x <code>m5.large</code></td>
</tr>
</tbody>
</table>
<ul>
<li>For this setup, we regularly <a href="_index.md#validation-and-test-results">test</a> and recommended <a href="https://cloud.google.com/kubernetes-engine">Google Kubernetes Engine (GKE)</a> and <a href="https://aws.amazon.com/eks/">Amazon Elastic Kubernetes Service (EKS)</a>. Other Kubernetes services may also work, but your mileage may vary.</li>
<li>Machine type examples are given for illustration purposes. These types are used in <a href="_index.md#validation-and-test-results">validation and testing</a> but are not intended as prescriptive defaults. Switching to other machine types that meet the requirements as listed is supported. See <a href="_index.md#supported-machine-types">Supported Machine Types</a> for more information.</li>
<li>The <a href="#webservice">Webservice</a> and <a href="#sidekiq">Sidekiq</a> target node pool totals are given for GitLab components only. Additional resources are required for the chosen Kubernetes provider's system processes. The given examples take this into account.</li>
<li>The <a href="#supporting">Supporting</a> target node pool total is given generally to accommodate several resources for supporting the GitLab deployment as well as any additional deployments you may wish to make depending on your requirements. Similar to the other node pools, the chosen Kubernetes provider's system processes also require resources. The given examples take this into account.</li>
<li>In production deployments, it's not required to assign pods to specific nodes. However, it is recommended to have several nodes in each pool spread across different availability zones to align with resilient cloud architecture practices.</li>
<li>Enabling autoscaling, such as Cluster Autoscaler, for efficiency reasons is encouraged, but it's generally recommended targeting a floor of 75% for Webservice and Sidekiq pods to ensure ongoing performance.</li>
</ul>
<p>Next are the backend components that run on static compute VMs using the Linux package (or External PaaS
services where applicable):</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>Nodes</th>
<th>Configuration</th>
<th>GCP example<sup>1</sup></th>
<th>AWS example<sup>1</sup></th>
</tr>
</thead>
<tbody>
<tr>
<td>Consul<sup>2</sup></td>
<td>3</td>
<td>2 vCPU, 1.8 GB memory</td>
<td><code>n1-highcpu-2</code></td>
<td><code>c5.large</code></td>
</tr>
<tr>
<td>PostgreSQL<sup>2</sup></td>
<td>3</td>
<td>2 vCPU, 7.5 GB memory</td>
<td><code>n1-standard-2</code></td>
<td><code>m5.large</code></td>
</tr>
<tr>
<td>PgBouncer<sup>2</sup></td>
<td>3</td>
<td>2 vCPU, 1.8 GB memory</td>
<td><code>n1-highcpu-2</code></td>
<td><code>c5.large</code></td>
</tr>
<tr>
<td>Internal load balancer<sup>4</sup></td>
<td>1</td>
<td>4 vCPU, 3.6 GB memory</td>
<td><code>n1-highcpu-4</code></td>
<td><code>c5n.xlarge</code></td>
</tr>
<tr>
<td>Redis/Sentinel<sup>3</sup></td>
<td>3</td>
<td>2 vCPU, 7.5 GB memory</td>
<td><code>n1-standard-2</code></td>
<td><code>m5.large</code></td>
</tr>
<tr>
<td>Gitaly<sup>6</sup><sup>7</sup></td>
<td>3</td>
<td>4 vCPU, 15 GB memory</td>
<td><code>n1-standard-4</code></td>
<td><code>m5.xlarge</code></td>
</tr>
<tr>
<td>Praefect<sup>6</sup></td>
<td>3</td>
<td>2 vCPU, 1.8 GB memory</td>
<td><code>n1-highcpu-2</code></td>
<td><code>c5.large</code></td>
</tr>
<tr>
<td>Praefect PostgreSQL<sup>2</sup></td>
<td>1+</td>
<td>2 vCPU, 1.8 GB memory</td>
<td><code>n1-highcpu-2</code></td>
<td><code>c5.large</code></td>
</tr>
<tr>
<td>Object storage<sup>5</sup></td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><strong>Footnotes</strong>:</p>
<!-- Disable ordered list rule https://github.com/DavidAnson/markdownlint/blob/main/doc/Rules.md#md029---ordered-list-item-prefix -->
<!-- markdownlint-disable MD029 -->
<ol>
<li>Machine type examples are given for illustration purposes. These types are used in <a href="_index.md#validation-and-test-results">validation and testing</a> but are not intended as prescriptive defaults. Switching to other machine types that meet the requirements as listed is supported, including ARM variants if available. See <a href="_index.md#supported-machine-types">Supported Machine Types</a> for more information.</li>
<li>Can be optionally run on reputable third-party external PaaS PostgreSQL solutions. See <a href="#provide-your-own-postgresql-instance">Provide your own PostgreSQL instance</a> for more information.</li>
<li>Can be optionally run on reputable third-party external PaaS Redis solutions. See <a href="#provide-your-own-redis-instance">Provide your own Redis instance</a> for more information.</li>
<li>Recommended to be run with a reputable third-party load balancer or service (LB PaaS) which can provide HA capabilities.
   Sizing depends on selected Load Balancer and additional factors such as Network Bandwidth. Refer to <a href="_index.md#load-balancers">Load Balancers</a> for more information.</li>
<li>Should be run on reputable Cloud Provider or Self Managed solutions. See <a href="#configure-the-object-storage">Configure the object storage</a> for more information.</li>
<li>Gitaly Cluster (Praefect) provides the benefits of fault tolerance, but comes with additional complexity of setup and management.
   Review the existing <a href="../gitaly/praefect/_index.md#before-deploying-gitaly-cluster-praefect">technical limitations and considerations before deploying Gitaly Cluster (Praefect)</a>. If you want sharded Gitaly, use the same specs listed in the previous table for <code>Gitaly</code>.</li>
<li>Gitaly specifications are based on high percentiles of both usage patterns and repository sizes in good health.
   However, if you have <a href="_index.md#large-monorepos">large monorepos</a> (larger than several gigabytes) or <a href="_index.md#additional-workloads">additional workloads</a> these can significantly impact Git and Gitaly performance and further adjustments will likely be required.</li>
</ol>
<!-- markdownlint-enable MD029 -->

<p>{{&lt; alert type="note" &gt;}}</p>
<p>For all PaaS solutions that involve configuring instances, it's recommended to implement a minimum of three nodes in three different availability zones to align with resilient cloud architecture practices.</p>
<p>{{&lt; /alert &gt;}}</p>
<pre><code class="language-plantuml">@startuml 3k
skinparam linetype ortho

card &quot;Kubernetes via Helm Charts&quot; as kubernetes {
  card &quot;**External Load Balancer**&quot; as elb #6a9be7

  together {
    collections &quot;**Webservice**&quot; as gitlab #32CD32
    collections &quot;**Sidekiq**&quot; as sidekiq #ff8dd1
  }

  card &quot;**Supporting Services**&quot; as support
}

card &quot;**Internal Load Balancer**&quot; as ilb #9370DB
collections &quot;**Consul** x3&quot; as consul #e76a9b

card &quot;Gitaly Cluster&quot; as gitaly_cluster {
  collections &quot;**Praefect** x3&quot; as praefect #FF8C00
  collections &quot;**Gitaly** x3&quot; as gitaly #FF8C00
  card &quot;**Praefect PostgreSQL***\n//Non fault-tolerant//&quot; as praefect_postgres #FF8C00

  praefect -[#FF8C00]-&gt; gitaly
  praefect -[#FF8C00]&gt; praefect_postgres
}

card &quot;Database&quot; as database {
  collections &quot;**PGBouncer** x3&quot; as pgbouncer #4EA7FF
  card &quot;**PostgreSQL** (Primary)&quot; as postgres_primary #4EA7FF
  collections &quot;**PostgreSQL** (Secondary) x2&quot; as postgres_secondary #4EA7FF

  pgbouncer -[#4EA7FF]-&gt; postgres_primary
  postgres_primary .[#4EA7FF]&gt; postgres_secondary
}

card &quot;redis&quot; as redis {
  collections &quot;**Redis** x3&quot; as redis_nodes #FF6347
}

cloud &quot;**Object Storage**&quot; as object_storage #white

elb -[#6a9be7]-&gt; gitlab
elb -[hidden]-&gt; sidekiq
elb -[hidden]-&gt; support

gitlab -[#32CD32]--&gt; ilb
gitlab -[#32CD32]r--&gt; object_storage
gitlab -[#32CD32,norank]----&gt; redis
gitlab -[#32CD32]----&gt; database

sidekiq -[#ff8dd1]--&gt; ilb
sidekiq -[#ff8dd1]r--&gt; object_storage
sidekiq -[#ff8dd1,norank]----&gt; redis
sidekiq .[#ff8dd1]----&gt; database

ilb -[#9370DB]--&gt; gitaly_cluster
ilb -[#9370DB]--&gt; database
ilb -[hidden,norank]--&gt; redis

consul .[#e76a9b]--&gt; database
consul .[#e76a9b,norank]--&gt; gitaly_cluster
consul .[#e76a9b]--&gt; redis

@enduml
</code></pre>
<h3>Kubernetes component targets</h3>
<p>The following section details the targets used for the GitLab components deployed in Kubernetes.</p>
<h4>Webservice</h4>
<p>Each Webservice pod (Puma and Workhorse) is recommended to be run with the following configuration:</p>
<ul>
<li>4 Puma Workers</li>
<li>4 vCPU</li>
<li>5 GB memory (request)</li>
<li>7 GB memory (limit)</li>
</ul>
<p>For 60 RPS or 3,000 users we recommend a total Puma worker count of around 16 so in turn it's recommended to run at
least 4 Webservice pods.</p>
<p>For further information on Webservice resource usage, see the Charts documentation on <a href="https://docs.gitlab.com/charts/charts/gitlab/webservice/#resources">Webservice resources</a>.</p>
<h5>NGINX</h5>
<p>It's also recommended deploying the NGINX controller pods across the Webservice nodes as a DaemonSet. This allows the controllers to scale dynamically with the Webservice pods they serve, and takes advantage of the higher network bandwidth larger machine types typically have.</p>
<p>This isn't a strict requirement. The NGINX controller pods can be deployed as desired as long as they have enough resources to handle the web traffic.</p>
<h4>Sidekiq</h4>
<p>Each Sidekiq pod is recommended to be run with the following configuration:</p>
<ul>
<li>1 Sidekiq worker</li>
<li>900m vCPU</li>
<li>2 GB memory (request)</li>
<li>4 GB memory (limit)</li>
</ul>
<p>Similar to the standard deployment documented previously, an initial target of 8 Sidekiq workers has been used here.
Additional workers may be required depending on your specific workflow.</p>
<p>For further information on Sidekiq resource usage, see the Charts documentation on <a href="https://docs.gitlab.com/charts/charts/gitlab/sidekiq/#resources">Sidekiq resources</a>.</p>
<h3>Supporting</h3>
<p>The Supporting Node Pool is designed to house all supporting deployments that are not required on the Webservice and Sidekiq pools.</p>
<p>This includes various deployments related to the Cloud Provider's implementation and supporting
GitLab deployments such as <a href="https://docs.gitlab.com/charts/charts/gitlab/gitlab-shell/">GitLab Shell</a>.</p>
<p>To make any additional deployments such as Container Registry, Pages, or Monitoring, deploy these in the Supporting Node Pool where possible and not in the Webservice or Sidekiq pools. The Supporting Node Pool has been designed to accommodate several additional deployments. However, if your deployments don't fit into the
pool as given, you can increase the node pool accordingly. Conversely, if the pool in your use case is over-provisioned you can reduce accordingly.</p>
<h3>Example config file</h3>
<p>An example for the GitLab Helm Charts for the 60 RPS or 3,000 users reference architecture configuration <a href="https://gitlab.com/gitlab-org/charts/gitlab/-/blob/master/examples/ref/3k.yaml">can be found in the Charts project</a>.</p>
<div align="right">
  <a type="button" class="btn btn-default" href="#set-up-components">
    Back to set up components <i class="fa fa-angle-double-up" aria-hidden="true"></i>
  </a>
</div>

<h2>Next steps</h2>
<p>After following this guide you should now have a fresh GitLab environment with core functionality configured accordingly.</p>
<p>You may want to configure additional optional features of GitLab depending on your requirements. See <a href="../../install/next_steps.html">Steps after installing GitLab</a> for more information.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>Depending on your environment and requirements, additional hardware requirements or adjustments may be required to set up additional features as desired. Refer to the individual pages for more information.</p>
<p>{{&lt; /alert &gt;}}</p></code></pre>
</body>
</html>
