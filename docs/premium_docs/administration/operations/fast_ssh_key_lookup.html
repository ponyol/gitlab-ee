<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Fast lookup is required for Geo</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Create
group: Source Code
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
gitlab_dedicated: no
description: Configure a faster SSH authorization method for GitLab instances with many users.
title: Fast lookup of SSH keys</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Free, Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>When the number of users grows, SSH operations become slow because OpenSSH performs a
linear search through the <code>authorized_keys</code> file to authenticate users.
This process requires significant time and disk I/O, which delays users attempting to
push or pull to a repository.
If users add or remove keys frequently, the operating system may not cache the
<code>authorized_keys</code> file, which causes repeated disk reads.</p>
<p>Instead of using the <code>authorized_keys</code> file, you can configure GitLab Shell to look up
SSH keys. It is faster because the lookup is indexed in the GitLab database.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>For standard (non-deploy key) users, consider using <a href="ssh_certificates.html">SSH certificates</a>.
They are faster than database lookups, but are not a drop-in replacement for the <code>authorized_keys</code> file.</p>
<p>{{&lt; /alert &gt;}}</p>
<h2>Fast lookup is required for Geo</h2>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>Unlike <a href="https://docs.gitlab.com/charts/">Cloud Native GitLab</a>, by default Linux package installations
manage an <code>authorized_keys</code> file that is located in the <code>git</code> user's home directory. For most installations,
this file is located under <code>/var/opt/gitlab/.ssh/authorized_keys</code>. Use this command to locate the
<code>authorized_keys</code> on your system:</p>
<pre><code class="language-shell">getent passwd git | cut -d: -f6 | awk '{print $1&quot;/.ssh/authorized_keys&quot;}'
</code></pre>
<p>The <code>authorized_keys</code> file contains all the public SSH keys for users allowed to access GitLab. However, to maintain a
single source of truth, <a href="../geo/_index.html">Geo</a> must be configured to perform SSH fingerprint
lookups with database lookup.</p>
<p>When you <a href="../geo/setup/_index.html">set up Geo</a>, you must follow the steps below
for both the primary and secondary nodes. Do not select <strong>Write to <code>authorized keys</code> file</strong> on the
primary node, because it is reflected automatically on the secondary if database replication is working.</p>
<h2>Set up fast lookup</h2>
<p>GitLab Shell provides a way to authorize SSH users with a fast, indexed lookup
to the GitLab database. GitLab Shell uses the fingerprint of the SSH key to
check whether the user is authorized to access GitLab.</p>
<p>Fast lookup can be enabled with the following SSH servers:</p>
<ul>
<li><a href="gitlab_sshd.html"><code>gitlab-sshd</code></a></li>
<li>OpenSSH</li>
</ul>
<p>You can run both services simultaneously by using separate ports for each service.</p>
<h3>With <code>gitlab-sshd</code></h3>
<p>To set up <code>gitlab-sshd</code>, see <a href="gitlab_sshd.html">the <code>gitlab-sshd</code> documentation</a>.
After <code>gitlab-sshd</code> is enabled, GitLab Shell and <code>gitlab-sshd</code> are configured
to use fast lookup automatically.</p>
<h3>With OpenSSH</h3>
<p>Prerequisites:</p>
<ul>
<li>OpenSSH 6.9 or later is required because <code>AuthorizedKeysCommand</code> must
  accept a fingerprint. To check your version, run <code>sshd -V</code>.</li>
</ul>
<p>To set up fast lookup with OpenSSH:</p>
<ol>
<li>Add the following to your <code>sshd_config</code> file:</li>
</ol>
<p><code>plaintext
   Match User git    # Apply the AuthorizedKeysCommands to the git user only
     AuthorizedKeysCommand /opt/gitlab/embedded/service/gitlab-shell/bin/gitlab-shell-authorized-keys-check git %u %k
     AuthorizedKeysCommandUser git
   Match all    # End match, settings apply to all users again</code></p>
<p>This file is usually located in:</p>
<ul>
<li>Linux package installations: <code>/etc/ssh/sshd_config</code></li>
<li>Docker installations: <code>/assets/sshd_config</code></li>
<li>
<p>Self-compiled installations: If you followed the instructions for
   <a href="../../install/self_compiled/_index.md#install-gitlab-shell">installing GitLab Shell from source</a>, the command should be
   located at <code>/home/git/gitlab-shell/bin/gitlab-shell-authorized-keys-check</code>.
   Consider creating a wrapper script somewhere else because this command must be owned by <code>root</code>,
   and not be writable by a group or others.
   Also consider changing the ownership of this command as needed, but this might require temporary
   ownership changes during <code>gitlab-shell</code> upgrades.</p>
</li>
<li>
<p>Reload OpenSSH:</p>
</li>
</ul>
<p>```shell
   # Debian or Ubuntu installations
   sudo service ssh reload</p>
<p># CentOS installations
   sudo service sshd reload
   ```</p>
<ol>
<li>
<p>Confirm that SSH is working:</p>
</li>
<li>
<p>Comment out your user's key in the <code>authorized_keys</code> file. To do this, start the line with <code>#</code>.</p>
</li>
<li>
<p>From your local machine, attempt to pull a repository or run:</p>
<p><code>shell
  ssh -T git@gitlab.example.com</code></p>
<p>A successful pull or <a href="../../user/ssh.md#verify-that-you-can-connect">welcome message</a>
  means that GitLab found the key in the database because the key is not present in the file.</p>
</li>
</ol>
<p>If there are lookup failures, the <code>authorized_keys</code> file is still scanned.
Git SSH performance might still be slow for many users, as long as the large file exists.</p>
<p>To resolve this, you can disable writes to the <code>authorized_keys</code> file:</p>
<ol>
<li>Confirm SSH works. This step is important because otherwise the file quickly becomes out-of-date.</li>
<li>
<p>Disable writes to the <code>authorized_keys</code> file:</p>
</li>
<li>
<p>In the upper-right corner, select <strong>Admin</strong>.</p>
</li>
<li>Select <strong>Settings</strong> &gt; <strong>Network</strong>.</li>
<li>Expand <strong>Performance optimization</strong>.</li>
<li>Clear the <strong>Use <code>authorized_keys</code> file to authenticate SSH keys</strong> checkbox.</li>
<li>
<p>Select <strong>Save changes</strong>.</p>
</li>
<li>
<p>Verify the change:</p>
</li>
<li>
<p>Remove your SSH key in the UI.</p>
</li>
<li>Add a new key.</li>
<li>
<p>Try to pull a repository.</p>
</li>
<li>
<p>Back up and delete your <code>authorized_keys</code> file.
   The current users' keys are already present in the database, so there is no need for migration
   or for users to re-add their keys.</p>
</li>
</ol>
<h3>How to go back to using the <code>authorized_keys</code> file</h3>
<p>This overview is brief. Refer to the previous instructions for more context.</p>
<ol>
<li>Enable writes to the <code>authorized_keys</code> file.</li>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>On the left sidebar, select <strong>Settings</strong> &gt; <strong>Network</strong>.</li>
<li>Expand <strong>Performance optimization</strong>.</li>
<li>Select the <strong>Use <code>authorized_keys</code> file to authenticate SSH keys</strong> checkbox.</li>
<li><a href="../raketasks/maintenance.md#rebuild-authorized_keys-file">Rebuild the <code>authorized_keys</code> file</a>.</li>
<li>Remove the <code>AuthorizedKeysCommand</code> lines from <code>/etc/ssh/sshd_config</code> or from <code>/assets/sshd_config</code> if you are using Docker
   from a Linux package installation.</li>
<li>Reload <code>sshd</code>: <code>sudo service sshd reload</code>.</li>
</ol>
<h2>SELinux support</h2>
<p>GitLab supports <code>authorized_keys</code> database lookups with <a href="https://en.wikipedia.org/wiki/Security-Enhanced_Linux">SELinux</a>.</p>
<p>Because the SELinux policy is static, GitLab doesn't support changing
internal web server ports. Administrators would have to create a special <code>.te</code>
file for the environment because it isn't generated dynamically.</p>
<h3>Additional documentation</h3>
<p>Additional technical documentation for <code>gitlab-sshd</code> may be found in the
GitLab Shell documentation.</p>
<h2>Troubleshooting</h2>
<h3>SSH traffic slow or high CPU load</h3>
<p>If your SSH traffic is <a href="https://github.com/linux-pam/linux-pam/issues/270">slow</a>
or causing high CPU load:</p>
<ul>
<li>Check the size of <code>/var/log/btmp</code>.</li>
<li>Ensure it is rotated on a regular basis, or after reaching a certain size.</li>
</ul>
<p>If this file is very large, GitLab SSH fast lookup can cause the bottleneck to be hit more frequently,
thus decreasing performance even further. Consider disabling
<a href="https://linux.die.net/man/5/sshd_config"><code>UsePAM</code> in your <code>sshd_config</code></a> to avoid reading <code>/var/log/btmp</code> altogether.</p>
<p>Running <code>strace</code> and <code>lsof</code> on a running <code>sshd: git</code> process returns debugging information.
To get an <code>strace</code> on an in-progress Git over SSH connection for IP <code>x.x.x.x</code>, run:</p>
<pre><code class="language-plaintext">sudo strace -s 10000 -p $(sudo netstat -tp | grep x.x.x.x | egrep 'ssh.*: git' | sed -e 's/.*ESTABLISHED *//' -e 's#/.*##')
</code></pre>
<p>Or get an <code>lsof</code> for a running Git over SSH process:</p>
<pre><code class="language-plaintext">sudo lsof -p $(sudo netstat -tp | egrep 'ssh.*: git' | head -1 | sed -e 's/.*ESTABLISHED *//' -e 's#/.*##')
</code></pre></code></pre>
</body>
</html>
