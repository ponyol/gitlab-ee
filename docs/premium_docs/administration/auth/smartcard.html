<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Existing password authentication</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Software Supply Chain Security
group: Authentication
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Smart card authentication
description: Authenticate using hardware devices for certificate-based login.</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>GitLab supports authentication using smart cards.</p>
<h2>Existing password authentication</h2>
<p>By default, existing users can continue to sign in with a username and password when smart card
authentication is enabled.</p>
<p>To force existing users to use only smart card authentication,
<a href="../settings/sign_in_restrictions.md#password-authentication-enabled">disable username and password authentication</a>.</p>
<h2>Authentication methods</h2>
<p>GitLab supports two authentication methods:</p>
<ul>
<li>X.509 certificates with local databases.</li>
<li>LDAP servers.</li>
</ul>
<h3>Authentication against a local database with X.509 certificates</h3>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Status: Experiment</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>Smart cards with X.509 certificates can be used to authenticate with GitLab.</p>
<p>To use a smart card with an X.509 certificate to authenticate against a local
database with GitLab, <code>CN</code> and <code>emailAddress</code> must be defined in the
certificate. For example:</p>
<pre><code class="language-plaintext">Certificate:
    Data:
        Version: 1 (0x0)
        Serial Number: 12856475246677808609 (0xb26b601ecdd555e1)
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: O=Random Corp Ltd, CN=Random Corp
        Validity
            Not Before: Oct 30 12:00:00 2018 GMT
            Not After : Oct 30 12:00:00 2019 GMT
        Subject: CN=Gitlab User, emailAddress=gitlab-user@example.com
</code></pre>
<h3>Authentication against a local database with X.509 certificates and SAN extension</h3>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Status: Experiment</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>Smart cards with X.509 certificates using SAN extensions can be used to authenticate
with GitLab.</p>
<p>To use a smart card with an X.509 certificate to authenticate against a local
database with GitLab:</p>
<ul>
<li>At least one of the <code>subjectAltName</code> (SAN) extensions
  must define the user identity (<code>email</code>) within the GitLab instance (<code>URI</code>).</li>
<li>The <code>URI</code> must match <code>Gitlab.config.host.gitlab</code>.</li>
<li>If your certificate contains only <strong>one</strong> SAN email entry, you don't need to
  add or modify it to match the <code>email</code> with the <code>URI</code>.</li>
</ul>
<p>For example:</p>
<pre><code class="language-plaintext">Certificate:
    Data:
        Version: 1 (0x0)
        Serial Number: 12856475246677808609 (0xb26b601ecdd555e1)
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: O=Random Corp Ltd, CN=Random Corp
        Validity
            Not Before: Oct 30 12:00:00 2018 GMT
            Not After : Oct 30 12:00:00 2019 GMT
        ...
        X509v3 extensions:
            X509v3 Key Usage:
                Key Encipherment, Data Encipherment
            X509v3 Extended Key Usage:
                TLS Web Server Authentication
            X509v3 Subject Alternative Name:
                email:gitlab-user@example.com, URI:http://gitlab.example.com/
</code></pre>
<h3>Authentication against an LDAP server</h3>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Status: Experiment</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>GitLab implements a standard way of certificate matching following
<a href="https://www.rfc-editor.org/rfc/rfc4523">RFC4523</a>. It uses the
<code>certificateExactMatch</code> certificate matching rule against the <code>userCertificate</code>
attribute. As a prerequisite, you must use an LDAP server that:</p>
<ul>
<li>Supports the <code>certificateExactMatch</code> matching rule.</li>
<li>Has the certificate stored in the <code>userCertificate</code> attribute.</li>
</ul>
<h3>Authentication against an Active Directory LDAP server</h3>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/328074">Introduced</a> in GitLab 16.9.</li>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/514025">Added</a> <code>reverse_issuer_and_subject</code> and <code>reverse_issuer_and_serial_number</code> formats in GitLab 17.11.</li>
<li><code>issuer_and_subject</code>, <code>reverse_issuer_and_subject</code>, and <code>subject</code> formats <a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/208209">updated</a> in GitLab 18.6 <a href="../feature_flags/_index.html">with a flag</a> named <code>smartcard_ad_formats_v2</code>. Enabled by default. Disable this flag to revert these formats to the previous versions.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>{{&lt; alert type="flag" &gt;}}</p>
<p>The functionality of this feature is controlled by a feature flag.
For more information, see the history.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>Active Directory does not support the <code>certificateExactMatch</code> rule or the <code>userCertificate</code> attribute. Most tools for certificate-based authentication such as smart cards use the <code>altSecurityIdentities</code> attribute, which can contain multiple certificates for each user. The data in the field must match <a href="https://learn.microsoft.com/en-us/entra/identity/authentication/concept-certificate-based-authentication-certificateuserids#supported-patterns-for-certificate-user-ids">one of the formats Microsoft recommends</a>.</p>
<p>Use the following attributes to customize the field GitLab checks and the format for certificate data:</p>
<ul>
<li><code>smartcard_ad_cert_field</code> - specify the name of the field to search. This can be any attribute on a user object.</li>
<li><code>smartcard_ad_cert_format</code> - specify the format of the information gathered from the certificate. This format must be one of the following values. The most common is
  <code>issuer_and_serial_number</code> to match the behavior of non-Active Directory LDAP servers.</li>
</ul>
<table>
<thead>
<tr>
<th><code>smartcard_ad_cert_format</code></th>
<th>Example data</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>principal_name</code></td>
<td><code>X509:&lt;PN&gt;alice@example.com</code></td>
</tr>
<tr>
<td><code>rfc822_name</code></td>
<td><code>X509:&lt;RFC822&gt;bob@example.com</code></td>
</tr>
<tr>
<td><code>subject</code></td>
<td><code>X509:&lt;S&gt;CN=dennis,OU=UserAccounts,DC=example,DC=com</code></td>
</tr>
<tr>
<td><code>issuer_and_serial_number</code></td>
<td><code>X509:&lt;I&gt;CN=CONTOSO-DC-CA,DC=example,DC=com&lt;SR&gt;1181914561</code></td>
</tr>
<tr>
<td><code>issuer_and_subject</code></td>
<td><code>X509:&lt;I&gt;CN=EXAMPLE-DC-CA,DC=example,DC=com&lt;S&gt;CN=cynthia,OU=UserAccounts,DC=example,DC=com</code></td>
</tr>
<tr>
<td><code>reverse_issuer_and_serial_number</code></td>
<td><code>X509:&lt;I&gt;DC=com,DC=example,CN=CONTOSO-DC-CA&lt;SR&gt;1181914561</code></td>
</tr>
<tr>
<td><code>reverse_issuer_and_subject</code></td>
<td><code>X509:&lt;I&gt;DC=com,DC=example,CN=CONTOSO-DC-CA&lt;S&gt;CN=cynthia,OU=UserAccounts,DC=example,DC=com</code></td>
</tr>
<tr>
<td><code>reverse_issuer_and_reverse_subject</code></td>
<td><code>X509:&lt;I&gt;DC=com,DC=example,CN=CONTOSO-DC-CA&lt;S&gt;DC=com,DC=example,OU=UserAccounts,CN=cynthia</code></td>
</tr>
</tbody>
</table>
<p>For <code>issuer_and_serial_number</code>, the <code>&lt;SR&gt;</code> portion is in reverse-byte-order, with the least-significant byte first. For more information, see <a href="https://learn.microsoft.com/en-us/archive/blogs/spatdsg/howto-map-a-user-to-a-certificate-via-all-the-methods-available-in-the-altsecurityidentities-attribute">how to map a user to a certificate using the altSecurityIdentities attribute</a>.</p>
<p>The reverse issuer formats sort the issuer string from the smallest unit to the largest. Some
Active Directory servers store certificates in this format.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>If no <code>smartcard_ad_cert_format</code> is specified, but an LDAP server is configured with <code>active_directory: true</code> and smart cards enabled, GitLab defaults to the behavior of 16.8 and earlier, and uses <code>certificateExactMatch</code> on the <code>userCertificate</code> attribute.</p>
<p>{{&lt; /alert &gt;}}</p>
<h3>Authentication against Entra ID Domain Services</h3>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/328074">Introduced</a> in GitLab 16.9.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p><a href="https://learn.microsoft.com/en-us/entra/fundamentals/whatis">Microsoft Entra ID</a>, formerly known as Azure Active Directory, provides a cloud-based directory for companies and organizations. <a href="https://learn.microsoft.com/en-us/entra/identity/domain-services/overview">Entra Domain Services</a> provides a secure read-only LDAP interface to the directory, but only exposes a limited subset of the fields Entra ID has.</p>
<p>Entra ID uses the <code>CertificateUserIds</code> field to manage client certificates for users, but this field is not exposed in LDAP / Entra ID Domain Services. With a cloud-only setup, it is not possible for GitLab to authenticate users' smart cards using LDAP.</p>
<p>In a hybrid on-premise and cloud environment, entities are synced between the on-premise Active Directory controller and the cloud Entra ID using <a href="https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-azure-ad-connect-v2">Entra Connect</a>. If you are <a href="https://learn.microsoft.com/en-us/entra/identity/authentication/concept-certificate-based-authentication-certificateuserids#update-certificateuserids-using-microsoft-entra-connect">syncing your <code>altSecurityIdentities</code> attribute to <code>certificateUserIds</code> in Entra ID using Entra ID Connect</a>, you can expose this data in LDAP / Entra ID Domain Services so it can be authenticated by GitLab:</p>
<ol>
<li>Add a rule to Entra ID Connect to sync the <code>altSecurityIdentities</code> to an additional attribute in Entra ID.</li>
<li>Enable that extra attribute as an <a href="https://learn.microsoft.com/en-us/entra/identity/domain-services/concepts-custom-attributes">extension attribute in Entra ID Domain Services</a>.</li>
<li>Configure the <code>smartcard_ad_cert_field</code> field in GitLab to use this extension attribute.</li>
</ol>
<h2>Configure GitLab for smart card authentication</h2>
<p>For Linux package installations:</p>
<ol>
<li>Edit <code>/etc/gitlab/gitlab.rb</code>:</li>
</ol>
<p>```ruby
   # Allow smart card authentication
   gitlab_rails['smartcard_enabled'] = true</p>
<p># Path to a file containing a CA certificate
   gitlab_rails['smartcard_ca_file'] = "/etc/ssl/certs/CA.pem"</p>
<p># Host and port where the client side certificate is requested by the
   # webserver (NGINX/Apache)
   gitlab_rails['smartcard_client_certificate_required_host'] = "smartcard.example.com"
   gitlab_rails['smartcard_client_certificate_required_port'] = 3444
   ```</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>Assign a value to at least one of the following variables:
   <code>gitlab_rails['smartcard_client_certificate_required_host']</code> or
   <code>gitlab_rails['smartcard_client_certificate_required_port']</code>.</p>
<p>{{&lt; /alert &gt;}}</p>
<ol>
<li>Save the file and <a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">reconfigure</a>
   GitLab for the changes to take effect.</li>
</ol>
<p>For self-compiled installations:</p>
<ol>
<li>Configure NGINX to request a client side certificate</li>
</ol>
<p>In NGINX configuration, an <strong>additional</strong> server context must be defined with
   the same configuration except:</p>
<ul>
<li>
<p>The additional NGINX server context must be configured to run on a different
     port:</p>
<p><code>plaintext
 listen *:3444 ssl;</code></p>
</li>
<li>
<p>It can also be configured to run on a different hostname:</p>
<p><code>plaintext
 listen smartcard.example.com:443 ssl;</code></p>
</li>
<li>
<p>The additional NGINX server context must be configured to require the client
     side certificate:</p>
<p><code>plaintext
 ssl_verify_depth 2;
 ssl_client_certificate /etc/ssl/certs/CA.pem;
 ssl_verify_client on;</code></p>
</li>
<li>
<p>The additional NGINX server context must be configured to forward the client
     side certificate:</p>
<p><code>plaintext
 proxy_set_header    X-SSL-Client-Certificate    $ssl_client_escaped_cert;</code></p>
</li>
</ul>
<p>For example, the following is an example server context in an NGINX
   configuration file (such as in <code>/etc/nginx/sites-available/gitlab-ssl</code>):</p>
<p>```plaintext
   server {
       listen smartcard.example.com:3443 ssl;</p>
<pre><code>   # certificate for configuring SSL
   ssl_certificate /path/to/example.com.crt;
   ssl_certificate_key /path/to/example.com.key;

   ssl_verify_depth 2;
   # CA certificate for client side certificate verification
   ssl_client_certificate /etc/ssl/certs/CA.pem;
   ssl_verify_client on;

   location / {
       proxy_set_header    Host                        $http_host;
       proxy_set_header    X-Real-IP                   $remote_addr;
       proxy_set_header    X-Forwarded-For             $proxy_add_x_forwarded_for;
       proxy_set_header    X-Forwarded-Proto           $scheme;
       proxy_set_header    Upgrade                     $http_upgrade;
       proxy_set_header    Connection                  $connection_upgrade;

       proxy_set_header    X-SSL-Client-Certificate    $ssl_client_escaped_cert;

       proxy_read_timeout 300;

       proxy_pass http://gitlab-workhorse;
   }
</code></pre>
<p>}
   ```</p>
<ol>
<li>Edit <code>config/gitlab.yml</code>:</li>
</ol>
<p>```yaml
   ## Smart card authentication settings
   smartcard:
     # Allow smart card authentication
     enabled: true</p>
<pre><code> # Path to a file containing a CA certificate
 ca_file: '/etc/ssl/certs/CA.pem'

 # Host and port where the client side certificate is requested by the
 # webserver (NGINX/Apache)
 client_certificate_required_host: smartcard.example.com
 client_certificate_required_port: 3443
</code></pre>
<p>```</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>Assign a value to at least one of the following variables:
   <code>client_certificate_required_host</code> or <code>client_certificate_required_port</code>.</p>
<p>{{&lt; /alert &gt;}}</p>
<ol>
<li>Save the file and <a href="../restart_gitlab.md#self-compiled-installations">restart</a>
   GitLab for the changes to take effect.</li>
</ol>
<h3>Additional security recommendations</h3>
<p>For extra security, deploy GitLab behind a firewall such as CloudFlare WAF or a server running <a href="https://modsecurity.org/">ModSecurity</a>. URLs matching the following patterns should be accessible to NGINX deployed as part of GitLab, but not to external clients:</p>
<pre><code class="language-plaintext">/-/smartcard/extract_certificate
/-/smartcard/verify_certificate
</code></pre>
<p>These paths should only be externally accessible using the smartcard hostname and port allocated to NGINX, and not externally accessible using the primary GitLab hostname and port. This should be robust against <a href="https://portswigger.net/web-security/host-header">HTTP Host Header attacks</a>, so that users cannot submit their own certificate parameters without going through NGINX.</p>
<h3>Additional steps when using SAN extensions</h3>
<p>For Linux package installations:</p>
<ol>
<li>Add to <code>/etc/gitlab/gitlab.rb</code>:</li>
</ol>
<p><code>ruby
   gitlab_rails['smartcard_san_extensions'] = true</code></p>
<ol>
<li>Save the file and <a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">reconfigure</a>
   GitLab for the changes to take effect.</li>
</ol>
<p>For self-compiled installations:</p>
<ol>
<li>Add the <code>san_extensions</code> line to <code>config/gitlab.yml</code> within the smart card section:</li>
</ol>
<p>```yaml
   smartcard:
      enabled: true
      ca_file: '/etc/ssl/certs/CA.pem'
      client_certificate_required_port: 3444</p>
<pre><code>  # Enable the use of SAN extensions to match users with certificates
  san_extensions: true
</code></pre>
<p>```</p>
<ol>
<li>Save the file and <a href="../restart_gitlab.md#self-compiled-installations">restart</a>
   GitLab for the changes to take effect.</li>
</ol>
<h3>Additional steps when authenticating against an LDAP server</h3>
<p>For Linux package installations:</p>
<ol>
<li>Edit <code>/etc/gitlab/gitlab.rb</code>:</li>
</ol>
<p>```ruby
   gitlab_rails['ldap_servers'] = YAML.load &lt;&lt;-EOS
   main:
     # snip...
     # Enable smart card authentication against the LDAP server. Valid values
     # are "false", "optional", and "required".
     smartcard_auth: optional</p>
<pre><code> # If your LDAP server is Active Directory, you can configure these two fields.
 # Specify which field contains certificate information, 'altSecurityIdentities' by default
 smartcard_ad_cert_field: altSecurityIdentities

 # Specify format of certificate information. Valid values are:
 # principal_name, rfc822_name, issuer_and_subject, subject, issuer_and_serial_number
 smartcard_ad_cert_format: issuer_and_serial_number
</code></pre>
<p>EOS
   ```</p>
<ol>
<li>Save the file and <a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">reconfigure</a>
   GitLab for the changes to take effect.</li>
</ol>
<p>For self-compiled installations:</p>
<ol>
<li>Edit <code>config/gitlab.yml</code>:</li>
</ol>
<p>```yaml
   production:
     ldap:
       servers:
         main:
           # snip...
           # Enable smart card authentication against the LDAP server. Valid values
           # are "false", "optional", and "required".
           smartcard_auth: optional</p>
<pre><code>       # If your LDAP server is Active Directory, you can configure these two fields.
       # Specify which field contains certificate information, 'altSecurityIdentities' by default
       smartcard_ad_cert_field: altSecurityIdentities

       # Specify format of certificate information. Valid values are:
       # principal_name, rfc822_name, issuer_and_subject, subject, issuer_and_serial_number
       smartcard_ad_cert_format: issuer_and_serial_number
</code></pre>
<p>```</p>
<ol>
<li>Save the file and <a href="../restart_gitlab.md#self-compiled-installations">restart</a>
   GitLab for the changes to take effect.</li>
</ol>
<h3>Require browser session with smart card sign-in for Git access</h3>
<p>For Linux package installations:</p>
<ol>
<li>Edit <code>/etc/gitlab/gitlab.rb</code>:</li>
</ol>
<p><code>ruby
   gitlab_rails['smartcard_required_for_git_access'] = true</code></p>
<ol>
<li>Save the file and <a href="../restart_gitlab.md#reconfigure-a-linux-package-installation">reconfigure</a>
   GitLab for the changes to take effect.</li>
</ol>
<p>For self-compiled installations:</p>
<ol>
<li>Edit <code>config/gitlab.yml</code>:</li>
</ol>
<p><code>yaml
   ## Smart card authentication settings
   smartcard:
     # snip...
     # Browser session with smart card sign-in is required for Git access
     required_for_git_access: true</code></p>
<ol>
<li>Save the file and <a href="../restart_gitlab.md#self-compiled-installations">restart</a>
   GitLab for the changes to take effect.</li>
</ol>
<h2>Passwords for users created via smart card authentication</h2>
<p>The <a href="../../security/passwords_for_integrated_authentication_methods.html">Generated passwords for users created through integrated authentication</a> guide provides an overview of how GitLab generates and sets passwords for users created via smart card authentication.</p></code></pre>
</body>
</html>
