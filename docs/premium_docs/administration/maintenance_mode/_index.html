<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Enable Maintenance Mode</title>
    <link rel="stylesheet" href="/../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Tenant Scale
group: Geo
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: GitLab Maintenance Mode</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>Maintenance Mode allows administrators to reduce write operations to a minimum while maintenance tasks are performed. The main goal is to block all external actions that change the internal state. The internal state includes the PostgreSQL database, but especially files, Git repositories, and Container repositories.</p>
<p>When Maintenance Mode is enabled, in-progress actions finish relatively quickly because no new actions are coming in, and internal state changes are minimal.
In that state, various maintenance tasks are easier. Services can be stopped completely or
further degraded for a shorter period of time than might otherwise be needed. For example, stopping cron jobs and draining queues should be fairly quick.</p>
<p>Maintenance Mode allows most external actions that do not change internal state. On a high-level, HTTP <code>POST</code>, <code>PUT</code>, <code>PATCH</code>, and <code>DELETE</code> requests are blocked and a detailed overview of <a href="#rest-api">how special cases are handled</a> is available.</p>
<h2>Enable Maintenance Mode</h2>
<p>Enable Maintenance Mode as an administrator in one of these ways:</p>
<ul>
<li><strong>Web UI</strong>:</li>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>On the left sidebar, select <strong>Settings</strong> &gt; <strong>General</strong>.</li>
<li>Expand <strong>Maintenance Mode</strong>, and toggle <strong>Enable Maintenance Mode</strong>.
     You can optionally add a message for the banner as well.</li>
<li>
<p>Select <strong>Save changes</strong>.</p>
</li>
<li>
<p><strong>API</strong>:</p>
</li>
</ul>
<p><code>shell
  curl --request PUT --header "PRIVATE-TOKEN:$ADMIN_TOKEN" "&lt;gitlab-url&gt;/api/v4/application/settings?maintenance_mode=true"</code></p>
<h2>Disable Maintenance Mode</h2>
<p>Disable Maintenance Mode in one of three ways:</p>
<ul>
<li><strong>Web UI</strong>:</li>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>On the left sidebar, select <strong>Settings</strong> &gt; <strong>General</strong>.</li>
<li>Expand <strong>Maintenance Mode</strong>, and toggle <strong>Enable Maintenance Mode</strong>.
     You can optionally add a message for the banner as well.</li>
<li>
<p>Select <strong>Save changes</strong>.</p>
</li>
<li>
<p><strong>API</strong>:</p>
</li>
</ul>
<p><code>shell
  curl --request PUT --header "PRIVATE-TOKEN:$ADMIN_TOKEN" "&lt;gitlab-url&gt;/api/v4/application/settings?maintenance_mode=false"</code></p>
<h2>Behavior of GitLab features in Maintenance Mode</h2>
<p>When Maintenance Mode is enabled, a banner is displayed at the top of the page.
The banner can be customized with a specific message.</p>
<p>An error is displayed when a user tries to perform a write operation that isn't allowed.</p>
<p><img alt="Maintenance Mode banner and error message" src="img/maintenance_mode_error_message_v17_6.png" /></p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>In some cases, the visual feedback from an action could be misleading. For example, when starring a project, the <strong>Star</strong> button changes to show the <strong>Unstar</strong> action. However, this is only the frontend update, and it doesn't take into account the failed status of the POST request. These visual bugs are to be fixed <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/295197">in follow-up iterations</a>.</p>
<p>{{&lt; /alert &gt;}}</p>
<h3>Administrator functions</h3>
<p>Systems administrators can edit the application settings. This allows
them to disable Maintenance Mode after it's been enabled.</p>
<h3>Authentication</h3>
<p>All users can sign in and out of the GitLab instance but no new users can be created.</p>
<p>If there are <a href="../auth/ldap/_index.html">LDAP syncs</a> scheduled for that time, they fail because user creation is disabled. Similarly, <a href="../../integration/saml.md#configure-saml-support-in-gitlab">user creations based on SAML</a> fail.</p>
<h3>Git actions</h3>
<p>All read-only Git operations continue to work, for example
<code>git clone</code> and <code>git pull</code>. All write operations fail, both through the CLI and Web IDE with the error message: <code>Git push is not allowed because this GitLab instance is currently in (read-only) maintenance mode.</code></p>
<p>If Geo is enabled, Git pushes to both primary and secondaries fail.</p>
<h3>Merge requests, issues, epics</h3>
<p>All write actions except those mentioned previously fail. For example, a user cannot update merge requests or issues.</p>
<h3>Incoming email</h3>
<p>Creating new issue replies, issues (including new Service Desk issues), merge requests <a href="../incoming_email.html">by email</a> fail.</p>
<h3>Outgoing email</h3>
<p>Notification emails continue to arrive, but emails that require database writes, like resetting the password, do not arrive.</p>
<h3>REST API</h3>
<p>For most JSON requests, <code>POST</code>, <code>PUT</code>, <code>PATCH</code>, and <code>DELETE</code> are blocked, and the API returns a <code>503</code> response with the error message: <code>GitLab Maintenance: system is in maintenance mode</code>. Only the following requests are allowed:</p>
<table>
<thead>
<tr>
<th style="text-align: center;">HTTP request</th>
<th style="text-align: center;">Allowed routes</th>
<th style="text-align: center;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><code>POST</code></td>
<td style="text-align: center;"><code>/admin/application_settings/general</code></td>
<td style="text-align: center;">To allow updating application settings in the administrator UI</td>
</tr>
<tr>
<td style="text-align: center;"><code>PUT</code></td>
<td style="text-align: center;"><code>/api/v4/application/settings</code></td>
<td style="text-align: center;">To allow updating application settings with the API</td>
</tr>
<tr>
<td style="text-align: center;"><code>POST</code></td>
<td style="text-align: center;"><code>/users/sign_in</code></td>
<td style="text-align: center;">To allow users to sign in.</td>
</tr>
<tr>
<td style="text-align: center;"><code>POST</code></td>
<td style="text-align: center;"><code>/users/sign_out</code></td>
<td style="text-align: center;">To allow users to sign out.</td>
</tr>
<tr>
<td style="text-align: center;"><code>POST</code></td>
<td style="text-align: center;"><code>/oauth/token</code></td>
<td style="text-align: center;">To allow users to sign in to a Geo secondary for the first time.</td>
</tr>
<tr>
<td style="text-align: center;"><code>POST</code></td>
<td style="text-align: center;"><code>/admin/session</code>, <code>/admin/session/destroy</code></td>
<td style="text-align: center;">To allow <a href="https://gitlab.com/groups/gitlab-org/-/epics/2158">Admin Mode for GitLab administrators</a></td>
</tr>
<tr>
<td style="text-align: center;"><code>POST</code></td>
<td style="text-align: center;">Paths ending with <code>/compare</code></td>
<td style="text-align: center;">Git revision routes.</td>
</tr>
<tr>
<td style="text-align: center;"><code>POST</code></td>
<td style="text-align: center;"><code>.git/git-upload-pack</code></td>
<td style="text-align: center;">To allow Git pull/clone.</td>
</tr>
<tr>
<td style="text-align: center;"><code>POST</code></td>
<td style="text-align: center;"><code>/api/v4/internal</code></td>
<td style="text-align: center;">internal API routes</td>
</tr>
<tr>
<td style="text-align: center;"><code>POST</code></td>
<td style="text-align: center;"><code>/admin/sidekiq</code></td>
<td style="text-align: center;">To allow management of background jobs in the <strong>Admin</strong> area</td>
</tr>
<tr>
<td style="text-align: center;"><code>POST</code></td>
<td style="text-align: center;"><code>/admin/geo</code></td>
<td style="text-align: center;">To allow updating Geo Nodes in the administrator UI</td>
</tr>
<tr>
<td style="text-align: center;"><code>POST</code></td>
<td style="text-align: center;"><code>/api/v4/geo_replication</code></td>
<td style="text-align: center;">To allow certain Geo-specific administrator UI actions on secondary sites</td>
</tr>
</tbody>
</table>
<h3>GraphQL API</h3>
<p>{{&lt; history &gt;}}</p>
<ul>
<li>The <code>GeoRegistriesUpdate</code> mutation addition in the allowlist was <a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/124259">introduced</a> in GitLab 16.2.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p><code>POST /api/graphql</code> requests are allowed but mutations are blocked with the error message <code>You cannot perform write operations on a read-only instance</code>.</p>
<p>The only mutation that is allowed is the <code>GeoRegistriesUpdate</code> which is used to resync and reverify registries.</p>
<h3>Continuous Integration</h3>
<ul>
<li>No new jobs or pipelines start, scheduled or otherwise.</li>
<li>Jobs that were already running continue to have a <code>running</code> status in the GitLab UI,
  even if they finish running on the GitLab Runner.</li>
<li>Jobs in the <code>running</code> state for longer than the project's time limit do not time out.</li>
<li>Pipelines cannot be started, retried or canceled. No new jobs can be created either.</li>
<li>The status of the runners in <code>/admin/runners</code> isn't updated.</li>
<li><code>gitlab-runner verify</code> returns the error <code>ERROR: Verifying runner... is removed</code>.</li>
</ul>
<p>After Maintenance Mode is disabled, new jobs are picked up again. Jobs that were
in the <code>running</code> state before enabling Maintenance Mode resume and their logs start
updating again.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>You should restart previously <code>running</code> pipelines after Maintenance Mode
is turned off.</p>
<p>{{&lt; /alert &gt;}}</p>
<h3>Deployments</h3>
<p>Deployments don't go through because pipelines are unfinished.</p>
<p>You should disable auto deploys during Maintenance Mode, and enable them when it is disabled.</p>
<h4>Terraform integration</h4>
<p>Terraform integration depends on running CI pipelines, hence it is blocked.</p>
<h3>Container registry</h3>
<p><code>docker push</code> fails with this error: <code>denied: requested access to the resource is denied</code>, but <code>docker pull</code> works.</p>
<h3>Package registry</h3>
<p>Package registry allows you to install but not publish packages.</p>
<h3>Background jobs</h3>
<p>Background jobs (cron jobs, Sidekiq) continue running as is, because background jobs are not automatically disabled.
As background jobs perform operations that can change the internal state of your instance, you may want to disable
some or all of them while maintenance mode is enabled.</p>
<p><a href="../geo/disaster_recovery/planned_failover.md#prevent-updates-to-the-primary-site">During a planned Geo failover</a>,
you should disable all cron jobs except for those related to Geo.</p>
<p>To monitor queues and disable jobs:</p>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>Select <strong>Monitoring</strong> &gt; <strong>Background jobs</strong>.</li>
<li>In the Sidekiq dashboard, select <strong>Cron</strong> and disable jobs individually or all at once by selecting <strong>Disable All</strong>.</li>
</ol>
<h3>Incident management</h3>
<p><a href="../../operations/incident_management/_index.html">Incident management</a> functions are limited. The creation of <a href="../../operations/incident_management/alerts.html">alerts</a> and <a href="../../operations/incident_management/manage_incidents.md#create-an-incident">incidents</a> are paused entirely. Notifications and paging on alerts and incidents are therefore disabled.</p>
<h3>Feature flags</h3>
<ul>
<li>Development feature flags cannot be turned on or off through the API, but can be toggled through the Rails console.</li>
<li><a href="../../operations/feature_flags.html">The feature flag service</a> responds to feature flag checks but feature flags cannot be toggled</li>
</ul>
<h3>Geo secondaries</h3>
<p>When primary is in Maintenance Mode, secondary also automatically goes into Maintenance Mode.</p>
<p>It is important that you do not disable replication before enabling Maintenance Mode.</p>
<p>Replication, verification and manual actions to resync and reverify registries through the Admin UI
continue to work, but proxied Git pushes to primary don't.</p>
<h3>Secure features</h3>
<p>Features that depend on creating issues or creating or approving merge requests,
do not work.</p>
<p>Exporting a vulnerability list from a vulnerability report page does not work.</p>
<p>Changing the status on a finding or vulnerability object does not work, even though no error is shown in the UI.</p>
<p>SAST and Secret Detection cannot be initiated because they depend on passing CI jobs to create artifacts.</p>
<h2>An example use case: a planned failover</h2>
<p>In the use case of <a href="../geo/disaster_recovery/planned_failover.html">a planned failover</a>, a few writes in the primary database are acceptable, because they are replicated quickly and are not significant in number.</p>
<p>For the same reason we don't automatically block background jobs when Maintenance Mode is enabled.</p>
<p>The resulting database writes are acceptable. Here, the trade-off is between more service degradation and the completion of replication.</p>
<p>However, during a planned failover, we <a href="../geo/disaster_recovery/planned_failover.md#prevent-updates-to-the-primary-site">ask users to turn off cron jobs that are not related to Geo, manually</a>. In the absence of new database writes and non-Geo cron jobs, new background jobs would either not be created at all or be minimal.</p></code></pre>
</body>
</html>
