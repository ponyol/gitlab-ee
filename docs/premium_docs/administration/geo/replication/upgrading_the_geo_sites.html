<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># General upgrade steps</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Tenant Scale
group: Geo
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Upgrading the Geo sites</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>Read these sections carefully before updating your Geo sites. Not following
version-specific upgrade steps may result in unexpected downtime. If you have
any specific questions, <a href="https://about.gitlab.com/support/#contact-support">contact Support</a>.
A database major version upgrade requires <a href="https://docs.gitlab.com/omnibus/settings/database.html#upgrading-a-geo-instance">re-initializing the PostgreSQL replication</a>
to Geo secondaries. This applies to both Linux-packaged and externally-managed databases.
This may result in a larger than expected downtime.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>Upgrading Geo sites involves performing:</p>
<ol>
<li>Version-specific upgrade steps, depending on the version being upgraded to or from:</li>
<li><a href="../../../update/versions/gitlab_18_changes.html">GitLab 18 upgrade notes</a></li>
<li><a href="../../../update/versions/gitlab_17_changes.html">GitLab 17 upgrade notes</a></li>
<li><a href="../../../update/versions/gitlab_16_changes.html">GitLab 16 upgrade notes</a></li>
<li><a href="../../../update/versions/gitlab_15_changes.html">GitLab 15 upgrade notes</a></li>
<li><a href="#general-upgrade-steps">General upgrade steps</a>, for all upgrades.</li>
</ol>
<h2>General upgrade steps</h2>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>These general upgrade steps require downtime in a multi-node setup.
If you want to avoid downtime, consider using
<a href="../../../update/zero_downtime.md#upgrade-multi-node-geo-instances">zero-downtime upgrades</a>.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>To upgrade the Geo sites when a new GitLab version is released, upgrade <strong>primary</strong>
and all <strong>secondary</strong> sites:</p>
<ol>
<li>Optional. <a href="pause_resume_replication.html">Pause replication on each <strong>secondary</strong> site</a>
   to protect the disaster recovery (DR) capability of the <strong>secondary</strong> sites.</li>
<li>SSH into each node of the <strong>primary</strong> site.</li>
<li><a href="../../../update/package/_index.html">Upgrade GitLab on the <strong>primary</strong> site</a>.</li>
<li>Perform testing on the <strong>primary</strong> site, particularly if you paused replication in step 1 to protect DR.
   For more information about post-upgrade testing, see
   <a href="../../../update/plan_your_upgrade.md#run-upgrade-health-checks">run upgrade health checks</a>.</li>
<li>Ensure that the secrets in the <code>/etc/gitlab/gitlab-secrets.json</code> file of both the primary site and the secondary site are the same. The file must be the same on all of a site's nodes.</li>
<li>SSH into each node of <strong>secondary</strong> sites.</li>
<li><a href="../../../update/package/_index.html">Upgrade GitLab on each <strong>secondary</strong> site</a>.</li>
<li>If you paused replication in step 1, <a href="../_index.md#pausing-and-resuming-replication">resume replication on each <strong>secondary</strong></a>.
   Then, restart Puma and Sidekiq on each <strong>secondary</strong> site. This is to ensure they
   are initialized against the newer database schema that is now replicated from
   the previously upgraded <strong>primary</strong> site.</li>
</ol>
<p><code>shell
   sudo gitlab-ctl restart sidekiq
   sudo gitlab-ctl restart puma</code></p>
<ol>
<li><a href="#check-status-after-upgrading">Test</a> <strong>primary</strong> and <strong>secondary</strong> sites, and check version in each.</li>
</ol>
<h3>Check status after upgrading</h3>
<p>Now that the upgrade process is complete, you may want to check whether
everything is working correctly:</p>
<ol>
<li>Run the Geo Rake task on an application node for the primary and secondary sites. Everything should be green:</li>
</ol>
<p><code>shell
   sudo gitlab-rake gitlab:geo:check</code></p>
<ol>
<li>Check the <strong>primary</strong> site's Geo dashboard for any errors.</li>
<li>Test the data replication by pushing code to the <strong>primary</strong> site and see if it
   is received by <strong>secondary</strong> sites.</li>
</ol>
<p>If you encounter any issues, see the <a href="troubleshooting/_index.html">Geo troubleshooting guide</a>.</p></code></pre>
</body>
</html>
