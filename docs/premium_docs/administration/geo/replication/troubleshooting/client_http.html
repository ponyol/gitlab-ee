<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Fixing client errors</title>
    <link rel="stylesheet" href="../../../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Tenant Scale
group: Geo
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Troubleshooting Geo client and HTTP response code errors</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<h2>Fixing client errors</h2>
<h3>Authorization errors from LFS HTTP(S) client requests</h3>
<p>You may have problems if you're running a version of <a href="https://git-lfs.com/">Git LFS</a> before 2.4.2.
As noted in <a href="https://github.com/git-lfs/git-lfs/issues/3025">this authentication issue</a>,
requests redirected from the secondary to the primary site do not properly send the
Authorization header. This may result in either an infinite <code>Authorization &lt;-&gt; Redirect</code>
loop, or Authorization error messages.</p>
<h3>Error: <code>Net::ReadTimeout</code> when pushing through SSH on a Geo secondary</h3>
<p>When you push large repositories through SSH on a Geo secondary site, you may encounter a timeout.
This is because Rails proxies the push to the primary and has a 60 second default timeout,
<a href="https://gitlab.com/gitlab-org/gitlab/-/issues/7405">as described in this Geo issue</a>.</p>
<p>Current workarounds are:</p>
<ul>
<li>Push through HTTP instead, where Workhorse proxies the request to the primary (or redirects to the primary if Geo proxying is not enabled).</li>
<li>Push directly to the primary.</li>
</ul>
<p>Example log (<code>gitlab-shell.log</code>):</p>
<pre><code class="language-plaintext">Failed to contact primary https://primary.domain.com/namespace/push_test.git\\nError: Net::ReadTimeout\&quot;,\&quot;result\&quot;:null}&quot; code=500 method=POST pid=5483 url=&quot;http://127.0.0.1:3000/api/v4/geo/proxy_git_push_ssh/push&quot;
</code></pre>
<h3>Repair OAuth authorization between Geo sites</h3>
<p>When upgrading a Geo site, you might not be able to sign into a secondary site that only uses OAuth for authentication. In that case, start a <a href="../../../operations/rails_console.html">Rails console</a> session on your primary site and perform the following steps:</p>
<ol>
<li>To find the affected node, first list all the Geo Nodes you have:</li>
</ol>
<p><code>ruby
   GeoNode.all</code></p>
<ol>
<li>Repair the affected Geo node by specifying the ID:</li>
</ol>
<p><code>ruby
   GeoNode.find(&lt;id&gt;).repair</code></p>
<h2>HTTP response code errors</h2>
<h3>Secondary site returns 502 errors with Geo proxying</h3>
<p>When <a href="../../secondary_proxy/_index.html">Geo proxying for secondary sites</a> is enabled, and the secondary site user interface returns
502 errors, it is possible that the response header proxied from the primary site is too large.</p>
<p>Check the NGINX logs for errors similar to this example:</p>
<pre><code class="language-plaintext">2022/01/26 00:02:13 [error] 26641#0: *829148 upstream sent too big header while reading response header from upstream, client: 10.0.2.2, server: geo.staging.gitlab.com, request: &quot;POST /users/sign_in HTTP/2.0&quot;, upstream: &quot;http://unix:/var/opt/gitlab/gitlab-workhorse/sockets/socket:/users/sign_in&quot;, host: &quot;geo.staging.gitlab.com&quot;, referrer: &quot;https://geo.staging.gitlab.com/users/sign_in&quot;
</code></pre>
<p>To resolve this issue:</p>
<ol>
<li>Set <code>nginx['proxy_custom_buffer_size'] = '8k'</code> in <code>/etc/gitlab.rb</code> on all web nodes on the secondary site.</li>
<li>Reconfigure the <strong>secondary</strong> using <code>sudo gitlab-ctl reconfigure</code>.</li>
</ol>
<p>If you still get this error, you can further increase the buffer size by repeating the previous steps
and changing the <code>8k</code> size, for example by doubling it to <code>16k</code>.</p>
<h3>Geo Admin area shows <code>Unknown</code> for health status and 'Request failed with status code 401'</h3>
<p>If using a load balancer, ensure that the load balancer's URL is set as the <code>external_url</code> in the
<code>/etc/gitlab/gitlab.rb</code> of the nodes behind the load balancer.</p>
<p>On the primary site, go to <strong>Admin</strong> &gt; <strong>Geo</strong> &gt; <strong>Settings</strong> and find the <strong>Allowed Geo IP</strong> field. Ensure the IP address of the secondary site is listed.</p>
<h3>Primary site returns 500 error when accessing <code>/admin/geo/replication/projects</code></h3>
<p>Navigating to <strong>Admin</strong> &gt; <strong>Geo</strong> &gt; <strong>Replication</strong> (or <code>/admin/geo/replication/projects</code>) on a primary Geo site, shows a 500 error, while that same link on the secondary works fine. The primary's <code>production.log</code> has a similar entry to the following:</p>
<pre><code class="language-plaintext">Geo::TrackingBase::SecondaryNotConfigured: Geo secondary database is not configured
  from ee/app/models/geo/tracking_base.rb:26:in `connection'
  [..]
  from ee/app/views/admin/geo/projects/_all.html.haml:1
</code></pre>
<p>On a Geo primary site this error can be ignored.</p>
<p>This happens because GitLab is attempting to display registries from the <a href="../../_index.md#geo-tracking-database">Geo tracking database</a> which doesn't exist on the primary site (only the original projects exist on the primary; no replicated projects are present, therefore no tracking database exists).</p>
<h3>Secondary site returns 400 error <code>Request header or cookie too large</code></h3>
<p>This error can happen when the internal URL of the primary site is incorrect.</p>
<p>For example, when you use a unified URL and the primary site's internal URL is also equal to the external URL. This causes a loop when a secondary site proxies requests to the primary site's internal URL.</p>
<p>To fix this issue, set the primary site's internal URL to a URL that is:</p>
<ul>
<li>Unique to the primary site.</li>
<li>
<p>Accessible from all secondary sites.</p>
</li>
<li>
<p>Visit the primary site.</p>
</li>
<li><a href="../../../geo_sites.md#set-up-the-internal-urls">Set up the internal URLs</a>.</li>
</ul>
<h3>Secondary site returns <code>Received HTTP code 403 from proxy after CONNECT</code></h3>
<p>If you have installed GitLab using the Linux package (Omnibus) and have configured the <code>no_proxy</code> <a href="https://docs.gitlab.com/omnibus/settings/environment-variables.html">custom environment variable</a> for Gitaly, you may experience this issue. Affected versions:</p>
<ul>
<li><code>15.4.6</code></li>
<li><code>15.5.0</code>-<code>15.5.6</code></li>
<li><code>15.6.0</code>-<code>15.6.3</code></li>
<li><code>15.7.0</code>-<code>15.7.1</code></li>
</ul>
<p>This is due to <a href="https://github.com/curl/curl/issues/10122">a bug introduced in the included version of cURL</a> shipped with
the Linux package 15.4.6 and later. You should upgrade to a later version where this has been
<a href="https://about.gitlab.com/releases/2023/01/09/security-release-gitlab-15-7-2-released/">fixed</a>.</p>
<p>The bug causes all wildcard domains (<code>.example.com</code>) to be ignored except for the last on in the <code>no_proxy</code> environment variable list. Therefore, if for any reason you cannot upgrade to a newer version, you can work around the issue by moving your wildcard domain to the end of the list:</p>
<ol>
<li>Edit <code>/etc/gitlab/gitlab.rb</code>:</li>
</ol>
<p><code>ruby
   gitaly['env'] = {
     "no_proxy" =&gt; "server.yourdomain.org, .yourdomain.com",
   }</code></p>
<ol>
<li>Reconfigure GitLab:</li>
</ol>
<p><code>shell
   sudo gitlab-ctl reconfigure</code></p>
<p>You can have only one wildcard domain in the <code>no_proxy</code> list.</p>
<h3>Geo Admin area returns 404 error for a secondary site</h3>
<p>Sometimes <code>sudo gitlab-rake gitlab:geo:check</code> indicates that <strong>Rails nodes of the secondary</strong> sites are
healthy, but a 404 Not Found error message for the <strong>secondary</strong> site is returned in the Geo <strong>Admin</strong> area on the web interface for
the <strong>primary</strong> site.</p>
<p>To resolve this issue:</p>
<ul>
<li>Try restarting <strong>each Rails, Sidekiq and Gitaly nodes on your secondary site</strong> using <code>sudo gitlab-ctl restart</code>.</li>
<li>Check <code>/var/log/gitlab/gitlab-rails/geo.log</code> on Sidekiq nodes to see if the <strong>secondary</strong> site is
  using IPv6 to send its status to the <strong>primary</strong> site. If it is, add an entry to
  the <strong>primary</strong> site using IPv4 in the <code>/etc/hosts</code> file. Alternatively, you should
  <a href="https://docs.gitlab.com/omnibus/settings/nginx.html#setting-the-nginx-listen-address-or-addresses">enable IPv6 on the <strong>primary</strong> site</a>.</li>
</ul>
<h2>WebSocket requests fail on Geo secondary sites</h2>
<p>When using features that rely on WebSockets (such as GitLab Duo Chat, live issue updates, or other real-time features), connections may fail with 404 errors on Geo secondary sites.</p>
<p>This occurs because WebSocket requests are proxied from the secondary to the primary. On the primary site, ActionCable must be configured to allow WebSocket requests from all Geo sites. By default, ActionCable only allows requests from the local site.</p>
<p>To fix this issue, configure <code>action_cable_allowed_origins</code> according to your installation type:</p>
<ul>
<li><a href="../configuration.md#add-primary-and-secondary-urls-as-allowed-actioncable-origins">Geo documentation for the Linux package</a></li>
<li><a href="https://docs.gitlab.com/charts/advanced/geo/#configure-primary-database">Geo documentation for the Helm chart</a></li>
</ul></code></pre>
</body>
</html>
