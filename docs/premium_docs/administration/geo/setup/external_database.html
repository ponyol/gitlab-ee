<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># **Primary** site</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Tenant Scale
group: Geo
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Geo with external PostgreSQL instances</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>This document is relevant if you are using a PostgreSQL instance that is not
managed by the Linux package. This includes
<a href="../../reference_architectures/_index.md#best-practices-for-the-database-services">cloud-managed instances</a>,
or manually installed and configured PostgreSQL instances.</p>
<p>Ensure that you are using one of the PostgreSQL versions that
the <a href="../../package_information/postgresql_versions.html">Linux package ships with</a>
to <a href="../_index.md#requirements-for-running-geo">avoid version mismatches</a>
in case a Geo site has to be rebuilt.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>If you're using GitLab Geo, we strongly recommend running instances installed by using the Linux package or using
<a href="../../reference_architectures/_index.md#recommended-cloud-providers-and-services">validated cloud-managed instances</a>,
as we actively develop and test based on those.
We cannot guarantee compatibility with other external databases.</p>
<p>{{&lt; /alert &gt;}}</p>
<h2><strong>Primary</strong> site</h2>
<ol>
<li>SSH into a <strong>Rails node on your primary</strong> site and login as root:</li>
</ol>
<p><code>shell
   sudo -i</code></p>
<ol>
<li>Edit <code>/etc/gitlab/gitlab.rb</code> and add:</li>
</ol>
<p>```ruby
   ##
   ## Geo Primary role
   ## - configure dependent flags automatically to enable Geo
   ##
   roles ['geo_primary_role']</p>
<p>##
   ## The unique identifier for the Geo site. See
   ## https://docs.gitlab.com/ee/administration/geo_sites.html#common-settings
   ##
   gitlab_rails['geo_node_name'] = '<site_name_here>'
   ```</p>
<ol>
<li>Reconfigure the <strong>Rails node</strong> for the change to take effect:</li>
</ol>
<p><code>shell
   gitlab-ctl reconfigure</code></p>
<ol>
<li>Execute the command below on the <strong>Rails node</strong> to define the site as <strong>primary</strong> site:</li>
</ol>
<p><code>shell
   gitlab-ctl set-geo-primary-node</code></p>
<p>This command uses your defined <code>external_url</code> in <code>/etc/gitlab/gitlab.rb</code>.</p>
<h3>Configure the external database to be replicated</h3>
<p>To set up an external database, you can either:</p>
<ul>
<li>Set up <a href="https://www.postgresql.org/docs/16/warm-standby.html#STREAMING-REPLICATION-SLOTS">streaming replication</a> yourself (for example Amazon RDS, or bare metal not managed by the Linux package).</li>
<li>Manually perform the configuration of your Linux package installations as follows.</li>
</ul>
<h4>Leverage your cloud provider's tools to replicate the primary database</h4>
<p>Given you have a primary site set up on AWS EC2 that uses RDS.
You can now just create a read-only replica in a different region and the
replication process is managed by AWS. Make sure you've set Network ACL (Access Control List), Subnet, and Security Group according to your needs, so the secondary Rails nodes can access the database.</p>
<p>The following instructions detail how to create a read-only replica for common
cloud providers:</p>
<ul>
<li>Amazon RDS - <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_ReadRepl.html#USER_ReadRepl.Create">Creating a Read Replica</a></li>
<li>Azure Database for PostgreSQL - <a href="https://learn.microsoft.com/en-us/azure/postgresql/single-server/how-to-read-replicas-portal">Create and manage read replicas in Azure Database for PostgreSQL</a></li>
<li>Google Cloud SQL - <a href="https://cloud.google.com/sql/docs/postgres/replication/create-replica">Creating read replicas</a></li>
</ul>
<p>When your read-only replica is set up, you can skip to <a href="#configure-secondary-site-to-use-the-external-read-replica">configure your secondary site</a></p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>The use of logical replication methods such as <a href="https://aws.amazon.com/dms/">AWS Database Migration Service</a>
or <a href="https://cloud.google.com/database-migration">Google Cloud Database Migration Service</a> to, for instance,
replicate from an on-premise primary database to an RDS secondary are not supported.</p>
<p>{{&lt; /alert &gt;}}</p>
<h4>Manually configure the primary database for replication</h4>
<p>The <a href="https://docs.gitlab.com/omnibus/roles/#gitlab-geo-roles"><code>geo_primary_role</code></a>
configures the <strong>primary</strong> node's database to be replicated by making changes to
<code>pg_hba.conf</code> and <code>postgresql.conf</code>. Make the following configuration changes
manually to your external database configuration and ensure that you restart PostgreSQL
afterwards for the changes to take effect:</p>
<pre><code class="language-plaintext">##
## Geo Primary Role
## - pg_hba.conf
##
host    all         all               &lt;trusted primary IP&gt;/32       md5
host    replication gitlab_replicator &lt;trusted primary IP&gt;/32       md5
host    all         all               &lt;trusted secondary IP&gt;/32     md5
host    replication gitlab_replicator &lt;trusted secondary IP&gt;/32     md5
</code></pre>
<pre><code class="language-plaintext">##
## Geo Primary Role
## - postgresql.conf
##
wal_level = hot_standby
max_wal_senders = 10
wal_keep_segments = 50
max_replication_slots = 1 # number of secondary instances
hot_standby = on
</code></pre>
<h2><strong>Secondary</strong> sites</h2>
<h3>Manually configure the replica database</h3>
<p>Make the following configuration changes manually to your <code>pg_hba.conf</code> and <code>postgresql.conf</code>
of your external replica database and ensure that you restart PostgreSQL afterwards
for the changes to take effect:</p>
<pre><code class="language-plaintext">##
## Geo Secondary Role
## - pg_hba.conf
##
host    all         all               &lt;trusted secondary IP&gt;/32     md5
host    replication gitlab_replicator &lt;trusted secondary IP&gt;/32     md5
host    all         all               &lt;trusted primary IP&gt;/24       md5
</code></pre>
<pre><code class="language-plaintext">##
## Geo Secondary Role
## - postgresql.conf
##
wal_level = hot_standby
max_wal_senders = 10
wal_keep_segments = 10
hot_standby = on
</code></pre>
<h3>Configure <strong>secondary</strong> site to use the external read-replica</h3>
<p>With Linux package installations, the
<a href="https://docs.gitlab.com/omnibus/roles/#gitlab-geo-roles"><code>geo_secondary_role</code></a>
has three main functions:</p>
<ol>
<li>Configure the replica database.</li>
<li>Configure the tracking database.</li>
<li>Enable the <a href="../_index.md#geo-log-cursor">Geo Log Cursor</a> (not covered in this section).</li>
</ol>
<p>To configure the connection to the external read-replica database and enable Log Cursor:</p>
<ol>
<li>SSH into each <strong>Rails, Sidekiq and Geo Log Cursor</strong> node on your <strong>secondary</strong> site and login as root:</li>
</ol>
<p><code>shell
   sudo -i</code></p>
<ol>
<li>Edit <code>/etc/gitlab/gitlab.rb</code> and add the following</li>
</ol>
<p>```ruby
   ##
   ## Geo Secondary role
   ## - configure dependent flags automatically to enable Geo
   ##
   roles ['geo_secondary_role']</p>
<p># note this is shared between both databases,
   # make sure you define the same password in both
   gitlab_rails['db_password'] = '<your_primary_db_password_here>'</p>
<p>gitlab_rails['db_username'] = 'gitlab'
   gitlab_rails['db_host'] = '<database_read_replica_host>'</p>
<p># Disable the bundled Omnibus PostgreSQL because we are
   # using an external PostgreSQL
   postgresql['enable'] = false
   ```</p>
<ol>
<li>Save the file and <a href="../../restart_gitlab.md#reconfigure-a-linux-package-installation">reconfigure GitLab</a></li>
</ol>
<h3>Configure the tracking database</h3>
<p><strong>Secondary</strong> sites use a separate PostgreSQL installation as a tracking
database to keep track of replication status and automatically recover from
potential replication issues. The Linux package automatically configures a tracking database
when <code>roles ['geo_secondary_role']</code> is set.
If you want to run this database external to your Linux package installation, use the following instructions.</p>
<h4>Understanding internal and external tracking databases</h4>
<p>You can configure the tracking database to be either:</p>
<ul>
<li>Internal (<code>geo_postgresql['enable'] = true</code>): The tracking database runs as a managed PostgreSQL instance on the same server as the Rails application. This is the default.</li>
<li>External (<code>geo_postgresql['enable'] = false</code>): The tracking database runs on a separate server or as a cloud-managed service.</li>
</ul>
<p>In multi-node secondary site setups, if you enable the tracking database on one Rails node, it becomes "external" to all other Rails nodes in the site. All other Rails nodes must set <code>geo_postgresql['enable'] = false</code> and specify connection details to connect to that tracking database.</p>
<h4>Cloud-managed database services</h4>
<p>If you are using a cloud-managed service for the tracking database, you may need
to grant additional roles to your tracking database user (by default, this is
<code>gitlab_geo</code>):</p>
<ul>
<li>Amazon RDS requires the <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Appendix.PostgreSQL.CommonDBATasks.html#Appendix.PostgreSQL.CommonDBATasks.Roles"><code>rds_superuser</code></a> role.</li>
<li>Azure Database for PostgreSQL requires the <a href="https://learn.microsoft.com/en-us/azure/postgresql/single-server/how-to-create-users#how-to-create-additional-admin-users-in-azure-database-for-postgresql"><code>azure_pg_admin</code></a> role.</li>
<li>Google Cloud SQL requires the <a href="https://cloud.google.com/sql/docs/postgres/users#default-users"><code>cloudsqlsuperuser</code></a> role.</li>
</ul>
<p>This is for the installation of extensions during installation and upgrades. As an alternative,
<a href="../../../install/postgresql_extensions.html">ensure the extensions are installed manually, and read about the problems that may arise during future GitLab upgrades</a>.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>If you want to use Amazon RDS as a tracking database, make sure it has access to
the secondary database. Unfortunately, just assigning the same security group is not enough as
outbound rules do not apply to RDS PostgreSQL databases. Therefore, you need to explicitly add an inbound
rule to the read-replica's security group allowing any TCP traffic from
the tracking database on port 5432.</p>
<p>{{&lt; /alert &gt;}}</p>
<h4>Create the tracking database</h4>
<p>Create and configure the tracking database in your PostgreSQL instance:</p>
<ol>
<li>Set up PostgreSQL according to the
   <a href="../../../install/requirements.md#postgresql">database requirements document</a>.</li>
<li>Set up a <code>gitlab_geo</code> user with a password of your choice, create the <code>gitlabhq_geo_production</code> database, and make the user an owner of the database.
   You can see an example of this setup in the <a href="../../../install/self_compiled/_index.md#7-database">self-compiled installation documentation</a>.</li>
<li>If you are <strong>not</strong> using a cloud-managed PostgreSQL database, ensure that your secondary
   site can communicate with your tracking database by manually changing the
   <code>pg_hba.conf</code> that is associated with your tracking database.
   Remember to restart PostgreSQL afterwards for the changes to take effect:</li>
</ol>
<p><code>plaintext
   ##
   ## Geo Tracking Database Role
   ## - pg_hba.conf
   ##
   host    all         all               &lt;trusted tracking IP&gt;/32      md5
   host    all         all               &lt;trusted secondary IP&gt;/32     md5
   # In multi-node setups, add entries for all Rails nodes that will connect</code></p>
<h4>Configure GitLab</h4>
<p>Configure GitLab to use this database. These steps are for Linux package and Docker deployments.</p>
<ol>
<li>SSH into a GitLab <strong>secondary</strong> server and login as root:</li>
</ol>
<p><code>shell
   sudo -i</code></p>
<ol>
<li>Edit <code>/etc/gitlab/gitlab.rb</code> with the connection parameters and credentials for
   the machine with the PostgreSQL instance:</li>
</ol>
<p>```ruby
   geo_secondary['db_username'] = 'gitlab_geo'
   geo_secondary['db_password'] = '<your_tracking_db_password_here>'</p>
<p>geo_secondary['db_host'] = '<tracking_database_host>'
   geo_secondary['db_port'] = <tracking_database_port>      # change to the correct port
   geo_postgresql['enable'] = false     # don't use internal managed instance
   ```</p>
<p>In multi-node setups, apply this configuration to each Rails node that needs to connect to the external tracking database.</p>
<ol>
<li>Save the file and <a href="../../restart_gitlab.md#reconfigure-a-linux-package-installation">reconfigure GitLab</a></li>
</ol>
<h4>Set up the database schema</h4>
<p>The reconfigure command in the <a href="#configure-gitlab">previously listed steps</a> for Linux package and Docker deployments should handle these steps automatically.</p>
<ol>
<li>This task creates the database schema. It requires the database user to be a superuser.</li>
</ol>
<p><code>shell
   sudo gitlab-rake db:create:geo</code></p>
<ol>
<li>Applying Rails database migrations (schema and data updates) is also performed by reconfigure. If <code>geo_secondary['auto_migrate'] = false</code> is set, or
   the schema was created manually, this step will be required:</li>
</ol>
<p><code>shell
   sudo gitlab-rake db:migrate:geo</code></p></code></pre>
</body>
</html>
