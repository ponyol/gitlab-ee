<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Repository verification</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Tenant Scale
group: Geo
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
gitlab_dedicated: no
title: Automatic background verification</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>Automatic background verification ensures that the transferred data matches a
calculated checksum. If the checksum of the data on the <strong>primary</strong> site matches checksum of the
data on the <strong>secondary</strong> site, the data transferred successfully. Following a planned failover,
any corrupted data may be <strong>lost</strong>, depending on the extent of the corruption.</p>
<p>If verification fails on the <strong>primary</strong> site, this indicates Geo is replicating a corrupted object.
You can restore it from backup or remove it from the <strong>primary</strong> site to resolve the issue.</p>
<p>If verification succeeds on the <strong>primary</strong> site but fails on the <strong>secondary</strong> site,
this indicates that the object was corrupted during the replication process.
Geo actively try to correct verification failures marking the repository to
be resynced with a back-off period. If you want to reset the verification for
these failures, so you should follow <a href="background_verification.md#reset-verification-for-projects-where-verification-has-failed">these instructions</a>.</p>
<p>If verification is lagging significantly behind replication, consider giving
the site more time before scheduling a planned failover.</p>
<h2>Repository verification</h2>
<p>On the <strong>primary</strong> site:</p>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>Select <strong>Geo</strong> &gt; <strong>Sites</strong>.</li>
<li>Expand <strong>Verification information</strong> tab for that site to view automatic checksumming
   status for repositories and wikis. Successes are shown in green, pending work
   in gray, and failures in red.</li>
</ol>
<p><img alt="Verification information tab with an overview of a healthy primary Geo instance." src="img/verification_status_primary_v14_0.png" /></p>
<p>On the <strong>secondary</strong> site:</p>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>Select <strong>Geo</strong> &gt; <strong>Sites</strong>.</li>
<li>Expand <strong>Verification information</strong> tab for that site to view automatic checksumming
   status for repositories and wikis. Successes are shown in green, pending work
   in gray, and failures in red.</li>
</ol>
<p><img alt="Verification information tab with an overview of a healthy secondary Geo instance." src="img/verification_status_secondary_v14_0.png" /></p>
<h2>Using checksums to compare Geo sites</h2>
<p>To check the health of Geo <strong>secondary</strong> sites, we use a checksum over the list of
Git references and their values. The checksum includes <code>HEAD</code>, <code>heads</code>, <code>tags</code>,
<code>notes</code>, and GitLab-specific references to ensure true consistency. If two sites
have the same checksum, then they definitely hold the same references. We compute
the checksum for every site after every update to make sure that they are all
in sync.</p>
<h2>Repository re-verification</h2>
<p>Due to bugs or transient infrastructure failures, it is possible for Git
repositories to change unexpectedly without being marked for verification.
Geo constantly reverifies the repositories to ensure the integrity of the
data. The default and recommended re-verification interval is 7 days, though
an interval as short as 1 day can be set. Shorter intervals reduce risk but
increase load and vice versa.</p>
<p>On the <strong>primary</strong> site:</p>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>Select <strong>Geo</strong> &gt; <strong>Sites</strong>.</li>
<li>Select <strong>Edit</strong> for the <strong>primary</strong> site to customize the minimum
   re-verification interval:</li>
</ol>
<p><img alt="Window with configuration attributes of a Geo node." src="img/reverification-interval_v11_6.png" /></p>
<h2>Reset verification for projects where verification has failed</h2>
<p>Geo actively tries to correct verification failures marking the repository to
be resynced with a back-off period. You can also manually <a href="../replication/troubleshooting/synchronization_verification.md#resync-and-reverify-individual-components">resync and reverify individual components through the UI or the Rails console</a>.</p>
<h2>Reconcile differences with checksum mismatches</h2>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><strong>Storage name</strong> and <strong>Relative path</strong> fields <a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/128416">renamed</a> from <strong>Gitaly storage name</strong> and <strong>Gitaly relative path</strong> in GitLab 16.3.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>If the <strong>primary</strong> and <strong>secondary</strong> sites have a checksum verification mismatch, the cause may not be apparent. To find the cause of a checksum mismatch:</p>
<ol>
<li>On the <strong>primary</strong> site:</li>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>On the left sidebar, select <strong>Overview</strong> &gt; <strong>Projects</strong>.</li>
<li>Find the project that you want to check the checksum differences and
      select its name.</li>
<li>
<p>On the project administration page, get the values in the <strong>Storage name</strong> and <strong>Relative path</strong> fields.</p>
</li>
<li>
<p>On a <strong>Gitaly node on the primary</strong> site and a <strong>Gitaly node on the secondary</strong> site, go to the project's repository
   directory. If using Gitaly Cluster (Praefect),
   <a href="../../gitaly/praefect/troubleshooting.md#check-cluster-health">check that it is in a healthy state</a> before
   running these commands.</p>
</li>
</ol>
<p>The default path is <code>/var/opt/gitlab/git-data/repositories</code>. If repository storages
   are customized, check the directory layout on your server to be sure:</p>
<p><code>shell
   cd /var/opt/gitlab/git-data/repositories</code></p>
<ol>
<li>
<p>Run the following command on the <strong>primary</strong> site, redirecting the output to a file:</p>
<p><code>shell
  git show-ref --head | grep -E "HEAD|(refs/(heads|tags|keep-around|merge-requests|environments|notes)/)" &gt; primary-site-refs</code></p>
</li>
<li>
<p>Run the following command on the <strong>secondary</strong> site, redirecting the output to a file:</p>
<p><code>shell
  git show-ref --head | grep -E "HEAD|(refs/(heads|tags|keep-around|merge-requests|environments|notes)/)" &gt; secondary-site-refs</code></p>
</li>
<li>
<p>Copy the files from the previous steps on the same system, and do a diff between the contents:</p>
<p><code>shell
  diff primary-site-refs secondary-site-refs</code></p>
</li>
</ol>
<h2>Current limitations</h2>
<p>For more information on what replication and verification methods are supported,
see the <a href="../replication/datatypes.html">supported Geo data types</a>.</p></code></pre>
</body>
</html>
