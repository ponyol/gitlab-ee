<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Promoting a **secondary** Geo site in single-secondary configurations</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Tenant Scale
group: Geo
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Disaster Recovery (Geo)
description: Recover from a disaster, using a Geo instance.</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>Geo replicates your database, your Git repositories, and other assets.
Some <a href="../_index.md#known-issues">known issues</a> exist.</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>Multi-secondary configurations require the complete re-synchronization and re-configuration of all non-promoted secondaries and
causes downtime.</p>
<p>{{&lt; /alert &gt;}}</p>
<h2>Promoting a <strong>secondary</strong> Geo site in single-secondary configurations</h2>
<p>While you can't automatically promote a Geo replica and do a failover,
you can promote it manually if you have <code>root</code> access to the machine.</p>
<p>This process promotes a <strong>secondary</strong> Geo site to a <strong>primary</strong> site. To regain
geographic redundancy as quickly as possible, you should add a new <strong>secondary</strong> site
immediately after following these instructions.</p>
<h3>Step 1. Allow replication to finish if possible</h3>
<p>If the <strong>secondary</strong> site is still replicating data from the <strong>primary</strong> site, follow
<a href="planned_failover.html">the planned failover docs</a> as closely as possible in
order to avoid unnecessary data loss.</p>
<h3>Step 2. Permanently disable the <strong>primary</strong> site</h3>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>If the <strong>primary</strong> site goes offline, there may be data saved on the <strong>primary</strong> site
that have not been replicated to the <strong>secondary</strong> site. This data should be treated
as lost if you proceed.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>If an outage on the <strong>primary</strong> site happens, you should do everything possible to
avoid a split-brain situation where writes can occur in two different GitLab
instances, complicating recovery efforts. So to prepare for the failover, we
must disable the <strong>primary</strong> site.</p>
<ul>
<li>
<p>If you have SSH access:</p>
</li>
<li>
<p>SSH into the <strong>primary</strong> site to stop and disable GitLab:</p>
<p><code>shell
 sudo gitlab-ctl stop</code></p>
</li>
<li>
<p>Prevent GitLab from starting up again if the server unexpectedly reboots:</p>
<p><code>shell
 sudo systemctl disable gitlab-runsvdir</code></p>
</li>
<li>
<p>If you do not have SSH access to the <strong>primary</strong> site, take the machine offline and
  prevent it from rebooting by any means at your disposal.
  You might need to:</p>
</li>
<li>
<p>Reconfigure the load balancers.</p>
</li>
<li>Change DNS records (for example, point the primary DNS record to the
    <strong>secondary</strong> site to stop usage of the <strong>primary</strong> site).</li>
<li>Stop the virtual servers.</li>
<li>Block traffic through a firewall.</li>
<li>Revoke object storage permissions from the <strong>primary</strong> site.</li>
<li>Physically disconnect a machine.</li>
</ul>
<p>If you plan to <a href="#step-4-optional-updating-the-primary-domain-dns-record">update the primary domain DNS record</a>,
  you may wish to maintain a low TTL to ensure fast propagation of DNS changes.</p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>The primary site's <code>/etc/gitlab/gitlab.rb</code> file is not copied to the secondary sites automatically during this process. Make sure that you back up the primary's <code>/etc/gitlab/gitlab.rb</code> file, so that you can later restore any needed values on your secondary sites.</p>
<p>{{&lt; /alert &gt;}}</p>
<h3>Step 3. Promoting a <strong>secondary</strong> site</h3>
<p>Note the following when promoting a secondary:</p>
<ul>
<li>If the secondary site <a href="../replication/pause_resume_replication.html">has been paused</a>, the promotion
  performs a point-in-time recovery to the last known state.
  Data that was created on the primary while the secondary was paused is lost.</li>
<li>A new <strong>secondary</strong> should not be added at this time. If you want to add a new
  <strong>secondary</strong>, do this after you have completed the entire process of promoting
  the <strong>secondary</strong> to the <strong>primary</strong>.</li>
<li>If you encounter an <code>ActiveRecord::RecordInvalid: Validation failed: Name has already been taken</code>
  error message during this process, for more information, see this
  <a href="failover_troubleshooting.md#fixing-errors-during-a-failover-or-when-promoting-a-secondary-to-a-primary-site">troubleshooting advice</a>.</li>
<li>If you are using separate URLs, you should <a href="#step-4-optional-updating-the-primary-domain-dns-record">point the primary domain DNS at the newly promoted site</a>. Otherwise, runners must be registered again with the newly promoted site, and all Git remotes, bookmarks, and external integrations must be updated.</li>
<li>If you are using <a href="../secondary_proxy/_index.md#configure-location-aware-dns">location-aware DNS</a>, the runners should automatically connect to the new primary after the old primary is removed from the DNS entry.</li>
<li>If you don't expect the runners connected to the previous primary to come back, you should remove them:</li>
<li>Through the UI:<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>Select <strong>CI/CD</strong> &gt; <strong>Runners</strong> and remove them.</li>
</ol>
</li>
<li>Using the <a href="../../../api/runners.html">Runners API</a>.</li>
</ul>
<h4>Promoting a <strong>secondary</strong> site running on a single node</h4>
<ol>
<li>
<p>SSH in to your <strong>secondary</strong> site and execute:</p>
</li>
<li>
<p>To promote the secondary site to primary:</p>
<p><code>shell
 sudo gitlab-ctl geo promote</code></p>
</li>
<li>
<p>To promote the secondary site to primary <strong>without any further confirmation</strong>:</p>
<p><code>shell
 sudo gitlab-ctl geo promote --force</code></p>
</li>
<li>
<p>Verify you can connect to the newly-promoted <strong>primary</strong> site using the URL used
   previously for the <strong>secondary</strong> site.</p>
</li>
<li>If successful, the <strong>secondary</strong> site is now promoted to the <strong>primary</strong> site.</li>
</ol>
<h4>Promoting a <strong>secondary</strong> site with multiple nodes</h4>
<ol>
<li>
<p>SSH to every Sidekiq, PostgreSQL, and Gitaly node in the <strong>secondary</strong> site and run one of the following commands:</p>
</li>
<li>
<p>To promote the node on the secondary site to primary:</p>
<p><code>shell
 sudo gitlab-ctl geo promote</code></p>
</li>
<li>
<p>To promote the secondary site to primary <strong>without any further confirmation</strong>:</p>
<p><code>shell
 sudo gitlab-ctl geo promote --force</code></p>
</li>
<li>
<p>SSH into each Rails node on your <strong>secondary</strong> site and run one of the following commands:</p>
</li>
<li>
<p>To promote the secondary site to primary:</p>
<p><code>shell
 sudo gitlab-ctl geo promote</code></p>
</li>
<li>
<p>To promote the secondary site to primary <strong>without any further confirmation</strong>:</p>
<p><code>shell
 sudo gitlab-ctl geo promote --force</code></p>
</li>
<li>
<p>Verify you can connect to the newly-promoted <strong>primary</strong> site using the URL used
   previously for the <strong>secondary</strong> site.</p>
</li>
<li>If successful, the <strong>secondary</strong> site is now promoted to the <strong>primary</strong> site.</li>
</ol>
<h4>Promoting a <strong>secondary</strong> site with a Patroni standby cluster</h4>
<ol>
<li>
<p>SSH to every Sidekiq, PostgreSQL, and Gitaly node in the <strong>secondary</strong> site and run one of the following commands:</p>
</li>
<li>
<p>To promote the secondary site to primary:</p>
<p><code>shell
 sudo gitlab-ctl geo promote</code></p>
</li>
<li>
<p>To promote the secondary site to primary <strong>without any further confirmation</strong>:</p>
<p><code>shell
 sudo gitlab-ctl geo promote --force</code></p>
</li>
<li>
<p>SSH into each Rails node on your <strong>secondary</strong> site and run one of the following commands:</p>
</li>
<li>
<p>To promote the secondary site to primary:</p>
<p><code>shell
 sudo gitlab-ctl geo promote</code></p>
</li>
<li>
<p>To promote the secondary site to primary <strong>without any further confirmation</strong>:</p>
<p><code>shell
 sudo gitlab-ctl geo promote --force</code></p>
</li>
<li>
<p>Verify you can connect to the newly-promoted <strong>primary</strong> site using the URL used
   previously for the <strong>secondary</strong> site.</p>
</li>
<li>If successful, the <strong>secondary</strong> site is now promoted to the <strong>primary</strong> site.</li>
</ol>
<h4>Promoting a <strong>secondary</strong> site with an external PostgreSQL database</h4>
<p>The <code>gitlab-ctl geo promote</code> command can be used in conjunction with an external PostgreSQL database.
In this case, you must first manually promote the replica database associated
with the <strong>secondary</strong> site:</p>
<ol>
<li>Promote the replica database associated with the <strong>secondary</strong> site. This
   sets the database to read-write. The instructions vary depending on where your database is hosted:</li>
<li><a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_ReadRepl.html#USER_ReadRepl.Promote">Amazon RDS</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/postgresql/single-server/how-to-read-replicas-portal#stop-replication">Azure PostgreSQL</a></li>
<li><a href="https://cloud.google.com/sql/docs/mysql/replication/manage-replicas#promote-replica">Google Cloud SQL</a></li>
<li>
<p>For other external PostgreSQL databases, save the following script in your
     secondary site, for example <code>/tmp/geo_promote.sh</code>, and modify the connection
     parameters to match your environment. Then, execute it to promote the replica:</p>
<p>```shell
 #!/bin/bash</p>
<p>PG_SUPERUSER=postgres</p>
<p># The path to your pg_ctl binary. You may need to adjust this path to match
 # your PostgreSQL installation
 PG_CTL_BINARY=/usr/lib/postgresql/16/bin/pg_ctl</p>
<p># The path to your PostgreSQL data directory. You may need to adjust this
 # path to match your PostgreSQL installation. You can also run
 # <code>SHOW data_directory;</code> from PostgreSQL to find your data directory
 PG_DATA_DIRECTORY=/etc/postgresql/16/main</p>
<p># Promote the PostgreSQL database and allow read/write operations
 sudo -u $PG_SUPERUSER $PG_CTL_BINARY -D $PG_DATA_DIRECTORY promote
 ```</p>
</li>
<li>
<p>SSH to every Sidekiq, PostgreSQL, and Gitaly node in the <strong>secondary</strong> site and run one of the following commands:</p>
</li>
<li>
<p>To promote the secondary site to primary:</p>
<p><code>shell
 sudo gitlab-ctl geo promote</code></p>
</li>
<li>
<p>To promote the secondary site to primary <strong>without any further confirmation</strong>:</p>
<p><code>shell
 sudo gitlab-ctl geo promote --force</code></p>
</li>
<li>
<p>SSH into each Rails node on your <strong>secondary</strong> site and run one of the following commands:</p>
</li>
<li>
<p>To promote the secondary site to primary:</p>
<p><code>shell
 sudo gitlab-ctl geo promote</code></p>
</li>
<li>
<p>To promote the secondary site to primary <strong>without any further confirmation</strong>:</p>
<p><code>shell
 sudo gitlab-ctl geo promote --force</code></p>
</li>
<li>
<p>Verify you can connect to the newly-promoted <strong>primary</strong> site using the URL used
   previously for the <strong>secondary</strong> site.</p>
</li>
<li>If successful, the <strong>secondary</strong> site is now promoted to the <strong>primary</strong> site.</li>
</ol>
<h3>Step 4. (Optional) Updating the primary domain DNS record</h3>
<p>Update DNS records for the primary domain to point to the <strong>secondary</strong> site.
This removes the need to update all references to the primary domain, for example
changing Git remotes and API URLs.</p>
<ol>
<li>SSH into the <strong>secondary</strong> site and login as root:</li>
</ol>
<p><code>shell
   sudo -i</code></p>
<ol>
<li>Update the primary domain's DNS record. After updating the primary domain's
   DNS records to point to the <strong>secondary</strong> site, edit <code>/etc/gitlab/gitlab.rb</code> on the
   <strong>secondary</strong> site to reflect the new URL:</li>
</ol>
<p><code>ruby
   # Change the existing external_url configuration
   external_url 'https://&lt;new_external_url&gt;'</code></p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>Changing <code>external_url</code> does not prevent access through the old secondary URL, as
   long as the secondary DNS records are still intact.</p>
<p>{{&lt; /alert &gt;}}</p>
<ol>
<li>
<p>Update the <strong>secondary</strong>'s SSL certificate:</p>
</li>
<li>
<p>If you use the <a href="https://docs.gitlab.com/omnibus/settings/ssl/#enable-the-lets-encrypt-integration">Let's Encrypt integration</a>,
     the certificate updates automatically.</p>
</li>
<li>
<p>If you had <a href="https://docs.gitlab.com/omnibus/settings/ssl/#configure-https-manually">manually set up</a>,
     the <strong>secondary</strong>'s certificate, copy the certificate from the <strong>primary</strong> to the <strong>secondary</strong>.
     If you don't have access to the <strong>primary</strong>, issue a new certificate and make sure it contains
     both the <strong>primary</strong> and <strong>secondary</strong> URLs in the subject alternative names. You can check with:</p>
<p><code>shell
 /opt/gitlab/embedded/bin/openssl x509 -noout -dates -subject -issuer \
     -nameopt multiline -ext subjectAltName -in /etc/gitlab/ssl/new-gitlab.new-example.com.crt</code></p>
</li>
<li>
<p>Reconfigure the <strong>secondary</strong> site for the change to take effect:</p>
</li>
</ol>
<p><code>shell
   gitlab-ctl reconfigure</code></p>
<ol>
<li>Execute the command below to update the newly promoted <strong>primary</strong> site URL:</li>
</ol>
<p><code>shell
   gitlab-rake geo:update_primary_node_url</code></p>
<p>This command uses the changed <code>external_url</code> configuration defined
   in <code>/etc/gitlab/gitlab.rb</code>.</p>
<ol>
<li>Verify you can connect to the newly promoted <strong>primary</strong> using its URL.
   If you updated the DNS records for the primary domain, these changes may
   not have yet propagated depending on the previous DNS records TTL.</li>
</ol>
<h3>Step 5. (Optional) Add <strong>secondary</strong> Geo site to a promoted <strong>primary</strong> site</h3>
<p>Promoting a <strong>secondary</strong> site to <strong>primary</strong> site using the previous process does not enable
Geo on the new <strong>primary</strong> site.</p>
<p>To bring a new <strong>secondary</strong> site online, follow the <a href="../setup/_index.html">Geo setup instructions</a>.</p>
<h3>Step 6. Removing the former secondary's tracking database</h3>
<p>Every <strong>secondary</strong> has a special tracking database that is used to save the status of the synchronization of all the items from the <strong>primary</strong>.
Because the <strong>secondary</strong> is already promoted, that data in the tracking database is no longer required.</p>
<p>You can remove the data with the following command:</p>
<pre><code class="language-shell">sudo rm -rf /var/opt/gitlab/geo-postgresql
</code></pre>
<p>If you have any <code>geo_secondary[]</code> configuration options enabled in your <code>gitlab.rb</code>
file, comment them out or remove them, and then <a href="../../restart_gitlab.md#reconfigure-a-linux-package-installation">reconfigure GitLab</a>
for the changes to take effect.</p>
<p>At this point, your promoted site is a normal GitLab site without Geo configured. Optionally, you can <a href="bring_primary_back.md#configure-the-former-primary-site-to-be-a-secondary-site">bring the old site back as a secondary</a>.</p>
<h2>Promoting secondary Geo replica in multi-secondary configurations</h2>
<p>If you have more than one <strong>secondary</strong> site and you need to promote one of them, we suggest you follow
<a href="#promoting-a-secondary-geo-site-in-single-secondary-configurations">Promoting a <strong>secondary</strong> Geo site in single-secondary configurations</a>
and after that you also need two extra steps.</p>
<h3>Step 1. Prepare the new <strong>primary</strong> site to serve one or more <strong>secondary</strong> sites</h3>
<ol>
<li>SSH into the new <strong>primary</strong> site and login as root:</li>
</ol>
<p><code>shell
   sudo -i</code></p>
<ol>
<li>Edit <code>/etc/gitlab/gitlab.rb</code>:</li>
</ol>
<p>```ruby
   ## Enable a Geo Primary role (if you haven't yet)
   roles ['geo_primary_role']</p>
<p>##
   # Allow PostgreSQL client authentication from the primary and secondary IPs. These IPs may be
   # public or VPC addresses in CIDR format, for example ['198.51.100.1/32', '198.51.100.2/32']
   ##
   postgresql['md5_auth_cidr_addresses'] = ['<primary_site_ip>/32', '<secondary_site_ip>/32']</p>
<p># Every secondary site needs to have its own slot so specify the number of secondary sites you're going to have
   # postgresql['max_replication_slots'] = 1 # Set this to be the number of Geo secondary nodes if you have more than one</p>
<p>##
   ## Disable automatic database migrations temporarily
   ## (until PostgreSQL is restarted and listening on the private address).
   ##
   gitlab_rails['auto_migrate'] = false
   ```</p>
<p>(For more details about these settings you can read <a href="../setup/database.md#step-1-configure-the-primary-site">Configure the primary server</a>)</p>
<ol>
<li>Save the file and reconfigure GitLab for the database listen changes and
   the replication slot changes to be applied:</li>
</ol>
<p><code>shell
   gitlab-ctl reconfigure</code></p>
<p>Restart PostgreSQL for its changes to take effect:</p>
<p><code>shell
   gitlab-ctl restart postgresql</code></p>
<ol>
<li>Re-enable migrations now that PostgreSQL is restarted and listening on the
   private address.</li>
</ol>
<p>Edit <code>/etc/gitlab/gitlab.rb</code> and <strong>change</strong> the configuration to <code>true</code>:</p>
<p><code>ruby
   gitlab_rails['auto_migrate'] = true</code></p>
<p>Save the file and reconfigure GitLab:</p>
<p><code>shell
   gitlab-ctl reconfigure</code></p>
<h3>Step 2. Initiate the replication process</h3>
<p>Now we need to make each <strong>secondary</strong> site listen to changes on the new <strong>primary</strong> site. To do that you need
to <a href="../setup/database.md#step-3-initiate-the-replication-process">initiate the replication process</a> again but this time
for another <strong>primary</strong> site. All the old replication settings are overwritten.</p>
<p>Existing secondary sites will all have populated databases so you may see a message like this:</p>
<pre><code class="language-shell">Found data inside the gitlabhq_production database! If you are sure you are in the secondary server, override with --force
</code></pre>
<p>After you have confirmed that you are on the appropriate secondary site, initiate the replication with <code>--force</code>.</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>Using <code>--force</code> causes <strong>all existing data in the database on that secondary server to be deleted</strong>.</p>
<p>{{&lt; /alert &gt;}}</p>
<h2>Promoting a secondary Geo cluster in the GitLab Helm chart</h2>
<p>When updating a cloud-native Geo deployment, the process for updating any node that is external to the secondary Kubernetes cluster does not differ from the non cloud-native approach. As such, you can always defer to <a href="#promoting-a-secondary-geo-site-in-single-secondary-configurations">Promoting a secondary Geo site in single-secondary configurations</a> for more information.</p>
<p>The following sections assume you are using the <code>gitlab</code> namespace. If you used a different namespace when setting up your cluster, you should also replace <code>--namespace gitlab</code> with your namespace.</p>
<h3>Step 1. Permanently disable the <strong>primary</strong> cluster</h3>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>If the <strong>primary</strong> site goes offline, there may be data saved on the <strong>primary</strong> site
that has not been replicated to the <strong>secondary</strong> site. This data should be treated
as lost if you proceed.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>If an outage on the <strong>primary</strong> site happens, you should do everything possible to
avoid a split-brain situation where writes can occur in two different GitLab
instances, complicating recovery efforts. So to prepare for the failover, you
must disable the <strong>primary</strong> site:</p>
<ul>
<li>If you have access to the <strong>primary</strong> Kubernetes cluster, connect to it and disable the GitLab <code>webservice</code> and <code>Sidekiq</code> pods:</li>
</ul>
<p><code>shell
  kubectl --namespace gitlab scale deploy gitlab-geo-webservice-default --replicas=0
  kubectl --namespace gitlab scale deploy gitlab-geo-sidekiq-all-in-1-v1 --replicas=0</code></p>
<ul>
<li>
<p>If you do not have access to the <strong>primary</strong> Kubernetes cluster, take the cluster offline and
  prevent it from coming back online by any means at your disposal.
  You might need to:</p>
</li>
<li>
<p>Reconfigure the load balancers.</p>
</li>
<li>Change DNS records (for example, point the primary DNS record to the
    <strong>secondary</strong> site to stop usage of the <strong>primary</strong> site).</li>
<li>Stop the virtual servers.</li>
<li>Block traffic through a firewall.</li>
<li>Revoke object storage permissions from the <strong>primary</strong> site.</li>
<li>Physically disconnect a machine.</li>
</ul>
<h3>Step 2. Promote all <strong>secondary</strong> site nodes external to the cluster</h3>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>If the secondary site <a href="../_index.md#pausing-and-resuming-replication">has been paused</a>, this performs
a point-in-time recovery to the last known state.
Data that was created on the primary while the secondary was paused is lost.</p>
<p>{{&lt; /alert &gt;}}</p>
<ol>
<li>
<p>For each node (such as PostgreSQL or Gitaly) outside of the <strong>secondary</strong> Kubernetes cluster using the Linux
   package, SSH into the node and run one of the following commands:</p>
</li>
<li>
<p>To promote the <strong>secondary</strong> site node external to the Kubernetes cluster to primary:</p>
<p><code>shell
 sudo gitlab-ctl geo promote</code></p>
</li>
<li>
<p>To promote the <strong>secondary</strong> site node external to the Kubernetes cluster to primary <strong>without any further confirmation</strong>:</p>
<p><code>shell
 sudo gitlab-ctl geo promote --force</code></p>
</li>
<li>
<p>Find the <code>toolbox</code> pod:</p>
</li>
</ol>
<p><code>shell
   kubectl --namespace gitlab get pods -lapp=toolbox</code></p>
<ol>
<li>Promote the secondary:</li>
</ol>
<p><code>shell
   kubectl --namespace gitlab exec -ti gitlab-geo-toolbox-XXX -- gitlab-rake geo:set_secondary_as_primary</code></p>
<p>Environment variables can be provided to modify the behavior of the task. The
   available variables are:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Default value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ENABLE_SILENT_MODE</code></td>
<td><code>false</code></td>
<td>If <code>true</code>, enables <a href="../../silent_mode/_index.html">Silent Mode</a> before promotion (GitLab 16.4 and later)</td>
</tr>
</tbody>
</table>
<h3>Step 3. Promote the <strong>secondary</strong> cluster</h3>
<ol>
<li>Update the existing cluster configuration.</li>
</ol>
<p>You can retrieve the existing configuration with Helm:</p>
<p><code>shell
   helm --namespace gitlab get values gitlab-geo &gt; gitlab.yaml</code></p>
<p>The existing configuration contains a section for Geo that should resemble:</p>
<p><code>yaml
   geo:
      enabled: true
      role: secondary
      nodeName: secondary.example.com
      psql:
         host: geo-2.db.example.com
         port: 5431
         password:
            secret: geo
            key: geo-postgresql-password</code></p>
<p>To promote the <strong>secondary</strong> cluster to a <strong>primary</strong> cluster, update <code>role: secondary</code> to <code>role: primary</code>.</p>
<p>If the cluster remains as a primary site, you can remove the entire <code>psql</code> section; it refers to the tracking database and is ignored while the cluster is acting as a primary site.</p>
<p>Update the cluster with the new configuration:</p>
<p><code>shell
   helm upgrade --install --version &lt;current Chart version&gt; gitlab-geo gitlab/gitlab --namespace gitlab -f gitlab.yaml</code></p>
<ol>
<li>
<p>Verify you can connect to the newly promoted primary using the URL used previously for the secondary.</p>
</li>
<li>
<p>Success! The secondary has now been promoted to primary.</p>
</li>
</ol>
<h2>Troubleshooting</h2>
<p>This section was moved to <a href="failover_troubleshooting.md#fixing-errors-during-a-failover-or-when-promoting-a-secondary-to-a-primary-site">another location</a>.</p></code></pre>
</body>
</html>
