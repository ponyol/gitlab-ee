<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Add user as a developer to all projects</title>
    <link rel="stylesheet" href="/../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: GitLab Delivery
group: Operate
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: User management Rake tasks</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Free, Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>GitLab provides Rake tasks for managing users. Administrators can also use the <strong>Admin</strong> area to
<a href="../admin_area.md#administering-users">manage users</a>.</p>
<h2>Add user as a developer to all projects</h2>
<p>To add a user as a developer to all projects, run:</p>
<pre><code class="language-shell"># omnibus-gitlab
sudo gitlab-rake gitlab:import:user_to_projects[username@domain.tld]

# installation from source
bundle exec rake gitlab:import:user_to_projects[username@domain.tld] RAILS_ENV=production
</code></pre>
<h2>Add all users to all projects</h2>
<p>To add all users to all projects, run:</p>
<pre><code class="language-shell"># omnibus-gitlab
sudo gitlab-rake gitlab:import:all_users_to_all_projects

# installation from source
bundle exec rake gitlab:import:all_users_to_all_projects RAILS_ENV=production
</code></pre>
<p>Administrators are added as maintainers and all other users are added as developers.</p>
<h2>Add user as a developer to all groups</h2>
<p>To add a user as a developer to all groups, run:</p>
<pre><code class="language-shell"># omnibus-gitlab
sudo gitlab-rake gitlab:import:user_to_groups[username@domain.tld]

# installation from source
bundle exec rake gitlab:import:user_to_groups[username@domain.tld] RAILS_ENV=production
</code></pre>
<h2>Add all users to all groups</h2>
<p>To add all users to all groups, run:</p>
<pre><code class="language-shell"># omnibus-gitlab
sudo gitlab-rake gitlab:import:all_users_to_all_groups

# installation from source
bundle exec rake gitlab:import:all_users_to_all_groups RAILS_ENV=production
</code></pre>
<p>Administrators are added as owners so they can add additional users to the group.</p>
<h2>Update all users in a given group to <code>project_limit:0</code> and <code>can_create_group: false</code></h2>
<p>To update all users in given group to <code>project_limit: 0</code> and <code>can_create_group: false</code>, run:</p>
<pre><code class="language-shell"># omnibus-gitlab
sudo gitlab-rake gitlab:user_management:disable_project_and_group_creation\[:group_id\]

# installation from source
bundle exec rake gitlab:user_management:disable_project_and_group_creation\[:group_id\] RAILS_ENV=production
</code></pre>
<p>It updates all users in the given group, its subgroups and projects in this group namespace, with the noted limits.</p>
<h2>Control the number of billable users</h2>
<p>Enable this setting to keep new users blocked until they have been cleared by the administrator.
Defaults to <code>false</code>:</p>
<pre><code class="language-plaintext">block_auto_created_users: false
</code></pre>
<h2>Disable two-factor authentication for all users</h2>
<p>This task disables two-factor authentication (2FA) for all users that have it enabled. This can be
useful if the GitLab <code>config/secrets.yml</code> file has been lost and users are unable
to sign in, for example.</p>
<p>To disable two-factor authentication for all users, run:</p>
<pre><code class="language-shell"># omnibus-gitlab
sudo gitlab-rake gitlab:two_factor:disable_for_all_users

# installation from source
bundle exec rake gitlab:two_factor:disable_for_all_users RAILS_ENV=production
</code></pre>
<h2>Rotate two-factor authentication encryption key</h2>
<p>GitLab stores the secret data required for two-factor authentication (2FA) in an encrypted
database column. The encryption key for this data is known as <code>otp_key_base</code>, and is
stored in <code>config/secrets.yml</code>.</p>
<p>If that file is leaked, but the individual 2FA secrets have not, it's possible
to re-encrypt those secrets with a new encryption key. This allows you to change
the leaked key without forcing all users to change their 2FA details.</p>
<p>To rotate the two-factor authentication encryption key:</p>
<ol>
<li>Look up the old key in the <code>config/secrets.yml</code> file, but <strong>make sure you're working
   with the production section</strong>. The line you're interested in looks like this:</li>
</ol>
<p><code>yaml
   production:
     otp_key_base: fffffffffffffffffffffffffffffffffffffffffffffff</code></p>
<ol>
<li>Generate a new secret:</li>
</ol>
<p>```shell
   # omnibus-gitlab
   sudo gitlab-rake secret</p>
<p># installation from source
   bundle exec rake secret RAILS_ENV=production
   ```</p>
<ol>
<li>Stop the GitLab server, back up the existing secrets file, and update the database:</li>
</ol>
<p>```shell
   # omnibus-gitlab
   sudo gitlab-ctl stop
   sudo cp config/secrets.yml config/secrets.yml.bak
   sudo gitlab-rake gitlab:two_factor:rotate_key:apply filename=backup.csv old_key=<old key> new_key=<new key></p>
<p># installation from source
   sudo /etc/init.d/gitlab stop
   cp config/secrets.yml config/secrets.yml.bak
   bundle exec rake gitlab:two_factor:rotate_key:apply filename=backup.csv old_key=<old key> new_key=<new key> RAILS_ENV=production
   ```</p>
<p>The <code>&lt;old key&gt;</code> value can be read from <code>config/secrets.yml</code> (<code>&lt;new key&gt;</code> was
   generated earlier). The <strong>encrypted</strong> values for the user 2FA secrets are
   written to the specified <code>filename</code>. You can use this to rollback in case of
   error.</p>
<ol>
<li>Change <code>config/secrets.yml</code> to set <code>otp_key_base</code> to <code>&lt;new key&gt;</code> and restart. Again, make sure
   you're operating in the <strong>production</strong> section.</li>
</ol>
<p>```shell
   # omnibus-gitlab
   sudo gitlab-ctl start</p>
<p># installation from source
   sudo /etc/init.d/gitlab start
   ```</p>
<p>If there are any problems (perhaps using the wrong value for <code>old_key</code>), you can
restore your backup of <code>config/secrets.yml</code> and rollback the changes:</p>
<pre><code class="language-shell"># omnibus-gitlab
sudo gitlab-ctl stop
sudo gitlab-rake gitlab:two_factor:rotate_key:rollback filename=backup.csv
sudo cp config/secrets.yml.bak config/secrets.yml
sudo gitlab-ctl start

# installation from source
sudo /etc/init.d/gitlab start
bundle exec rake gitlab:two_factor:rotate_key:rollback filename=backup.csv RAILS_ENV=production
cp config/secrets.yml.bak config/secrets.yml
sudo /etc/init.d/gitlab start

</code></pre>
<h2>Bulk assign users to GitLab Duo</h2>
<p>You can assign users in bulk to GitLab Duo using a CSV file with the names of the users.
The CSV file must have a header named <code>username</code>, followed by the usernames on each subsequent row.</p>
<pre><code class="language-plaintext">username
user1
user2
user3
user4
</code></pre>
<h3>GitLab Duo Pro</h3>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/142189">Introduced</a> in GitLab 16.9.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>To perform bulk user assignment for GitLab Duo Pro, you can use the following Rake task:</p>
<pre><code class="language-shell">bundle exec rake duo_pro:bulk_user_assignment DUO_PRO_BULK_USER_FILE_PATH=path/to/your/file.csv
</code></pre>
<p>If you prefer to use square brackets in the file path, you can escape them or use double quotes:</p>
<pre><code class="language-shell">bundle exec rake duo_pro:bulk_user_assignment\['path/to/your/file.csv'\]
# or
bundle exec rake &quot;duo_pro:bulk_user_assignment[path/to/your/file.csv]&quot;
</code></pre>
<h3>GitLab Duo Pro and Enterprise</h3>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab.com, GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/187230">Introduced</a> in GitLab 18.0.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<h4>GitLab Self-Managed</h4>
<p>This Rake task bulk assigns GitLab Duo Pro or Enterprise seats at the instance level to a list of users from a
CSV file, based on the available purchased add-on.</p>
<p>To perform bulk user assignment for a GitLab Self-Managed instance:</p>
<pre><code class="language-shell">bundle exec rake gitlab_subscriptions:duo:bulk_user_assignment DUO_BULK_USER_FILE_PATH=path/to/your/file.csv
</code></pre>
<p>If you prefer to use square brackets in the file path, you can escape them or use double quotes:</p>
<pre><code class="language-shell">bundle exec rake gitlab_subscriptions:duo:bulk_user_assignment\['path/to/your/file.csv'\]
# or
bundle exec rake &quot;gitlab_subscriptions:duo:bulk_user_assignment[path/to/your/file.csv]&quot;
</code></pre>
<h4>GitLab.com</h4>
<p>GitLab.com administrators can also use this Rake task to bulk assign GitLab Duo Pro or Enterprise seats for GitLab.com
groups, based on the available purchased add-on for that group.</p>
<p>To perform bulk user assignment for a GitLab.com group:</p>
<pre><code class="language-shell">bundle exec rake gitlab_subscriptions:duo:bulk_user_assignment DUO_BULK_USER_FILE_PATH=path/to/your/file.csv NAMESPACE_ID=&lt;namespace_id&gt;
</code></pre>
<p>If you prefer to use square brackets in the file path, you can escape them or use double quotes:</p>
<pre><code class="language-shell">bundle exec rake gitlab_subscriptions:duo:bulk_user_assignment\['path/to/your/file.csv','&lt;namespace_id&gt;'\]
# or
bundle exec rake &quot;gitlab_subscriptions:duo:bulk_user_assignment[path/to/your/file.csv,&lt;namespace_id&gt;]&quot;
</code></pre>
<h2>Troubleshooting</h2>
<h3>Errors during bulk user assignment</h3>
<p>When using the Rake task for bulk user assignment, you might encounter the following errors:</p>
<ul>
<li><code>User is not found</code>: The specified user was not found. Please ensure the provided username matches an existing user.</li>
<li><code>ERROR_NO_SEATS_AVAILABLE</code>: No more seats are available for user assignment. Please see how to <a href="../../subscriptions/subscription-add-ons.md#view-assigned-gitlab-duo-users">view assigned GitLab Duo users</a> to check current seat assignments.</li>
<li><code>ERROR_INVALID_USER_MEMBERSHIP</code>: The user is not eligible for assignment due to being inactive, a bot, or a ghost. Please ensure the user is active and, if on GitLab.com, a member of the provided namespace.</li>
</ul>
<h2>Related topics</h2>
<ul>
<li><a href="../../security/reset_user_password.md#use-a-rake-task">Reset user passwords</a></li>
</ul></code></pre>
</body>
</html>
