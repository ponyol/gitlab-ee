<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Gather GitLab and system information</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: GitLab Delivery
group: Operate
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Maintenance Rake tasks</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Free, Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>GitLab provides Rake tasks for general maintenance.</p>
<h2>Gather GitLab and system information</h2>
<p>This command gathers information about your GitLab installation and the system it runs on.
These may be useful when asking for help or reporting issues. In a multi-node environment, run this command on nodes running GitLab Rails to avoid PostgreSQL socket errors.</p>
<ul>
<li>Linux package installations:</li>
</ul>
<p><code>shell
  sudo gitlab-rake gitlab:env:info</code></p>
<ul>
<li>Self-compiled installations:</li>
</ul>
<p><code>shell
  bundle exec rake gitlab:env:info RAILS_ENV=production</code></p>
<p>Example output:</p>
<pre><code class="language-plaintext">System information
System:         Ubuntu 20.04
Proxy:          no
Current User:   git
Using RVM:      no
Ruby Version:   2.7.6p219
Gem Version:    3.1.6
Bundler Version:2.3.15
Rake Version:   13.0.6
Redis Version:  6.2.7
Sidekiq Version:6.4.2
Go Version:     unknown

GitLab information
Version:        15.5.5-ee
Revision:       5f5109f142d
Directory:      /opt/gitlab/embedded/service/gitlab-rails
DB Adapter:     PostgreSQL
DB Version:     13.8
URL:            https://app.gitaly.gcp.gitlabsandbox.net
HTTP Clone URL: https://app.gitaly.gcp.gitlabsandbox.net/some-group/some-project.git
SSH Clone URL:  git@app.gitaly.gcp.gitlabsandbox.net:some-group/some-project.git
Elasticsearch:  no
Geo:            no
Using LDAP:     no
Using Omniauth: yes
Omniauth Providers:

GitLab Shell
Version:        14.12.0
Repository storage paths:
- default:      /var/opt/gitlab/git-data/repositories
- gitaly:       /var/opt/gitlab/git-data/repositories
GitLab Shell path:              /opt/gitlab/embedded/service/gitlab-shell


Gitaly
- default Address:      unix:/var/opt/gitlab/gitaly/gitaly.socket
- default Version:      15.5.5
- default Git Version:  2.37.1.gl1
- gitaly Address:       tcp://10.128.20.6:2305
- gitaly Version:       15.5.5
- gitaly Git Version:   2.37.1.gl1
</code></pre>
<h2>Show GitLab license information</h2>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>This command shows information about your <a href="../license.html">GitLab license</a> and
how many seats are used. It is only available on GitLab Enterprise
installations: a license cannot be installed into GitLab Community Edition.</p>
<p>These may be useful when raising tickets with Support, or for programmatically
checking your license parameters.</p>
<ul>
<li>Linux package installations:</li>
</ul>
<p><code>shell
  sudo gitlab-rake gitlab:license:info</code></p>
<ul>
<li>Self-compiled installations:</li>
</ul>
<p><code>shell
  bundle exec rake gitlab:license:info RAILS_ENV=production</code></p>
<p>Example output:</p>
<pre><code class="language-plaintext">Today's Date: 2020-02-29
Current User Count: 30
Max Historical Count: 30
Max Users in License: 40
License valid from: 2019-11-29 to 2020-11-28
Email associated with license: user@example.com
</code></pre>
<h2>Check GitLab configuration</h2>
<p>The <code>gitlab:check</code> Rake task runs the following Rake tasks:</p>
<ul>
<li><code>gitlab:gitlab_shell:check</code></li>
<li><code>gitlab:gitaly:check</code></li>
<li><code>gitlab:sidekiq:check</code></li>
<li><code>gitlab:incoming_email:check</code></li>
<li><code>gitlab:ldap:check</code></li>
<li><code>gitlab:app:check</code></li>
<li><code>gitlab:geo:check</code> (only if you're running <a href="../geo/replication/troubleshooting/common.md#health-check-rake-task">Geo</a>)</li>
</ul>
<p>It checks that each component was set up according to the installation guide and suggest fixes
for issues found. This command must be run from your application server and doesn't work correctly on
component servers like <a href="../gitaly/configure_gitaly.md#run-gitaly-on-its-own-server">Gitaly</a>.</p>
<p>You may also have a look at our troubleshooting guides for:</p>
<ul>
<li><a href="../troubleshooting/_index.html">GitLab</a>.</li>
<li><a href="https://docs.gitlab.com/omnibus/#troubleshooting">Linux package installations</a>.</li>
</ul>
<p>Additionally you should also <a href="check.md#verify-database-values-can-be-decrypted-using-the-current-secrets">verify database values can be decrypted using the current secrets</a>.</p>
<p>To run <code>gitlab:check</code>, run:</p>
<ul>
<li>Linux package installations:</li>
</ul>
<p><code>shell
  sudo gitlab-rake gitlab:check</code></p>
<ul>
<li>Self-compiled installations:</li>
</ul>
<p><code>shell
  bundle exec rake gitlab:check RAILS_ENV=production</code></p>
<ul>
<li>Kubernetes installations:</li>
</ul>
<p><code>shell
  kubectl exec -it &lt;toolbox-pod-name&gt; -- sudo gitlab-rake gitlab:check</code></p>
<p>{{&lt; alert type="note" &gt;}}
  Due to the specific architecture of Helm-based GitLab installations, the output may contain
  false negatives for connectivity verification to <code>gitlab-shell</code>, Sidekiq, and <code>systemd</code>-related files.
  These reported failures are expected and do not indicate actual issues, disregard them when reviewing diagnostic results.
  {{&lt; /alert &gt;}}</p>
<p>Use <code>SANITIZE=true</code> for <code>gitlab:check</code> if you want to omit project names from the output.</p>
<p>Example output:</p>
<pre><code class="language-plaintext">Checking Environment ...

Git configured for git user? ... yes
Has python2? ... yes
python2 is supported version? ... yes

Checking Environment ... Finished

Checking GitLab Shell ...

GitLab Shell version? ... OK (1.2.0)
Repo base directory exists? ... yes
Repo base directory is a symlink? ... no
Repo base owned by git:git? ... yes
Repo base access is drwxrws---? ... yes
post-receive hook up-to-date? ... yes
post-receive hooks in repos are links: ... yes

Checking GitLab Shell ... Finished

Checking Sidekiq ...

Running? ... yes

Checking Sidekiq ... Finished

Checking GitLab App...

Database config exists? ... yes
Database is SQLite ... no
All migrations up? ... yes
GitLab config exists? ... yes
GitLab config up to date? ... no
Cable config exists? ... yes
Resque config exists? ... yes
Log directory writable? ... yes
Tmp directory writable? ... yes
Init script exists? ... yes
Init script up-to-date? ... yes
Redis version &gt;= 2.0.0? ... yes

Checking GitLab ... Finished
</code></pre>
<h2>Rebuild <code>authorized_keys</code> file</h2>
<p>In some cases it is necessary to rebuild the <code>authorized_keys</code> file,
for example, if after an upgrade you receive <code>Permission denied (publickey)</code> when pushing <a href="../../user/ssh.html">via SSH</a>
and find <code>404 Key Not Found</code> errors in <a href="../logs/_index.md#gitlab-shelllog">the <code>gitlab-shell.log</code> file</a>.
To rebuild <code>authorized_keys</code>, run:</p>
<ul>
<li>Linux package installations:</li>
</ul>
<p><code>shell
  sudo gitlab-rake gitlab:shell:setup</code></p>
<ul>
<li>Self-compiled installations:</li>
</ul>
<p><code>shell
  cd /home/git/gitlab
  sudo -u git -H bundle exec rake gitlab:shell:setup RAILS_ENV=production</code></p>
<p>Example output:</p>
<pre><code class="language-plaintext">This will rebuild an authorized_keys file.
You will lose any data stored in authorized_keys file.
Do you want to continue (yes/no)? yes
</code></pre>
<h2>Clear Redis cache</h2>
<p>If for some reason the dashboard displays the wrong information, you might want to
clear Redis' cache. To do this, run:</p>
<ul>
<li>Linux package installations:</li>
</ul>
<p><code>shell
  sudo gitlab-rake cache:clear</code></p>
<ul>
<li>Self-compiled installations:</li>
</ul>
<p><code>shell
  cd /home/git/gitlab
  sudo -u git -H bundle exec rake cache:clear RAILS_ENV=production</code></p>
<h2>Precompile the assets</h2>
<p>Sometimes during version upgrades you might end up with some wrong CSS or
missing some icons. In that case, try to precompile the assets again.</p>
<p>This Rake task only applies to self-compiled installations. <a href="../../update/package/package_troubleshooting.md#missing-asset-files">Read more</a>
about troubleshooting this problem when running the Linux package.
The guidance for Linux package might be applicable for Kubernetes and Docker
deployments of GitLab, though in general, container-based installations
don't have issues with missing assets.</p>
<ul>
<li>Self-compiled installations:</li>
</ul>
<p><code>shell
  cd /home/git/gitlab
  sudo -u git -H bundle exec rake gitlab:assets:compile RAILS_ENV=production</code></p>
<p>For Linux package installations, the unoptimized assets (JavaScript, CSS) are frozen at
the release of upstream GitLab. The Linux package installation includes optimized versions
of those assets. Unless you are modifying the JavaScript / CSS code on your
production machine after installing the package, there should be no reason to redo
<code>rake gitlab:assets:compile</code> on the production machine. If you suspect that assets
have been corrupted, you should reinstall the Linux package.</p>
<h2>Check TCP connectivity to a remote site</h2>
<p>Sometimes you need to know if your GitLab installation can connect to a TCP
service on another machine (for example a PostgreSQL or web server)
to troubleshoot proxy issues.
A Rake task is included to help you with this.</p>
<ul>
<li>Linux package installations:</li>
</ul>
<p><code>shell
  sudo gitlab-rake gitlab:tcp_check[example.com,80]</code></p>
<ul>
<li>Self-compiled installations:</li>
</ul>
<p><code>shell
  cd /home/git/gitlab
  sudo -u git -H bundle exec rake gitlab:tcp_check[example.com,80] RAILS_ENV=production</code></p>
<h2>Clear exclusive lease (DANGER)</h2>
<p>GitLab uses a shared lock mechanism: <code>ExclusiveLease</code> to prevent simultaneous operations
in a shared resource. An example is running periodic garbage collection on repositories.</p>
<p>In very specific situations, an operation locked by an Exclusive Lease can fail without
releasing the lock. If you can't wait for it to expire, you can run this task to manually
clear it.</p>
<p>To clear all exclusive leases:</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>Don't run it while GitLab or Sidekiq is running</p>
<p>{{&lt; /alert &gt;}}</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:exclusive_lease:clear
</code></pre>
<p>To specify a lease <code>type</code> or lease <code>type + id</code>, specify a scope:</p>
<pre><code class="language-shell"># to clear all leases for repository garbage collection:
sudo gitlab-rake gitlab:exclusive_lease:clear[project_housekeeping:*]

# to clear a lease for repository garbage collection in a specific project: (id=4)
sudo gitlab-rake gitlab:exclusive_lease:clear[project_housekeeping:4]
</code></pre>
<h2>Display status of database migrations</h2>
<p>See the <a href="../../update/background_migrations.html">background migrations documentation</a>
for how to check that migrations are complete when upgrading GitLab.</p>
<p>To check the status of specific migrations, you can use the following Rake task:</p>
<pre><code class="language-shell">sudo gitlab-rake db:migrate:status
</code></pre>
<p>To check the <a href="../geo/setup/external_database.md#configure-the-tracking-database">tracking database on a Geo secondary site</a>, you can use the following Rake task:</p>
<pre><code class="language-shell">sudo gitlab-rake db:migrate:status:geo
</code></pre>
<p>This outputs a table with a <code>Status</code> of <code>up</code> or <code>down</code> for
each migration. Example:</p>
<pre><code class="language-shell">database: gitlabhq_production

 Status   Migration ID    Type     Milestone    Name
--------------------------------------------------
   up     20240701074848  regular  17.2         AddGroupIdToPackagesDebianGroupComponents
   up     20240701153843  regular  17.2         AddWorkItemsDatesSourcesSyncToIssuesTrigger
   up     20240702072515  regular  17.2         AddGroupIdToPackagesDebianGroupArchitectures
   up     20240702133021  regular  17.2         AddWorkspaceTerminationTimeoutsToRemoteDevelopmentAgentConfigs
   up     20240604064938  post     17.2         FinalizeBackfillPartitionIdCiPipelineMessage
   up     20240604111157  post     17.2         AddApprovalPolicyRulesFkOnApprovalGroupRules
</code></pre>
<p>Starting with GitLab 17.1, migrations are executed in an
order that conforms to the GitLab release cadence.</p>
<h2>Run incomplete database migrations</h2>
<p>Database migrations can be stuck in an incomplete state, with a <code>down</code>
status in the output of the <code>sudo gitlab-rake db:migrate:status</code> command.</p>
<ol>
<li>To complete these migrations, use the following Rake task:</li>
</ol>
<p><code>shell
   sudo gitlab-rake db:migrate</code></p>
<ol>
<li>
<p>After the command completes, run <code>sudo gitlab-rake db:migrate:status</code> to check if all migrations are completed (have an <code>up</code> status).</p>
</li>
<li>
<p>Hot reload <code>puma</code> and <code>sidekiq</code> services:</p>
</li>
</ol>
<p><code>shell
   sudo gitlab-ctl hup puma
   sudo gitlab-ctl restart sidekiq</code></p>
<p>Starting with GitLab 17.1, migrations are executed in an
order that conforms to the GitLab release cadence.</p>
<h2>Rebuild database indexes</h2>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/42705">Introduced</a> in GitLab 13.5 <a href="../../administration/feature_flags/_index.html">with a flag</a> named <code>database_reindexing</code>. Disabled by default.</li>
<li><a href="https://gitlab.com/groups/gitlab-org/-/epics/3989">Enabled on GitLab.com</a> in GitLab 13.9.</li>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/188548">Enabled on GitLab Self-Managed and GitLab Dedicated</a> in GitLab 18.0.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>Use with caution when running in a production environment, and run during off-peak times.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>Database indexes can be rebuilt regularly to reclaim space and maintain healthy
levels of index bloat over time. Reindexing can also be run as a
<a href="https://docs.gitlab.com/omnibus/settings/database.html#automatic-database-reindexing">regular cron job</a>.
A "healthy" level of bloat is highly dependent on the specific index, but generally
should be below 30%.</p>
<p>Prerequisites:</p>
<ul>
<li>This feature requires PostgreSQL 12 or later.</li>
<li>These index types are <strong>not supported</strong>: expression indexes and indexes used for constraint exclusion.</li>
</ul>
<h3>Run reindexing</h3>
<p>The following task rebuilds only the two indexes in each database with the highest bloat. To rebuild more than two indexes, run the task again until all desired indexes have been rebuilt.</p>
<ol>
<li>Run the reindexing task:</li>
</ol>
<p><code>shell
   sudo gitlab-rake gitlab:db:reindex</code></p>
<ol>
<li>Check <a href="../../administration/logs/_index.md#application_jsonlog">application_json.log</a> to verify execution or to troubleshoot.</li>
</ol>
<h3>Customize reindexing settings</h3>
<p>For smaller instances or to adjust reindexing behavior, you can modify these settings using the Rails console:</p>
<pre><code class="language-shell">sudo gitlab-rails console
</code></pre>
<p>Then customize the configuration:</p>
<pre><code class="language-ruby"># Lower minimum index size to 100 MB (default is 1 GB)
Gitlab::Database::Reindexing.minimum_index_size!(100.megabytes)

# Change minimum bloat threshold to 30% (default is 20%, there is no benefit from setting it lower)
Gitlab::Database::Reindexing.minimum_relative_bloat_size!(0.3)
</code></pre>
<h3>Automated reindexing</h3>
<p>For larger instances with significant database size, automate database reindexing by scheduling it to run during periods of low activity.</p>
<h4>Schedule with crontab</h4>
<p>For packaged GitLab installations, use crontab:</p>
<ol>
<li>Edit the crontab:</li>
</ol>
<p><code>shell
   sudo crontab -e</code></p>
<ol>
<li>
<p>Add an entry based on your preferred schedule:</p>
</li>
<li>
<p>Option 1: Run daily during quiet periods</p>
</li>
</ol>
<p><code>shell
   # Run database reindexing every day at 21:12
   # The log will be rotated by the packaged logrotate daemon
   12 21 * * * /opt/gitlab/bin/gitlab-rake gitlab:db:reindex &gt;&gt; /var/log/gitlab/gitlab-rails/cron_reindex.log 2&gt;&amp;1</code></p>
<ol>
<li>Option 2: Run on weekends only</li>
</ol>
<p><code>shell
   # Run database reindexing at 01:00 AM on weekends
   0 1 * * 0,6 /opt/gitlab/bin/gitlab-rake gitlab:db:reindex &gt;&gt; /var/log/gitlab/gitlab-rails/cron_reindex.log 2&gt;&amp;1</code></p>
<ol>
<li>Option 3: Run frequently during low-traffic hours</li>
</ol>
<p><code>shell
   # Run database reindexing every 3 hours during night hours (22:00-07:00)
   0 22,1,4,7 * * * /opt/gitlab/bin/gitlab-rake gitlab:db:reindex &gt;&gt; /var/log/gitlab/gitlab-rails/cron_reindex.log 2&gt;&amp;1</code></p>
<p>For Kubernetes deployments, you can create a similar schedule using the CronJob resource to run the reindexing task.</p>
<h3>Notes</h3>
<ul>
<li>Rebuilding database indexes is a disk-intensive task, so you should perform the
  task during off-peak hours. Running the task during peak hours can lead to
  increased bloat, and can also cause certain queries to perform slowly.</li>
<li>The task requires free disk space for the index being restored. The created
  indexes are appended with <code>_ccnew</code>. If the reindexing task fails, re-running the
  task cleans up the temporary indexes.</li>
<li>The time it takes for database index rebuilding to complete depends on the size
  of the target database. It can take between several hours and several days.</li>
<li>The task uses Redis locks, it's safe to schedule it to run frequently.
  It's a no-op if another reindexing task is already running.</li>
</ul>
<h2>Dump the database schema</h2>
<p>In rare circumstances, the database schema can differ from what the application code expects
even if all database migrations are complete. If this does occur, it can lead to odd errors
in GitLab.</p>
<p>To dump the database schema:</p>
<pre><code class="language-shell">SCHEMA=/tmp/structure.sql gitlab-rake db:schema:dump
</code></pre>
<p>The Rake task creates a <code>/tmp/structure.sql</code> file that contains the database schema dump.</p>
<p>To determine if there are any differences:</p>
<ol>
<li>Go to the <a href="https://gitlab.com/gitlab-org/gitlab/-/blob/master/db/structure.sql"><code>db/structure.sql</code></a> file in the <a href="https://gitlab.com/gitlab-org/gitlab"><code>gitlab</code></a> project.
   Select the branch that matches your GitLab version. For example, the file for GitLab 16.2: <a href="https://gitlab.com/gitlab-org/gitlab/-/blob/16-2-stable-ee/db/structure.sql">https://gitlab.com/gitlab-org/gitlab/-/blob/16-2-stable-ee/db/structure.sql</a>.</li>
<li>Compare <code>/tmp/structure.sql</code> with the <code>db/structure.sql</code> file for your version.</li>
</ol>
<h2>Check the database for schema inconsistencies</h2>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/390719">Introduced</a> in GitLab 15.11.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>This Rake task checks the database schema for any inconsistencies and prints them in the terminal.
This task is a diagnostic tool to be used under the guidance of GitLab Support.
You should not use the task for routine checks as database inconsistencies might be expected.</p>
<pre><code class="language-shell">gitlab-rake gitlab:db:schema_checker:run
</code></pre>
<h2>Collect information and statistics about the database</h2>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/groups/gitlab-com/-/epics/2456">Introduced</a> in GitLab 17.11.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>The <code>gitlab:db:sos</code> command gathers configuration, performance, and diagnostic data about your GitLab
database to help you troubleshoot issues. Where you run this command depends on your configuration. Make sure
to run this command relative to where GitLab is installed <code>(/gitlab)</code>.</p>
<ul>
<li><strong>Scaled GitLab</strong>: on your Puma or Sidekiq server.</li>
<li><strong>Cloud native install</strong>: on the toolbox pod.</li>
<li><strong>All other configurations</strong>: on your GitLab server.</li>
</ul>
<p>Modify the command as needed:</p>
<ul>
<li><strong>Default path</strong> - To run the command with the default file path (<code>/var/opt/gitlab/gitlab-rails/tmp/sos.zip</code>), run <code>gitlab-rake gitlab:db:sos</code>.</li>
<li><strong>Custom path</strong> - To change the file path, run <code>gitlab-rake gitlab:db:sos["/absolute/custom/path/to/file.zip"]</code>.</li>
<li><strong>Zsh users</strong> - If you have not modified your Zsh configuration, you must add quotation marks
  around the entire command, like this: <code>gitlab-rake "gitlab:db:sos[/absolute/custom/path/to/file.zip]"</code></li>
</ul>
<p>The Rake task runs for five minutes. It creates a compressed folder in the path you specify.
The compressed folder contains a large number of files.</p>
<h3>Enable optional query statistics data</h3>
<p>The <code>gitlab:db:sos</code> Rake task can also gather data for troubleshooting slow queries using the
<a href="https://www.postgresql.org/docs/16/pgstatstatements.html"><code>pg_stat_statements</code> extension</a>.</p>
<p>Enabling this extension is optional, and requires restarting PostgreSQL and GitLab. This data is
likely required for troubleshooting GitLab performance issues caused by slow database queries.</p>
<p>Prerequisites:</p>
<ul>
<li>You must be a PostgreSQL user with superuser privileges to enable or disable an extension.</li>
</ul>
<p>{{&lt; tabs &gt;}}</p>
<p>{{&lt; tab title="Linux package (Omnibus)" &gt;}}</p>
<ol>
<li>Modify <code>/etc/gitlab/gitlab.rb</code> to add the following line:</li>
</ol>
<p><code>ruby
   postgresql['shared_preload_libraries'] = 'pg_stat_statements'</code></p>
<ol>
<li>Run reconfigure:</li>
</ol>
<p><code>shell
   sudo gitlab-ctl reconfigure</code></p>
<ol>
<li>PostgreSQL needs to restart to load this extension, requiring a GitLab restart as well:</li>
</ol>
<p><code>shell
   sudo gitlab-ctl restart postgresql
   sudo gitlab-ctl restart sidekiq
   sudo gitlab-ctl restart puma</code></p>
<p>{{&lt; /tab &gt;}}</p>
<p>{{&lt; tab title="Docker" &gt;}}</p>
<ol>
<li>Modify <code>/etc/gitlab/gitlab.rb</code> to add the following line:</li>
</ol>
<p><code>ruby
   postgresql['shared_preload_libraries'] = 'pg_stat_statements'</code></p>
<ol>
<li>Run reconfigure:</li>
</ol>
<p><code>shell
   docker exec -it &lt;container-id&gt; gitlab-ctl reconfigure</code></p>
<ol>
<li>PostgreSQL needs to restart to load this extension, requiring a GitLab restart as well:</li>
</ol>
<p><code>shell
   docker exec -it &lt;container-id&gt; gitlab-ctl restart postgresql
   docker exec -it &lt;container-id&gt; gitlab-ctl restart sidekiq
   docker exec -it &lt;container-id&gt; gitlab-ctl restart puma</code></p>
<p>{{&lt; /tab &gt;}}</p>
<p>{{&lt; tab title="External PostgreSQL service" &gt;}}</p>
<ol>
<li>Add or uncomment the following parameters in your <code>postgresql.conf</code> file</li>
</ol>
<p><code>shell
   shared_preload_libraries = 'pg_stat_statements'
   pg_stat_statements.track = all</code></p>
<ol>
<li>
<p>Restart PostgreSQL for the changes to take effect.</p>
</li>
<li>
<p>Restart GitLab: the web (Puma) and Sidekiq services should be restarted.</p>
</li>
</ol>
<p>{{&lt; /tab &gt;}}</p>
<p>{{&lt; /tabs &gt;}}</p>
<ol>
<li>On the <a href="../troubleshooting/postgresql.html">database console</a> run:</li>
</ol>
<p><code>SQL
   CREATE EXTENSION pg_stat_statements;</code></p>
<ol>
<li>Check the extension is working:</li>
</ol>
<p><code>SQL
   SELECT extname FROM pg_extension WHERE extname = 'pg_stat_statements';
   SELECT * FROM pg_stat_statements LIMIT 10;</code></p>
<h2>Check the database for duplicate CI/CD tags</h2>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/518698">Introduced</a> in GitLab 17.10.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>This Rake task checks the <code>ci</code> database for duplicate tags in the <code>tags</code> table.
This issue might affect instances that have undergone multiple major upgrades over an extended period.
Run the following command to search duplicate tags, then rewrite any tag assignments that
reference duplicate tags to use the original tag instead.</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:db:deduplicate_tags
</code></pre>
<p>To run this command in dry-run mode, set the environment variable <code>DRY_RUN=true</code>.</p>
<h2>Detect PostgreSQL collation version mismatches</h2>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/195450">Introduced</a> in GitLab 18.2.</li>
<li>Spot check of predefined set of indexes for corruption <a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/198071">introduced</a> in GitLab 18.3.</li>
<li>Option to customize <code>MAX_TABLE_SIZE</code> and bypass PgBouncer <a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/202736">introduced</a> in GitLab 18.4.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>The PostgreSQL collation checker:</p>
<ul>
<li>Detects collation version mismatches between the database and operating system that can cause index corruption. PostgreSQL uses the operating system's <code>glibc</code> library for
  string collation (sorting and comparison rules).</li>
<li>Performs corruption spot checks (duplicate detection) on a predefined set of indexes. These indexes are known to be prone to corruption issues because of collation mismatch.</li>
</ul>
<p>Run this task after operating system upgrades that change the underlying <code>glibc</code> library.</p>
<p>Prerequisites:</p>
<ul>
<li>PostgreSQL 13 or later.</li>
</ul>
<p>To check for PostgreSQL collation mismatches and related index corruption in all databases:</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:db:collation_checker
</code></pre>
<p>To check a specific database:</p>
<pre><code class="language-shell"># Check main database
sudo gitlab-rake gitlab:db:collation_checker:main

# Check CI database
sudo gitlab-rake gitlab:db:collation_checker:ci
</code></pre>
<h3>Adjust table size limits</h3>
<p>By default, tables larger than 1 GB are skipped to avoid long-running queries that could impact database performance.
You can adjust the table size threshold by setting the <code>MAX_TABLE_SIZE</code> environment variable.</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>Increasing the table size limit might result in long-running queries that could impact database performance.</p>
<p>{{&lt; /alert &gt;}}</p>
<pre><code class="language-shell"># Set custom table size limit (in bytes)
# to increase the max table size threshold to 10 GB
MAX_TABLE_SIZE=10737418240 sudo gitlab-rake gitlab:db:collation_checker:main
</code></pre>
<h3>Bypass PgBouncer for long-running queries</h3>
<p>See <a href="#resolve-statement-timeout-errors">resolve statement timeout errors</a> in the troubleshooting section.</p>
<h3>Example output</h3>
<p>When no issues are found:</p>
<pre><code class="language-plaintext">Checking for PostgreSQL collation mismatches on main database...
No collation mismatches detected on main.
Found 8 indexes to corruption spot check.
No corrupted indexes detected.
</code></pre>
<p>If mismatches are detected, the task provides remediation steps to fix the affected indexes.</p>
<p>Example output with mismatches:</p>
<pre><code class="language-plaintext">Checking for PostgreSQL collation mismatches on main database...
⚠️ COLLATION MISMATCHES DETECTED on main database!
2 collation(s) have version mismatches:
  - en_US.utf8: stored=428.1, actual=513.1
  - es_ES.utf8: stored=428.1, actual=513.1

Found 8 indexes to corruption spot check.
Affected indexes that need to be rebuilt:
  - index_projects_on_name (btree) on table projects
    • Issues detected: duplicates
    • Affected columns: name
    • Type: UNIQUE
    • Needs deduplication: Yes

REMEDIATION STEPS:
1. Put GitLab into maintenance mode
2. Run the following SQL commands:

# Step 1: Check for duplicate entries in unique indexes
SELECT name, COUNT(*), ARRAY_AGG(id) FROM projects GROUP BY name HAVING COUNT(*) &gt; 1 LIMIT 1;

# If duplicates exist, you may need to use gitlab:db:deduplicate_tags or similar tasks
# to fix duplicate entries before rebuilding unique indexes.

# Step 2: Rebuild affected indexes
# Option A: Rebuild individual indexes with minimal downtime:
REINDEX INDEX CONCURRENTLY index_projects_on_name;

# Option B: Alternatively, rebuild all indexes at once (requires downtime):
REINDEX DATABASE main;

# Step 3: Refresh collation versions
ALTER DATABASE main REFRESH COLLATION VERSION;

3. Take GitLab out of maintenance mode
</code></pre>
<p>For more information about PostgreSQL collation issues and how they affect database indexes, see the <a href="../postgresql/upgrading_os.html">PostgreSQL upgrading OS documentation</a>.</p>
<h2>Repair corrupted database indexes</h2>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/196677">Introduced</a> in GitLab 18.2.</li>
<li>Option to bypass PgBouncer <a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/203843">introduced</a> in GitLab 18.4.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>The index repair tool fixes corrupted or missing database indexes that can cause data integrity issues.
The tool addresses specific problematic indexes that are affected by
collation mismatches or other corruption issues. The tool:</p>
<ul>
<li>Deduplicates data when unique indexes are corrupted.</li>
<li>Updates references to maintain data integrity.</li>
<li>Rebuilds or creates indexes with correct configuration.</li>
</ul>
<p>Before repairing indexes, run the tool in dry-run mode to analyze potential changes:</p>
<pre><code class="language-shell">sudo DRY_RUN=true gitlab-rake gitlab:db:repair_index
</code></pre>
<p>The following example output shows the changes:</p>
<pre><code class="language-shell">INFO -- : DRY RUN: Analysis only, no changes will be made.
INFO -- : Running Index repair on database main...
INFO -- : Processing index 'index_merge_request_diff_commit_users_on_name_and_email'...
INFO -- : Index is unique. Checking for duplicate data...
INFO -- : No duplicates found in 'merge_request_diff_commit_users' for columns: name,email.
INFO -- : Index exists. Reindexing...
INFO -- : Index reindexed successfully.
</code></pre>
<p>To repair all known problematic indexes in all databases:</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:db:repair_index
</code></pre>
<p>The command processes each database and repairs the indexes. For example:</p>
<pre><code class="language-shell">INFO -- : Running Index repair on database main...
INFO -- : Processing index 'index_merge_request_diff_commit_users_on_name_and_email'...
INFO -- : Index is unique. Checking for duplicate data...
INFO -- : No duplicates found in 'merge_request_diff_commit_users' for columns: name,email.
INFO -- : Index does not exist. Creating new index...
INFO -- : Index created successfully.
INFO -- : Index repair completed for database main.
</code></pre>
<p>To repair indexes in a specific database:</p>
<pre><code class="language-shell"># Repair indexes in main database
sudo gitlab-rake gitlab:db:repair_index:main

# Repair indexes in CI database
sudo gitlab-rake gitlab:db:repair_index:ci
</code></pre>
<h3>Bypass PgBouncer for long-running queries</h3>
<p>See <a href="#resolve-statement-timeout-errors">resolve statement timeout errors</a> in the troubleshooting section.</p>
<h2>Troubleshooting</h2>
<h3>Advisory lock connection information</h3>
<p>After running the <code>db:migrate</code> Rake task, you may see output like the following:</p>
<pre><code class="language-shell">main: == [advisory_lock_connection] object_id: 173580, pg_backend_pid: 5532
main: == [advisory_lock_connection] object_id: 173580, pg_backend_pid: 5532
</code></pre>
<p>The messages returned are informational and can be ignored.</p>
<h3>PostgreSQL socket errors when executing the <code>gitlab:env:info</code> Rake task</h3>
<p>After running <code>sudo gitlab-rake gitlab:env:info</code> on Gitaly or other non-Rails nodes, you might see the following error:</p>
<pre><code class="language-plaintext">PG::ConnectionBad: could not connect to server: No such file or directory
Is the server running locally and accepting
connections on Unix domain socket &quot;/var/opt/gitlab/postgresql/.s.PGSQL.5432&quot;?
</code></pre>
<p>This is because, in a multi-node environment, the <code>gitlab:env:info</code> Rake task should only be executed on the nodes running <strong>GitLab Rails</strong>.</p>
<h3>Resolve statement timeout errors</h3>
<p>If your GitLab instance uses PgBouncer and you encounter statement timeouts during database maintenance tasks (like collation checker or index repair), bypass PgBouncer by using direct PostgreSQL connections.</p>
<pre><code class="language-shell"># Example with direct connection
GITLAB_BACKUP_PGUSER=postgres GITLAB_BACKUP_PGHOST=localhost sudo gitlab-rake gitlab:db:collation_checker

GITLAB_BACKUP_PGUSER=postgres GITLAB_BACKUP_PGHOST=localhost sudo gitlab-rake gitlab:db:repair_index
</code></pre>
<p>Supported environment variables:</p>
<ul>
<li><code>GITLAB_BACKUP_PGHOST</code></li>
<li><code>GITLAB_BACKUP_PGUSER</code></li>
<li><code>GITLAB_BACKUP_PGPORT</code></li>
<li><code>GITLAB_BACKUP_PGPASSWORD</code></li>
</ul>
<p>For more information on bypassing PgBouncer and a full list of supported environment variables, see the
<a href="../postgresql/pgbouncer.md#procedure-for-bypassing-pgbouncer">procedure for bypassing PgBouncer</a>.</p></code></pre>
</body>
</html>
