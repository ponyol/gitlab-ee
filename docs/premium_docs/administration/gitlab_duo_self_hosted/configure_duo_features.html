<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Configure access to the local AI Gateway</title>
    <link rel="stylesheet" href="/../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: AI-powered
group: Custom Models
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
description: Configure your GitLab instance to use GitLab Duo Self-Hosted.
title: Configure GitLab to access GitLab Duo Self-Hosted</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Add-on: GitLab Duo Enterprise</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/groups/gitlab-org/-/epics/12972">Introduced</a> in GitLab 17.1 <a href="../feature_flags/_index.html">with a flag</a> named <code>ai_custom_model</code>. Disabled by default.</li>
<li><a href="https://gitlab.com/groups/gitlab-org/-/epics/15176">Enabled on GitLab Self-Managed</a> in GitLab 17.6.</li>
<li>Changed to require GitLab Duo add-on in GitLab 17.6 and later.</li>
<li>Feature flag <code>ai_custom_model</code> removed in GitLab 17.8</li>
<li>Ability to set AI Gateway URL using UI <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/473143">added</a> in GitLab 17.9.</li>
<li>Generally available in GitLab 17.9.</li>
<li>Changed to include Premium in GitLab 18.0.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>Prerequisites:</p>
<ul>
<li><a href="../../update/_index.html">Upgrade GitLab to version 17.9 or later</a>.</li>
<li>You must be an administrator.</li>
</ul>
<p>To configure your GitLab instance to access the available self-hosted models in your infrastructure:</p>
<ol>
<li><a href="_index.md#configuration-types">Confirm that a fully self-hosted configuration is appropriate for your use case</a>.</li>
<li>Configure your GitLab instance to access the AI Gateway.</li>
<li>In GitLab 18.4 and later, configure your GitLab instance to access the GitLab Duo Agent Platform service.</li>
<li>Configure the self-hosted model.</li>
<li>Configure the GitLab Duo features to use your self-hosted model.</li>
</ol>
<h2>Configure access to the local AI Gateway</h2>
<p>To configure access between your GitLab instance and your local AI Gateway:</p>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>On the left sidebar, select <strong>GitLab Duo</strong>.</li>
<li>Select <strong>Change configuration</strong>.</li>
<li>Under <strong>Local AI Gateway URL</strong>, enter your AI Gateway URL.</li>
<li>Select <strong>Save changes</strong>.</li>
</ol>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>If your AI Gateway URL points to a local network or private IP address (for example, <code>172.31.x.x</code> or internal hostnames like <code>ip-172-xx-xx-xx.region.compute.internal</code>), GitLab might block the request for security reasons. To allow requests to this address, <a href="../../security/webhooks.md#allow-outbound-requests-to-certain-ip-addresses-and-domains">add the address to the IP allowlist</a>.</p>
<p>{{&lt; /alert &gt;}}</p>
<h2>Configure timeout for the AI Gateway</h2>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/567878">Introduced</a> in GitLab 18.7.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>To conserve resources and prevent long-running queries, configure the timeout for GitLab requests to the AI Gateway when waiting for model responses.
Use longer timeouts for self-hosted models with large context windows or complex queries.</p>
<p>You can configure a timeout between 60 and 600 seconds (10 minutes). If you don't set the timeout, GitLab uses the default timeout of 60 seconds.</p>
<p>To configure the AI Gateway timeout:</p>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>On the left sidebar, select <strong>GitLab Duo</strong>.</li>
<li>Select <strong>Change configuration</strong>.</li>
<li>Under <strong>AI Gateway request timeout</strong>, enter the timeout value in seconds (between 60 and 600).</li>
<li>Select <strong>Save changes</strong>.</li>
</ol>
<h3>Determine the timeout value</h3>
<p>The timeout value depends on your specific deployment and use case.</p>
<p>To determine the timeout value:</p>
<ul>
<li>Start with the default timeout of 60 seconds and monitor for timeout errors.</li>
<li>Monitor your logs for <code>A1000</code> timeout errors in your logs. If these errors occur frequently, consider increasing the timeout.</li>
<li>Consider your use case. Larger prompts, complex code generation tasks, or processing large design documents might require longer timeouts.</li>
<li>Consider your infrastructure. Model performance depends on available GPU resources, network latency between the AI Gateway and model endpoint, and the model's processing capabilities.</li>
<li>Increase incrementally. If you experience timeouts, increase the value gradually (for example, by 30-60 seconds) and monitor the results.</li>
</ul>
<p>For more information on troubleshooting timeout errors, see <a href="troubleshooting.md#error-a1000">Error A1000</a>.</p>
<h2>Configure access to the GitLab Duo Agent Platform</h2>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Status: Beta</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/groups/gitlab-org/-/epics/19213">Introduced</a> in GitLab 18.4, as an <a href="../../policy/development_stages_support.md#experiment">experiment</a> with a <a href="../feature_flags/_index.html">feature flag</a> named <code>self_hosted_agent_platform</code>. Disabled by default.</li>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/558083">Changed</a> from experiment to beta in GitLab 18.5.</li>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/208951">Enabled</a> in GitLab 18.7.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>{{&lt; alert type="flag" &gt;}}</p>
<p>The availability of this feature is controlled by a feature flag.
For more information, see the history.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>Prerequisites:</p>
<ul>
<li>Self-hosted beta models and features are <a href="#turn-on-self-hosted-beta-models-and-features">turned on</a>.</li>
</ul>
<p>To access the Agent Platform service from your GitLab instance:</p>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>On the left sidebar, select <strong>GitLab Duo</strong>.</li>
<li>Select <strong>Change configuration</strong>.</li>
<li>Under <strong>Local URL for the GitLab Duo Agent Platform service</strong>, enter the URL for the local Agent Platform service.</li>
<li>
<p>The URL prefix cannot start with <code>http://</code> or <code>https://</code>.</p>
</li>
<li>
<p>If the URL is not set up with TLS, you must set the <code>DUO_AGENT_PLATFORM_SERVICE_SECURE</code> environment variable in your GitLab instance:</p>
<ul>
<li>For Linux package installations, in <code>gitlab_rails['env']</code>, set <code>'DUO_AGENT_PLATFORM_SERVICE_SECURE' =&gt; false</code></li>
<li>For self-compiled installations, in <code>/etc/default/gitlab</code> set <code>export DUO_AGENT_PLATFORM_SERVICE_SECURE=false</code></li>
<li>Select <strong>Save changes</strong>.</li>
</ul>
</li>
</ol>
<h2>Add a self-hosted model</h2>
<p>You must add a self-hosted model to your GitLab instance to use it with GitLab Duo features.</p>
<p>To add a self-hosted model:</p>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>On the left sidebar, select <strong>GitLab Duo</strong>.</li>
<li>Select <strong>Configure GitLab Duo Self-Hosted</strong>.</li>
<li>If <strong>Configure GitLab Duo Self-Hosted</strong> is not available, synchronize your
     subscription after purchase:<ol>
<li>On the left sidebar, select <strong>Subscription</strong>.</li>
<li>In <strong>Subscription details</strong>, to the right of <strong>Last sync</strong>, select
    synchronize subscription ({{&lt; icon name="retry" &gt;}}).</li>
</ol>
</li>
<li>Select <strong>Add self-hosted model</strong>.</li>
<li>Complete the fields:</li>
<li><strong>Deployment name</strong>: Enter a name to uniquely identify the model deployment, for example, <code>Mixtral-8x7B-it-v0.1 on GCP</code>.</li>
<li><strong>Model family</strong>: Select the model family the deployment belongs to. You can select either a supported or compatible model.</li>
<li><strong>Endpoint</strong>: Enter the URL where the model is hosted.</li>
<li><strong>API key</strong>: Optional. Add an API key if you need one to access the model.</li>
<li>
<p><strong>Model identifier</strong>: Enter the model identifier based on your deployment method. The model identifier should match the following format:</p>
<table>
<thead>
<tr>
<th>Deployment method</th>
<th>Format</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="supported_llm_serving_platforms.md#find-the-model-name">vLLM</a></td>
<td><code>custom_openai/&lt;name of the model served through vLLM&gt;</code></td>
<td><code>custom_openai/Mixtral-8x7B-Instruct-v0.1</code></td>
</tr>
<tr>
<td><a href="#set-the-model-identifier-for-amazon-bedrock-models">Amazon Bedrock</a></td>
<td><code>bedrock/&lt;model ID of the model&gt;</code></td>
<td><code>bedrock/mistral.mixtral-8x7b-instruct-v0:1</code></td>
</tr>
<tr>
<td>Azure OpenAI</td>
<td><code>azure/&lt;model ID of the model&gt;</code></td>
<td><code>azure/gpt-35-turbo</code></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Select <strong>Create self-hosted model</strong>.</p>
</li>
</ol>
<h3>Set the model identifier for Amazon Bedrock models</h3>
<p>To set a model identifier for an Amazon Bedrock model:</p>
<ol>
<li>Set your <code>AWS_REGION</code>. Ensure you have access to models in that region in your AI gateway Docker configuration.</li>
<li>Add the region prefix to the model's inference profile ID for cross-region inferencing.</li>
<li>Use the <code>bedrock/</code> prefix region as the prefix for the model identifier.</li>
</ol>
<p>For example, for the Anthropic Claude 3.5 v2 model in the Tokyo region:</p>
<ul>
<li>The <code>AWS_REGION</code> is <code>ap-northeast-1</code>.</li>
<li>The cross-region inferencing prefix is <code>apac.</code>.</li>
<li>The model identifier is <code>bedrock/apac.anthropic.claude-3-5-sonnet-20241022-v2:0</code>.</li>
</ul>
<p>Some regions are not supported by cross-region inferencing. For these regions, do not specify a region prefix in the model identifier. For example:</p>
<ul>
<li>The <code>AWS_REGION</code> is <code>eu-west-2</code>.</li>
<li>The model identifier is <code>bedrock/anthropic.claude-3-7-sonnet-20250219-v1:0</code>.</li>
</ul>
<h2>Turn on self-hosted beta models and features</h2>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>Turning on beta self-hosted models and features also accepts the <a href="https://handbook.gitlab.com/handbook/legal/testing-agreement/">GitLab Testing Agreement</a>.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>To enable self-hosted beta models and features:</p>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>On the left sidebar, select <strong>GitLab Duo</strong>.</li>
<li>Select <strong>Change configuration</strong>.</li>
<li>Under <strong>Self-hosted beta models and features</strong>, select the <strong>Use beta models and features in GitLab Duo Self-Hosted</strong> checkbox.</li>
<li>Select <strong>Save changes</strong>.</li>
</ol>
<h2>Configure GitLab Duo features to use self-hosted models</h2>
<h3>View configured features</h3>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>On the left sidebar, select <strong>GitLab Duo</strong>.</li>
<li>Select <strong>Configure GitLab Duo Self-Hosted</strong>.</li>
<li>If <strong>Configure GitLab Duo Self-Hosted</strong> is not available, synchronize your
     subscription after purchase:<ol>
<li>On the left sidebar, select <strong>Subscription</strong>.</li>
<li>In <strong>Subscription details</strong>, to the right of <strong>Last sync</strong>, select
    synchronize subscription ({{&lt; icon name="retry" &gt;}}).</li>
</ol>
</li>
<li>Select the <strong>AI-native features</strong> tab.</li>
</ol>
<h3>Configure a feature to use a self-hosted model</h3>
<p>Configure a GitLab Duo feature and sub-feature to send queries to the self-hosted model:</p>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>On the left sidebar, select <strong>GitLab Duo</strong>.</li>
<li>Select <strong>Configure GitLab Duo Self-Hosted</strong>.</li>
<li>Select the <strong>AI-native features</strong> tab.</li>
<li>For the feature and sub-feature you want to configure, from the dropdown list, choose the self-hosted model you want to use.</li>
</ol>
<p>For example, for the code generation, you can select <strong>Claude-3 on Bedrock deployment (Claude 3)</strong>.</p>
<p><img alt="GitLab Duo Self-Hosted Feature Configuration" src="img/gitlab_duo_self_hosted_feature_configuration_v17_11.png" /></p>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>If you don't specify a model for a GitLab Duo Chat sub-feature, it automatically uses the model configured for <strong>General Chat</strong>.
This ensures all Chat functionality works without requiring individual model configuration for each sub-feature.</p>
<p>{{&lt; /alert &gt;}}</p>
<h3>Configure a feature to use a GitLab AI vendor model</h3>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Status: Beta</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/groups/gitlab-org/-/epics/17192">Introduced</a> in GitLab 18.3, as a <a href="../../policy/development_stages_support.md#beta">beta</a> with a <a href="../feature_flags/_index.html">feature flag</a> named <code>ai_self_hosted_vendored_features</code>. Disabled by default.</li>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/214030">Enabled by default</a> in GitLab 18.7</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>{{&lt; alert type="flag" &gt;}}
The availability of this feature is controlled by a feature flag.
For more information, see the history.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>You can configure a GitLab Duo feature to use the GitLab AI vendor model, even if you use a self-hosted AI gateway and models.</p>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>On the left sidebar, select <strong>GitLab Duo</strong>.</li>
<li>Select <strong>Configure GitLab Duo Self-Hosted</strong>.</li>
<li>Select the <strong>AI-native features</strong> tab.</li>
<li>For the feature and sub-feature you want to configure, from the dropdown list, select <strong>GitLab AI vendor model</strong>.</li>
</ol>
<p><img alt="GitLab Duo Self-Hosted feature configuration using GitLab AI vendor model" src="img/gitlab_duo_self_hosted_feature_configuration_with_vendored_model_v18_3.png" /></p>
<h3>Disable GitLab Duo features</h3>
<p>GitLab Duo features remain turned on even if you have not chosen a model for a sub-feature.</p>
<p>To disable a GitLab Duo feature or sub-feature:</p>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>On the left sidebar, select <strong>GitLab Duo</strong>.</li>
<li>Select <strong>Configure GitLab Duo Self-Hosted</strong>.</li>
<li>Select the <strong>AI-native features</strong> tab.</li>
<li>For the feature or sub-feature you want to disable, from the dropdown list, select <strong>Disabled</strong>.</li>
</ol>
<p><img alt="Disabling GitLab Duo Feature" src="img/gitlab_duo_self_hosted_disable_feature_v17_11.png" /></p>
<h3>Self-host the GitLab documentation</h3>
<p>If your GitLab Duo Self-Hosted setup prevents you from accessing the GitLab documentation at
<code>docs.gitlab.com</code>, you can self-host the documentation.
For more information, see <a href="../docs_self_host.html">Host the GitLab product documentation</a>.</p>
<h2>Related topics</h2>
<ul>
<li><a href="supported_models_and_hardware_requirements.md#supported-models">Supported models</a></li>
<li><a href="supported_models_and_hardware_requirements.md#compatible-models">Compatible models</a></li>
<li><a href="_index.md#configuration-types">GitLab Duo Self-Hosted configuration types</a></li>
</ul></code></pre>
</body>
</html>
