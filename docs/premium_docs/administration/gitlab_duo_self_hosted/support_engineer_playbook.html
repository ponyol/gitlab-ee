<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Support Engineer Playbook and Common Issues</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: AI-powered
group: Custom Models
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
description: Troubleshooting tips for GitLab Duo Self-Hosted
title: GitLab Duo Self-Hosted Support Engineer Playbook</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Add-on: GitLab Duo Enterprise</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/groups/gitlab-org/-/epics/12972">Introduced</a> in GitLab 17.1 <a href="../feature_flags/_index.html">with a flag</a> named <code>ai_custom_model</code>. Disabled by default.</li>
<li><a href="https://gitlab.com/groups/gitlab-org/-/epics/15176">Enabled on GitLab Self-Managed</a> in GitLab 17.6.</li>
<li>Changed to require GitLab Duo add-on in GitLab 17.6 and later.</li>
<li>Feature flag <code>ai_custom_model</code> removed in GitLab 17.8.</li>
<li>Generally available in GitLab 17.9.</li>
<li>Changed to include Premium in GitLab 18.0.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<h2>Support Engineer Playbook and Common Issues</h2>
<p>This section provides Support Engineers with essential commands and troubleshooting steps for debugging GitLab Duo Self-Hosted issues.</p>
<h2>Essential Debugging Commands</h2>
<h3>Display AI Gateway Environment Variables</h3>
<p>Check all AI Gateway environment variables to verify configuration:</p>
<pre><code class="language-shell">docker exec -it &lt;ai-gateway-container&gt; env | grep AIGW
</code></pre>
<p>Key variables to verify:</p>
<ul>
<li><code>AIGW_CUSTOM_MODELS__ENABLED</code> - must be <code>true</code></li>
<li><code>AIGW_GITLAB_URL</code> - should match your GitLab instance URL</li>
<li><code>AIGW_GITLAB_API_URL</code> - should be accessible from the container</li>
<li><code>AIGW_AUTH__BYPASS_EXTERNAL</code> - should only be <code>true</code> during troubleshooting</li>
</ul>
<h3>Verify User Permissions</h3>
<p>Check if a user has the correct permissions for Code Suggestions with self-hosted models:</p>
<pre><code class="language-ruby"># In GitLab Rails console
user = User.find_by_id(&quot;&lt;user_id&gt;&quot;)
user.allowed_to_use?(:code_suggestions, service_name: :self_hosted_models)
</code></pre>
<h3>Examine AI Gateway Client Logs</h3>
<p>View AI Gateway client logs to identify connection issues:</p>
<pre><code class="language-shell">docker logs &lt;ai-gateway-container&gt; | grep &quot;Gitlab::Llm::AiGateway::Client&quot;
</code></pre>
<h3>View GitLab Logs for AI Gateway Requests</h3>
<p>To see the actual requests made to the AI Gateway, use:</p>
<pre><code class="language-shell"># View live logs
sudo gitlab-ctl tail | grep -E &quot;(ai_gateway|llm\.log)&quot;

# View specific log file with JSON formatting
sudo cat /var/log/gitlab/gitlab-rails/llm.log | jq '.'

# Filter for specific request types
 sudo cat /var/log/gitlab/gitlab-rails/llm.log | jq 'select(.message)'

 sudo cat /var/log/gitlab/gitlab-rails/llm.log | grep Llm::CompletionWorker | jq '.'
</code></pre>
<h3>View AI Gateway Logs for Model Requests</h3>
<p>To see the actual requests sent to the model:</p>
<pre><code class="language-shell"># View AI Gateway container logs
docker logs &lt;ai-gateway-container&gt; 2&gt;&amp;1 | grep -E &quot;(model|litellm|custom_openai)&quot;

# For structured logs, if available
docker logs &lt;ai-gateway-container&gt; 2&gt;&amp;1 | grep &quot;model_endpoint&quot;
</code></pre>
<h2>Common Configuration Issues and Solutions</h2>
<h3>Missing <code>/v1</code> Suffix in Model Endpoint</h3>
<p><strong>Symptom</strong>: 404 errors when making requests to vLLM or OpenAI-compatible models</p>
<p><strong>How to spot in logs</strong>:</p>
<pre><code class="language-shell"># Look for 404 errors in AI Gateway logs
docker logs &lt;ai-gateway-container&gt; | grep &quot;404&quot;
</code></pre>
<p><strong>Solution</strong>: Ensure the model endpoint includes the <code>/v1</code> suffix:</p>
<ul>
<li>Incorrect: <code>http://localhost:4000</code></li>
<li>Correct: <code>http://localhost:4000/v1</code></li>
</ul>
<h3>Certificate Validation Issues</h3>
<p><strong>Symptom</strong>: SSL certificate errors or connection failures</p>
<p><strong>How to spot in logs</strong>:</p>
<pre><code class="language-shell"># Look for SSL/TLS errors
sudo cat /var/log/gitlab/gitlab-rails/llm.log | grep -i &quot;ssl\|certificate\|tls&quot;
</code></pre>
<p><strong>Validation</strong>: Verify certificate status - GitLab server must use a trusted certificate, as self-signed certificates are not supported.</p>
<p><strong>Solution</strong>:</p>
<ul>
<li>Use trusted certificates for GitLab instance</li>
<li>If using self-signed certificates, configure proper certificate paths in the AI Gateway container</li>
</ul>
<h3>Network Connectivity Issues</h3>
<p><strong>Symptom</strong>: Timeouts or connection refused errors</p>
<p><strong>How to spot in logs</strong>:</p>
<pre><code class="language-shell"># Look for network-related errors
docker logs &lt;ai-gateway-container&gt; | grep -E &quot;(timeout|connection|refused|unreachable)&quot;
</code></pre>
<p><strong>Validation commands</strong>:</p>
<pre><code class="language-shell"># Test from AI Gateway container to GitLab
docker exec -it &lt;ai-gateway-container&gt; curl &quot;$AIGW_GITLAB_API_URL/projects&quot;

# Test from AI Gateway container to model endpoint
docker exec -it &lt;ai-gateway-container&gt; curl &quot;&lt;model_endpoint&gt;/health&quot;
</code></pre>
<h3>Authentication and Authorization Issues</h3>
<p><strong>Symptom</strong>: 401 Unauthorized or 403 Forbidden errors</p>
<p><strong>How to spot in logs</strong>:</p>
<pre><code class="language-shell"># Look for authentication errors
sudo cat /var/log/gitlab/gitlab-rails/llm.log | jq 'select(.status == 401 or .status == 403)'
</code></pre>
<p><strong>Common causes</strong>:</p>
<ul>
<li>User doesn't have GitLab Duo Enterprise seat assigned</li>
<li>License issues</li>
<li>Incorrect AI Gateway URL configuration</li>
</ul>
<h3>Model Configuration Issues</h3>
<p><strong>Symptom</strong>: Model not responding or returning errors</p>
<p><strong>How to spot in logs</strong>:</p>
<pre><code class="language-shell"># Look for model-specific errors
docker logs &lt;ai-gateway-container&gt; | grep -E &quot;(model_name|model_endpoint|litellm)&quot;
</code></pre>
<p><strong>Validation</strong>:</p>
<pre><code class="language-shell"># Test model directly from AI Gateway container
docker exec -it &lt;ai-gateway-container&gt; sh
curl --request POST &quot;&lt;model_endpoint&gt;/v1/chat/completions&quot; \
     --header 'Content-Type: application/json' \
     --data '{&quot;model&quot;: &quot;&lt;model_name&gt;&quot;, &quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Hello&quot;}]}'
</code></pre>
<h2>Log Analysis Workflow</h2>
<h3>Step 1: Enable Verbose Logging</h3>
<p>Check if the <code>Capture detailed information about AI-related activities and requests</code> instance setting is enabled, in GitLab Rails console:</p>
<pre><code class="language-ruby">::Ai::Setting.instance.enabled_instance_verbose_ai_logs
</code></pre>
<p>If it returns <code>false</code>, enable the flag using:</p>
<pre><code class="language-ruby">::Ai::Setting.instance.update!(enabled_instance_verbose_ai_logs: true)
</code></pre>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>To enable logging, use the <code>enabled_instance_verbose_ai_logs</code> instance setting. Do not use the <code>expanded_ai_logging</code> feature flag. Only use the <code>expanded_ai_logging</code> feature flag on GitLab.com for debugging purposes. Do not use this feature flag in GitLab Self-Managed instances, including instances running GitLab Duo Self-Hosted.</p>
<p>{{&lt; /alert &gt;}}</p>
<h3>Step 2: Reproduce the Issue</h3>
<p>Have the user reproduce the issue while monitoring logs:</p>
<pre><code class="language-shell"># Terminal 1: Monitor GitLab logs
sudo gitlab-ctl tail | grep -E &quot;(ai_gateway|llm\.log)&quot;

# Terminal 2: Monitor AI Gateway logs
docker logs -f &lt;ai-gateway-container&gt;
</code></pre>
<h3>Step 3: Analyze Request Flow</h3>
<ol>
<li><strong>GitLab to AI Gateway</strong>: Check if request reaches AI Gateway</li>
<li><strong>AI Gateway to Model</strong>: Verify model endpoint is called</li>
<li><strong>Response Path</strong>: Ensure response is properly formatted and returned</li>
</ol>
<h3>Step 4: Common Error Patterns</h3>
<table>
<thead>
<tr>
<th>Error Pattern</th>
<th>Location</th>
<th>Likely Cause</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Connection refused</code></td>
<td>GitLab logs</td>
<td>AI Gateway not accessible</td>
</tr>
<tr>
<td><code>404 Not Found</code></td>
<td>AI Gateway logs</td>
<td>Missing <code>/v1</code> in model endpoint</td>
</tr>
<tr>
<td><code>401 Unauthorized</code></td>
<td>GitLab logs</td>
<td>Authentication/license issues</td>
</tr>
<tr>
<td><code>Timeout</code></td>
<td>Either</td>
<td>Network or model performance issues</td>
</tr>
<tr>
<td><code>SSL certificate verify failed</code></td>
<td>GitLab logs</td>
<td>Certificate validation issues</td>
</tr>
</tbody>
</table>
<h2>Quick Diagnostic Commands</h2>
<h2><strong>AI Gateway Instance Commands:</strong></h2>
<p><strong>1. Test AI Gateway health:</strong></p>
<pre><code class="language-shell">curl --silent --output /dev/null --write-out &quot;%{http_code}&quot; &quot;&lt;ai-gateway-url&gt;/monitoring/healthz&quot;
</code></pre>
<p><strong>2. Check AI Gateway environment variables:</strong></p>
<pre><code class="language-shell">docker exec &lt;ai-gateway-container&gt; env | grep AIGW
</code></pre>
<p><strong>3. Check AI Gateway logs for errors:</strong></p>
<pre><code class="language-shell">docker logs &lt;ai-gateway-container&gt; 2&gt;&amp;1 | grep --ignore-case error | tail --lines=20
</code></pre>
<h2><strong>GitLab Self-Managed Instance Commands:</strong></h2>
<p><strong>4. Check user permissions (GitLab Rails console):</strong></p>
<pre><code class="language-shell">sudo gitlab-rails console
</code></pre>
<p>Then in the console:</p>
<pre><code class="language-ruby">User.find_by_id('&lt;user_id&gt;').can?(:access_code_suggestions)
</code></pre>
<p><strong>5. Check GitLab LLM logs for errors:</strong></p>
<pre><code class="language-shell">sudo tail --lines=100 /var/log/gitlab/gitlab-rails/llm.log | grep --ignore-case error
</code></pre>
<p><strong>6. Check feature flags:</strong></p>
<pre><code class="language-shell">sudo gitlab-rails console
</code></pre>
<p>Then:</p>
<pre><code class="language-ruby">Feature.enabled?(:expanded_ai_logging)
</code></pre>
<p><strong>7. Test connectivity from GitLab to AI Gateway:</strong></p>
<pre><code class="language-shell">curl --verbose &quot;&lt;ai-gateway-url&gt;/monitoring/healthz&quot;
</code></pre>
<h3>Emergency Diagnostic One-liner</h3>
<p>For quick issue identification:</p>
<pre><code class="language-shell"># Check all critical components at once
docker exec &lt;ai-gateway-container&gt; env | grep AIGW_CUSTOM_MODELS__ENABLED &amp;&amp; \
curl --silent &quot;&lt;ai-gateway-url&gt;/monitoring/healthz&quot; &amp;&amp; \
sudo tail --lines=10 /var/log/gitlab/gitlab-rails/llm.log | jq '.level'
</code></pre>
<h2>Escalation Criteria</h2>
<p>Escalate to Custom Models team when:</p>
<ol>
<li><strong>All basic troubleshooting steps completed</strong> without resolution</li>
<li><strong>Model integration issues</strong> that require deep technical knowledge</li>
<li><strong>Feature not listed</strong> in self-hosted models unit primitives</li>
<li><strong>Suspected GitLab Duo platform bugs</strong> affecting multiple users</li>
<li><strong>Performance issues</strong> with specific model configurations</li>
</ol>
<h2>Additional Resources</h2>
<ul>
<li><a href="../../install/install_ai_gateway.html">AI Gateway Installation Guide</a></li>
<li><a href="troubleshooting.html">GitLab Duo Self-Hosted Troubleshooting</a></li>
</ul></code></pre>
</body>
</html>
