<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># GitLab.com AI Gateway</title>
    <link rel="stylesheet" href="/../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: AI-powered
group: Custom Models
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
description: Get started with GitLab Duo Self-Hosted.
title: GitLab Duo Self-Hosted configuration and authentication</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Add-on: GitLab Duo Enterprise</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/groups/gitlab-org/-/epics/12972">Introduced</a> in GitLab 17.1 <a href="../feature_flags/_index.html">with a flag</a> named <code>ai_custom_model</code>. Disabled by default.</li>
<li><a href="https://gitlab.com/groups/gitlab-org/-/epics/15176">Enabled on GitLab Self-Managed</a> in GitLab 17.6.</li>
<li>Changed to require GitLab Duo add-on in GitLab 17.6 and later.</li>
<li>Feature flag <code>ai_custom_model</code> removed in GitLab 17.8.</li>
<li>Generally available in GitLab 17.9.</li>
<li>Changed to include Premium in GitLab 18.0.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>There are two configuration options for self-managed customers:</p>
<ul>
<li><strong>GitLab.com AI Gateway</strong>: This is the default configuration for GitLab Self-Managed customers. Use the GitLab-managed AI Gateway with external large language model (LLM) providers selected by GitLab (for example, Google Vertex or Anthropic).</li>
<li><strong>Self-hosted AI Gateway</strong>: Deploy and manage your own AI Gateway and language models in your infrastructure, without depending on GitLab-provided external language providers.</li>
</ul>
<h2>GitLab.com AI Gateway</h2>
<p>In this configuration, your GitLab instance depends on and sends requests to the external GitLab AI Gateway, which communicates with external AI vendors such as Google Vertex or Anthropic. The response is then forwarded back to your GitLab instance.</p>
<pre><code class="language-mermaid">%%{init: { &quot;theme&quot;: &quot;default&quot;, &quot;fontFamily&quot;: &quot;GitLab Sans&quot;, &quot;sequence&quot;: { &quot;actorFontSize&quot;: 12, &quot;participantFontSize&quot;: 12, &quot;messageFontSize&quot;: 12 } }}%%
sequenceDiagram
    accTitle: GitLab.com AI Gateway flow
    accDescr: User requests are processed through a self-hosted GitLab instance, external AI Gateway, and AI vendor.

    actor User as User
    participant SelfHostedGitLab as Self-hosted GitLab (Your Instance)
    participant GitLabAIGateway as GitLab AI Gateway (External)
    participant GitLabAIVendor as GitLab AI Vendor (External)

    User -&gt;&gt; SelfHostedGitLab: Send request
    SelfHostedGitLab -&gt;&gt; SelfHostedGitLab: Check if self-hosted model is configured
    SelfHostedGitLab -&gt;&gt; GitLabAIGateway: Forward request for AI processing
    GitLabAIGateway -&gt;&gt; GitLabAIVendor: Create prompt and send request to AI model server
    GitLabAIVendor --&gt;&gt; GitLabAIGateway: Respond to the prompt
    GitLabAIGateway --&gt;&gt; SelfHostedGitLab: Forward AI response
    SelfHostedGitLab --&gt;&gt; User: Forward AI response
</code></pre>
<h2>Self-hosted AI Gateway</h2>
<p>In this configuration, the entire system is isolated within the enterprise, ensuring a fully self-hosted environment that safeguards data privacy.</p>
<pre><code class="language-mermaid">%%{init: { &quot;theme&quot;: &quot;default&quot;, &quot;fontFamily&quot;: &quot;GitLab Sans&quot;, &quot;sequence&quot;: { &quot;actorFontSize&quot;: 12, &quot;participantFontSize&quot;: 12, &quot;messageFontSize&quot;: 12 } }}%%
sequenceDiagram
    accTitle: Self-hosted AI Gateway flow
    accDescr: User requests are processed entirely within self-hosted infrastructure using an AI Gateway and model.

    actor User as User
    participant SelfHostedGitLab as Self-hosted GitLab
    participant SelfHostedAIGateway as Self-hosted AI Gateway
    participant SelfHostedModel as Self-hosted model

    User -&gt;&gt; SelfHostedGitLab: Send request
    SelfHostedGitLab -&gt;&gt; SelfHostedGitLab: Check if self-hosted model is configured
    SelfHostedGitLab -&gt;&gt; SelfHostedAIGateway: Forward request for AI processing
    SelfHostedAIGateway -&gt;&gt; SelfHostedModel: Create prompt and perform request to AI model server
    SelfHostedModel --&gt;&gt; SelfHostedAIGateway: Respond to the prompt
    SelfHostedAIGateway --&gt;&gt; SelfHostedGitLab: Forward AI response
    SelfHostedGitLab --&gt;&gt; User: Forward AI response
</code></pre>
<h2>Authentication for GitLab Duo Self-Hosted</h2>
<p>The authentication process for GitLab Duo Self-Hosted is secure, efficient, and made up of the following key components:</p>
<ul>
<li>
<p><strong>Self-issued tokens</strong>: In this architecture, access credentials are not synchronized with <code>cloud.gitlab.com</code>. Instead, tokens are self-issued dynamically, similar to the functionality on GitLab.com. This method provides users with immediate access while maintaining a high level of security.</p>
</li>
<li>
<p><strong>Offline environments</strong>: In offline setups, there are no connections to <code>cloud.gitlab.com</code>. All requests are routed exclusively to the self-hosted AI Gateway.</p>
</li>
<li>
<p><strong>Token minting and verification</strong>: The instance mints the token, which is then verified by the AI Gateway against the GitLab instance.</p>
</li>
<li>
<p><strong>Model configuration and security</strong>: When an administrator configures a model, they can incorporate an API key to authenticate requests. Additionally, you can enhance security by specifying connection IP addresses within your network, ensuring that only trusted IPs can interact with the model.</p>
</li>
</ul>
<p>As illustrated in the following diagram:</p>
<ol>
<li>The authentication flow begins when the user configures the model through the GitLab instance and submits a request to access the GitLab Duo feature.</li>
<li>The GitLab instance mints an access token, which the user forwards to GitLab and then to the AI Gateway for verification.</li>
<li>Upon confirming the token's validity, the AI Gateway sends a request to the AI model, which uses the API key to authenticate the request and process it.</li>
<li>The results are then relayed back to the GitLab instance, completing the flow by sending the response to the user, which is designed to be secure and efficient.</li>
</ol>
<pre><code class="language-mermaid">%%{init: { &quot;theme&quot;: &quot;default&quot;, &quot;fontFamily&quot;: &quot;GitLab Sans&quot;, &quot;sequence&quot;: { &quot;actorFontSize&quot;: 12, &quot;participantFontSize&quot;: 12, &quot;messageFontSize&quot;: 12 } }}%%
sequenceDiagram
    accTitle: GitLab Duo authentication flow
    accDescr: Authentication tokens are minted, verified, and used to secure AI model requests.

    participant User as User
    participant GitLab as GitLab Instance
    participant AI Gateway as AI Gateway
    participant AIModel as AI Model

    User-&gt;&gt;GitLab: Configure Model
    User-&gt;&gt;GitLab: Request Access
    GitLab-&gt;&gt;GitLab: Mint Token
    GitLab-&gt;&gt;User: Send Token
    User-&gt;&gt;GitLab: Forward Minted Token
    GitLab-&gt;&gt;AI Gateway: Verify Token
    AI Gateway-&gt;&gt;GitLab: Token Validated
    GitLab-&gt;&gt;AI Gateway: Send Request to Model
    AI Gateway-&gt;&gt;AIModel: Send Request to Model
    AIModel-&gt;&gt;AIModel: Authenticate using API Key
    AIModel-&gt;&gt;AI Gateway: Process Request
    AI Gateway-&gt;&gt;GitLab: Send Result to GitLab
    GitLab-&gt;&gt;User: Send Response
</code></pre></code></pre>
</body>
</html>
