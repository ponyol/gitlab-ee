<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Manage background migrations with Rake tasks</title>
    <link rel="stylesheet" href="/../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: Data Access
group: Database Frameworks
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Check migrations before upgrade</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Free, Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<h2>Manage background migrations with Rake tasks</h2>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/191722">Introduced</a> in GitLab 18.5.</li>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/211674">Enhanced</a> in GitLab 18.7.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>GitLab provides a set of Rake tasks to manage background migrations from the command line.
These tasks are particularly useful for self-managed administrators who need to manage background
migrations when the Admin UI is not available, such as during downtime upgrades or maintenance windows.</p>
<p>All Rake tasks work across all databases (main and ci) and use a unified migration ID format: <code>{database}_{id}</code>.
For example, <code>main_85</code> refers to migration ID 85 in the main database, and <code>ci_10</code> refers to migration ID 10
in the ci database.</p>
<h3>List all background migrations</h3>
<p>To view all batched background migrations across all databases:</p>
<p>{{&lt; tabs &gt;}}</p>
<p>{{&lt; tab title="GitLab 18.5 and later" &gt;}}</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:background_migrations:list
</code></pre>
<p>Example output:</p>
<pre><code class="language-plaintext">id      | table_name                                              | job_class_name                                              | status
--------|---------------------------------------------------------|-------------------------------------------------------------|----------
main_1  | namespace_settings                                      | UpdateRequireDpopForManageApiEndpointsToFalse               | finished
main_2  | resource_iteration_events                               | BackfillResourceIterationEventsNamespaceId                  | finalized
main_3  | identities                                              | DeleteTwitterIdentities                                     | finalized
main_4  | software_license_policies                               | BackfillLicensesOutsideSpdxCatalogue                        | finalized
main_5  | security_policies                                       | BackfillPipelineExecutionPoliciesMetadata                   | finished
ci_1    | ci_runners                                              | MarkAdminBotRunnersAsHosted                                 | finalized
ci_2    | p_ci_build_trace_metadata                               | BackfillUpsertedCiBuildTraceMetadataProjectId               | finalized
ci_3    | ci_runners                                              | BackfillOrganizationIdOnCiRunners                           | finalized
</code></pre>
<p>{{&lt; /tab &gt;}}</p>
<p>{{&lt; tab title="GitLab 18.4 and earlier" &gt;}}</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:background_migrations:status
</code></pre>
<p>{{&lt; /tab &gt;}}</p>
<p>{{&lt; /tabs &gt;}}</p>
<h3>Show migration details</h3>
<p>To view detailed information about a specific migration:</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:background_migrations:show[&lt;migration_id&gt;]
</code></pre>
<p>For example:</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:background_migrations:show[ci_1]
</code></pre>
<p>Example output:</p>
<pre><code class="language-plaintext">id                       | ci_1
created_at               | 2025-05-06 22:40:08 UTC
updated_at               | 2025-08-20 22:29:07 UTC
min_value                | 1
max_value                | 30
batch_size               | 1000
sub_batch_size           | 100
interval                 | 120
status                   | finalized
job_class_name           | MarkAdminBotRunnersAsHosted
batch_class_name         | PrimaryKeyBatchingStrategy
table_name               | ci_runners
column_name              | id
job_arguments            | []
total_tuple_count        |
pause_ms                 | 100
max_batch_size           |
started_at               | 2025-05-06 22:40:08 UTC
on_hold_until            |
gitlab_schema            | gitlab_ci
finished_at              | 2025-05-06 22:40:13 UTC
queued_migration_version | 20250505095336
min_cursor               |
max_cursor               |
</code></pre>
<h3>Pause a migration</h3>
<p>To pause an active background migration:</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:background_migrations:pause[&lt;migration_id&gt;]
</code></pre>
<p>For example:</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:background_migrations:pause[main_85]
</code></pre>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>You can only pause migrations with an <code>active</code> status. Attempting to pause a migration in any other
state results in an error.</p>
<p>{{&lt; /alert &gt;}}</p>
<h3>Resume a migration</h3>
<p>To resume a paused background migration:</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:background_migrations:resume[&lt;migration_id&gt;]
</code></pre>
<p>For example:</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:background_migrations:resume[main_85]
</code></pre>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>You can only resume migrations with a <code>paused</code> status. Attempting to resume a migration in any other
state results in an error.</p>
<p>{{&lt; /alert &gt;}}</p>
<h3>Execute a migration</h3>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/211674">Introduced</a> in GitLab 18.7.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>To execute a specific background migration immediately:</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:background_migrations:execute[&lt;migration_id&gt;]
</code></pre>
<p>For example:</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:background_migrations:execute[ci_10]
</code></pre>
<p>Example output:</p>
<pre><code class="language-plaintext">Are you sure you want to execute this migration? yes
Executing background migration `ci_10`...
Done.
</code></pre>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>This task executes the migration synchronously in the foreground. The migration runs until completion
or failure. This can take a significant amount of time for large migrations and may impact database
performance. Use this task during maintenance windows when possible.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>The task prompts for confirmation before executing. If the migration fails to complete, check the
migration status with <code>gitlab:background_migrations:show[&lt;migration_id&gt;]</code> for more details.</p>
<h3>Execute all migrations</h3>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/211674">Introduced</a> in GitLab 18.7.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>To execute all unfinished background migrations across all databases:</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:background_migrations:execute_all
</code></pre>
<p>Example output:</p>
<!--
The following codeblock uses extra spaces to avoid the Vale ReferenceLinks test.
Do not remove the two-space nesting.
-->

<p>```plaintext
  Are you sure you want to execute all unfinished migrations? yes
  [main] Executing 6 background migrations...</p>
<p>[ci] Executing 3 background migrations...</p>
<p>```</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>This task executes all unfinished migrations synchronously in the foreground. This can take a very
long time and significantly impact database performance. Only use this task during planned maintenance
windows. The task continues even if individual migrations fail, but reports failures in the output.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>The task:</p>
<ul>
<li>Prompts for confirmation before executing.</li>
<li>Processes migrations in order by ID.</li>
<li>Reports the status of each migration as it completes.</li>
<li>Continues processing remaining migrations even if some fail.</li>
</ul>
<h2>Check for pending database background migrations</h2>
<p>{{&lt; history &gt;}}</p>
<ul>
<li>Feature <a href="../administration/feature_flags/_index.html">flag</a> <code>execute_batched_migrations_on_schedule</code> <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/329511">enabled by default</a> in GitLab 13.12.</li>
<li>For GitLab Self-Managed, administrators can opt to disable it.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>To update database tables in batches, GitLab can use batched background migrations. These migrations
are created by GitLab developers and run automatically on upgrade. However, such migrations are
limited in scope to help with migrating some <code>integer</code> database columns to <code>bigint</code>, which is needed to
prevent integer overflow for some tables.</p>
<p>Batched background migrations are handled by Sidekiq and
run in isolation,
so an instance can remain operational while the migrations are processed. However,
performance might degrade on larger instances that are heavily used while
batched background migrations are run. You should
<a href="../administration/admin_area.md#background-jobs">Actively monitor the Sidekiq status</a>
until all migrations are completed.</p>
<p>To decrease the time required to complete these migrations, increase the number of
<a href="../administration/sidekiq/extra_sidekiq_processes.html">Sidekiq workers</a>
that can process jobs in the <code>background_migration</code> queue.</p>
<h3>Check the status of batched background migrations</h3>
<p>You can check the status of batched background migrations in the GitLab UI, or
by querying the database directly. Before you upgrade GitLab, all migrations must
have a <code>Finished</code> status.</p>
<p>If the migrations are not finished and you try to upgrade GitLab, you might
see this error:</p>
<pre><code class="language-plaintext">Expected batched background migration for the given configuration to be marked
as 'finished', but it is 'active':
</code></pre>
<p>If you get this error,
<a href="background_migrations_troubleshooting.md#database-migrations-failing-because-of-batched-background-migration-not-finished">review the options</a> for
how to complete the batched background migrations needed for the GitLab upgrade.</p>
<h4>From the GitLab UI</h4>
<p>Prerequisites:</p>
<ul>
<li>You must have administrator access to the instance.</li>
</ul>
<p>To check the status of batched background migrations:</p>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>Select <strong>Monitoring</strong> &gt; <strong>Background migrations</strong>.</li>
<li>Select <strong>Queued</strong> or <strong>Finalizing</strong> to see incomplete migrations,
   and <strong>Failed</strong> for failed migrations.</li>
</ol>
<h4>From the database</h4>
<p>Prerequisites:</p>
<ul>
<li>You must have administrator access to the instance.</li>
</ul>
<p>To query the database directly for the status of batched background migrations:</p>
<ol>
<li>Sign in to a <code>psql</code> prompt, according to the directions for your instance's
   installation method. For example, <code>sudo gitlab-psql</code> for Linux package installations.</li>
<li>To see details on incomplete batched background migrations, run this query in
   the <code>psql</code> session:</li>
</ol>
<p><code>sql
   SELECT
     job_class_name,
     table_name,
     column_name,
     job_arguments
   FROM batched_background_migrations
   WHERE status NOT IN(3, 6);</code></p>
<p>Alternatively, you can wrap the query with <code>gitlab-psql -c "&lt;QUERY&gt;"</code> to check the status of
batched background migrations:</p>
<pre><code class="language-shell">gitlab-psql -c &quot;SELECT job_class_name, table_name, column_name, job_arguments FROM batched_background_migrations WHERE status NOT IN(3, 6);&quot;
</code></pre>
<p>If the query returns zero rows, all batched background migrations are complete.</p>
<h3>Enable or disable advanced features</h3>
<p>Batched background migrations provide feature flags that enable you to customize
migrations or pause them entirely. These feature flags should only be disabled by
advanced users who understand the risks of doing so.</p>
<h4>Pause batched background migrations</h4>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>There can be <a href="../administration/feature_flags/_index.md#risks-when-disabling-released-features">risks when disabling released features</a>.
Refer to each feature's history for more details.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>To pause an ongoing batched background migration,
disable the batched background migrations feature.
Disabling the feature completes the current batch of migrations, then waits to start
the next batch until after the feature is enabled again.</p>
<p>Prerequisites:</p>
<ul>
<li>You must have administrator access to the instance.</li>
</ul>
<p>Use the following database queries to see the state of the current batched background migration:</p>
<ol>
<li>Obtain the ID of the running migration:</li>
</ol>
<p><code>sql
   SELECT
    id,
    job_class_name,
    table_name,
    column_name,
    job_arguments
   FROM batched_background_migrations
   WHERE status NOT IN(3, 6);</code></p>
<ol>
<li>Run this query, replacing <code>XX</code> with the ID you obtained in the previous step,
   to see the status of the migration:</li>
</ol>
<p><code>sql
   SELECT
    started_at,
    finished_at,
    finished_at - started_at AS duration,
    min_value,
    max_value,
    batch_size,
    sub_batch_size
   FROM batched_background_migration_jobs
   WHERE batched_background_migration_id = XX
   ORDER BY id DESC
   limit 10;</code></p>
<ol>
<li>
<p>Run the query multiple times within a few minutes to ensure no new row has been added.
   If no new row has been added, the migration has been paused.</p>
</li>
<li>
<p>After confirming the migration has paused, restart the migration (using the <code>enable</code>
   command mentioned previously) to proceed with the batch when ready. On larger instances,
   background migrations can take as long as 48 hours to complete each batch.</p>
</li>
</ol>
<h4>Automatic batch size optimization</h4>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/60133">Introduced</a> in GitLab 13.2 <a href="../administration/feature_flags/_index.html">with a flag</a> named <code>optimize_batched_migrations</code>. Enabled by default.</li>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/204173">Generally available</a> in GitLab 18.4. Feature flag <code>optimize_batched_migrations</code> removed.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>There can be <a href="../administration/feature_flags/_index.md#risks-when-disabling-released-features">risks when disabling released features</a>.
Refer to this feature's history for more details.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>To maximize throughput of batched background migrations (in terms of the number of tuples updated per time unit), batch sizes are automatically adjusted based on how long the previous batches took to complete.</p>
<h4>Parallel execution</h4>
<p>{{&lt; history &gt;}}</p>
<ul>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/104027">Introduced</a> in GitLab 15.7 <a href="../administration/feature_flags/_index.html">with a flag</a> named <code>batched_migrations_parallel_execution</code>. Disabled by default.</li>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/372316">Enabled on GitLab.com</a> in GitLab 15.11.</li>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/120808">Generally available</a> in GitLab 16.1. Feature flag <code>batched_migrations_parallel_execution</code> removed.</li>
</ul>
<p>{{&lt; /history &gt;}}</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>There can be <a href="../administration/feature_flags/_index.md#risks-when-disabling-released-features">risks when disabling released features</a>.
Refer to this feature's history for more details.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>To speed up the execution of batched background migrations, two migrations are executed at the same time.</p>
<p><a href="../administration/feature_flags/_index.html">GitLab administrators with access to the GitLab Rails console</a> can change
the number of batched background migrations executed in parallel:</p>
<pre><code class="language-ruby">ApplicationSetting.update_all(database_max_running_batched_background_migrations: 4)
</code></pre>
<h3>Resolve failed batched background migrations</h3>
<p>If a batched background migration fails, <a href="#fix-and-retry-the-migration">fix and retry</a> it.
If the migration continues to fail with an error, either:</p>
<ul>
<li><a href="#finish-a-failed-migration-manually">Finish the failed migration manually</a></li>
<li><a href="#mark-a-failed-migration-finished">Mark the failed migration finished</a></li>
</ul>
<h4>Fix and retry the migration</h4>
<p>All failed batched background migrations must be resolved to upgrade to a newer
version of GitLab. If you <a href="#check-the-status-of-batched-background-migrations">check the status</a>
of batched background migrations, some migrations might display in the <strong>Failed</strong> tab
with a <strong>failed</strong> status:</p>
<p><img alt="A failed batched background migrations table." src="img/batched_background_migrations_failed_v14_3.png" /></p>
<p>To determine why the batched background migration failed,
view the failure error logs
or view error information in the UI.</p>
<p>Prerequisites:</p>
<ul>
<li>
<p>You must have administrator access to the instance.</p>
</li>
<li>
<p>In the upper-right corner, select <strong>Admin</strong>.</p>
</li>
<li>Select <strong>Monitoring</strong> &gt; <strong>Background migrations</strong>.</li>
<li>Select the <strong>Failed</strong> tab. This displays a list of failed batched background migrations.</li>
<li>Select the failed <strong>Migration</strong> to see the migration parameters and the jobs that failed.</li>
<li>Under <strong>Failed jobs</strong>, select each <strong>ID</strong> to see why the job failed.</li>
</ul>
<p>If you are a GitLab customer, consider opening a <a href="https://support.gitlab.com/hc/en-us/requests/new">Support Request</a>
to debug why the batched background migrations failed.</p>
<p>To correct the problem, you can retry the failed migration.</p>
<p>Prerequisites:</p>
<ul>
<li>
<p>You must have administrator access to the instance.</p>
</li>
<li>
<p>In the upper-right corner, select <strong>Admin</strong>.</p>
</li>
<li>Select <strong>Monitoring</strong> &gt; <strong>Background migrations</strong>.</li>
<li>Select the <strong>Failed</strong> tab. This displays a list of failed batched background migrations.</li>
<li>Select a failed batched background migration to retry by clicking on the retry button ({{&lt; icon name="retry" &gt;}}).</li>
</ul>
<p>To monitor the retried batched background migrations, you can
<a href="#check-the-status-of-batched-background-migrations">check the status of batched background migrations</a>
on a regular interval.</p>
<h4>Finish a failed migration manually</h4>
<p>To manually finish a batched background migration that failed with an error,
use the information in the failure error logs or the database:</p>
<p>{{&lt; tabs &gt;}}</p>
<p>{{&lt; tab title="From the failure error logs" &gt;}}</p>
<ol>
<li>View the failure error logs
   and look for an <code>An error has occurred, all later migrations canceled</code> error message, like this:</li>
</ol>
<p>```plaintext
   StandardError: An error has occurred, all later migrations canceled:</p>
<p>Expected batched background migration for the given configuration to be marked as
   'finished', but it is 'active':
     {:job_class_name=&gt;"CopyColumnUsingBackgroundMigrationJob",
      :table_name=&gt;"push_event_payloads",
      :column_name=&gt;"event_id",
      :job_arguments=&gt;[["event_id"],
      ["event_id_convert_to_bigint"]]
     }
   ```</p>
<ol>
<li>Run the following command, replacing the values in angle brackets with the correct arguments:</li>
</ol>
<p><code>shell
   sudo gitlab-rake gitlab:background_migrations:finalize[&lt;job_class_name&gt;,&lt;table_name&gt;,&lt;column_name&gt;,'&lt;job_arguments&gt;']</code></p>
<p>When dealing with multiple arguments, such as <code>[["id"],["id_convert_to_bigint"]]</code>, escape the
   comma between each argument with a backslash <code>\</code> to prevent an invalid character error.
   For example, to finish the migration from the previous step:</p>
<p><code>shell
   sudo gitlab-rake gitlab:background_migrations:finalize[CopyColumnUsingBackgroundMigrationJob,push_event_payloads,event_id,'[["event_id"]\, ["event_id_convert_to_bigint"]]']</code></p>
<p>{{&lt; /tab &gt;}}</p>
<p>{{&lt; tab title="From the database" &gt;}}</p>
<ol>
<li><a href="#check-the-status-of-batched-background-migrations">Check the status</a> of the
   migration in the database.</li>
<li>Use the query results to construct a migration command, replacing the values
   in angle brackets with the correct arguments:</li>
</ol>
<p><code>shell
   sudo gitlab-rake gitlab:background_migrations:finalize[&lt;job_class_name&gt;,&lt;table_name&gt;,&lt;column_name&gt;,'&lt;job_arguments&gt;']</code></p>
<p>For example, if the query returns this data:</p>
<ul>
<li><code>job_class_name</code>: <code>CopyColumnUsingBackgroundMigrationJob</code></li>
<li><code>table_name</code>: <code>events</code></li>
<li><code>column_name</code>: <code>id</code></li>
<li><code>job_arguments</code>: <code>[["id"], ["id_convert_to_bigint"]]</code></li>
</ul>
<p>When dealing with multiple arguments, such as <code>[["id"],["id_convert_to_bigint"]]</code>, escape the
 comma between each argument with a backslash <code>\</code> to prevent an invalid character error.
 Every comma in the <code>job_arguments</code> parameter value must be escaped with a backslash.</p>
<p>For example:</p>
<p><code>shell
 sudo gitlab-rake gitlab:background_migrations:finalize[CopyColumnUsingBackgroundMigrationJob,ci_builds,id,'[["id"\, "stage_id"]\,["id_convert_to_bigint"\,"stage_id_convert_to_bigint"]]']</code></p>
<p>{{&lt; /tab &gt;}}</p>
<p>{{&lt; /tabs &gt;}}</p>
<h4>Mark a failed migration finished</h4>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p><a href="https://about.gitlab.com/support/#contact-support">Contact GitLab Support</a> before using
these instructions. This action can cause data loss, and make your instance fail
in ways that are difficult to recover from.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>There can be cases where the background migration fails: when jumping too many version upgrades,
or backward-incompatible database schema changes. (For an example, see <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/393216">issue 393216</a>).
Failed background migrations prevent further application upgrades.</p>
<p>When the background migration is determined to be "safe" to skip, the migration can be manually marked finished:</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>Make sure you create a backup before proceeding.</p>
<p>{{&lt; /alert &gt;}}</p>
<pre><code class="language-ruby"># Start the rails console

connection = ApplicationRecord.connection # or Ci::ApplicationRecord.connection, depending on which DB was the migration scheduled

Gitlab::Database::SharedModel.using_connection(connection) do
  migration = Gitlab::Database::BackgroundMigration::BatchedMigration.find_for_configuration(
    Gitlab::Database.gitlab_schemas_for_connection(connection),
    'BackfillUserDetailsFields',
    :users,
    :id,
    []
  )

  # mark all jobs completed
  migration.batched_jobs.update_all(status: Gitlab::Database::BackgroundMigration::BatchedJob.state_machine.states['succeeded'].value)
  migration.update_attribute(:status, Gitlab::Database::BackgroundMigration::BatchedMigration.state_machine.states[:finished].value)
end
</code></pre>
<h3>Run all background migrations synchronously</h3>
<p>There may be cases where you want to force background migrations to run in the foreground during a maintenance window.</p>
<p>This script may timeout/exit before all migrations are completed. You can run it again until all migrations are complete.</p>
<pre><code class="language-ruby"># Start the rails console

databases = ActiveRecord::Tasks::DatabaseTasks.setup_initial_database_yaml

Gitlab::Database.database_base_models.each do |database_name, model|
  Gitlab::Database::SharedModel.using_connection(model.connection) do
    Gitlab::Database::BackgroundMigration::BatchedMigration.with_status([:paused, :active]).find_each(batch_size: 100) do |migration|
      puts &quot;#{database_name}: Finalizing migration #{migration.job_class_name} (ID: #{migration.id})... &quot;
      Gitlab::Database::BackgroundMigration::BatchedMigrationRunner.finalize(
        migration.job_class_name,
        migration.table_name,
        migration.column_name,
        Gitlab::Json.parse(migration.job_arguments),
        connection: model.connection
      )
      puts(&quot;done!\n&quot;)
    end
  end
end
</code></pre>
<h2>View batched background migration logs</h2>
<p>When troubleshooting batched background migrations, you can view detailed execution logs in multiple locations.</p>
<h3>Sidekiq logs</h3>
<p>The <a href="../administration/logs/_index.md#sidekiq-logs">Sidekiq logs</a> show when the <code>Database::BatchedBackgroundMigrationWorker</code> jobs are executed. These logs show job execution but do not identify which specific migration is running.</p>
<h3>Application logs</h3>
<p>To identify which batched background migration is running, check the <a href="../administration/logs/_index.md#application_jsonlog">application logs</a>. The application logs contain detailed information including:</p>
<ul>
<li>The class name of the specific batched background migration (<code>job_class_name</code>)</li>
<li>State transitions (pending, running, and succeeded or failed)</li>
</ul>
<h3>Trace a migration execution</h3>
<p>To trace a specific batched background migration:</p>
<ol>
<li>Find <code>correlation_id</code> in the Sidekiq log entry for <code>Database::BatchedBackgroundMigrationWorker</code>.</li>
<li>Search the application logs with that <code>correlation_id</code> to see detailed state transitions.</li>
</ol>
<p>Example application log entry:</p>
<pre><code class="language-json">{
  &quot;severity&quot;: &quot;INFO&quot;,
  &quot;time&quot;: &quot;2025-08-27T22:52:07.806Z&quot;,
  &quot;meta.caller_id&quot;: &quot;Database::BatchedBackgroundMigration::MainExecutionWorker&quot;,
  &quot;correlation_id&quot;: &quot;74d0295cbe4bb6147230a7d481fb0f8a&quot;,
  &quot;message&quot;: &quot;BatchedJob transition&quot;,
  &quot;batched_job_id&quot;: 725,
  &quot;previous_state&quot;: &quot;pending&quot;,
  &quot;new_state&quot;: &quot;running&quot;,
  &quot;batched_migration_id&quot;: 638,
  &quot;job_class_name&quot;: &quot;BackfillSentNotificationsAfterPartition&quot;,
  &quot;job_arguments&quot;: []
},
{
  &quot;severity&quot;: &quot;INFO&quot;,
  &quot;time&quot;: &quot;2025-08-27T22:52:14.293Z&quot;,
  &quot;meta.caller_id&quot;: &quot;Database::BatchedBackgroundMigration::MainExecutionWorker&quot;,
  &quot;correlation_id&quot;: &quot;74d0295cbe4bb6147230a7d481fb0f8a&quot;,
  &quot;message&quot;: &quot;BatchedJob transition&quot;,
  &quot;batched_job_id&quot;: 725,
  &quot;previous_state&quot;: &quot;running&quot;,
  &quot;new_state&quot;: &quot;succeeded&quot;,
  &quot;batched_migration_id&quot;: 638,
  &quot;job_class_name&quot;: &quot;BackfillSentNotificationsAfterPartition&quot;,
  &quot;job_arguments&quot;: []
}
</code></pre>
<h2>Check for pending advanced search migrations</h2>
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>This section is only applicable if you have enabled the <a href="../integration/advanced_search/elasticsearch.html">Elasticsearch integration</a>.
Major releases require all <a href="../integration/advanced_search/elasticsearch.md#advanced-search-migrations">advanced search migrations</a>
to be finished from the most recent minor release in your current version
before the major version upgrade. You can find pending migrations by
running the following command.</p>
<p>{{&lt; tabs &gt;}}</p>
<p>{{&lt; tab title="Linux package (Omnibus)" &gt;}}</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:elastic:list_pending_migrations
</code></pre>
<p>{{&lt; /tab &gt;}}</p>
<p>{{&lt; tab title="Self-compiled (source)" &gt;}}</p>
<pre><code class="language-shell">cd /home/git/gitlab
sudo -u git -H bundle exec rake gitlab:elastic:list_pending_migrations
</code></pre>
<p>{{&lt; /tab &gt;}}</p>
<p>{{&lt; /tabs &gt;}}</p>
<p>If you're on a long upgrade path and have many pending migrations, you might want to configure
<strong>Requeue indexing workers</strong> and <strong>Number of shards for non-code indexing</strong> to speed up indexing.
Another option is to ignore the pending migrations and <a href="../integration/advanced_search/elasticsearch.md#index-the-instance">reindex the instance</a> after you upgrade GitLab to the target version.
You can also disable advanced search during this process with the <a href="../integration/advanced_search/elasticsearch.md#advanced-search-configuration"><strong>Search with advanced search</strong></a> setting.</p>
<p>{{&lt; alert type="warning" &gt;}}</p>
<p>Indexing large instances comes with risks.
For more information, see <a href="../integration/advanced_search/elasticsearch.md#index-large-instances-efficiently">index large instances efficiently</a>.</p>
<p>{{&lt; /alert &gt;}}</p></code></pre>
</body>
</html>
