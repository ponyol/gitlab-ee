<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Set configurations in the Rails console</title>
    <link rel="stylesheet" href="/../../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: AI-powered
group: Global Search
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Troubleshooting Elasticsearch access</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>When working with Elasticsearch access, you might encounter the following issues.</p>
<h2>Set configurations in the Rails console</h2>
<p>See <a href="../../../administration/operations/rails_console.md#starting-a-rails-console-session">Starting a Rails console session</a>.</p>
<h3>List attributes</h3>
<p>To list all available attributes:</p>
<ol>
<li>Open the Rails console (<code>sudo gitlab-rails console</code>).</li>
<li>Run the following command:</li>
</ol>
<pre><code class="language-ruby">ApplicationSetting.last.attributes
</code></pre>
<p>The output contains all the settings available in <a href="../../advanced_search/elasticsearch.html">Elasticsearch integration</a>, such as <code>elasticsearch_indexing</code>, <code>elasticsearch_url</code>, <code>elasticsearch_replicas</code>, and <code>elasticsearch_pause_indexing</code>.</p>
<h3>Set attributes</h3>
<p>To set an Elasticsearch integration setting, run a command like:</p>
<pre><code class="language-ruby">ApplicationSetting.last.update(elasticsearch_url: '&lt;your ES URL and port&gt;')

#or

ApplicationSetting.last.update(elasticsearch_indexing: false)
</code></pre>
<h3>Get attributes</h3>
<p>To check if the settings have been set in <a href="../../advanced_search/elasticsearch.html">Elasticsearch integration</a> or in the Rails console, run a command like:</p>
<pre><code class="language-ruby">Gitlab::CurrentSettings.elasticsearch_url

#or

Gitlab::CurrentSettings.elasticsearch_indexing
</code></pre>
<h3>Change the password</h3>
<p>To change the Elasticsearch password, run the following commands:</p>
<pre><code class="language-ruby">es_url = Gitlab::CurrentSettings.current_application_settings

# Confirm the current Elasticsearch URL
es_url.elasticsearch_url

# Set the Elasticsearch URL
es_url.elasticsearch_url = &quot;http://&lt;username&gt;:&lt;password&gt;@your.es.host:&lt;port&gt;&quot;

# Save the change
es_url.save!
</code></pre>
<h2>View logs</h2>
<p>One of the most valuable tools for identifying issues with the Elasticsearch
integration are logs. The most relevant logs for this integration are:</p>
<ol>
<li><a href="../../../administration/logs/_index.md#sidekiqlog"><code>sidekiq.log</code></a> - All of the
   indexing happens in Sidekiq, so much of the relevant logs for the
   Elasticsearch integration can be found in this file.</li>
<li><a href="../../../administration/logs/_index.md#elasticsearchlog"><code>elasticsearch.log</code></a> - There
   are additional logs specific to Elasticsearch that are sent to this file
   that might contain diagnostic information about searching,
   indexing, or migrations.</li>
</ol>
<p>Here are some common pitfalls and how to overcome them.</p>
<h2>Verify that your GitLab instance is using Elasticsearch</h2>
<p>To verify that your GitLab instance is using Elasticsearch:</p>
<ul>
<li>
<p>When you perform a search, in the upper-right corner of the search results page,
  ensure <strong>Advanced search is enabled</strong> is displayed.</p>
</li>
<li>
<p>In the <strong>Admin</strong> area, under <strong>Settings</strong> &gt; <strong>Search</strong>, check that the
  advanced search settings are selected.</p>
</li>
</ul>
<p>Those same settings there can be obtained from the Rails console if necessary:</p>
<p><code>ruby
  ::Gitlab::CurrentSettings.elasticsearch_search?         # Whether or not searches will use Elasticsearch
  ::Gitlab::CurrentSettings.elasticsearch_indexing?       # Whether or not content will be indexed in Elasticsearch
  ::Gitlab::CurrentSettings.elasticsearch_limit_indexing? # Whether or not Elasticsearch is limited only to certain projects/namespaces</code></p>
<ul>
<li>Confirm searches use Elasticsearch by accessing the
  <a href="../../../administration/operations/rails_console.html">Rails console</a> and running the following
  commands:</li>
</ul>
<p><code>rails
  u = User.find_by_email('email_of_user_doing_search')
  s = SearchService.new(u, {:search =&gt; 'search_term'})
  pp s.search_objects.class</code></p>
<p>The output from the last command is the key here. If it shows:</p>
<ul>
<li><code>ActiveRecord::Relation</code>, <strong>it is not</strong> using Elasticsearch.</li>
<li>
<p><code>Kaminari::PaginatableArray</code>, <strong>it is</strong> using Elasticsearch.</p>
</li>
<li>
<p>If Elasticsearch is limited to specific namespaces and you need to know if
  Elasticsearch is being used for a specific project or namespace, you can use
  the Rails console:</p>
</li>
</ul>
<p><code>ruby
  ::Gitlab::CurrentSettings.search_using_elasticsearch?(scope: Namespace.find_by_full_path("/my-namespace"))
  ::Gitlab::CurrentSettings.search_using_elasticsearch?(scope: Project.find_by_full_path("/my-namespace/my-project"))</code></p>
<h2>Error: <code>User: anonymous is not authorized to perform: es:ESHttpGet</code></h2>
<p>When using a domain level access policy with AWS OpenSearch or Elasticsearch, the AWS role is not assigned to the
correct GitLab nodes. The GitLab Rails and Sidekiq nodes require permission to communicate with the search cluster.</p>
<pre><code class="language-plaintext">User: anonymous is not authorized to perform: es:ESHttpGet because no resource-based policy allows the es:ESHttpGet
action
</code></pre>
<p>To fix this, ensure the AWS role is assigned to the correct GitLab nodes.</p>
<h2>No valid region specified</h2>
<p>When using AWS authorization with advanced search, the region you specify must be valid.</p>
<h2>Error: <code>no permissions for [indices:data/write/bulk]</code></h2>
<p>When using fine-grained access control with an IAM role or a role created using AWS OpenSearch Dashboards, you might
encounter the following error:</p>
<pre><code class="language-json">{
  &quot;error&quot;: {
    &quot;root_cause&quot;: [
      {
        &quot;type&quot;: &quot;security_exception&quot;,
        &quot;reason&quot;: &quot;no permissions for [indices:data/write/bulk] and User [name=arn:aws:iam::xxx:role/INSERT_ROLE_NAME_HERE, backend_roles=[arn:aws:iam::xxx:role/INSERT_ROLE_NAME_HERE], requestedTenant=null]&quot;
      }
    ],
    &quot;type&quot;: &quot;security_exception&quot;,
    &quot;reason&quot;: &quot;no permissions for [indices:data/write/bulk] and User [name=arn:aws:iam::xxx:role/INSERT_ROLE_NAME_HERE, backend_roles=[arn:aws:iam::xxx:role/INSERT_ROLE_NAME_HERE], requestedTenant=null]&quot;
  },
  &quot;status&quot;: 403
}
</code></pre>
<p>To fix this, you need
to <a href="https://docs.aws.amazon.com/opensearch-service/latest/developerguide/fgac.html#fgac-mapping">map the roles to users</a>
in the AWS OpenSearch Dashboards.</p>
<h2>Create additional master users in AWS OpenSearch Service</h2>
<p>You can set a master user when you create a domain.
With this user, you can create additional master users.
For more information, see the
<a href="https://docs.aws.amazon.com/opensearch-service/latest/developerguide/fgac.html#fgac-more-masters">AWS documentation</a>.</p>
<p>To create users and roles with permissions and map users to roles,
see the <a href="https://opensearch.org/docs/latest/security/access-control/users-roles/">OpenSearch documentation</a>.
You must include the following permissions in the role:</p>
<pre><code class="language-json">{
  &quot;cluster_permissions&quot;: [
    &quot;cluster_composite_ops&quot;,
    &quot;cluster_monitor&quot;
  ],
  &quot;index_permissions&quot;: [
    {
      &quot;index_patterns&quot;: [
        &quot;gitlab*&quot;
      ],
      &quot;allowed_actions&quot;: [
        &quot;data_access&quot;,
        &quot;manage_aliases&quot;,
        &quot;search&quot;,
        &quot;create_index&quot;,
        &quot;delete&quot;,
        &quot;manage&quot;
      ]
    },
    {
      &quot;index_patterns&quot;: [
        &quot;*&quot;
      ],
      &quot;allowed_actions&quot;: [
        &quot;indices:admin/aliases/get&quot;,
        &quot;indices:monitor/stats&quot;
      ]
    }
  ]
}
</code></pre>
<h2>Accumulation of open TCP connections</h2>
<p>In GitLab 17.11 and later, you might notice an increase in
open TCP connections from GitLab processes to external services.
These connections accumulate over time and are not properly closed.</p>
<p>This issue is related to the Faraday adapter switching from
<code>net_http</code> to <code>typhoeus</code> for connection pooling in GitLab.
For more information, see <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/550805">issue 550805</a>.</p>
<p>To resolve this issue, set
<a href="../../../api/settings.md#available-settings"><code>elasticsearch_client_adapter</code></a> to <code>net_http</code>.</p></code></pre>
</body>
</html>
