<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># Create an empty index</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <pre><code><hr />
<p>stage: AI-powered
group: Global Search
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: Troubleshooting Elasticsearch indexing and searching</p>
<hr />
<p>{{&lt; details &gt;}}</p>
<ul>
<li>Tier: Premium, Ultimate</li>
<li>Offering: GitLab Self-Managed, GitLab Dedicated</li>
</ul>
<p>{{&lt; /details &gt;}}</p>
<p>When working with Elasticsearch indexing or searching, you might encounter the following issues.</p>
<h2>Create an empty index</h2>
<p>For indexing issues, try first to create an empty index.
Check the Elasticsearch instance to see if the <code>gitlab-production</code> index exists.
If it does, manually delete the index on the Elasticsearch instance and try to recreate it from the
<a href="../../advanced_search/elasticsearch.md#gitlab-advanced-search-rake-tasks"><code>recreate_index</code></a>
Rake task.</p>
<p>If you still encounter issues, try to create an index manually on the Elasticsearch instance.
If you:</p>
<ul>
<li>Cannot create indices, contact your Elasticsearch administrator.</li>
<li>Can create indices, contact GitLab Support.</li>
</ul>
<h2>Check the status of indexed projects</h2>
<p>You can check for errors during project indexing.
Errors might occur on:</p>
<ul>
<li>The GitLab instance: if you cannot fix them yourself, contact GitLab Support for guidance.</li>
<li>The Elasticsearch instance: <a href="../../elasticsearch/troubleshooting/_index.html">if the error is not listed</a>, contact your Elasticsearch administrator.</li>
</ul>
<p>If indexing does not return errors, check the status of indexed projects with the following Rake tasks:</p>
<ul>
<li><a href="../../advanced_search/elasticsearch.md#gitlab-advanced-search-rake-tasks"><code>sudo gitlab-rake gitlab:elastic:index_projects_status</code></a>
  for the overall status</li>
<li><a href="../../advanced_search/elasticsearch.md#gitlab-advanced-search-rake-tasks"><code>sudo gitlab-rake gitlab:elastic:projects_not_indexed</code></a>
  for specific projects that are not indexed</li>
</ul>
<p>If indexing is:</p>
<ul>
<li>Complete, contact GitLab Support.</li>
<li>Not complete, try to reindex that project by running
  <code>sudo gitlab-rake gitlab:elastic:index_projects ID_FROM=&lt;project ID&gt; ID_TO=&lt;project ID&gt;</code>.</li>
</ul>
<p>If reindexing the project shows errors on:</p>
<ul>
<li>The GitLab instance: contact GitLab Support.</li>
<li>The Elasticsearch instance or no errors at all: contact your Elasticsearch administrator to check the instance.</li>
</ul>
<h2>No search results after updating GitLab</h2>
<p>We continuously make updates to our indexing strategies and aim to support
newer versions of Elasticsearch. When indexing changes are made, you might
have to <a href="../../advanced_search/elasticsearch.md#zero-downtime-reindexing">reindex</a> after updating GitLab.</p>
<h2>No search results after indexing all repositories</h2>
<p>{{&lt; alert type="note" &gt;}}</p>
<p>Don't use these instructions for scenarios that only index a <a href="../../advanced_search/elasticsearch.md#limit-the-amount-of-namespace-and-project-data-to-index">subset of namespaces</a>.</p>
<p>{{&lt; /alert &gt;}}</p>
<p>Make sure you <a href="../../advanced_search/elasticsearch.md#enable-advanced-search">indexed all the database data</a>.</p>
<p>If there aren't any results (hits) in the UI search, check if you are seeing the same results via the rails console (<code>sudo gitlab-rails console</code>):</p>
<pre><code class="language-ruby">u = User.find_by_username('your-username')
s = SearchService.new(u, {:search =&gt; 'search_term', :scope =&gt; 'blobs'})
pp s.search_objects.to_a
</code></pre>
<p>Beyond that, check via the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-search.html">Elasticsearch Search API</a> to see if the data shows up on the Elasticsearch side:</p>
<pre><code class="language-shell">curl --request GET &lt;elasticsearch_server_ip&gt;:9200/gitlab-production/_search?q=&lt;search_term&gt;
</code></pre>
<p>More <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-filter-context.html">complex Elasticsearch API calls</a> are also possible.</p>
<p>If the results:</p>
<ul>
<li>Sync up, check that you are using <a href="../../../user/search/advanced_search.md#syntax">supported syntax</a>. Advanced search does not support <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/325234">exact substring matching</a>.</li>
<li>Do not match up, this indicates a problem with the documents generated from the project. It is best to <a href="../../advanced_search/elasticsearch.md#indexing-a-range-of-projects-or-a-specific-project">reindex that project</a>.</li>
</ul>
<p>See <a href="../../advanced_search/elasticsearch.md#advanced-search-index-scopes">Elasticsearch Index Scopes</a> for more information on searching for specific types of data.</p>
<h2>No search results after switching Elasticsearch servers</h2>
<p>To reindex the database, repositories, and wikis, <a href="../../advanced_search/elasticsearch.md#index-the-instance">index the instance</a>.</p>
<h2>Indexing fails with <code>error: elastic: Error 429 (Too Many Requests)</code></h2>
<p>If <code>Search::Elastic::CommitIndexerWorker</code> Sidekiq workers are failing with this error during indexing, it usually means that Elasticsearch is unable to keep up with the concurrency of indexing request. To address change the following settings:</p>
<ul>
<li>To decrease the indexing throughput you can decrease <code>Bulk request concurrency</code> (see <a href="../../advanced_search/elasticsearch.md#advanced-search-configuration">Advanced search settings</a>). This is set to <code>10</code> by default, but you change it to as low as 1 to reduce the number of concurrent indexing operations.</li>
<li>If changing <code>Bulk request concurrency</code> didn't help, you can use the <a href="../../../administration/sidekiq/processing_specific_job_classes.md#routing-rules">routing rules</a> option to <a href="../../advanced_search/elasticsearch.md#index-large-instances-with-dedicated-sidekiq-nodes-or-processes">limit indexing jobs only to specific Sidekiq nodes</a>, which should reduce the number of indexing requests.</li>
</ul>
<h2>Error: <code>Elasticsearch::Transport::Transport::Errors::RequestEntityTooLarge</code></h2>
<pre><code class="language-plaintext">[413] {&quot;Message&quot;:&quot;Request size exceeded 10485760 bytes&quot;}
</code></pre>
<p>This exception is seen when your Elasticsearch cluster is configured to reject requests above a certain size (10 MiB in this case). This corresponds to the <code>http.max_content_length</code> setting in <code>elasticsearch.yml</code>. Increase it to a larger size and restart your Elasticsearch cluster.</p>
<p>AWS has <a href="https://docs.aws.amazon.com/opensearch-service/latest/developerguide/limits.html#network-limits">network limits</a> on the maximum size of HTTP request payloads based on the size of the underlying instance. Set the maximum bulk request size to a value lower than 10 MiB.</p>
<h2>Indexing is very slow or fails with <code>rejected execution of coordinating operation</code></h2>
<p>Bulk requests getting rejected by the Elasticsearch nodes are likely due to load and lack of available memory.
Ensure that your Elasticsearch cluster meets the <a href="../../advanced_search/elasticsearch.md#system-requirements">system requirements</a> and has enough resources
to perform bulk operations. See also the error <a href="#indexing-fails-with-error-elastic-error-429-too-many-requests">"429 (Too Many Requests)"</a>.</p>
<h2>Indexing fails with <code>strict_dynamic_mapping_exception</code></h2>
<p>Indexing might fail if all <a href="../../advanced_search/elasticsearch.md#all-migrations-must-be-finished-before-doing-a-major-upgrade">advanced search migrations were not finished before doing a major upgrade</a>.
A large Sidekiq backlog might accompany this error. To fix the indexing failures, you must reindex the database, repositories, and wikis.</p>
<ol>
<li>Pause indexing so Sidekiq can catch up:</li>
</ol>
<p><code>shell
   sudo gitlab-rake gitlab:elastic:pause_indexing</code></p>
<ol>
<li><a href="#last-resort-to-recreate-an-index">Recreate the index from scratch</a>.</li>
<li>Resume indexing:</li>
</ol>
<p><code>shell
   sudo gitlab-rake gitlab:elastic:resume_indexing</code></p>
<h2>Indexing keeps pausing with <code>elasticsearch_pause_indexing setting is enabled</code></h2>
<p>You might notice that new data is not being detected when you run a search.</p>
<p>This error occurs when that new data is not being indexed properly.</p>
<p>To resolve this error, <a href="../../advanced_search/elasticsearch.md#zero-downtime-reindexing">reindex your data</a>.</p>
<p>However, when reindexing, you might get an error where the indexing process keeps pausing, and the Elasticsearch logs show the following:</p>
<pre><code class="language-shell">&quot;message&quot;:&quot;elasticsearch_pause_indexing setting is enabled. Job was added to the waiting queue&quot;
</code></pre>
<p>If reindexing does not resolve this issue, and you did not pause the indexing process manually, this error might be happening because two GitLab instances share one Elasticsearch cluster.</p>
<p>To resolve this error, disconnect one of the GitLab instances from using the Elasticsearch cluster.</p>
<p>For more information, see <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/3421">issue 3421</a>.</p>
<h2>Search fails with <code>too_many_clauses: maxClauseCount is set to 1024</code></h2>
<p>This error occurs when a query has more clauses than defined in the <code>indices.query.bool.max_clause_count</code> setting:</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/search-settings.html">In Elasticsearch 7.17 and earlier</a>, the default value is <code>1024</code>.</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.0/search-settings.html">In Elasticsearch 8.0</a>, the default value is <code>4096</code>.</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.1/search-settings.html">In Elasticsearch 8.1 and later</a>, the setting is deprecated and the value is dynamically determined.</li>
</ul>
<p>To resolve this issue, increase the value or upgrade Elasticsearch 8.1 or later. Increasing the value may lead to performance degradation.</p>
<h2>Error: <code>disk usage exceeded flood-stage watermark, index has read-only-allow-delete block</code></h2>
<p>This error occurs when your Elasticsearch cluster has
at least one node that is critically low on disk space.
A cluster that exceeds the default watermark threshold of 95%
enforces a read-only block that prevents all further write operations.
This block might cause new index operations to fail and result in outdated search results.</p>
<p>You can check if the cluster is in read-only mode with the following Rake task:</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:elastic:info
</code></pre>
<p>Look for output that indicates that <code>blocks.write</code> or <code>blocks.read_only_allow_delete</code> is <code>true</code>.</p>
<p>To check disk usage on your Elasticsearch cluster, run the following command:</p>
<pre><code class="language-shell">curl --request GET '&lt;your_ES_cluster&gt;:9200/_cat/allocation?v&amp;pretty'
</code></pre>
<p>To resolve this issue, increase your disk volume on full nodes.
You can estimate cluster size with the following Rake task:</p>
<pre><code class="language-shell">sudo gitlab-rake gitlab:elastic:estimate_cluster_size
</code></pre>
<h2>Last resort to recreate an index</h2>
<p>There may be cases where somehow data never got indexed and it's not in the
queue, or the index is somehow in a state where migrations just cannot
proceed. It is always best to try to troubleshoot the root cause of the problem
by <a href="access.md#view-logs">viewing the logs</a>.</p>
<p>As a last resort, you can recreate the index from scratch. For small GitLab installations,
recreating the index can be a quick way to resolve some issues. For large GitLab
installations, however, this method might take a very long time. Your index
does not show correct search results until the indexing is complete. You might
want to clear the <strong>Search with advanced search</strong> checkbox
while the indexing is running.</p>
<p>If you are sure you've read the previous caveats and want to proceed, then you
should run the following Rake task to recreate the entire index from scratch.</p>
<p>{{&lt; tabs &gt;}}</p>
<p>{{&lt; tab title="Linux package (Omnibus)" &gt;}}</p>
<pre><code class="language-shell"># WARNING: DO NOT RUN THIS UNTIL YOU READ THE DESCRIPTION ABOVE
sudo gitlab-rake gitlab:elastic:index
</code></pre>
<p>{{&lt; /tab &gt;}}</p>
<p>{{&lt; tab title="Self-compiled (source)" &gt;}}</p>
<pre><code class="language-shell"># WARNING: DO NOT RUN THIS UNTIL YOU READ THE DESCRIPTION ABOVE
cd /home/git/gitlab
sudo -u git -H bundle exec rake gitlab:elastic:index
</code></pre>
<p>{{&lt; /tab &gt;}}</p>
<p>{{&lt; /tabs &gt;}}</p>
<h2>Improve Elasticsearch performance</h2>
<p>To improve performance, ensure:</p>
<ul>
<li>The Elasticsearch server <strong>is not</strong> running on the same node as GitLab.</li>
<li>The Elasticsearch server have enough RAM and CPU cores.</li>
<li>That sharding <strong>is</strong> being used.</li>
</ul>
<p>Going into some more detail here, if Elasticsearch is running on the same server as GitLab, resource contention is <strong>very</strong> likely to occur. Ideally, Elasticsearch, which requires ample resources, should be running on its own server (maybe coupled with Logstash and Kibana).</p>
<p>When it comes to Elasticsearch, RAM is the key resource. Elasticsearch themselves recommend:</p>
<ul>
<li><strong>At least</strong> 8 GB of RAM for a non-production instance.</li>
<li><strong>At least</strong> 16 GB of RAM for a production instance.</li>
<li>Ideally, 64 GB of RAM.</li>
</ul>
<p>For CPU, Elasticsearch recommends at least 2 CPU cores, but Elasticsearch states common
setups use up to 8 cores. For more details on server specs, check out the
<a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/hardware.html">Elasticsearch hardware guide</a>.</p>
<p>Beyond the obvious, sharding comes into play. Sharding is a core part of Elasticsearch.
It allows for horizontal scaling of indices, which is helpful when you are dealing with
a large amount of data.</p>
<p>With the way GitLab does indexing, there is a <strong>huge</strong> amount of documents being
indexed. By using sharding, you can speed up the ability of Elasticsearch to locate
data because each shard is a Lucene index.</p>
<p>If you are not using sharding, you are likely to hit issues when you start using
Elasticsearch in a production environment.</p>
<p>An index with only one shard has <strong>no scale factor</strong> and is likely
to encounter issues when called upon with some frequency. See the
<a href="https://www.elastic.co/guide/en/elasticsearch/guide/2.x/capacity-planning.html">Elasticsearch documentation on capacity planning</a>.</p>
<p>The easiest way to determine if sharding is in use is to check the output of the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-health.html">Elasticsearch Health API</a>:</p>
<ul>
<li>Red means the cluster is down.</li>
<li>Yellow means it is up with no sharding/replication.</li>
<li>Green means it is healthy (up, sharding, replicating).</li>
</ul>
<p>For production use, it should always be green.</p>
<p>Beyond these steps, you get into some of the more complicated things to check,
such as merges and caching. These can get complicated and it takes some time to
learn them, so it is best to escalate/pair with an Elasticsearch expert if you need to
dig further into these.</p>
<p>Reach out to GitLab Support, but this is likely to be something a skilled
Elasticsearch administrator has more experience with.</p>
<h2>Slow initial indexing</h2>
<p>The more data your GitLab instance has, the longer the indexing takes.
You can estimate cluster size with the Rake task <code>sudo gitlab-rake gitlab:elastic:estimate_cluster_size</code>.</p>
<h3>For code documents</h3>
<p>Ensure you have enough Sidekiq nodes and processes to efficiently index code, commits, and wikis.
If your initial indexing is slow, consider <a href="../../advanced_search/elasticsearch.md#index-large-instances-with-dedicated-sidekiq-nodes-or-processes">dedicated Sidekiq nodes or processes</a>.</p>
<h3>For non-code documents</h3>
<p>If the initial indexing is slow but Sidekiq has enough nodes and processes,
you can adjust advanced search worker settings in GitLab.
For <strong>Requeue indexing workers</strong>, the default value is <code>false</code>.
For <strong>Number of shards for non-code indexing</strong>, the default value is <code>2</code>.
These settings limit indexing to 2000 documents per minute.</p>
<p>To adjust worker settings:</p>
<ol>
<li>In the upper-right corner, select <strong>Admin</strong>.</li>
<li>Select <strong>Settings</strong> &gt; <strong>Search</strong>.</li>
<li>Expand <strong>Advanced search</strong>.</li>
<li>Select the <strong>Requeue indexing workers</strong> checkbox.</li>
<li>In the <strong>Number of shards for non-code indexing</strong> text box, enter a value higher than <code>2</code>.</li>
<li>Select <strong>Save changes</strong>.</li>
</ol></code></pre>
</body>
</html>
